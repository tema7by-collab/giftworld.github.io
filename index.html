<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/jpeg" href="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAMgAyADASIAAhEBAxEB/8QAHAABAQEAAgMBAAAAAAAAAAAAAAECAwgEBQcG/8QASBAAAgEDAgQFAQQGBwcEAAcAAAERAiExAwQFBkFRBxJCYXEyCBMigRQ2YnORsRUjM1JTk6EWQ1VygpLBJCY1sjRERYPR4fH/xAAZAQEBAQEBAQAAAAAAAAAAAAAAAQIEAwX/xAAoEQEBAAMAAQQCAgMAAwEAAAAAAQIDEQQSITEyQVETMxQiYSNCUnH/2gAMAwEAAhEDEQA/AO0zwfna/wC0q+T3z19KP7Sn+J6WrQ1PvG6qYpbySp8uKmnz1HmUUqhe4poVKNQjyt6shNhLDtgEUnuMhucjAQgkNFTfcSBHOSR3NfkLxcKlgiQi+wCC0mZfQq9wADSHQCZK5F4FwiQ4uVhttFSgKggTewAWFgkgABVgiCJLKUSAS6ixmLCICqCZEwBQVXuAJ8lkmWV2CM5CUIs3DYC4KAJYRa4I02FXrgsD0kuAEBLuXCsCs/kL9DRAiw/MLNZISEFVkwUMB1JgRBXIAmTU2CVpAKxMu6CACA/pDCANgFkBBmLF6ld0BICnqS6NAR2Fy1EbbVgg2CqyM3YGoJBMFhthSAhEZDsAEzgL6QggCZKwBc9CYRMBSGX/AECEATIwX4HuBGupq5mWUCgjLSBCXZZLIQdjNSVSuauRwB4epR5H7EPMqpTUHi1aNXm/Cmzcqel77Q/saPhHKePpatFOlQnXSmkrScn32l/iU/xPRXIDj++0v8Sn+I+/0v8AEp/iEfnqVNSg9hXU6lSm7QcOhQqaZeTkaTPK1ZEasX0jCGTKnqBOpcAJkEkQBUwABILJJEywKSLhqSgPSRsImQEWNW8oJlAWSdRKQkA3BFdlQmUBfUR/USJNJQgEBJmYZqkBKEEgOYAmCiYQTAMR1JcoDoWkhagEgCUBIAktIEsEFZMIA3IgJBgICZIYmAKl3KRyyqwEnoILKMtt1WAZEdjRn9kCsRcBNgOo9UhAAnJLovwJAOGOgX1AAy4RAAyxeQ5CYFqEGc4KBaSPNiRYuFcB1DbYTLIEgs9jK/1KgCDfYdQncAS6K74LT7gRXZSdQBZRJBUwDdiSCSgKmBIQEnsIY6lcsBBG+hYAFFRnJcMHBkmxUxPQCZKxIAIrRLgA1OC0VOipNEJkDxtb+1qfdmYPJ1aFVTbJ4vVrsekqLBIRUOpoeaJFQseKs3ZrCE3EAJlhsRGDMdwNEHUPp2Av5EiEWSAWn4HqIyxAEu2SILI9wLNiJRkqViXAuTMdjVJL/kA6BQX0kSQFsmZmVY1FyL6QDsGSZg05eQEWM36ldgpAP6iyE+hLyA+QGuwSASEWESLgTBYK8kuAgpIuSGBpuCEhGgJ0C+kQAFySxKNAZmCq7KIADKHqFmAjsIsZuipPqAZIkpMgWC2kjTEAVpdBFgkSLgXBEX5Mv2As3wFZgdQAAYEyXKgEugL1KGiRN2Af0lWCQGAbRVgiiQAbAsPgAW3lIqe4i4EwXqJlwSUBULl9IAkiZwg0WbWAgSgl2H2ApJsVWQnoAXwOoZaQJIXuIKBJuVqSByAEkpyUB1HUMkQBW7EvYob7AH9I6AkoC+xw61C+pHLZl8qx0LErw0Eb1KfLW10MHp0eaPUHcRc8g+BcJQzM3yFOxX9JeiJADCLJmJKn0AJSUgd2AL8iyROoFshYWkz2AP2LeC0mcgaWCSB0AvpuQpGgCkmCiAiqDMyasTqFX1ASRIBYk9i2guAIkGVyKfcCQWBklwKHkkuS1ARiShQAaJA6kwBokFHpANLoB6gBJK7iewkIND0gBSYF2KSNgIHpsX0kUgLl+AAiXLEBse4UywBYCCFJZM/mAauUt+pJp7AVxBEXJGBfURzFi0jAAVCWx6QI4FgnIAOO4witCAM5NYDd4EAE5mRZsNCkBgZM9zVICLGcGnckXASX1EdipgZyahAQwI7FgOxOoBWDdhAAJhCRIB/UEOo6ASAyhYuAYQ6EiQNESRH7Gun7QBwkZ90WCYAzq0+amTxjy5k8fVpiqTWNSvIjFzVRB1Mi/BEXDDYVCSzQpACBkXACkJdx6rBEsUQGgJD7h/UXuFgKJCLkEAUSJFQGcj8zRAihpgAZiTWCfA+QomyuXYfNiICqkRcgAskgpGEX8wGhAUGcARADAyBIDAgUgBgAQApAGQgGgsioKD1EKBC0iAAE2ApCGB+ZHdlAWY/MQQKNhMBgMsswPgekCzJmCzDEgJEANhEZSFnsFJEMTBOoBuBctI+AIpYTZah6QISJ6msioIiK8GcmoAEm5cCwVmYLJbCAJLZR6jMMI07CQ0PSAu0BkQFZhldkB7gCyRu4ATcZUgicIC9bjrkJXkdQgCkYC4dxJaQqdCk6lyBnGDOrT5qGbEhKfAXuTBZCqDKVzQBoekBruAGGJgQwhJLFkARz0JEF6lbCnpMz0RUAKrGZbeC3KAt1H5EdwrIAUiLkHBR3EiCSAvJZImJAvyG7WI7gAsXEr3KKQiQWwbCXuAyH8j2EBWYZqkSSABSB/SBQMj1APSSSzYkhFqFwSQvEuxktipXyAuBIlMCXfwSYNYGQhliEJHpAKAoGB6go8kgskAqRIKkPUBIUlqAgBCIXICMwjRAFgVokEmQK32LNrEkP6QAcBMA6sdeglBu/sKUghV7E+RNyzYCWLC6EsPL7hUjuasSLiAEAYQTCElpEkYEiTTgTCM5C8abge4yIBwAGQFuxJhkwXNwJk1AqGQhPYiLAAlgoJkYCqAg0BfSJSVySXIOokhYCAgX1EbLIUj3GLEX1FiAEww3cPAAekNh3AQIr9SZNTAUwiK4+SgQsmY7mmwEvyikSZhgVItiDCAvwZmCpCX2ASCSir3AN2CI/Y0sgZmS3gqsif+QCL6hFgkECYYZWwqTOC+oTBmZA02QdS1ARlCYywI7FVwAiFGTMoK1FyWksCwEdwKcMquASgR2DQiwCbkZpIjYREshABVqJhFSJ1AJiS2I2Bc9RAiCKeoFI2WLkkISEWojAXkEmDUBUd2WCSSJA16SBpdypAEpDRLlSsEIhGYuW5Qp8kywwAf1BCzsMIApECRcCXRZLMECI0oLICQVFcXiCgCYLfuGV2QGZg1MhKck62Aob7EksBCO4iVklyRAVR1JUnLL0AsCe5nAmegFdwhN8FAdGREwMgaqAiF7kywKEwLAJM3ZV9RZuApCh1BsNATqOtgl7h2wBVYjsEmADmCyZyassgRywqYyVvsZv1A1K6C5LBT1AsEkS2UCVNxCKrZJ8BJgHGQ7gAVWFJnJoB8kmcEnuaAYJcOZEgWSdQWO4E65KSIwPkAE7BfUUAGzOcGrAPTcEbvHQqQAzboamBSA6QZjuai5LgPgsgBD1BsgbCimLl/IZIBafcYwSABJk07sWDfYAkkh8GY7jAGnLFxLACbEZYsR/SEJEFginAVfSSbiCpAQsiAkBIJmxr1Cpx0AW8o9JLiegBNFt5RBIAJ3LSLEABNzcmDThgHfoJIlYIB1DnIQAP6QHIhyAgSAgJnBonwLgWA3AwEwErLJ6pK7kkAOgzcOQAi4AArgem5IuBMXLm46lqnoApDaRLliQJ1KHKZmJATYuEWU8BXYBYsFgVEQFsTqWJGEBm/mNYEkd2AVyWRr4EAZyWAwBVkZIvqHwA6kllx8BP2AicIqUlm8E+AGELlUrI/ICAJSOoBssPuOsIzD6gVx1uCwoAEbbBZREAywwygZmDRfIIAkIkSyw0wAuhksfhuQARyEuokCghaQJeQSWaCFhUGhSAUkxJbyICo0WkJrBIAR7lSBF9QFixEUnUCgECE3DZbCnqFZ/MrEgCwRSJKsgFLyZauakRYAkzLtk1AkAsE6lkzLA1YhafcJWAz+ZV9RfgiAWEBRJMgaJhiPcJBFiUT2F11ETkKAWAEwW97i82FwA6AATAlld0VtIAQImQKCKyKAC+kskkCdSss2M5A08E9NiuIJABCRfElpAXZGvcExgBTNy3kvyRO4FwRz0Bb9gIr5LMEkRcCgnsLgCzcQzMIDXqJd/BbNiQIrFyKSSEGmExNyhTIlE6iLgWJFIlIZASzRlOMkYRavYJMekSAwMiRPYKRYSkLk6gFDLYVexEsgX0mZZUG10AXJfoWJwaiwRm5VKF7AKzdlhSa6BIDLtgqVrhQMsC/BJYmBYBDAAQuPUG2ZyBqokhFqClIWQMAPUaMu4wEIGMDCFICH1FQuPUAMxJonQKNhEzk07ASLlbgXC90EPSRlVxUATFkKiAWwt5RFx6gqQIL8MekCApOoFpFiMsBEci5SAVYM5NVE6BSwGFcWASCSlgtwEF9JnJqkCL3EOfYWD+mwQbkYVwlCCuFSzLKQiMCOoFpFJBYCkLS7km4RGrlgMBUhjua9iACpixADLZInUL3AtIkN9gABJAFECI6iAAgWQkIsIhHdlhJgMdSINSWr2Ck/skkd+xMAai1zMyJ7mvUBIKnYSIsECR7hfSGgKDMQaalhSBYQhC7gJAwMgB6RhEV2EWQkmJEAPUHMyMMT2Ck2CVxIANdhIuIAiLZCoQESJZfkSl0FQCRIFgpZIE9UlaQCCItQwAkRLHuQC+qw9RF9JbNBGjPqFhSBG4HQjv1LhQFEWRJF9QFkABCoT7iBEAFYWGbj1AJI8walGbhViBSRIdQLAaECAjOAlOTWA3fACwmRFw2kBn8zQicgKkhgWgCZDUs0ErhGYgsliRKVgM4KW3YWColb2AAC5QPcCXgtyMtLkBSJRmmLmreUIWQsRKSgCSEJS9woA7iwCwkWEAPkse5OpYUBERHd2LKRVmQqL4LIpAEgtxAwBGUimS1ARCAWbAJsSCwkZ6/sgam4S7gALeZGjMdzQHHMFEFb6AT4LISSGWBFIi5avYAZhlaZfUAHSB6QZwBrsBACFIbM3ZqAqZZZGH7AALipT1FwFIhsnyLgX5Ii5YiHYBT7hsy37mpS6sCL3GPc4Nxvtrt77jc6Wkv2qkfneJ+IHLfDXV99xLSqayqLmpjb8M3PGfNfqW32CufLOJeNvAdu2ttp6uv7qx+d3Xj44f6Lwteb9qo1NWVeV8jXPy+7D04Oum58duM11f1O029C91MHrtbxp5oqvTXoUr2oLNOTF8zB2cgkRMnVurxk5pz+kaUf8paPGjmml31dBr3pL/Dkf5eH/AF2ivMCTrXtvHPj2m199t9vqL2WT3ew8fa5S3nC0+7oZm6cos8rCvvRUz5bwnxr5e3bS3NGrt23EvB+24Vzhy9xNL9D4poN9qqoZn0WfMemO3DL4r3kBounVp6tPm066dSnvS5I7k5x696AEICDuOgWJAJFSCmV1DqopbVddK9pAQhUR6mirfe0/xRj73QTvq0fxReU65PUZmDP32hP9rR/FD73R/wAWj+KHKnY05NJQcf32j/jUfxQ++0Zn76j+KHKdjkUkuZ+90f8AFo/iPvdH/Fo/ihxetQWUkZ+90f8AFo/7kR62gs61H/cgdbqIl1JRqUakvSrpqSzDk1PYgTIWfYVCbABGRSHKAi+ordwsEV2AclgSS4FpI2EWAJJZMyjUARh/SMoqsrgRFgR2CTAkCLgQAgQ2JJDArZIRQ0Af0hLuFBMgWLgN2sEAkSWwSXUBEpDBLlpAT2GVcOxmWwNYYlMkllQBZJT7kLPSADa8xCYD9gLDbD+kJD5ABWDdytQBBLY6Fp9wIy2/MEcSBLsqUFsiQA6lIkkJAoDyACY+QsEkA/qLSCAUQRLuGA6lqEQKQI5YK3BnIFgjY9LhSeBxXimz4Vtnr8R3OnoaavNTiQWye9efM2TOHeb7a7HSq1N5uNPSoSlupnxbnTxu09Guvb8u6KrqUr76rH5HyDjXNPFuO671eJbuuufSnCPbDVb8uXZ5WOP1dheZvGDgfDlVRw9fpmspunCPmfH/ABg4/wARmjaOjaaTwqbs+ZUVQa8/U98deMcefkZ5PO4nxniXEa3Vvd7r6suYdVj1rpUy7+7OTLI7G3h2/lh0roZwzkyjLCsz3Ms02RsKwxC9jXQJBQJKBliANU0rsclFX3dU0N0vumcZYCP0vBeduOcHdL2m/wBVUpz5KnKPovLvjtrabp0+ObRalOHq0OIPilX0wZiYRm4St47csfiu4nLfO3BOYNGirY7yj72r/d1O6P0actdjo9ttbW2uqtXbalWnqU4qpZ9R5H8X+J8M1KNvxed3tcOp/VSjwy08+HXr8uX2ydkpvEWLSkeo5Z5k4ZzHtlq8N3FFdUJ1ac3pPcNXv/A8bLPl2Y5TL3jWmk6kdVfErmTin+2fEaNLf7jT09Ot0000VtJHahVJVSdOPEWueduK/vme2n5rk8u2SceJVzFxdr/5Pd/5jOJ8w8Xn/wCS3X+Yz1jckg6eOHte0/2h4v14lu/8xj/aHi//ABLdf5jPVwMDh6r+3tP9oOLz/wDJbr/MY/2g4v8A8S3X+Yz1clJyHqv7e0/p/i7/AP1Ld/5jKuYeMLHE93/mM9TIkch2vaVcw8X/AOJbv/MZn/aHjH/Et3/mM9cSJHpi9r7N9njjfEd3zPuttu95ra2i9LzeWuqbyjsLTSjrX9nBRznrp/4L/wDB2Taucm2cyfQ8a9wBF7h5B5ulHbBF3NekjdgLMBMjuEBZsQRLE9AACKl1AgqJEs18AErAjmAgK32HyRhsArhfSEH8gX8rmblDYB/SEILKANrqLNWIWwEVlcNhSGBconQoakCTDsTJpYuJAQJSQbkem4BTDEXEwJAkB+4YAiVzVpAnsAiRFzN2XqBSMsDICWJkCyAjcD/7EjuaiQJEZHwWLXAEgP6SpSWEgjEWKvc2SEFZQgqSFgISWagspIDGTQwrEAKZBZMq8SwNQWVDdTVKWW7QeJxLiO14bta9zvtajR0aFLdTg6/eJXi7uOK1auw4DU9DaYeqvqqN4YXJ47N2Oue76Hz/AOKfDuX1Xt+HeTeb3FnKpOu/NHM/FeYd5VrcR3Vdablac/hR6ivWqrrqr1Kqqq25dTyzDudWGExfPz3ZbL7uNp/CKm4yGErG2G6W1g5E7HDSzkT7B51y36E9RjzXNMIrcuDLsUmQ0zUpM9DTDU4Co7EQqwUKl+guVEwBq4kBIIGqUKaTkpUIMWs00X7HLSoxZ9yI1HuVm153COMb7g+7o3Gw3FelqUufwuJ+T714e+LO14vTRseM1LQ3istRu1R11lyzjdXlqVVFTVSdmuhjPCZPbVuywvY7vU6irpVdDVVLUprDOnHP1Tq504tP+Oz914c+K244QqNjxuqrX2uFqt3oPnXNG80+I8xb7d6DnT1dR1Ut9jz14XG1079s2Yyx6tyLlSsaPZzJcpJDASUACSJYyFcDNzkpIWkD6r9nR/8AvTW/cs7KN3OtP2dv121P3LOyzUs5N32fQ8X6JNwsiF0DcHk6hq4wLjCAS+xmJNU+4nsBmINQPSKgIpYcyWkSwFJIhmmyTICRkTIAJORBLwEnAEb6CLGsETl2AfAf1DDE3Ak9ypIsyhHcA0iNRgsKREALmfzK3IABO5RT7AAPcO4CQ3LBoDLgzKESaiEBGTAuyqwFqIrDqX1BEx0KnfBJLV7AHMiUvkXJ1wFWwi+R+RLgUy20WAwg2y0+5FcAW5FKyW4qASRyHZBXAJyWUkTEhKbhUTvZmlm5nAyBr4HpCS7j9kIzjJ6jmbmDY8ucK1N5xHVpopS/CutT7G+aOO7TlzhOpvt/WqaaV+Glu9TOqHPvOW+5r4rXrbjUqp21LjT0k7JHprwuTw3b/R7T5eT4h8/8Q5q39aqrq0tinFGlS4TXufj07mYgdTrkk9o+dllcvetI0ZTBUBUAAp9i0qLk6yEwjaZpMyoLIRqSgBlGjNRszFitMsMsQQiiIvcoVwKaSckVPZnIk5QYtRJnIlGQjTKyIzNwzLAVOFBxPvJanMmZJWpGapjFwl2VwslI2ezRMMpGyh1wJ9igKEKAJP7IVihAEWkCkjNfUvs7z/ttqWt9yzss8nWv7Ot+dtX9y/8AwdlHk5N32fS8T+sgWEWKkebqSewwLeUzEgakkCBeQJPQsORHUL6giXRqmeo9RJfYC/It0GRgB6iZYRQpgEksAItcYViJyhAFyLEZcBEsW/USSbgTBZlFAVJSDLYNAEhA9I/IIQEhUOshRxIJ1DdwLIpIJAs/skbkuWAEwKRkSEDRlK/sPUFG2TqRvoaAfBJaFy5Aillp9wnAt1AE65L+YSl+wQkJyiwIQE9IEIJQFA0WYJ5gJ0D+kvSSP5AK9jx+K8Q23CuH6293tao0dJNtt59jnqrppTqrqSppUtvsdb/Grn18a4lXwrYarWx0LVNP62b14+qvHdt/jx6/OeJXOu65p4vqVOprZUP+q0+kH4pqTVTU2ZDsk5Hyrlcr2sOxnODTuy9Sp1INEgoUMosIoE6EX0hfIi4FVPZm6WccRc0mBpG5hGFY1kIRcy1c2yQUZiRBqIEIgzBUupfLJpJYKFCuclKc3M0qDaQedVD9oQKsAZqdjjqqFTMtqAsjL+kjK8Gckbiok9xgZCnq9hYfsiADZQR2CqCKxQJJQTqKNUvuCDqQfU/s6frtrfuX/NHZerLOtP2df121L/7l/wA0dlqnBy7vs+h4f0QEgSeTqX0gnQuAFwribACFHpEdZCA81wJQCkeoZwIYUgVEZVZAQTcSVQwJBcD4HpCJcsSwJuAHqDTM3QVYbYZJZUBYEWEkTYFgAJAKR6iX7DHQCwS0j5RaWgM5NOFYU/A9ICofIlGZlWQRoKwSgBUkthYnWwFJIRUwImWbgSkEJRG0xliwAIJlkKJNsRcZwIYD1EgsB2APBoyLgRkumavaD1/H+JaPCOE7rf7qpU6WhS6vl9BztS3k7Xzbx153fBeFLhXD9RLebpfiqWaKTrb5m6nVVVNTu2ez5t41r8wcf3O/3FUvUqflXZdD1OTt14+mPlbc7nl2tKGalGaSwbeSovwSCgRqSQbSIwIA0MASCfBYKkAECJZfKBaXJpGcIebpIRyJSGhS8Jf6I9hsuD8Q31ap2my1tVvEUj2Znu9c0i0pH7LY+GXM+9h0cPdCfWtwe40PBnmWun8a0aH/AMxn1z9vSas78R84SKqZZ9MfgtzJP4XoP/qPH1vCPmjRTf6NTXH92pMszx/aXTsn4fPaVDNO1up+g4lyhxzYpvX4duFGWqG/5HotfS1dCt06unVRViKqWi+qPKyz5jguZqTaNNycbdykiOxh/UbqcrJgjUR3K1YRCFw2jAAVLFJBQMM2SR0AO6KAARIKS5BUUmEEUfU/s6r/AN7as/4L/mjss8s61/Z0f/vTV/cv+aOyrdzk3fZ9DxfomUBAPJ1AlBwiSBXYSSST2CKmWRFyJMKdSygkZiALIuVO3uHLAkln8OAla5JSAAtRAHwWoTIAgVgyyBJEiVBMgapEkZcZAhZI2X0gqdSvBIENgJbJgoQFV3cOJFQSAT2HqECqOgCVNyMJSABYQMwwEI0RKAAbBRkCL6RYkwaiwEYgqQmwCEhYQIAYBGgpAXLGBSGgDZVgzYsroBUpcK58P+0XzO1Tt+CbWpJP8erDPtW/3enseH7jdarijSodTZ035s4pq8a5h32+1am/PqOPjoe+nHt65PKz5PS9DVTeYM+U5ajEM6Xz8WIuUkGgqqxVBnIQRyUghaQiBlww0BlqwSL0HwFVIqRFKyz9JydylxLmjf0aOx0mtNv8Wo1FKXyO8+WZLbyPz+noV6tSo0qKq63hUqWfveUvCXjfHWtXc0/om3eatRQ/yPt/I/hpwrl3To1NbTp3W8y661KXwft8KFZLCWDwz3f/AC7tXifnN885Y8JuBcI06HuNJ7zXSvVW7T8H7zZbPabOhU7ba6GlSv7tKOa5YPC52/Lsw144/Eabf5GWVsVGW0k0q2jK+oP6gLU1UmqqU+kM9Hxflfg3Faaqd7sNKtv1KlJnu2H9JZbEyxl+Y+M80+CO016a9Xgm4ejV/hV3TPkHM3JvGeXdVriG1q+7mFqUqUzuKeNvdnob7b1aO70aNXTqUPzKT1x3WfLm2eJjl74+zpDLdNjUWPu/iF4OLy6vEOXMpeZ7eM/B8Q3uz1tpr16O406tLVocOmpQ0dGOUy94+fnry13leK0/KJDb8pDTESRkZEBsnoCmGBcFJk0BP2RcpLeUCklhf6CfYAlc1BFdk/MD6p9nT9dtb9y/5o7LPJ1q+zpfnbU/cv8AmjsrVmxybvs+j4v0PSIsG4Etnk6SlZkQg2xhAat0JKJ6SQBWkMkYkAixcSR5yAgt0T3DfYApeSyoMz3NQAkK4hCkBgkhCQJPcqiSZLF7gGkWLEV8hsCYNJmU73K32AtiP6gVWAjLdhZFQCO4IyxF0A+SORcvpAERR6gJN8B3wVwT4AtITgkXLSBmbDFzUoRLAUgR2CyERlmUKhUFQP6bBOwuAKLeUAZwamwS7iJuAWBJMWK0EGpJZXLEGYvkVXzXx34//RfKn6Hp1Nau7qjPTqdZXVMn0r7QXG3v+baNjRVOntKYj3Z8zpdoO3XOYvk+Rn6syoy2amReTbxcZDbJ1DTKKvqI8l9QGuppODjk0shmtZZpkXsaS7hmpSvYlTSUtHJF/Y/SchcpbnmnjenttKhrb0tPVr7IW8MZcryPJ8OeRd5zZxClvTensKGvvNVq3wjtHy/wXY8C4fp7Ph2jTp6dKvVF2xwDg214JwzS2Gx01p6Wmot1PYxLuzj2bLl7PradE1zv5b6DoRWB5ugiRgsEAK7I/qE9UX5AekJXAkCEyVWyVYuBLQTypsqUmoQK0nFvSfOvFHw52vMez1d5sKKdLiFCdXmpX1+zPof5kdXldmzWOVxvYxnhM5yuj3E9rr8P3ertN3pvT1tKry1JniJnZLxr8P8AT4zsK+K8M0o32im61SvrR1tadFTprTVScNPozrwzmU7Hy9mq68uCNkCcI2wSGKsBkGWbIZko1hBAzIGyKCkn2ATAnuXqOoH1P7On666v7l/zR2Wbudavs5/rrq/uX/NHZar6jk3fZ9Dw/oTPQjZWySjydSFuXJAEk6FESApImUfAAkFAELZCkQAiSdS1BQsgIJUV5GEAgLuJkRCAVCoUkcgErFsHgAT4yVLqxIAnwEikbAqRmbwOxqAFXsSSizyEPSFIDYVCyLEUAIuC1ewt5QCYdxkkNAIEiWxIQSZRL7Gb9QqldxYAMEktUdRCB1lqWaS7glwi1DCEIfIEQckwabCnpOHcai0dGvUqxSpbOb1HoefN/Vw3lHiW5UTTpOCydrOd5ja6k837+rifNPEt1W/N59Zw32R6mxqtuuqqpq7bbZmDvj4tvWqQ3cifctsgDOTUzhCICdcbTNGrslS7BWYKvcylBroDosnJS+5xps0rMM152x29e73WloaFDq1dSpU00rqzth4a8q6XLPLujp+RLd6tPm1aovJ8Z+z5y5/SfMWpxLc0zobSPJKs6jsnVdvCXsc+7P8ADu8PVyeusNXJBp/VYk/xOd9AUyBD8wAOR6RceoB6bEplo10JV7AFZiUAmBCtQKo6D5B0wIkWEsBBGnkqQv0AzUk6HTWppqs0dZ/HHkr+guOU8Q2Wn5dlurtLozs1B+f5/wCA6fMHK272tdM6qpdWm+swemvL014b9czx/wCum/eTODyt3tqtruNXQ1U1qadTpaZ48nW+V1n1exl/UbdiNg6Ay4RVcrSjJMFARYdQgiCglipuQj6r9nT9ddX9y/5o7KPJ1r+zl+uut+5f80dlm7nJu+z6Pi/RlJBwG0HB5uknsA0LBTIgJD4AXYSgSxdxIOmSKwwy+oAmmxULIfABYI7stjMWA16bD5GSOzApAiyDoPVYjZZXUHUkMtn0EhCkXJL7C4VcGZkrllAUghQEySAiwAFROpQMv2NQJhiH+QDAgYQCGJE9xUHZgJRA1BQrODUtsWkAGrGVbqap9w4CMxJpoYWSKQLgTckPuIuBYm5GoLD6CPcKUk6jLLgAfPfHXefo3IGvRMPWqVC9z6Bk+S/aP3Hl5Z2Oh/f1ZN6/s8d95rrrtUl0MRY5KjDU4O18aJCYV3YeV3uaCs0qGayVKxfSURohqJI1AHE1cWNO5mII0tKI035Uk7uEa9Nj2nLOx/pDmHh22iVqayTXsMvhJ73jtB4Q8Fp4NyVs6XQlra9P3tb63P2vpg4trtqdvttHQotTp0KlfwOT8zgt7bX2tePpxkWIKZhzkrkjaGifJF8gJuKRgsSBBUXGCU+4DKFINBGYBYJEAINGWwrhR2CBcAKvqLTE3wT0yRuQOqfjXwVcI533Dopa0tz/AFtLPwdj779pLhqr4dw7iCSVWnU6H+Z8CaZ2673Hr4+7H052FRlwXoYaNPOLEsYEwRlaXIwUEBO1xTgTIjuEVIYRIKkB9V+zl+uur+5f/g7LM60/Zz/XTV/cv/wdlavqOXd9n0fE/rIRIK8C0Hk6kECkYQFeCUmcmlYBKHwQoQECBgBAHpAUWSYZR8gMiofAgBgJCLAIB3YgYASIHqCyFMMZDV7EdgHwIBMgapAshLAEgvpH8gAj+IsAFiOS1exAKKSL3LV7BAGcGshSLhsLBIAFnsSC0gLtCEZnojSXcIVCbCkkgECP2NUvuFRSX4YknXACA7lqEgQ+JfaU1Y0OFac+puD7az4V9per+u4Wvk3q+zn8r+uviNTkyg1c0dz5DMlSNJexYwAMorTkoRlmajVRmp3kLBkdxZjoRqInB+38G9q954gbBJStOa2fiHg+mfZ40XXzvXX/AHNKxnO8xreudyjs7U/xOe5GaMnC+0QLhi4CH1EkuX5ANC3lCyaAk2HQoCJSJEkkKskibgtX1ATFhSGrorwAp+oVfUSBSAbgnuav+RKvYD5946bFbrkLcV9dGpVI6rtyl7Hb/wAU6Fq8hcVpaVtOTp+quh1aPq+b5k/36phmuon9k9nMAoCoUk/slIJImFco6BEV+pSdCoo+q/Z0j/bTV/cv/wAHZWr6jrR9nX9c9b9yzstXk5N32fR8X6DchioJXPJ1FvKBEDqgE3FQkAPSBjIkCFgEf1AX0iLSJgjlgWkNrBXHlIsSAGcFlECAgAKSH8iCOZAv5lp+ogAOZsAS4F9IA9ICFliexEWUBLwUzNip3AQWEJJHuAi5RUHdADOClkBlXJ8F9REBafcjbkTLK2AIype5GATsWogkAPcquhAEYkBwA6BFM5A0BHuIAzmx8K+0wo1uFVR3Pus9j4j9pfSnbcK1FjzNHrq+zn8r+uvhSNJEpNUo7HyCLZEFVi1AZryZbDcmagFTOOcSJKGpFEwZZehGm1dn1b7OqS5w1+70j5TQ4g+jeBG8+4590aJhatDRnP3xrWi8zjtA10CsWu1TMo4X2Vci4kTKAhfSMoAKRSBSAj+BYJk0BmDRmAApECQBZJliBPYBcJmgBl4CwMBOXYQfmPE2pU8i8XdT/wBy/wCR05Sz8nbjxm3NG38PeIS4qrp8q/M6lumGzq0fV87y7/uwjUDCHQ9nMQGioiuBSOCksQKfpD9ikp+kCkWR1CyUfV/s5frnrfuWdk3k62/ZytznrfuWdkndnJu+z6Ph/wBZAdg8g8nSZAqJ1ywNRBAPkAHElsSFkBBmWa9QdkAjuJAwgCTyx6hMgBCQkVCoDPujUibDpIGYZbvJbyMgBS0KhCAN9hLYSuMAS5ZAqATYkFixE7gWyAACB8hZABL3HqJctID8zODUXJFwHUruxUQCgSFkBBEi+oXB0+Q47EgLrID4L+ZmJLABwSEWCxcAPyHqCYCOxLl9RJcgOp8j+0jofect7HVX+71bs+uQpyfgfHDa/pPIG6qtOk1Xg3rvMo8fInddjq2l/A0mKfpULJrod74qElMtPuZqX4bEEbSdjibk27HGw1EaQJ1I2RsRtGEbQGkz9DyBxJcK5x4dunHlVcOfc/Nz2C1Hp6tGpTmhyMvhMfa9d6FWtRKtRFSlDJ6DkDi9HGuUeHbtVJ1vTSrS6NWP0KUHBZyvtYX1YykCS9SVexGikVDAsAbuVOxFkAJQpNADIpCm4kDRJJkA6LJbIlIB0yIGMAA13InAaEXSA+Q/aQ4stHgWz4fTV+LWrVTS7L//AE67Wlu59D8d+Of0nzrXo6daq0trT5Eliep86pqk7dc5i+Rvy9WdquELQSr6R0NsGSkTL1HQJ+yJH7QFQbCcgCZKrBkiQPq32cv1z1/3LOyr+qx1q+zn+uet+5Z2Vf1WOTd9n0fF+iQEXJFHlPJ0gq9hCYAKVSJ7jOAs3AWcCwgJAMYCWB5A3ACbwAEvcHTIi4geoBMkbRbBpAIRbGblAADACJYqJJYkDOMM0T5ESwKA10IAZbEgtmAFwKghAHpsErhUuWAPTYCXF4KMgGxI9QlBCwFv7rIAvcqdgZXswNST5E9A3YKsgiKAFQJ/9QiyKWgriyAKwUZRnJpYAiTcnpOc9nTv+VuI7eqlVOrRqhfke8pMaulTq6denUpVShosvLKZTssdJNSh6epXQ1DpqaMtWue+524dVw3mziW2dPlpWq3Sn2PRr3yfQnu+DlOXjLwZqlGqlDOOq4RmpzJxs3VHQwRuM0io0A0yjRlhhVdiK7hiZyF8BH3T7OXMdFOtuuC7muHV+PSl2+D71GZ6HSXgHFdbhHGNtvttV5dTRrVXyup3F5S45tuYOAbfiG1qVXnp/GuzObdjy9ju8Tb2emvaVfURq4coSc7sFcQPgf8AcVQhRFwExkfAVxgCpk9QFgFQwLAIXEWuBLAdiwQTcKTbB6fnDjOnwHl3d73VaTpoaonq4Pc09fM4Syzrz498308S4hTwjZan9Ro/2jpdm+x6a8fVXju2fx42vkHEtzqb3f6+6123Xq1uttnjLJy10puTEQdb5Pek9yyjNgoYaasLhQFfAD5HQRIgoqiARoK2AL1LBCkR9U+zn+uet+5Z2WbOtP2df101e33LOyrh1HLu+z6Pif1nwI7miHk6mbSLCkAIIvqL6SJgVWyIIWkIKRCCc1ewgBYCwhAaJYjUBqwVEryH9RcBZAXGQmJ7AMByPSKQhYOcIC4BIQGh6QqAtLRmOwGoGB6itgZAuTIGsgSKgESTDFywBM/BVYUi4Qz1DQEdwA9QUACdRhgdQKSfYj9hgCzcpG46FpCpAX0knuXoEOhIRUOoFdlYekBOwUJF7uxaR6QOvP2geC/ovH9DiOmoo16Yq+T5PVls7SeMvA3xjk/VqopnV27+8UK8I6s1J3XbJ26svVi+P5WHozRmGbqdoMOWejnjjahkaNP/AFMRBGopnBWrGZD0aMir2CYA0ZHwEaTg+heEHPuryzxina7qup8O3FUVL+63aT52pk0/bJMp32TG3C9jvLt9fT3GjRraFar0tRTTUnaDl9WDrr4O+JVfCatLhPGtR17Otxp6j9B2J0NTT1tGjU0dSmuiteZVJymceeHpr6+rbNkUINQH0Rh6q72IpQuJsBehINGWEGhHuLwPyAQJuBIUUlmCSXAEyhCdpho0qfNabn4bxL582vK2wr09GunV4hWvLRRS58vyamNt9mM85hO14Xi5z5pcu8Kr2ezrVXENZeVR6Pc6x6+rXr6upq6tTq1K35qm+rPM4txLc8V3uru97qVamrqOW28Hr3Y68MPTHyN227b1GjiqpObJxtM284xEENNPqZug9FWJNJpWMek0o6kCbWQyJHpsUGJESGQJKRFQR9V+zov/AHnq/uWdlmr5OtP2c/1z1p/wWdlK8nLu+z6Pif1jUlmCQMnk6mjN0MZDcgG7BYLBKQiFJ1NOYAmEGxT7h/AAQBUAqAyiBVFITCAUiwiR6ghcUioYASKg2i9AqEL7jIBXGBFh8gMk9iprzCQIEELAXrAJFygJZF7lWRUBGxcfJfTYIESbAb7BVgQRe46gWBUJRE+4DoCO+RHYDSZG7guAcEu5OozdFUg4WM4NZDsBJKu46XQ9ICkYJh2LPcDj3OjTuNtq6OpDp1KXS18nULnvgmpwHmbebOpRSq26HGU7/wDk7gp9T5J9oLlh73hWnxja0f123UanlWae/wCR7aMuXjk8vX68e/p13qq7mHVYNGW7nU+Zxlu4bEqQGpGZbMv3NSRhoKsEK0BoyIgJMC4LTS3kqRy0U3KxW6FCPpfhz4m7zl2vT2nEHXuthMQ3ej4PmqNp5sS4yzlTDO4XsdyuBcf4fxvZ063D9zRqTmnzXpPZS8wdNuB8c4hwXdU6/DtxXpNOWk4TPsHKfjXpai09vx3bOiqEvvaf5s5s9FnvH0dXl45e2T7TJpI9XwfmDhfF9KirYbzR1HUp8vmv/A9s0/yPGyx2TKX4ZhlI6oVyO+SKC8k62L7NBGjDsaU9EcW63OhtaHXutajSpiZqcF5b8LbI1K6mdTWo0dJ6mrqU0aazVU4g+e81eLHA+CU6mntq/wBM3CwqMHxHnDxK43zHXXpvVq2+1eNOhxY3jqt+XPs8nHH2j654ieLm14bRq7LgT++3T/C9ZYpPgPE+JbjiW71NzvdWrV1q3LbcwevVd5d28sqqU3OrDCY/D5u3Zlsvu3NvYzMiSx2NPIiERqxXYgGKl1MNOTmfwcdSDUrIDVwG1BhfSbAEgpKfpIEFF5BUfVfs5/rnrfuWdlHk60/Zz/XTV/cs7LN3OTd9n0fD+hUB6rg8nUfIAgFKgrIYuMoIK7HqAC8AFm4bQCr2EDAq9gELBV7kpHqAW6B2FRfkIigv5kjsIC8KRFwF6pBwaBLCAL6TKUXND0gLi4E3AAEaQAEwaAiK7EkdAK73gzHc1SJgDKVw/Y03ISgCJlmGRlgBM4FRlW+BEgaASFPUCWHUQTAFTD9w/pAEmMFAf1ATBVcJhXAks1BCgBgQKgI7YODiG2097stbba9Cr09Sl0tM5sByyz2LO+zp34hcva/LXMWvtNWmNGqrzaT70s/M3O1XjDyZp8ycBq19Chfpu2p81Di79jqzr6Opoa1elq0OnUoqdLT6HZhl6o+Ru13XlxkCJVyQ+ht54oRlqAUAIsgWk1SrlSN0hi1aFe5ypESNJFYqpFVgAiVXYULKDgzXVKgDn2293Gz1FqbXW1NKpdaaoP1fDvFbmfh1NNFO+r1aF01L2Pw1bOJ3yZsl+Xthllj8V9k2Xj1xPSppW72Ohqvq02j3O28fdvUv67hNf/TUfAFSjmo7GP48b+Hr/kbJ8V2CXj1sYlcK1Z/5keDv/Het0P8AQ+GeWr9pnxKlwieaWyzVj+kvlbP2+kcS8ZeZN1TVRoVae3T/ALquj8fxbmXjHFKm9/v9fVno67Hp3ECr6TUxk+Hlltyy+azW23c4alc5nc46k5KkrjX1FpyaMSG3MqzVJwJm1Ve4Yscq9ywca+r2NplRZjoZd0a6DCA4qldmLo5mjjqXcjUrIRSYDRElIh8ALlJ8lA+p/Zz/AF01f3LOyzmTrT9nX9dNX9yzss8nJu+z6Hh/QnuEg2m/ceo8nUELYgFSFQbsZwBqRA9NgApEBQMAPkT+yJACJQXcTYJWAeotRHZCQHpECQBHKwJtgCZYFaCQakNuEBPksIRKkAGwsAjApICDuBSL6iK0mk5cgPUQtQCFQgWJ1CqkZ/MrVh0AkWNUkTmwicAFZMmSpFskBmmbmkrEUkh3Aty/JMIl0AmSwUzDA1gUuTMWKgLCJAZcICCC0kTuBaR6SWDAB2FsjoA6R0Z8D8cuQf0fXq47wvT/AKqu+tRSsPuffEjj3O10d5ttTbbrTpr0dSny1UtZRvXnca8t2qbMeOjjTSZm8XPpHizyFq8s8Sq3O1oqq4frOaaony+x83fc7Jezr5OWNxvKGTUk6lVRSrhI2qQzaiVzmSRFTY2kVilJpNEi5LBlackbEmamAqZx1VCuo422G5Cq5m5UyEbxEbTgz0ImGnNRW2zkVzx04OSluoPOxyNXL0Iu4m5WCJMuDbJYL1w1Iw7ZOdqWcVSI1KwmaTI6YJgPRy0M15pOFM3S5DFjmmwXuZpcmoDCu+DEG+pKgdcVSgy0cteDLVg1KwTCKyZDahXCQSA+p/Z0/XXV/cv+aOy1eTrT9nT9ddX9y/5o7Leo5N32fQ8X6AgfAnueTqBIpGGAFId2LABP7IkSApLFiSuwiwCRnAK7ICCotoMQwNXgCBEABF7BwEgDmRFiEyBYLI9I9IDJFKHUsrqBIlyFYl2VKwDqXBIKACzcekZAO7DdhEACFpDhCQJJJZUWZYCkLAAEvI6lj3IvqCLJJLBHYCmcl6lp9grN0aUwSHJWwJeSgAKST7BBXCKPSRoAX0kgdA2FBNrF+SAWJEXUjATYHi8X4btOMcN1tnvtNVaOqnTfp7o6t+JvIW65U3tWpRRVqcPrf4NRLHsztdZHh8Z4btuLcP1NpvtOnU0alF1j3R6YbLi592mbJ/10iIlLPpXiX4X7zl3Wr3nDKatxw93teqk+b0qJlX7HXLL8Pm5Y3C8olByU0ii9zkSNPO0pNGb9jQYUhmSNoCNmKmWp3OKqqSNSK2cc+wYYbgDRkNp8l9IKrgSk5aHBx4NUvuGK51UmaXc4aIbOR+kR52GR1DhJlKMeqw8hqAkFcNVJxtHkNSZrpsGpXD8FTJEf/wBCl97MjbmpbNJs4U/c1IYsc6uWxhMqWQyyxUa6Ei5SMVKEZfc5KkZgjUrDCK1ceoNPqf2df121f3D/AJo7KuDrX9nSf9tNaMfcP+aOynqOTd9n0fF+hgZL1JUeTqX4MZNGcgaksSSEKgFgArBCJLDJC7iYwADyKgA9IkYETcKCPxXYFQCPcCBMAJaEhO49QEFy+mw+Qh6RSKhNgqdAi0iWBCwGxNgIIDclpADGSP6g/qAvqI7hot4ARYEaCQQumWBIb7AIYklygJEBsXC8HghVbJMsCq1wSS3CJTM3DLSTqBcIEy7FAnyTJQmAEBB/SBZFJFbICnUskmMkyEb6mWkMIL6RwY1dOjW06tPVopr06rOmpSmfH/EPwg0N997vuX0tLcZq0Vamp+x9kIkaxyuNY2a8c5yulfEOFb3he6q23ENCvR1qXDVSPGdMHcPmblDhHMe1enxDb0fe9NWlRUj4Rzn4UcV4K69bh9D3e1XWm7R14bZk+Zu8bPD3nvHzQw3c5NemvRrqo1KKqK04aqUQePVXfJ6OX3aqf4rGGzDqdzLqbDUjTZDDbCI3I0AEGmWjROpbBOs/BqCoMJ1CpBqxEFapszkTucSZumoRjjmSkNJETNRJWaw/YKTTRx1OPcJ1yJHPttnrbvWo0dtQ9TVrslSj3vKHJHGOZNzStpt6qNCV5tWqySOxXIXh5wrlfRprenTuN61+LUrUw/YxnsmL31ePnsv/AB895G8HaKdhXv8AmOlqryOqjQmOnU+H8R0Vp8S3NFCiinUqpXxJ3a41rLS4NvdSqyp0a3/odKd/febipddRv/UxryuXXv5Gua+SPDho0mZY9R6udypm6ajhTZqmoJY5k5EWMJ2N04Kypir2NQSEiDDUmYuclRlpBY+rfZxpnm7c1dFo/wDlHZBnXn7NmnPMG/1IstODsM8nJu+z6fif1iDkNPoKjydRcXEsSwED0hsU/AQkRcU/AywED1XEAB8BZEMOwUDxkTYOYADISsLg6NkLMEmWEVqwcAgDDL8D1BsKkzYvpFvKRASWapEojnoBH7FLSSbg6ssNiklOGBfURodSYArKKX3EgLsXQgVBD3AIwq3ApIBZRPcOCyBEVWGYgYAzLNNsSRMIFIxf8govcuQRfSAHQl0W7YCBctRFcFVruZmMGiSkEF7h2DYCjH/1DL8ARI0rEmxYAqjqPS04jqmDNQH43m/w54FzCq9XV2/3G6af9Zp2l+58R5s8IeN8Lr1NXYUfpe36eV3g7PtEvLixvHbli8M/Hwz93RnebbdbLUdG72+ppVq0V0tHHS2+h3Q4zyxwnjWlVRxDZaWpKjzJQz51x3wM4dufPXwncPb1u6pqwe+O6X5cmfh5T4ddrkmD6Txvwe5k4d5npadO4oX9y7PxfEeXuKcObW72WtQ1+wz1mUvw57hlj8x6lFzgVqqlxVS6flQROOqKNR0NpBY9zaSjIYtZg1TQaStYtSsgz1xOkkM5YfQzbzXCyuFyJhHMttrarjS0tStv+7S2e54XyVx/itVK2vD9byvrXT5SdkbmNvw9JRXDXY5tNuqr8Kb7H1PgHgdxTX8lfFNxRoUzemm7PqvLPhjy/wAGVFdW3/SddeqtzcxduMemPi55uvvLnJXG+P6lK2ezrWm3/aVKF/qfY+UfBrh+w+73HGqv0rXV1p+lf/yfV9GjT0NJae306NKhYVKguTxy3W/Ds1eJhh733eNs9pobTRp0trpUaWlSoVNCiDmmHZmmiHi65OPQeIG9Wy5M4pqtx/UulfmdQdVqpt93J2Q8e+JfofJj26f49xUlB1rqcux16J/q+X5t7nxx1qMHCzyHSupw1U3se1c0rMlTI0LkejkpqRtM4F9Jy0uCvOxyTYlzKdzTvgjK36mepqHFyOI9wr7d9mnRf3/E9b4R92mx8d+zbt/LwHfa/wDe1IwfYX0OPbf9q+v40/8AHFlhyJsJZ5vc9Joz8oAJBYIEBcnUoCbh3FQmApDYshV0DQASPSAAp9w7YEyEBbyiA4ClxUIACRUCAGpK5BFIESuakVCkFRZuWRUIQEm5H2L1K2Bm/UpcmWrgacMnlKl3J8ASYL1L8kQFqIhAAdCSUvpAiuy4+A4IlIE7FY6iQCcCSZKARJYmxUAkJllCQJNxdYRXYLADOSFyGwRIhl9Q/MAKiFpIwIlc16iIqxcCyUR16GWBow2CVZAX8pQTICOxoUhMDSrawzx9zoaG4pa1tDT1F+1Smc1TUe5JhF6cfnOIcmcB38/f8M0E31pSR6DeeEHLG5crbV6X/LUfQclZZnlPisXVhfmPlOt4HcBq/stxr0fnJ41fgTwz0cQ1l+R9fYS6l/lz/bz/AMfXfw+OLwJ4f/xHV9rHLpeBfC1Hn3+s/g+vBfSP5c/2f42v9PmW28FeXtJp6mpuNTunVk93svC/lbbY2C1Gv77k/ZqxOo/kyv5amnXPiPXbLl7hGyoVO24ft6EsfhPYKiihfgopp/5UbySDNtr0mMnxE+REYDRH7EVpFp+oyjYEdzMTC7m4sePv91p7LY6261WqaNKh1S/YvOpbx17+0Rxj9J5i2vDtKqaNCl1VL3Pky6tntebOJV8X5k32+rbar1HHxNj1fszuwnJI+Ltz9Wdo7kdKNJWI1ODTDhqVzjaPIamTjdNyNSsXRJNMk3DTdNRulycScG0wxY237EqcUSVO1yVJ1OmlZqcFSR2f8B9o9tyLpVVUul6tfmPo0yz0HIWyWw5S4doU9NNN/wAD3/qODP3yfb1TmEgJ/ZEXDszLYpBlezKBcjCA+QE2JM1FCyBCvJMsAJLL8wpaE3ABYNGZAekJGjKyBnJp2CsTLkB5vawm5JReoF6SSfYNtWKBJasX0hdwA/IhcCwCQLEAL6SpXIWn3AjtgdS/mS4BzORD7lqMxPUCkavYQjWAJ1LBAwJgsEjuayAqI2+gKBIcFpJlofACSxJnBQDsAvpEASJKkABWiF9Rl1AMGjMs0CIWBSZugKir3QCUgFIbVNFVTaSpUuTSU4Pwvi/zMuAcu16OjWlu9yvLTGUaxx7eMZ5zDG5V6PiXjBt9hzTq7N6H3mw02qHqU9H1Po/COMbHjOxo3PDtenV06lhO6OnGpqVVVVVajmpuW31Z7Ll/mjiPLm9p1+H6tSXWhv8ACzoy0yz2fN1ebZl/t8O4FoyU+ccieKfC+P06e33rp2u+iGqsM+jUNVLzJp0vDV0c1xs+X0sM8c57NJBQXoII2klgkCoCNQySh8mlA6IIL6gBOoLBAKrWBB0AuZBEigPzLBJACZYdmPSAI3LLJGyPvIG8nyrx75qp4dwenhG21Etxufrh4R++5m45tuX+D62+3lapVCfkT9T7HUXmnmDX5g4zuN/uam3XU/Kn0R7acO3tcvlbPTjyfL1rd3NyObGKXKuKbZOt8rjkT6QMGVextLuES1zNUHLCRIXUHePHqSJEI56lY42iNSuODS/0I1DHUNt0/Se65W2D4lzHw7a0qfvNZL8j0qPpngPweriXOenrtfg2tP3k++CZXk6a56spHZjQ0VobbR0qUkqKUoRpu5upy2zBwvtyc9iB6hE5YSXQgfA6wGgBmYNRJExIFjsTqCgIIl3FygSxUiWgSBRkEaArkKxMK5QIWLCkjAJF+CAAJLYjh9AL6RZD1EgCq4IwBYJ1BJ7AaDwTDLUBLQGyZLZIC2MzIszUAKfcEgqQBtBQhBALEsNInQJSETBbllIichQdQxAFaROguAJkrY9iYAQzU2sZlmkgiQUVESAsks0JDQWBRSIAK/sE+wbtYJ3XYdE3G509pttXca7VOnp0uqqpnVvxE5ir5h5h19w2/uKKnTp0zZLufU/G/mxbLhv9DbWtffa99Rp4XY+B11fhsdenDk7XyfO3dvojx9b6jxtVnNrO54mpVLPauPGON1taiqpbVSxUnDR9I5E8WOK8vujb72p7zZ4ip3R82ZJjBmyX5dGGVx+HcflTnfg3MWjS9puKNPVavpV1Qz9K6Gjo3td5r7TUWrttbU0tVOU6XB9K5T8Z+L8Ipp0eJpbzbq01fUjwy0/p3a/K/GTsxU3JPk/FcreJfAOYKaFp7unba79Go4P2enXTqUeeitV0u6acpnhlLPl1Y545fFXJQi0mWjALBSjN2Rx1LgNSAeLGU2IRV9IC5cElyJAsizMzBU32A1Ypn1FSmUsA6Ok9dxziu04LsNTd7/Vp09OhTDd38Hpuc+e+EcsbWt6+vRq7pL8OjS5bfudaueedeI81byqvc6lVG3T/AAaSdkj1w13L5c27yJhOT5eR4n8+bnmziTo026NjpVRRRP1e5+JmHBlq8XEHVJyPn5ZXK9rkTwaTOMqZWOOamxtVnAm0cilwVmxyq5YRiluTaYYpaIMVJHKTyzcGLx6lBk5ql7GKkG5WE4lt+x2S+zvwb9D5c3HENSlqvc1RS32R114fs69/xLbbXRpb1NatUpL5O53LPDaOE8A2Wy01C09NJ/PU8N2XJx2eLh3L1fp7RkuHP5BXOV9JIsZwav0GGEKSTOR1LgKli4sRRkuWAkE6lkBJJuUeoIzk00A2AJf8wiTIVqJFXQhcsBHuA5EWAZ6CIEszdgayML3HpJ8AF9JfSRN9Su4C2TMyVQhaQElUCQBGF8gmAi+qCRBUuoYUgR7gQAUyGWDM2Atw5EkmQjQfyKiBUhGnCJYQBIgpJnoV/SBRUGrECEEnuamMkVwK3YnQtIyAWCF+RACBSSCTYKpaglYU+4E9NzwOOcU0eEcK199uGqaNGlv5Z7GFMLJ8N8eOaPvdejgu11PwUX1vL1ZvXh6snhv2fx4WvmPMXGdbjXGNxv8AWrdT1Kn5U+iPV11pLLJU4wePqVnfJycfDvcr2pq1XZ4lceY5K65ZwvJHrjiTIv3EoTYj1Gcb9zVQ9RBnTmmvzUt01LDTP1/LXP8Ax/gjpW33teppL0ajlQflEclNMjnfln12fD75y1446OoqaONbR0PrXRg+j8H585b4oqVtuIadNT9Nbg6hUWscujW6Kppbpfsed0417Y+Xnj8+7u1o62hrUqrR1qNSl/3XJt0HTfacycV2NS/Rd/r0R081j9FsPFjmfZpL9KWql0rUmLov4dGPm4/mO0xmDrttfHHjOkktxtdHU/KD2ej4869vvuGUfkYunJ6TzNdfdoEHxWjx50mvxcN/gclXjtt/L+Hh1zP8WS/5OH7fZoJJ8Q1vHmv/AHPDKI9z0+/8duLan/4fZaOn+Uj+LJL5Wufl2HaPH193ttvQ69fX09Omm7mqDq1xLxb5o3jqVO6WjS+lFMQfld/zBxXiFVT3e/165ynUzc0X81i+ZPxHaDj/AIncvcIVSe7p3GovTpuT5XzZ4y8T4lp16HCqf0PQqt519TR8hmXLlt9WclNSiJPXHVI5s/Izy+Hk73dau73FWtudavW1anLqqcyeM7iUGerxYZhm2RqwGcEWTUIlgqplWTPpKmGbHNSzdLb6nDSzdLDNjnV7GsWOGluTkpclYsa8snHXQ+hz5Ry7bbV7rX09DQpdWpXUqVSurYJfd+/8AuXP6S5kr4jr6c6G0+ltZqZ2Unofl/DjlujlzljbbaEtetKvUfWWfqbSzh2ZerJ9rx9fow//AETH5jOAYe42B8mchGpIUkhV9JELFsEJCyHfBmGBoXYJNrAWBUZyUCzCIoLA9IVnImCooD0iPw5BnIRqY6Ehtl9ITAhZhBsjgCZKUKArOTVIkAAnfAWbjLsBEHcP6bBSA+GLLIVmIlyA6kfsVjoA9yL/AFLeAse4RcGYgqJL6gUCS2Cs2RfMILYCSFctXsPSESL5JgqUlVsgR3LZCexLgWnqRD4EhTqWr2MzY1SBmO5qoWFQCksGfgJw7sI9RzlxzS5f5d3W+1XSq6U6dNd20dT+Kb3U4hv9bd7ipuvVqdV30PoXjfzT/SvGaOGbWudrt1+KHmo+X11TZnbpw9M6+R5e255emfEcerVbJ42pX2OXUryeHU23c9K8McVdX8SdTLNEenpIMlyICqKV7ESN00hCmk5KVCwKUclK7ledpQ8mkyQUINmZuJI6klgBU11I2oMtpmavpCyORNDzKTjT7hsi8brqtYw3JJc5JICo42ok2RtTgNRnBU75I1IaDTk7GjjT/gWZYQYL/MgEZIsVjqFZkBo0ACqZn1GwOSio5qGeKng5aX1DzseZQkz614F8of0hxR8X3mlO227ihVL6n3PnPJvBNzzHxzR2G1pbpbTrqXpR224BwnR4Lwfb7Ha0JUaVKpb7+55bc/TOPfxdHry7fiPOZOpXAOR9dFYKPzKQC1CkjsWkAskbLSHAKnyLFiTMII1KFmRXDQFAwZmwGvgj+oDo5ClwE7EyBqoEnoXAD0j0mclkIsEbRZsEurCpYQVf6E6gAkWzyZfsBpWE9hDIAguGAESlzAbFK7jqFI6hkyMAayIIi1AQMdSSwKnAkT1EgTJfL7kwLgWQoAQFpjoRgkICsL3JM9DTSAgkNEwBUgrC5M5ApJg18ESlgVKR6gAEe5+U8TOZNLlvlfca7q/9Rq0ujSXuz9W/g6+/aO1eIPjG1o1NOtbGiiaakppb9zevHuTx353HC2Pk+rua9zr6mtq1N16lXmbOOvV/CzgWrK9zDrk7nxue7VVS6HG7h2cgjc9gyH9IbDa9CozJulBmqlexyU0immDkpReMWiRoi9iqVkImCSgzj1Ggi1VIw2ZZmQ1I0xNrkDI1xZEmZsZQON+bsSP2ikyFJKSEEwqkJVkjYFm5pNEIkBomCgIjuZkMuAqI0SCXA1CkKCgCRCOfZ7fX3u609rtqaq9XUappSWTj0NGvX1KNLSpdepW4SSydjfB3w4o4PtaOK8W01VvtRTp0/wBxGcs5jOrr13ZeR77wp5J0+VOC0V61Ke/1qU9Str6Z6H7yTPya9JxXK5Xr6+GEwkxgKgRyRpMlZJsVe4ETUB+wyamAMwy9S5HpAzElRJk0ERFbIF7hRLqGkJuPL1AYZVchQFhV7EgjVwKWoEQOJNi2gsmcgUBvsTIGkoRJDK4AkFwZyXCAuQsEkf8A1Ast5Ee4t0AE6Cldy2I05AJ3Ddy0j4AVELJADuPkilFYElDJYUByASL6jMM0BJC+kL3K8QBCwSHJLzAGpSMxJWrEl9AK0EgiP2As3DKu5OoFp9wHBALFh6SOYGUBXg9fxjhez4ts69tv9CnW06rOVg89JwPYsvCyX2rrp4h+D+54d97vuX6atba5q0pmqn4PkuroamlqPT1qK9Oulw1UoZ3mWIaTtg/E88eGvCeZtKvUooW13jX9pRTk98Nv7cO3xfzi6lVZIz9lzl4fcZ5a1anr6FWrtphalFLdvc/FuqHDlVdoPeWX4cdxuPtWvSVIlPuaSuASRyUoU0ycqRY87SlG4chIqKymCO5W5MuwEqdoOJ/VIq+pGWw1EeQy1GYI2P2JhXK7EzkKiL0JJcAIsWkl3gsQAhiLmlLZoM9Y6kiTcEgHXG5Qk3ZWMNdgSrZFsyR3GQ00SAkIApmIK/YNxTcCTc8jZ7fV3m4o0NtpV6mrU0lTSpk8vgHAeIcwb/T2vDdCvUqqcOpKy95Oy3ht4abHlbSo3W6VO44i0pqalU/BjPOYt69OWyvVeEnhjpcI0tPivGdOmvd1KaNN4oPrD9sdityzLlnJllcr2vp69c1zkRiC3Jcy9FViNi4XwALYl5LAGV7GifAXuBZawPkiFSfewFwSLlq9yYQAkOLinJbgB1CTeSgQMsEYFckUvJcC4Coki6yJABuxckX1AVMTIsFAAem5IL8gZfYYwX4LFgIWoiY+QCzYdSWRbgVoCekEiGETGTXwSS+mwUeSdCXZWAkC1gwLKBlR2NJ+wEbJfqaiRUEBXkekyu4Fukg/qEhuQoyTYZKgFwE+gkCvsMQRXZQhAJdu5YvkKTkznBoRAD1XCyJFXsAUSWn6ieWMh5A49xp0bjSq0tainU06sqpTJ8x5z8HeEcZ8+tw1/oe6d7fTPwfUIYd3g1MrPhjLXjn8uoPM3h5x3l/Vq+/2tWtoJ/2mmm0fmqaGq3TWnTUspneKvSo1aHRq0quh5VSlH43mbwx5e42qqqdvTtddp/j01Fz2x3ftx7PDv/pXVRLqkbSPqXMfgxxbYKrV4ZXRu9GbUr6kfPOJcK3vDNT7vfbXV0av2qT3xzl+HDnqzw+Y8F2MtippSmzDZphUzjqYb7GcBRsx8m2ZebEaiMD2I0Gmbl6GjDfsFa+ACgRexqmepEaiwEwjSRFLdzU9IDI0GjUWCuGWHTJxwc8EdNgdeOxXg5KqTjqtmyI2Kr3NU3ZNOmrU1FTp0uup9Ers/e8oeF/HeYHTXXova7Zu9eomv4Etk+VmNy9o/E6ejXq1qjTpddTwqVLZ9I5D8I+Jcdqo3HElVtdnZvzWqaPsnJnhhwXlyijUr0Vud4s6leJ9j9zhJJQksI8c936derxPzm9Hyzyzw3lzZrb8M0KaWs6jS8z/ADPdJdW7liUIOe5W/LuxkxnICQG7BTuKSL6QgJPcs/wLFhhQBJJD6miS4CLEEHUruBmOxZEEv1Cxp5DgiuWIAkpMFAEuS7NSFMARfSJJg0BLhYkoqAmUSJNYEAIDj8yIRDAJCwsOoC4XuGyTIRqBUSCzAVIEkmSgOoldQrsJQBYXlyMshUwEmZRV9QsAkfIkALCSpQMgSC2FJlq4RbkjsaeLBYASSegpkICQjUIiUsZYVZFMvAsjL9gNNwMkS7llBAJdzOShRvsICK32AzDLBbsR3AYCQSuAFREWkZYRLjNRcYHpClQp+BSFKAsxTg8HiXC9hxPRenvtnpa1L/vU3PNyzPcvbPhLJfl8z5j8HuBcRdWpsVVtNR9FdHznjngtx3aOurYVae5oWFTVDOyaKrYNzblHPn42GX/HTPiXK/GeGtrecO3FEdfJKPTuiqlxVTVS+so7wa2jp61Dp1tOjUpfSpSel33JvL++pqW44ZoN1ZdNMM9Jv/ceGXhfqunDUzDMXWTs9v8AwY5b3Pmeh99oVPs8H5fiHgGnL2XFPhVI9JtxeV8XZHwiJYPqvEPA/j+3qja62lrr+B6HeeFPNe3qf/ofvEv7rRqZ41i685+H4ck2P0evyHzLoz5+Fbi3ZSeLVyrxvTT83C90v+gvqiemz8PThdz2VXAeK0fVw/cr/oZxvhHEF/8Aktwv/wBtjsSyvB7HJJ5lPCOINwtluH/0M5tPgPFdR/g4fuW/+Rjqcr1lOTR7vR5P4/r0zo8L3D/I8/b+HHNevDp4VqpftNIeqE15X4j8snJqD6DsPB7mXctfeU6Wj/zXP02w8Cd3U6XvOI0Knr5KTN2Yz8tTRsv4fGoTRqjRrrap09Ouup9EjsfwnwW4FtVTVu9XW3FSyphM/Y8I5N4Dwtf+m4dpeb+9WpZi7pPh6Y+Hnfl1a4TyRx3itVL2nD9Z01OPM6YR9B5f8Cd5rOnU4xuqdKjLooydg9NU6VPk0qaaKe1KgVO1zzy3W/Dpw8THH5935Dlvw85f4DFW12dOprL16i8x+spSpp8qpVNKsklBr0ibnjcrfl044Y4/EE/4FknqDsI0XQSCZPgA0T8jXpuAqdSk6kiwF6lt1GCO4RZ7CxmyHUBMmlYYIBfglwFPUKESvcoTCLFgl3JIuBR6SAC1ewvJBNsBRu4ZfVcjYF9QbEolXsBfSPUPSICFRGAAbLhC35gCTaYDDAUhKkEyawgDQwZmS/IFt1JaSXQnuBppGYRrJOoCBBMGpAkixZsRXYCCk6lBwpI/qElbQEkQWCTcAVIkF+AMxJqDMx0F2EaFgTqFBMotidAKSB6bC/YC1R0JcQLpAJHyJaKAgEZYAhZsCJAUiK2QBFy1EuWAIlBIk0LhDGR/Ik3uUKZwRwWTM9wKn2CnuVwzMdgDc1Q0mR0UPOnS/wAjbxcgT0uJ7fRf1aOn/wBpP0PbRfb6X/ac9xSXpyOFbXbLG301/wBKNU6GgsaOmv8ApORsem4ORPLSlamlfCIm8GqfgkpEVLzkXfuVMnUB0tY1hGYkvSEBbeUZFIwEIHpMxNVyscBfSB8jLC8Am+xMFTAdQ7FmwkCZRcIEAfIgtRmWEWE7iRBbIKgtALAERFPYq+osgRIqpSyKTOQjVkT4LgekKYdxYiuygSxZISzAtuwkOw6gLEfsaqJAFcWHyRss2CMwi2WS0kiWFRrqawiOxItICnJc9B0KBIBZIvcC0mclkqsBmblYVxFwCgswRoAWZCiA2RIB1KKSAF9RSNEiwFSsGgvpCswK8Cl9yTcNyBM4K7MpFcCkDHQBeBBJfm9ipAILYiuSO4FX1Flkwip+wDJnBr4FM9Qh+QBICqkDMQawBIvkpILjIE6lyZyaiADViT0CJZAH2NTBFDZcyERuWASZCtRYgfZBsCNXLIjqWwESLYSsEgCzBnJqojsgEXK5JDgsNAS5FTfoau1cjQCrsSPcqVhhgAvqJkqaWQLUBKIrgVu5II1cvUA3eA12JksOQCxcBhKQGEX0kf0gC0mcmiSBahNiSX1ARe5Wu5OpagJ1sIlkwa65AR7iDOREAWxTMSVp9QgC4ImFSYKiZD7AVsNQIUCJYESlGlZXLEIgEf1AsEYDoWCQR9gLISJCNekCe4ywFCAYsPkihsvQCzYiZTMyBZLkjAE/IsFqJcBcP4KRgJDLUAFJA7FygM5LcuCeYAW4VzQGPlF/IWI3cC+kjLMIiAJuRP8AEk9GVJAE0Gw2uxV3gCIl7GqhhAEu4sZuzSVgI3aw81sDy9y+oCeYjbixqEKQJPUiqk1ZiEAm4yrjyBqAIyhYJVLQFmxFcT0KkApjoQmMGqX3AfIhGZk1IARITLIEakQFBnIGrD4HpEgMIZFIAgX1C3YIAkwlZk8zmINPIEb7FxkQIkB+RFBWoI7AWyMz2Kl3LMYQEcgAAS7KyTGANPIqAcWAhQ0KQH5EgQLgG10BbRJLgUilln9kT2AjRfkklbAZwSIuyxYgFntYlwy0vugMzPQq+oWgQ2AumFZ5CnqIUgG5KjMItUzYCuUFgUjIGZkpYjAygASgnqgXAszYjAm4FsRwX0kgC4wRfSIl2DADoR+xZ6QAuLiWhLbAdCthQJAiLcTe4kBHce5l3+TSsgFJMssfhyMAZwXoHdYJCAS+hbyVQhPYAoAgKwCr3HpGWRgWyRnJbCQKoHwFcAAG7CbBCl9hLY+AgHpFIkUhUSNmQkACQbSCgHWcFy7hMTewFmFBPxRYMqdgcMZMxIhlbfYBiwgBgH9QU9STBqZsDpBIJDF0DqpdyzCIRR2AoDZYsBILEGclSkB8CWizApcgJIWEJAUh4ExkZYGUoZrIcsAMmcGmoJIFV8hozNioCR3NSZWYNRb3B0mSQGx5rA6RctQkmWAgtRLllgIEkLCAkkwalCQdJRIuVokA6rYmwqFgI2UQkAEIzNh+ZrACkRceoVewOisTLL+YwER/UX+ZESbyFa9QdiNyIAl89Sr3LNzLcoDSZEvcsGcA6ZNEpYAuCZYLgA7KxExKZQJNyVvy0tlODWrlwWJXkDCuKhBFPMpYyh6QAdjMLuahsiQFiw+QJ7gXIssiewgIpmYECkAsiZYcIBRqEKRMsNhCBKgsWJ5AorBfIcAICRSLSA+Ak5uTqW/UKSiWBWoAhWuwgAIGBcZQQ9JJKJSyFFgWQ6/smYYGsj0jBLyBIg1IqEJBE+Spr8wEgE3EszKLIFnsR9AX2QUsToIL6QJhF6SMoXAisrlq9iXwAgpKJEXAO4uR2LLCkMnUXE9AL6QBgBjITAqCHpHpAAUvug1IbMruFalJCSACyEyNlkB6rDDEBXYQsAAJDZbi8jDAkl+BCEBYzF5NOqBcU+4C2QIFpCNGV3JIcgHfBbBSTqBRhCCSFSZLdsL6itgJIX1B4CJeS0iYJIFAqHpCjYJHuWAIkkLBIlkBK6vLSeI7uTl1avNVBg3GK8xPqxUcmvpvTqthnHMWMNkpCkK7DfYA25FXsExLAB3Q9Ip9wgHfAjuLIKB4F59g2BF+ZYkSRKAK2lYKHkJSw4QQq9hDFMibAVK92IRHgQoAsE8qHwPzCjgUiEADgQILL6gSkSG7ltCkIki4qACkRLFhcKVdBSZjuauBCyw32FPuBILHcfAjuEGzN2asJAQLGcmoAiDhB2KFQSWRYAkokQAEKR6gJAZuZauVSiyA+SWdRfkfAUki+oJJBwwKIkWM5CNNdhEZCkkNu4BFuw30SEhSwlkhMs/sgA4EdyOLAVQLMWJAFwPSZlmlkIQMBsjswLdj5DYgKD0ioBAQ3cCQEMJSwmwA8hYuZwyphVeCUhISAwLFiSQAdw0KiBFJAEAUSRBgTIfsawiIKicIqCuGAsrHFq1woRrUapTPGbllkSiLSA5k9Ue+1NNV0wz1cptwe2eD0HndOrV2kxlDF5QThmaKvNTKNKDDSzLNGao6CLgA8Cr2F4ATawyIlDyvy5AKxJuGrZK1KsAqjqFDUkickiANekYVyJQGpAssWFKjqSGwLcTOREdQAnsH3JH8QARW1GBD8oVIETK6g12DQCRkYHpARBmZKp7kfsBqBMMl3VkAPMWSQRfwA1SHgRPUYAOwyKgBISZZSQ92SJwAfQks11gzKAquVokBJgUWAVNgJC6DHUQEmBMlcCLZHl7sCt+xJJ5Z6l8sASZFkUJPqBUpFkQJICqA2oDgjiAF+xaRSSHIFFRm6NfIBIjtcl0aTUXuAyhEK5JvYMC5HpAiwANiIyTqBZsQJPuVICQGxF8l8gCRMhIWAYEiJvIaAzLNNtMRYylcDSZG0IuWIAiLYjUhKwEnsaqJhl6SBnBqozk1HcCJ3F5sI6EiLyBokBhKeoCLldkSAATLRS664QSbcUnnaGl93TLyyydSvTaza1aqX0cGTW4f/qNT5ZiT0kGqRJJBR7v9K0PK/wCspPVVbbWqqbWnVDujx4P0en9FPwPSPS6ehr0O+nVBzVUulrzKD2xw6ulTWrq5mxOvXSWk3q0PTcNWOP4MNEXDkQSyILfuLwTJqwBYEktFi0/ACRefYT+yRMCyV2Mz7B3AshtxYhejAK+RgzPYrAoEin3AVC8WEOZEsArCxGTAFcjHyJEdQHyWn2M5EwBpOBSQuQHqCRmGavAD1YEO5LlpfcCvBkesoCH1JiyHUYcgX5FiFwAGST3QQFsPjBPkuEAv1wJCdiSmBR5iQmLAWbCMGZ7C8oDUmcliMldsAMIWfUj6FAQiWAgC1exLhMsyAv1IUAS8la7BsLACEgMkl/kBSO5bYEAIJ1K3dQSQEuSkEgX1CRSTqBZgWEkkCz2FRGwrgWX2EkkWAonuQMCth4JlBt4AqVh3CwKQBFMgs2Ag6hFlSBCQzRPNcBeBUl1cCtqlSzxtXU8+MFk6WvY7erQovVqUycz3Wj/iU/xPRQISuzcnEeVq7bVr1a6qNNtNymjP6Jr/AOFUe629tGj4RvqbHov0Xcf4dQ/RNf8Awqj35APzeD9Hp/RT8H5xn6PT+in4INCACji1aKa1+I8LV0HQ56HsWjNSmmDFideq6ljueXrbeZdOTxaqXS/xK5iziypSICQkikQFMiLhgGxMCYACxAxNwKKiJN5KBFZFljBOoFFXSBUEwCsPkVCoB+ZPkOyAAexYJ1AqsiZZY9zNugFJg1YdMhC5E3Im9irICYJIHyFTJRAx1AmDWVci+kAX4EQG7EAriRMXCsgAzkOA2I7gROwSQSRQFJmEasQBCkmDUSQImTVQGAEmcjODUBUdgpBQJYOxVAakA8EkFAD0iIERYIeoSkHgkBQqwSCgSbYCc5RZCuwBPcsXIAF5HpZVdBBMjECegVSNlJSgJHcsFqFwIX0kkK6Ak2KvqL6QEGvcEgQUCwR/UGiKpm3U16TLa6gawZqrVK9zjr1osnJwt+Y1J1LWqqnWYgoPQZgyzkqM1WA/QaNtGj4RynFo/wBjp/COUoCAAP/Z">
    <title>Gifts World Pro</title>
    <style>
        :root { 
            --bg: #070d14; --card: #111b21; --accent: #2481cc; --text: #ffffff; 
            --secondary: #7f91a4; --err: #e74c3c; --green: #2ecc71; --orange: #f39c12;
            --glass: rgba(23, 33, 43, 0.95); --tg: #229ED9;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 0; overflow-x: hidden; }

        .btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 18px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; font-size: 14px; display: inline-block; text-decoration: none; text-align: center; position: relative; overflow: hidden; }
        .btn:hover:not(:disabled) { box-shadow: 0 5px 22px rgba(36,129,204,0.45); transform: translateY(-1px); }
        .btn:active:not(:disabled) { transform: scale(0.93) !important; opacity: 0.82; }
        input, textarea, select { width: 100%; padding: 14px; margin: 10px 0; border-radius: 15px; border: 2px solid #2b3a4a; background: #0e1621; color: white; outline: none; font-size: 16px; }

        .page { display: none; padding: 15px; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding-bottom: 120px; }
        .page.active { display: grid; animation: fadeInUp 0.3s ease both; }
        #friends, #admin { display: none; flex-direction: column; width: 100%; max-width: 600px; margin: 0 auto; }
        #friends.active, #admin.active { display: flex; animation: fadeInUp 0.3s ease both; }

        .card { background: var(--card); border-radius: 25px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.05); position: relative; transition: transform 0.22s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.22s ease; animation: fadeInScale 0.35s ease both; }
        .card:hover { transform: translateY(-5px) scale(1.025); box-shadow: 0 14px 44px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.09); }
        .card .item-emoji { display: inline-block; transition: transform 0.2s cubic-bezier(0.34,1.56,0.64,1); }
        .card:hover .item-emoji { animation: wiggle 0.55s ease; }

        .nav { display: flex; background: var(--glass); backdrop-filter: blur(20px); position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; border-radius: 30px; padding: 10px; z-index: 1000; border: 1px solid rgba(255,255,255,0.1); animation: slideInNav 0.55s cubic-bezier(0.34,1.56,0.64,1) 0.1s both; }
        .nav-btn { flex: 1; background: none; border: none; color: var(--secondary); cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 11px; position: relative; transition: color 0.2s, transform 0.2s cubic-bezier(0.34,1.56,0.64,1); }
        .nav-btn:active { transform: scale(0.82); }
        .nav-btn.active { color: var(--accent); }
        .nav-btn.active i { animation: bounceIn 0.38s cubic-bezier(0.34,1.56,0.64,1); }
        .nav-btn i { font-size: 22px; margin-bottom: 4px; font-style: normal; }

        .badge { position: absolute; top: -2px; right: 15px; background: var(--err); color: white; font-size: 10px; min-width: 18px; height: 18px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; border: 2px solid var(--bg); }
        .badge-merge { position: absolute; top: -2px; left: 15px; background: #7c3aed; color: white; font-size: 10px; min-width: 18px; height: 18px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; border: 2px solid var(--bg); }
        .collapsible-header { display:flex; align-items:center; justify-content:space-between; cursor:pointer; padding:10px 0 6px; user-select:none; }
        .collapsible-header:hover { opacity:0.8; }
        .collapsible-arrow { transition:transform 0.25s; font-size:14px; color:var(--secondary); }
        .collapsible-body { overflow:hidden; max-height:0; transition:max-height 0.35s ease; }
        .collapsible-body.open { max-height:3000px; }
        .avatar { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent); object-fit: cover; background: #0e1621; margin-bottom: 15px; transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1), border-color 0.3s; }
        .avatar:hover { transform: scale(1.08) rotate(4deg); border-color: gold; }

        #toast-container .toast-item {
            background: var(--glass);
            backdrop-filter: blur(20px);
            color: white;
            padding: 13px 20px;
            border-radius: 18px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.08);
            transform: translateY(20px) scale(0.9);
            opacity: 0;
            transition: all 0.38s cubic-bezier(0.34,1.56,0.64,1);
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: all;
            border-left: 3px solid var(--accent);
            max-width: 100%;
            word-break: break-word;
        }
        #toast-container .toast-item.show {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        #toast-container .toast-item.hide {
            transform: translateY(-10px) scale(0.9);
            opacity: 0;
        }
        #modal-content { animation: popIn 0.32s cubic-bezier(0.34,1.56,0.64,1) both; }

        .pinned-section { width: 100%; background: rgba(255,255,255,0.03); border-radius: 25px; padding: 15px; margin: 10px 0; display: flex; overflow-x: auto; gap: 15px; min-height: 80px; align-items: center; }
        .pinned-section > div { transition: transform 0.2s cubic-bezier(0.34,1.56,0.64,1); }
        .pinned-section > div:hover { transform: translateY(-6px) scale(1.12); }
        .price-up {
            display: inline-flex; align-items: center; gap: 3px;
            color: #00e676; font-size: 11px; font-weight: 900;
            background: rgba(0,230,118,0.13); border-radius: 6px;
            padding: 2px 6px; line-height: 1.4;
            text-shadow: 0 0 8px rgba(0,230,118,0.5);
        }
        .price-down {
            display: inline-flex; align-items: center; gap: 3px;
            color: #ff4d4d; font-size: 11px; font-weight: 900;
            background: rgba(255,77,77,0.13); border-radius: 6px;
            padding: 2px 6px; line-height: 1.4;
            text-shadow: 0 0 8px rgba(255,77,77,0.5);
        }
        .tg-btn { background: var(--tg); margin-bottom: 8px; }
        /* === ADMIN PANEL === */
        .adm-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; }
        .adm-header-title { font-size:20px; font-weight:900; letter-spacing:-0.5px; }
        .adm-header-sub { font-size:11px; color:var(--secondary); margin-top:2px; }

        .adm-tabs { display: flex; gap: 6px; margin-bottom: 18px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .adm-tabs::-webkit-scrollbar { display: none; }
        .adm-tab { flex-shrink: 0; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); color: var(--secondary); border-radius: 22px; padding: 7px 14px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; display:flex;align-items:center;gap:4px; }
        .adm-tab:hover { background: rgba(255,255,255,0.08); color: white; }
        .adm-tab.active { background: var(--accent); color: white; border-color: transparent; box-shadow: 0 4px 14px rgba(36,129,204,0.35); }
        .adm-section { display: none; }
        .adm-section.active { display: block; animation: fadeInUp 0.25s ease both; }

        /* Stats grid */
        .adm-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
        .adm-stat { position:relative; overflow:hidden; border-radius: 20px; padding: 16px 14px; text-align: center; border: 1px solid rgba(255,255,255,0.06); background: #0d1720; }
        .adm-stat::before { content:''; position:absolute; inset:0; opacity:0.06; }
        .adm-stat.blue::before { background: radial-gradient(circle at top right, var(--accent), transparent 70%); }
        .adm-stat.green::before { background: radial-gradient(circle at top right, var(--green), transparent 70%); }
        .adm-stat.orange::before { background: radial-gradient(circle at top right, var(--orange), transparent 70%); }
        .adm-stat.purple::before { background: radial-gradient(circle at top right, #a29bfe, transparent 70%); }
        .adm-stat .val { font-size: 24px; font-weight: 900; color: white; position:relative; }
        .adm-stat .lbl { font-size: 10px; color: var(--secondary); margin-top: 4px; position:relative; letter-spacing:0.5px; text-transform:uppercase; }
        .adm-stat .ico { font-size:28px; position:absolute; right:12px; top:12px; opacity:0.15; }

        /* User rows */
        .adm-user-row { background: #0d1720; border-radius: 16px; padding: 12px 14px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .adm-user-row:hover { background: #111f2e; border-color: rgba(36,129,204,0.2); transform: translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,0.3); }
        .adm-user-row .uname { font-weight: bold; font-size: 14px; }
        .adm-user-row .uinfo { font-size: 11px; color: var(--secondary); margin-top: 3px; }
        .adm-user-row .ubadge { font-size: 11px; background: rgba(36,129,204,0.12); color: var(--accent); padding: 4px 10px; border-radius: 20px; font-weight: bold; white-space: nowrap; border:1px solid rgba(36,129,204,0.15); }
        .adm-user-row .uavatar { width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#1a2a3a,#0a1520);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;margin-right:10px;border:1px solid rgba(255,255,255,0.08); }

        .adm-user-detail { background: #0a1520; border-radius: 20px; padding: 16px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.06); display: none; }
        .adm-user-detail.open { display: block; animation: fadeInUp 0.2s ease both; }

        .adm-inv-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 8px 0; scrollbar-width: none; }
        .adm-inv-scroll::-webkit-scrollbar { display:none; }
        .adm-inv-item { flex-shrink: 0; background: #070d14; border-radius: 12px; padding: 8px 10px; text-align: center; font-size: 20px; min-width: 46px; border:1px solid rgba(255,255,255,0.06); transition:0.15s; cursor:default; }
        .adm-inv-item:hover { border-color:rgba(36,129,204,0.3); transform:scale(1.05); }

        /* Promo cards */
        .promo-card { background: #0d1720; border-radius: 18px; padding: 14px 16px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.06); display:flex; align-items:center; gap:12px; }
        .promo-card-info { flex:1; min-width:0; }
        .promo-badge { display: inline-block; background: rgba(46,204,113,0.15); color: var(--green); border-radius: 20px; padding: 2px 10px; font-size: 10px; font-weight: bold; margin-bottom: 5px; border:1px solid rgba(46,204,113,0.2); }
        .promo-badge.used { background: rgba(127,145,164,0.1); color: var(--secondary); border-color: rgba(127,145,164,0.15); }
        .promo-code-text { font-family: monospace; font-size: 15px; font-weight: bold; letter-spacing: 2px; color: gold; }

        /* Tool cards */
        .tool-card { background: #0d1720; border-radius: 20px; padding: 16px; border: 1px solid rgba(255,255,255,0.06); margin-bottom: 10px; }
        .tool-card-title { font-weight: bold; font-size: 13px; margin-bottom: 10px; display:flex;align-items:center;gap:6px; }

        /* Danger zone */
        .danger-zone { border: 1px solid rgba(231,76,60,0.2); border-radius: 20px; padding: 16px; background: rgba(231,76,60,0.04); margin-top:4px; }
        .danger-zone-title { font-size:11px; color:var(--err); font-weight:bold; letter-spacing:0.5px; text-transform:uppercase; margin-bottom:10px; display:flex;align-items:center;gap:5px; }

        .search-box { background: #0e1824; border: 1px solid #2b3a4a; border-radius: 14px; padding: 10px 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .search-box input { background: none; border: none; margin: 0; padding: 0; font-size: 14px; flex: 1; } 
        .search-filter-bar { 
            grid-column: 1/-1;
            display: flex; 
            gap: 10px; 
            margin-bottom: 5px; 
            flex-wrap: wrap;
            align-items: center;
        }
        .search-filter-bar input { 
            flex: 1; 
            min-width: 140px; 
            background: #0e1824; 
            border: 1px solid #2b3a4a; 
            border-radius: 14px; 
            padding: 11px 16px; 
            margin: 0; 
            font-size: 14px; 
            color: white; 
            outline: none;
        }
        .search-filter-bar input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(36,129,204,0.15); }
        .filter-btn { 
            background: #0e1824; 
            border: 1px solid #2b3a4a; 
            border-radius: 12px; 
            padding: 9px 14px; 
            color: var(--secondary); 
            font-size: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            white-space: nowrap;
            transition: 0.2s;
            flex-shrink: 0;
        }
        .filter-btn:hover { background: #1a2636; color: white; }
        .filter-btn.active { background: var(--accent); border-color: var(--accent); color: white; box-shadow: 0 4px 12px rgba(36,129,204,0.35); }

        @keyframes rainbow { 0%{color:#ff6b6b} 16%{color:#ffd93d} 33%{color:#6bcb77} 50%{color:#4d96ff} 66%{color:#c77dff} 83%{color:#ff6bcd} 100%{color:#ff6b6b} }
        .rarity-nft { animation: rainbow 2s linear infinite; font-weight:bold; }

        /* ===== MERGE SYSTEM ===== */
        @keyframes mergeGlow { 0%,100%{box-shadow:0 0 0 0 rgba(255,215,0,0)} 50%{box-shadow:0 0 30px 8px rgba(255,215,0,0.5)} }
        @keyframes mergeUpgrade { 0%{transform:scale(1) rotate(0)} 30%{transform:scale(1.4) rotate(-5deg)} 60%{transform:scale(0.9) rotate(5deg)} 100%{transform:scale(1) rotate(0)} }
        @keyframes epicPulse { 0%,100%{box-shadow:0 0 0 0 rgba(162,155,254,0)} 50%{box-shadow:0 0 20px 5px rgba(162,155,254,0.4)} }
        @keyframes legendaryShimmer { 0%{background-position:-200% center} 100%{background-position:200% center} }
        @keyframes rarePulse { 0%,100%{box-shadow:0 0 0 0 rgba(77,180,255,0)} 50%{box-shadow:0 0 16px 4px rgba(77,180,255,0.35)} }

        .rarity-common  { color:#7f91a4; font-size:10px; font-weight:bold; }
        .rarity-rare    { color:#4db4ff; font-size:10px; font-weight:bold; }
        .rarity-epic    { color:#a29bfe; font-size:10px; font-weight:bold; }
        .rarity-legendary { background:linear-gradient(90deg,#ffd700,#ffb347,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text; font-size:10px; font-weight:bold; background-size:200% auto; animation:legendaryShimmer 3s linear infinite; }

        /* Performance: will-change only on animated elements */
        .nft-card { will-change: box-shadow; }
        .nft-emoji { will-change: transform; }
        .fly-emoji, .confetti-piece { will-change: transform, opacity; }

        /* Reduce animations on low-end devices */
        @media (prefers-reduced-motion: reduce) {
            .nft-card, .nft-emoji, .rarity-nft, .rarity-legendary { animation: none !important; }
            .card-rare, .card-epic, .card-legendary { animation: none !important; }
            .merge-ready { animation: none !important; }
            * { transition-duration: 0.01ms !important; animation-duration: 0.01ms !important; }
        }

        .card-rare     { border:1.5px solid rgba(77,180,255,0.5)!important; background:linear-gradient(135deg,#0a0d2e,#0c1a30)!important; box-shadow:0 0 10px 2px rgba(77,180,255,0.18); }
        .card-epic     { border:1.5px solid rgba(162,155,254,0.55)!important; background:linear-gradient(135deg,#0d0a2e,#1a0e3a)!important; box-shadow:0 0 10px 2px rgba(162,155,254,0.2); }
        .card-legendary{ border:2px solid rgba(255,215,0,0.7)!important; background:linear-gradient(135deg,#1a1200,#0e1824,#1a1200)!important; box-shadow:0 0 14px 3px rgba(255,215,0,0.22); }
        .card-legendary::before { content:''; position:absolute; inset:0; border-radius:25px; background:linear-gradient(105deg,transparent 30%,rgba(255,215,0,0.12) 50%,transparent 70%); pointer-events:none; z-index:1; }

        .nft-id-badge { position:absolute; bottom:6px; left:8px; font-size:9px; color:rgba(255,255,255,0.35); font-family:monospace; letter-spacing:0.5px; z-index:3; }
        .nft-id-badge.nft { color:rgba(255,215,0,0.55); }
        .nft-id-badge.common-id { color:rgba(255,255,255,0.22); }

        .merge-btn { background:linear-gradient(90deg,#7c3aed,#a855f7)!important; margin-top:5px!important; font-size:11px!important; position:relative; overflow:hidden; }
        .merge-ready { box-shadow:0 0 18px 4px rgba(255,215,0,0.35); border-color:rgba(255,215,0,0.7)!important; }

        .merge-count-badge { position:absolute; top:7px; left:7px; background:rgba(162,155,254,0.9); color:#fff; font-size:9px; font-weight:bold; border-radius:10px; padding:1px 6px; z-index:3; backdrop-filter:blur(4px); }
        .merge-count-badge.ready { background:linear-gradient(90deg,#7c3aed,#a855f7); }

        .merge-panel { grid-column:1/-1; background:linear-gradient(135deg,#0d0a20,#120d2e); border:1.5px solid rgba(162,155,254,0.4); border-radius:22px; padding:18px; margin-bottom:5px; }
        .merge-panel h4 { margin:0 0 10px; color:#a29bfe; font-size:15px; display:flex; align-items:center; gap:8px; }
        .merge-items-row { display:flex; gap:10px; overflow-x:auto; padding:6px 0; }
        .merge-slot { width:80px; height:80px; border-radius:16px; border:2px dashed rgba(162,155,254,0.4); display:flex; align-items:center; justify-content:center; font-size:32px; flex-shrink:0; background:rgba(162,155,254,0.05); transition:0.2s; cursor:pointer; }
        .merge-slot.filled { border-color:rgba(162,155,254,0.8); background:rgba(162,155,254,0.12); }
        .merge-slot:hover { border-color:#a29bfe; background:rgba(162,155,254,0.2); }
        .pin-badge { position:absolute;top:4px;right:4px;font-size:14px;line-height:1;filter:drop-shadow(0 1px 3px rgba(0,0,0,0.7)); }
        .gift-cell-wrap { position:relative; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(18px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.88); } to { opacity: 1; transform: scale(1); } }
        @keyframes popIn { 0% { transform: scale(0) rotate(-10deg); opacity: 0; } 70% { transform: scale(1.12) rotate(3deg); opacity: 1; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-130px) scale(1.8); opacity: 0; } }
        @keyframes shimmer { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }
        @keyframes pulseGold { 0%, 100% { box-shadow: 0 0 0 0 rgba(255,215,0,0.55), 0 8px 32px rgba(0,0,0,0.4); } 50% { box-shadow: 0 0 0 12px rgba(255,215,0,0), 0 8px 32px rgba(0,0,0,0.4); } }
        @keyframes pulse { 0%, 100% { opacity:1; transform:scale(1); } 50% { opacity:0.4; transform:scale(0.8); } }
        @keyframes wiggle { 0%,100% { transform: rotate(0deg) scale(1); } 20% { transform: rotate(-10deg) scale(1.15); } 40% { transform: rotate(10deg) scale(1.2); } 60% { transform: rotate(-6deg) scale(1.1); } 80% { transform: rotate(6deg) scale(1.05); } }
        @keyframes confettiFall { 0% { transform: translateY(-10px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        @keyframes slideInNav { from { transform: translateX(-50%) translateY(50px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.15); opacity: 1; } 70% { transform: scale(0.92); } 100% { transform: scale(1); } }
        @keyframes float { 0%,100% { transform: translateY(0px); } 50% { transform: translateY(-7px); } }
        @keyframes balanceFlash { 0% { color: var(--accent); transform: scale(1); } 35% { color: #2ecc71; transform: scale(1.3); } 100% { color: var(--accent); transform: scale(1); } }

        /* ===== DUEL & TRADE ANIMATIONS ===== */
        @keyframes duelShakeL { 0%,100%{transform:translateX(0) rotate(0deg)} 20%{transform:translateX(-18px) rotate(-8deg)} 40%{transform:translateX(12px) rotate(5deg)} 60%{transform:translateX(-8px) rotate(-4deg)} 80%{transform:translateX(5px) rotate(2deg)} }
        @keyframes duelShakeR { 0%,100%{transform:translateX(0) rotate(0deg)} 20%{transform:translateX(18px) rotate(8deg)} 40%{transform:translateX(-12px) rotate(-5deg)} 60%{transform:translateX(8px) rotate(4deg)} 80%{transform:translateX(-5px) rotate(-2deg)} }
        @keyframes duelClash { 0%{transform:translate(-50%,-50%) scale(1) rotate(0deg);opacity:1} 25%{transform:translate(-50%,-50%) scale(2.5) rotate(15deg);opacity:1} 50%{transform:translate(-50%,-50%) scale(3.2) rotate(-10deg);opacity:0.9} 75%{transform:translate(-50%,-50%) scale(2) rotate(5deg);opacity:0.5} 100%{transform:translate(-50%,-50%) scale(0) rotate(0deg);opacity:0} }
        @keyframes duelWinner { 0%{transform:translateY(0) scale(1)} 30%{transform:translateY(-22px) scale(1.35)} 60%{transform:translateY(-12px) scale(1.25)} 100%{transform:translateY(-6px) scale(1.2)} }
        @keyframes duelLoser { 0%{transform:scale(1);opacity:1;filter:none} 100%{transform:scale(0.4) translateY(25px);opacity:0.15;filter:grayscale(1) blur(2px)} }
        @keyframes duelFlash { 0%,100%{background:rgba(0,0,0,0.88)} 30%{background:rgba(255,80,0,0.3)} 60%{background:rgba(255,30,0,0.4)} }
        @keyframes swordSpin { 0%{transform:translate(-50%,-50%) rotate(0deg) scale(1)} 50%{transform:translate(-50%,-50%) rotate(200deg) scale(2)} 100%{transform:translate(-50%,-50%) rotate(360deg) scale(1)} }
        @keyframes tradeArrow { 0%,100%{transform:translateX(0);opacity:1} 50%{transform:translateX(6px);opacity:0.6} }
        @keyframes tradeGlow { 0%,100%{box-shadow:0 0 0 0 rgba(46,204,113,0)} 50%{box-shadow:0 0 0 8px rgba(46,204,113,0.15)} }
        .duel-clash-emoji { position:fixed; top:50%; left:50%; font-size:64px; pointer-events:none; z-index:9999; animation: duelClash 0.85s ease forwards; }
        .duel-sword-spin { position:fixed; top:50%; left:50%; font-size:52px; pointer-events:none; z-index:9999; animation: swordSpin 0.6s ease-in-out; }


        /*  PINNED GIFTS RING AROUND AVATAR  */
        @keyframes orbitRing {
            from { transform: rotate(0deg); }
            to   { transform: rotate(0deg); }
        }
        @keyframes counterOrbit {
            from { transform: rotate(0deg) scale(1); }
            to   { transform: rotate(0deg) scale(1); }
        }
        @keyframes ringPulse {
            0%,100% { opacity:0.6; transform: scale(1); }
            50%      { opacity:1;   transform: scale(1.15); }
        }
        .avatar-ring-wrap {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 200px;
            height: 200px;
            margin: 0 auto 18px;
        }
        .avatar-ring-orbit {
            position: absolute;
            top: 0; left: 0;
            width: 200px; height: 200px;
            pointer-events: none;
            overflow: visible;
        }
        .avatar-ring-item {
            position: absolute;
            width: 28px; height: 28px;
            border-radius: 50%;
            background: rgba(10,21,32,0.92);
            border: 1.5px solid rgba(255,255,255,0.18);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.6);
            overflow: hidden;
        }
        .avatar-ring-item img {
            width: 22px; height: 22px;
            object-fit: contain;
            filter: drop-shadow(0 1px 4px rgba(0,0,0,0.5));
        }
        .avatar-ring-item span { font-size: 16px; line-height: 1; }
        .avatar-ring-item.ring-nft {
            border-color: rgba(255,215,0,0.7);
            background: rgba(26,18,0,0.95);
            box-shadow: 0 0 8px rgba(255,215,0,0.4), 0 2px 10px rgba(0,0,0,0.6);
        }
        .nft-card { animation: pulseGold 4s ease-in-out infinite, fadeInScale 0.4s ease both !important; }
        .nft-card::before { content: ''; position: absolute; inset: 0; border-radius: 25px; pointer-events: none; background: linear-gradient(105deg, transparent 30%, rgba(255,215,0,0.12) 50%, transparent 70%); z-index: 1; }
        .nft-emoji { animation: float 3.5s ease-in-out infinite; }
        .fly-emoji { position: fixed; font-size: 38px; pointer-events: none; z-index: 9999; animation: floatUp 0.95s cubic-bezier(0.25,0.46,0.45,0.94) forwards; }
        .confetti-piece { position: fixed; width: 9px; height: 9px; pointer-events: none; z-index: 9999; border-radius: 2px; animation: confettiFall linear forwards; }
        .balance-flash { animation: balanceFlash 0.65s cubic-bezier(0.34,1.56,0.64,1); }
        .gift-img { width:74px; height:74px; object-fit:contain; display:block; margin:0 auto 8px; transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1); filter:drop-shadow(0 4px 12px rgba(0,0,0,0.4)); flex-shrink:0; }
        .gift-img-wrap { width:100%; height:96px; display:flex; align-items:center; justify-content:center; margin-bottom:6px; flex-shrink:0; overflow:hidden; }
        .gift-img-wrap .gift-img { margin:0; width:74px; height:74px; }
        .gift-img-wrap .gift-img-pony { width:90px; height:90px; }
        .card:hover .gift-img { transform:scale(1.18) translateY(-5px) rotate(3deg); }
        .gift-img-sm { width:46px; height:46px; object-fit:contain; display:block; margin:0 auto 4px; filter:drop-shadow(0 2px 6px rgba(0,0,0,0.3)); flex-shrink:0; }
        .card-inner { display:flex; flex-direction:column; align-items:center; width:100%; }
        #shop .card:nth-child(1){animation-delay:.04s} #shop .card:nth-child(2){animation-delay:.08s} #shop .card:nth-child(3){animation-delay:.12s} #shop .card:nth-child(4){animation-delay:.16s} #shop .card:nth-child(5){animation-delay:.2s} #shop .card:nth-child(6){animation-delay:.24s} #shop .card:nth-child(n+7){animation-delay:.28s}
        #profile { display:none; flex-direction:column; padding:0; padding-bottom:120px; }
        #profile.active { display:flex; }
        .tg-profile { display:flex; flex-direction:column; width:100%; }

        .tg-profile-hero {
            background: linear-gradient(180deg, #0d1f35 0%, var(--card) 100%);
            padding: 30px 20px 24px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            position: relative;
        }
        .tg-avatar-wrap { position:relative; display:inline-block; margin-bottom:0; }
        .tg-avatar {
            width:100px; height:100px; border-radius:50%;
            object-fit:cover; border:3px solid var(--accent);
            cursor:pointer; display:block;
            transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1), border-color 0.3s;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        }
        .tg-avatar:hover { transform:scale(1.06); border-color:gold; }
        .tg-avatar-edit {
            position:absolute; bottom:2px; right:2px;
            width:28px; height:28px; border-radius:50%;
            background:var(--accent); display:flex; align-items:center; justify-content:center;
            font-size:13px; cursor:pointer; border:2px solid var(--bg);
            box-shadow:0 2px 8px rgba(0,0,0,0.4);
        }
        .tg-username { font-size:22px; font-weight:700; margin:0 0 6px; letter-spacing:0.3px; color:var(--text); }
        .tg-bio { color:var(--secondary); font-size:13px; margin:0 0 20px; line-height:1.5; max-width:280px; margin-left:auto; margin-right:auto; }

        .tg-stats {
            display:flex; align-items:center; justify-content:center; gap:0;
            background:rgba(255,255,255,0.04); border-radius:18px; padding:14px 10px;
            margin-bottom:20px; border:1px solid rgba(255,255,255,0.07);
        }
        .tg-stat { flex:1; text-align:center; }
        .tg-stat-val { font-size:20px; font-weight:700; color:white; }
        .tg-stat-lbl { font-size:10px; color:var(--secondary); margin-top:2px; }
        .tg-stat-div { width:1px; height:32px; background:rgba(255,255,255,0.1); flex-shrink:0; }

        .tg-actions { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
        .tg-action-btn {
            display:flex; flex-direction:column; align-items:center; gap:4px;
            background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.09);
            border-radius:16px; padding:10px 14px; cursor:pointer; color:white;
            font-size:11px; font-weight:600; min-width:68px;
            transition:0.2s cubic-bezier(0.34,1.56,0.64,1);
        }
        .tg-action-btn:active { transform:scale(0.9); }
        .tg-action-btn:hover { background:rgba(255,255,255,0.1); }
        .tg-action-icon { font-size:20px; }
        .tg-action-tg { background:rgba(34,158,217,0.15); border-color:rgba(34,158,217,0.3); color:#229ED9; }
        .tg-action-red { background:rgba(231,76,60,0.12); border-color:rgba(231,76,60,0.25); color:#e74c3c; }

        .tg-gifts-section { padding:0 0 10px; }
        .tg-gifts-header {
            display:flex; justify-content:space-between; align-items:center;
            padding:16px 16px 10px; font-size:13px; font-weight:700;
            color:var(--secondary); text-transform:uppercase; letter-spacing:0.8px;
        }
        .tg-gifts-count {
            background:rgba(36,129,204,0.2); color:var(--accent);
            border-radius:10px; padding:2px 8px; font-size:12px; font-weight:700;
        }
        .tg-gifts-grid {
            display:grid; grid-template-columns:repeat(3,1fr); gap:5px;
            padding:0 6px 6px;
        }
        /* NFT animations */
        @keyframes nftGoldPulse{0%,100%{box-shadow:0 0 0 1.5px rgba(255,215,0,0.55),0 4px 20px rgba(255,215,0,0.25)}50%{box-shadow:0 0 0 2.5px rgba(255,215,0,0.9),0 6px 30px rgba(255,215,0,0.5)}}
        @keyframes nftGoldShimmer{0%{background-position:-200% center}100%{background-position:200% center}}
        @keyframes nftImgFloat{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-5px) scale(1.06)}}
        @keyframes nftLizPulse{0%,100%{box-shadow:0 0 0 1.5px rgba(77,255,145,0.55),0 4px 20px rgba(77,255,145,0.25)}50%{box-shadow:0 0 0 2.5px rgba(77,255,145,0.9),0 6px 30px rgba(77,255,145,0.5)}}
        @keyframes nftStars{0%{opacity:0;transform:scale(0) rotate(0deg)}50%{opacity:1}100%{opacity:0;transform:scale(1.5) rotate(180deg)}}

        .tg-gift-cell {
            background:var(--card); cursor:pointer; aspect-ratio:1;
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            gap:3px; transition:0.22s cubic-bezier(0.34,1.56,0.64,1);
            border-radius:18px; overflow:hidden; position:relative;
            border:1.5px solid rgba(255,255,255,0.07);
            box-shadow:0 2px 10px rgba(0,0,0,0.3);
        }
        .tg-gift-cell:hover { border-color:rgba(255,255,255,0.22); box-shadow:0 8px 24px rgba(0,0,0,0.55); transform:scale(1.05) translateY(-3px); }
        .tg-gift-cell:active { transform:scale(0.91); }
        .tg-gift-inner {
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            width:100%; flex:1; padding:8px 4px 0; position:relative;
        }
        .tg-gift-inner img { width:58px; height:58px; object-fit:contain; filter:drop-shadow(0 3px 12px rgba(0,0,0,0.45)); transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1); }
        .tg-gift-cell:hover .tg-gift-inner img { transform:scale(1.15) translateY(-3px); }
        .tg-gift-name { font-size:10px; color:var(--secondary); text-align:center; padding:0 4px 3px; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%; }

        /* NFT GOLD */
        .tg-gift-nft {
            background:linear-gradient(145deg,#1c1200,#0f1a1f,#1a1100) !important;
            animation:nftGoldPulse 2.5s ease-in-out infinite;
            border-color:rgba(255,215,0,0.6) !important;
            will-change:box-shadow;
        }
        .tg-gift-nft::before {
            content:''; position:absolute; inset:0; border-radius:18px; pointer-events:none; z-index:0;
            background:linear-gradient(105deg,transparent 25%,rgba(255,215,0,0.12) 50%,transparent 75%);
            background-size:200% 100%; animation:nftGoldShimmer 2.5s linear infinite;
            will-change:background-position;
        }
        .tg-gift-nft .tg-gift-inner { z-index:1; }
        .tg-gift-nft .tg-gift-inner img { animation:nftImgFloat 3s ease-in-out infinite; filter:drop-shadow(0 4px 16px rgba(255,215,0,0.55)); will-change:transform; }
        .tg-gift-nft .tg-gift-name {
            background:linear-gradient(90deg,#ffd700,#ffb347,#ffd700);
            background-size:200% auto;
            animation:nftGoldShimmer 2s linear infinite;
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
            font-weight:bold;
        }
        .tg-gift-nft-badge {
            position:absolute; top:5px; right:5px; z-index:3;
            background:linear-gradient(90deg,#b8860b,#ffd700,#b8860b);
            background-size:200% auto; animation:nftGoldShimmer 1.8s linear infinite;
            color:#000; font-size:7px; font-weight:900; border-radius:6px; padding:2px 5px;
            letter-spacing:0.5px; box-shadow:0 1px 6px rgba(255,215,0,0.5);
            will-change:background-position;
        }
        .tg-gift-nft-serial {
            position:absolute; bottom:22px; left:0; right:0; text-align:center; z-index:3;
            font-size:7px; color:rgba(255,215,0,0.5); font-family:monospace; letter-spacing:0.3px;
        }
        .tg-gift-nft-price {
            font-size:8px; color:rgba(255,215,0,0.7); font-weight:bold; padding-bottom:4px; z-index:1;
        }

        /* NFT LIZARD */
        .tg-gift-nft-lizard {
            background:linear-gradient(145deg,#001a08,#0a1f12,#001208) !important;
            animation:nftLizPulse 2.5s ease-in-out infinite;
            border-color:rgba(77,255,145,0.6) !important;
            will-change:box-shadow;
        }
        .tg-gift-nft-lizard::before {
            content:''; position:absolute; inset:0; border-radius:18px; pointer-events:none; z-index:0;
            background:linear-gradient(105deg,transparent 25%,rgba(77,255,145,0.12) 50%,transparent 75%);
            background-size:200% 100%; animation:nftGoldShimmer 2.5s linear infinite;
            will-change:background-position;
        }
        .tg-gift-nft-lizard .tg-gift-inner { z-index:1; }
        .tg-gift-nft-lizard .tg-gift-inner img { animation:nftImgFloat 3s ease-in-out infinite; filter:drop-shadow(0 4px 16px rgba(77,255,145,0.6)); will-change:transform; }
        .tg-gift-nft-lizard .tg-gift-name {
            background:linear-gradient(90deg,#00ff88,#4dff91,#00cc66);
            background-size:200% auto; animation:nftGoldShimmer 2s linear infinite;
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; font-weight:bold;
        }
        .tg-gift-nft-lizard .tg-gift-nft-badge { background:linear-gradient(90deg,#007744,#4dff91,#007744); }
        .tg-gift-nft-lizard .tg-gift-nft-serial { color:rgba(77,255,145,0.45); }
        .tg-gift-nft-lizard .tg-gift-nft-price { color:rgba(77,255,145,0.7); }

        .tg-gift-from {
            position:absolute; top:6px; left:5px; z-index:3;
            background:rgba(243,156,18,0.9); color:white;
            font-size:7px; font-weight:700; border-radius:7px; padding:2px 5px;
            backdrop-filter:blur(4px); max-width:48px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
        }
        .tg-gift-pinned { border-color:rgba(243,156,18,0.6) !important; box-shadow:0 0 0 1px rgba(243,156,18,0.25), 0 4px 14px rgba(243,156,18,0.2) !important; }

        /* ===== DESKTOP / PC STYLES ===== */
        @media (min-width: 768px) {
            body { max-width: 1200px; margin: 0 auto; }

            .nav {
                width: 480px;
                max-width: 480px;
                bottom: 28px;
                border-radius: 32px;
            }
            .nav-btn { font-size: 12px; padding: 4px 6px; }
            .nav-btn i { font-size: 24px; }

            .page { 
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
                gap: 20px; 
                padding: 20px 20px 140px;
                max-width: 1200px;
                margin: 0 auto;
            }
            .card { padding: 24px; border-radius: 28px; }
            .gift-img { width: 90px; height: 90px; }
            .gift-img-wrap { height: 110px; }
            .gift-img-wrap .gift-img { width: 90px; height: 90px; }

            #friends, #admin { 
                max-width: 800px; 
                margin: 0 auto; 
                padding: 20px 20px 140px;
            }
            #profile { 
                max-width: 700px; 
                margin: 0 auto; 
                padding: 20px; 
            }
            #profile.active { padding-bottom: 140px; }

            .tg-gifts-grid { grid-template-columns: repeat(4, 1fr); gap: 8px; }

            .adm-stat-grid { grid-template-columns: repeat(4, 1fr); }
            .adm-stat .val { font-size: 30px; }

            input, textarea, select { font-size: 15px; }

            #toast-container { 
                bottom: 130px; 
                max-width: 500px; 
            }

            #modal-content { max-width: 500px; }
            #modal-overlay { padding: 30px; }

            .search-filter-bar { gap: 12px; }
            .search-filter-bar input { font-size: 15px; }

            .pinned-section { gap: 20px; padding: 20px; }

            .adm-tabs { gap: 10px; }
            .adm-tab { padding: 10px 20px; font-size: 14px; }
        }

        @media (min-width: 1100px) {
            .page { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
            .tg-gifts-grid { grid-template-columns: repeat(5, 1fr); }
        }
    </style>
</head>
<body>


<!-- Toast notifications container -->
<div id="toast-container" style="position:fixed;bottom:110px;left:50%;transform:translateX(-50%);z-index:5000;display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none;width:92%;max-width:400px;"></div>

<!-- Beautiful modal overlay -->
<div id="modal-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0);display:none;align-items:center;justify-content:center;z-index:2000;padding:20px;transition:background 0.3s;" onclick="if(event.target==this) closeModal()">
    <div id="modal-content" class="card" style="width:100%;max-width:400px;background:var(--card);max-height:85vh;overflow-y:auto;"></div>
</div>

<!-- Confirm dialog -->
<div id="confirm-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0);display:none;align-items:center;justify-content:center;z-index:6000;padding:20px;transition:background 0.3s;">
    <div id="confirm-box" style="width:100%;max-width:340px;background:var(--card);border-radius:24px;padding:24px;border:1px solid rgba(255,255,255,0.1);box-shadow:0 30px 80px rgba(0,0,0,0.8);animation:popIn 0.32s cubic-bezier(0.34,1.56,0.64,1) both;">
        <div id="confirm-icon" style="font-size:44px;text-align:center;margin-bottom:10px;"></div>
        <h3 id="confirm-title" style="text-align:center;margin:0 0 8px;font-size:17px;"></h3>
        <p id="confirm-msg" style="text-align:center;color:var(--secondary);font-size:13px;margin:0 0 20px;line-height:1.5;"></p>
        <div style="display:flex;gap:10px;">
            <button id="confirm-cancel" class="btn" style="background:#1a2636;color:var(--secondary);border:1px solid rgba(255,255,255,0.08);flex:1;" onclick="resolveConfirm(false)"></button>
            <button id="confirm-ok" class="btn" style="flex:1;" onclick="resolveConfirm(true)"></button>
        </div>
    </div>
</div>

<style>
    @keyframes authSlideIn { from{opacity:0;transform:translateY(30px) scale(0.95)} to{opacity:1;transform:translateY(0) scale(1)} }
    @keyframes titlePulse { 0%,100%{text-shadow:0 0 20px rgba(36,129,204,0.4)} 50%{text-shadow:0 0 40px rgba(36,129,204,0.8)} }
    @keyframes formSlide { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

    .auth-wrap { min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; gap:16px; }
    .auth-logo { text-align:center; animation:authSlideIn 0.5s cubic-bezier(0.34,1.56,0.64,1) both; }
    .auth-logo h1 { font-size:32px; color:var(--accent); margin:8px 0 4px; animation:titlePulse 3s ease-in-out infinite; }
    .auth-logo p { color:var(--secondary); font-size:13px; margin:0; }

    .auth-card {
        width:100%; max-width:360px;
        background:var(--card);
        border-radius:26px;
        padding:6px 6px 20px;
        border:1px solid rgba(255,255,255,0.07);
        animation:authSlideIn 0.5s cubic-bezier(0.34,1.56,0.64,1) 0.08s both;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    /* Tab switcher */
    .auth-tabs { display:flex; background:#0a1520; border-radius:20px; padding:5px; margin-bottom:16px; }
    .auth-tab {
        flex:1; padding:10px; border:none; background:none; color:var(--secondary);
        font-size:14px; font-weight:bold; border-radius:16px; cursor:pointer;
        transition:all 0.25s cubic-bezier(0.34,1.56,0.64,1);
    }
    .auth-tab.active { background:var(--accent); color:white; box-shadow:0 4px 15px rgba(36,129,204,0.4); transform:scale(1.03); }
    .auth-tab.active.green { background:var(--green); box-shadow:0 4px 15px rgba(46,204,113,0.4); }

    /* Form */
    .auth-form { display:none; padding:0 6px; animation:formSlide 0.25s ease both; }
    .auth-form.active { display:block; }
    .auth-form input { margin:6px 0; padding:13px 40px 13px 14px; font-size:15px; border-radius:14px; }
    .auth-form .btn { border-radius:14px; padding:13px; margin-top:8px; font-size:15px; font-weight:bold; }
    .auth-err { font-size:12px; color:var(--err); margin-top:6px; min-height:16px; text-align:center; padding:0 4px; }
    .input-wrap { position:relative; }
    .input-status { position:absolute; right:13px; top:50%; transform:translateY(-50%); font-size:14px; pointer-events:none; }

    .auth-links { width:100%; max-width:360px; display:flex; gap:10px; animation:authSlideIn 0.5s cubic-bezier(0.34,1.56,0.64,1) 0.18s both; }
    .auth-links a { flex:1; padding:10px; font-size:13px; border-radius:14px; }

        /* ===== NFT UPGRADE LEVELS ===== */
        .nft-lvl1-fire { background:linear-gradient(145deg,#1a0500,#2d0a00,#1a0500) !important; border-color:rgba(255,80,0,0.7) !important; }
        .nft-lvl1-ocean { background:linear-gradient(145deg,#001a2d,#002d4a,#001a2d) !important; border-color:rgba(0,150,255,0.7) !important; }
        .nft-lvl1-forest { background:linear-gradient(145deg,#001a08,#002d12,#001a08) !important; border-color:rgba(0,200,80,0.7) !important; }
        .nft-lvl1-galaxy { background:linear-gradient(145deg,#0a0015,#150020,#0a0015) !important; border-color:rgba(180,0,255,0.7) !important; }
        .nft-lvl1-sunset { background:linear-gradient(145deg,#1a0820,#2d0d10,#1a0820) !important; border-color:rgba(255,100,150,0.7) !important; }
        .nft-lvl2::after { content:''; position:absolute; inset:0; border-radius:18px; pointer-events:none; z-index:0; opacity:0.25; }
        .nft-lvl2-grid::after { background-image: repeating-linear-gradient(0deg,rgba(255,255,255,0.08) 0px,transparent 1px,transparent 20px),repeating-linear-gradient(90deg,rgba(255,255,255,0.08) 0px,transparent 1px,transparent 20px); }
        .nft-lvl2-dots::after { background-image: radial-gradient(circle,rgba(255,255,255,0.15) 1px,transparent 1px); background-size:12px 12px; }
        .nft-lvl2-hex::after { background-image: repeating-linear-gradient(60deg,rgba(255,255,255,0.06) 0,rgba(255,255,255,0.06) 1px,transparent 0,transparent 50%),repeating-linear-gradient(120deg,rgba(255,255,255,0.06) 0,rgba(255,255,255,0.06) 1px,transparent 0,transparent 50%); background-size:20px 35px; }
        .nft-lvl2-waves::after { background-image: repeating-linear-gradient(45deg,rgba(255,255,255,0.05) 0px,rgba(255,255,255,0.05) 2px,transparent 2px,transparent 10px); }
        .nft-lvl2-stars::after { background-image: radial-gradient(circle,rgba(255,255,255,0.3) 1px,transparent 1px),radial-gradient(circle,rgba(255,255,255,0.15) 1px,transparent 1px); background-size:25px 25px,13px 13px; background-position:0 0,12px 12px; }
        @keyframes auPulseF { 0%,100%{box-shadow:0 0 20px 3px rgba(255,80,0,0.3)} 50%{box-shadow:0 0 40px 10px rgba(255,80,0,0.7)} }
        @keyframes auPulseO { 0%,100%{box-shadow:0 0 20px 3px rgba(0,150,255,0.3)} 50%{box-shadow:0 0 40px 10px rgba(0,150,255,0.7)} }
        @keyframes auPulseG { 0%,100%{box-shadow:0 0 20px 3px rgba(0,200,80,0.3)} 50%{box-shadow:0 0 40px 10px rgba(0,200,80,0.7)} }
        @keyframes auPulseV { 0%,100%{box-shadow:0 0 20px 3px rgba(180,0,255,0.3)} 50%{box-shadow:0 0 40px 10px rgba(180,0,255,0.7)} }
        @keyframes auPulseP { 0%,100%{box-shadow:0 0 20px 3px rgba(255,100,150,0.3)} 50%{box-shadow:0 0 40px 10px rgba(255,100,150,0.7)} }
        .nft-lvl3-fire { animation:auPulseF 2.5s ease-in-out infinite !important; }
        .nft-lvl3-ocean { animation:auPulseO 2.5s ease-in-out infinite !important; }
        .nft-lvl3-forest { animation:auPulseG 2.5s ease-in-out infinite !important; }
        .nft-lvl3-galaxy { animation:auPulseV 2.5s ease-in-out infinite !important; }
        .nft-lvl3-sunset { animation:auPulseP 2.5s ease-in-out infinite !important; }
        @keyframes particleFloat { 0%{transform:translateY(0) scale(1);opacity:0.9} 100%{transform:translateY(-28px) scale(0.3);opacity:0} }
        .nft-lvl4-particles { overflow:visible !important; }
        .nft-particle { position:absolute; width:5px; height:5px; border-radius:50%; pointer-events:none; z-index:10; animation:particleFloat 1.8s ease-in-out infinite; }
        @keyframes holoShine { 0%{background-position:0% 50%;opacity:0.55} 50%{background-position:100% 50%;opacity:1} 100%{background-position:0% 50%;opacity:0.55} }
        .nft-lvl5-holo::before { content:''; position:absolute; inset:-2px; border-radius:20px; background:linear-gradient(105deg,#ff0000,#ff7f00,#ffff00,#00ff00,#0000ff,#8b00ff,#ff0000); background-size:400% 400%; animation:holoShine 3s ease infinite; z-index:0; opacity:0.5; }
        .nft-lvl5-holo { position:relative; overflow:visible !important; }
        .nft-lvl5-holo .tg-gift-inner,.nft-lvl5-holo .tg-gift-name,.nft-lvl5-holo .tg-gift-nft-badge { z-index:2 !important; position:relative; }
        /* Ring items: block all upgrade side-effects that break absolute positioning */
        .avatar-ring-item { position:absolute !important; }
        .avatar-ring-item.nft-lvl3-fire,
        .avatar-ring-item.nft-lvl3-ocean,
        .avatar-ring-item.nft-lvl3-forest,
        .avatar-ring-item.nft-lvl3-galaxy,
        .avatar-ring-item.nft-lvl3-sunset { animation: none !important; }
        .avatar-ring-item.nft-lvl5-holo { overflow:hidden !important; }
        .avatar-ring-item.nft-lvl5-holo::before { display:none !important; }
        .avatar-ring-item.nft-lvl4-particles { overflow:hidden !important; }
        .nft-upgrade-badge { position:absolute; bottom:5px; right:5px; z-index:5; font-size:8px; font-weight:900; border-radius:8px; padding:2px 5px; letter-spacing:0.3px; }
        .modal-aura-pulse { animation: modalAuraPulse 2s ease-in-out infinite; }
        @keyframes modalAuraPulse { 0%,100% { filter: brightness(1); } 50% { filter: brightness(1.25); } }
        .nft-upg-1 { background:linear-gradient(90deg,#555,#888); color:#fff; }
        .nft-upg-2 { background:linear-gradient(90deg,#1a5fa8,#4db4ff); color:#fff; }
        .nft-upg-3 { background:linear-gradient(90deg,#7c3aed,#a855f7); color:#fff; }
        .nft-upg-4 { background:linear-gradient(90deg,#b8860b,#ffd700); color:#000; }
        .nft-upg-5 { background:linear-gradient(90deg,#ff0044,#ff7700,#ffee00,#00ff88,#0088ff,#aa00ff); background-size:300% 100%; animation:shimmer 2s linear infinite; color:#fff; }

        .cosm-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin:8px 0; }
        .cosm-item { background:#0a1520; border:1.5px solid rgba(255,255,255,0.07); border-radius:14px; padding:10px 12px; cursor:pointer; transition:0.18s; display:flex; flex-direction:column; gap:4px; }
        .cosm-item:hover { border-color:rgba(36,129,204,0.4); }
        .cosm-item.active-cosm { border-color:var(--accent); background:rgba(36,129,204,0.12); box-shadow:0 0 0 1px rgba(36,129,204,0.3); }
        .cosm-item.locked { opacity:0.5; cursor:default; }
        .cosm-preview { font-size:18px; font-weight:bold; }
        .cosm-name { font-size:12px; color:var(--secondary); }
        .cosm-price { font-size:11px; color:var(--accent); margin-top:2px; }
        .cosm-unlock { font-size:10px; color:#a29bfe; margin-top:2px; }
        .cosm-section-title { font-size:13px; color:var(--secondary); margin:12px 0 4px; font-weight:bold; }
        .cosm-badge { display:inline-block; font-size:11px; padding:1px 6px; border-radius:8px; margin-left:4px; vertical-align:middle; font-weight:bold; }
        .cosm-prefix { margin-right:4px; }

        /*  Color shimmer    */
        @keyframes shimmer {
            0%   { background-position: 0%   50% }
            50%  { background-position: 100% 50% }
            100% { background-position: 0%   50% }
        }
        .name-shimmer {
            display:inline-block;
            background-size:300% 100%;
            animation:shimmer 2.5s ease infinite;
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
            font-weight:700;
            color:transparent; /* fallback      */
        }
        .shimmer-blue    { background-image: linear-gradient(90deg, #5dade2, #aed6f1, #2e86c1, #85c1e9, #5dade2); }
        .shimmer-green   { background-image: linear-gradient(90deg, #2ecc71, #a9dfbf, #27ae60, #82e0aa, #2ecc71); }
        .shimmer-purple  { background-image: linear-gradient(90deg, #a29bfe, #dcd6ff, #6c5ce7, #c5b9ff, #a29bfe); }
        .shimmer-orange  { background-image: linear-gradient(90deg, #f39c12, #fde3a7, #e67e22, #fad7a0, #f39c12); }
        .shimmer-pink    { background-image: linear-gradient(90deg, #fd79a8, #ffd6e7, #e84393, #ffb3d1, #fd79a8); }
        .shimmer-gold    { background-image: linear-gradient(90deg, #ffd700, #fff4b3, #ffaa00, #ffe680, #ffd700); }
        .shimmer-red     { background-image: linear-gradient(90deg, #e74c3c, #f1948a, #c0392b, #ec7063, #e74c3c); }
        /*  Admin rainbow prefix  */
        @keyframes adminRainbow {
            0%   {background-position:0%   50%}
            50%  {background-position:100% 50%}
            100% {background-position:0%   50%}
        }
        .admin-rainbow-prefix {
            display:inline-block;
            background:linear-gradient(90deg,#ff6b6b,#ffd93d,#6bcb77,#4d96ff,#c77dff,#ff6bcd,#ff6b6b);
            background-size:300% 100%;
            animation:adminRainbow 2s linear infinite;
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
            font-weight:900;
            font-size:0.95em;
            letter-spacing:0.5px;
            margin-right:4px;
        }
        /*  Sell (trash) button  */
        .sell-btn {
            position:absolute;top:6px;left:6px;z-index:5;
            background:rgba(231,76,60,0.75);
            border:none;border-radius:8px;
            width:26px;height:26px;
            cursor:pointer;font-size:13px;
            display:flex;align-items:center;justify-content:center;
            transition:background 0.2s, transform 0.15s;
        }
        .sell-btn:hover { background:rgba(231,76,60,1); transform:scale(1.15); }
        .sell-btn:active { transform:scale(0.9); }
        /*  Lizard badge  */
        .lizard-badge {
            display:inline-block;
            font-size:14px;
            vertical-align:middle;
            margin-left:3px;
            filter:drop-shadow(0 0 5px rgba(80,255,120,0.8));
            animation:wiggle 3.5s ease-in-out infinite;
        }
        /*  Pinned outline - moved to main css above  */
</style>

<div id="auth-screen" class="auth-wrap">
    <div class="auth-logo">
        <div style="font-size:52px;"></div>
        <h1>Gifts World</h1>
        <p>  </p>
    </div>

    <div class="auth-card">
        <!-- Tabs -->
        <div class="auth-tabs">
            <button class="auth-tab active" id="tab-login" onclick="switchAuthTab('login')"> </button>
            <button class="auth-tab" id="tab-reg" onclick="switchAuthTab('reg')"> </button>
        </div>

        <!-- Login form -->
        <div class="auth-form active" id="form-login">
            <div class="input-wrap">
                <input type="text" id="l-user" placeholder="" autocomplete="username" oninput="clearAuthErr('l-err')">
            </div>
            <div class="input-wrap">
                <input type="password" id="l-pass" placeholder="" autocomplete="current-password" oninput="clearAuthErr('l-err')" onkeydown="if(event.key==='Enter') auth('login')">
            </div>
            <div class="auth-err" id="l-err"></div>
            <button class="btn" style="background:var(--accent);" onclick="auth('login')"> </button>
        </div>

        <!-- Register form -->
        <div class="auth-form" id="form-reg">
            <div class="input-wrap">
                <input type="text" id="r-user" placeholder=" " autocomplete="off" oninput="checkUsername(this.value)">
                <span class="input-status" id="r-user-status"></span>
            </div>
            <div class="input-wrap">
                <input type="password" id="r-pass" placeholder=" " autocomplete="new-password" oninput="clearAuthErr('r-err')" onkeydown="if(event.key==='Enter') auth('reg')">
            </div>
            <div class="auth-err" id="r-err"></div>
            <button class="btn" style="background:var(--green);" onclick="auth('reg')"> </button>
        </div>
    </div>

    <div class="auth-links">
        <a href="https://t.me/Gifts_World_Pro" target="_blank" class="btn" style="background:var(--tg);"> </a>
        <a href="https://dalink.to/gifworld" target="_blank" class="btn" style="background:#505050;"> </a>
    </div>
</div>


<div id="app" style="display:none">
    <div style="padding:15px 20px;background:var(--glass);position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.05);">
        <b id="header-name" style="display:inline-block;">...</b>
        <div style="font-weight:bold;"><span id="u-bal" style="color:var(--accent);">0</span> </div>
    </div>

    <div id="shop" class="page active"></div>
    <div id="inv" class="page"></div>
    <div id="market" class="page"></div>

    <div id="friends" class="page">
        <div id="duel-challenges-section"></div>
        <div id="trade-offers-section"></div>
        <div style="position:relative;margin-bottom:12px;">
            <input type="text" id="friend-search" placeholder="    ..."
                oninput="filterAllUsers(this.value)"
                onfocus="showUserDropdown(this.value)"
                onblur="setTimeout(hideUserDropdown,200)"
                style="width:100%;box-sizing:border-box;">
            <div id="user-dropdown" style="display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:#0e1824;border:1px solid #2b3a4a;border-radius:14px;z-index:100;max-height:280px;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.5);"></div>
        </div>
        <div id="friend-requests"></div>
        <div id="friends-list"></div>
    </div>

    <div id="profile" class="page"></div>

    <!-- ===== ADMIN PANEL ===== -->
    <div id="admin" class="page" style="padding:15px;padding-bottom:120px;">

        <!-- Header -->
        <div class="adm-header">
            <div>
                <div class="adm-header-title">  </div>
                <div class="adm-header-sub" id="adm-online-hint"> ...</div>
            </div>
            <button onclick="admRefresh()" style="background:rgba(36,129,204,0.12);border:1px solid rgba(36,129,204,0.2);color:var(--accent);border-radius:12px;padding:8px 14px;font-size:12px;cursor:pointer;font-weight:bold;"> </button>
        </div>

        <!-- Tabs -->
        <div class="adm-tabs">
            <button class="adm-tab active" onclick="admTab('overview',this)"> </button>
            <button class="adm-tab" onclick="admTab('users',this)"> </button>
            <button class="adm-tab" onclick="admTab('market',this)"> </button>
            <button class="adm-tab" onclick="admTab('promos',this)"> </button>
            <button class="adm-tab" onclick="admTab('tools',this)"> </button>
            <button class="adm-tab" onclick="admTab('sales',this)"> </button>
        </div>

        <!--  Overview  -->
        <div id="adm-overview" class="adm-section active">
            <div class="adm-stat-grid" id="adm-stats-grid"></div>

            <!-- Top players -->
            <div style="background:#0d1720;border-radius:20px;padding:16px;border:1px solid rgba(255,255,255,0.06);margin-bottom:12px;">
                <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:12px;">    </div>
                <div id="adm-top-users"></div>
            </div>

            <!-- Quick actions -->
            <div style="background:#0d1720;border-radius:20px;padding:16px;border:1px solid rgba(255,255,255,0.06);margin-bottom:12px;">
                <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:12px;">  </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <button class="btn" style="background:rgba(46,204,113,0.12);border:1px solid rgba(46,204,113,0.2);color:var(--green);font-size:12px;padding:10px;" onclick="admTab('tools',document.querySelectorAll('.adm-tab')[4])"> </button>
                    <button class="btn" style="background:rgba(243,156,18,0.12);border:1px solid rgba(243,156,18,0.2);color:var(--orange);font-size:12px;padding:10px;" onclick="admTab('promos',document.querySelectorAll('.adm-tab')[3])"> </button>
                    <button class="btn" style="background:rgba(36,129,204,0.12);border:1px solid rgba(36,129,204,0.2);color:var(--accent);font-size:12px;padding:10px;" onclick="admTab('users',document.querySelectorAll('.adm-tab')[1])"> </button>
                    <button class="btn" style="background:rgba(36,129,204,0.12);border:1px solid rgba(36,129,204,0.2);color:var(--accent);font-size:12px;padding:10px;" onclick="admTab('sales',document.querySelectorAll('.adm-tab')[5])"> </button>
                </div>
            </div>

            <!-- Activity Feed -->
            <div style="background:#0d1720;border-radius:20px;padding:16px;border:1px solid rgba(255,255,255,0.06);">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                    <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;">  </div>
                    <div style="display:flex;align-items:center;gap:5px;background:rgba(46,204,113,0.08);border:1px solid rgba(46,204,113,0.2);border-radius:10px;padding:3px 9px;">
                        <span style="width:6px;height:6px;border-radius:50%;background:var(--green);display:inline-block;animation:pulse 1.5s infinite;"></span>
                        <span style="font-size:10px;color:var(--green);font-weight:bold;">Live</span>
                    </div>
                </div>
                <div id="adm-activity-feed"><div style="color:var(--secondary);text-align:center;padding:16px;font-size:13px;">...</div></div>
            </div>
        </div>

        <!--  Users  -->
        <div id="adm-users" class="adm-section">
            <div class="search-box" style="margin-bottom:10px;">
                <span style="color:var(--secondary);"></span>
                <input type="text" id="adm-search" placeholder="  , IP..." oninput="admFilterUsers(this.value)" style="flex:1;">
                <span id="adm-user-count" style="font-size:11px;color:var(--secondary);white-space:nowrap;"></span>
            </div>
            <div id="adm-users-list"></div>
        </div>

        <!--  Market  -->
        <div id="adm-market" class="adm-section">
            <div style="background:#0d1720;border-radius:20px;padding:16px;border:1px solid rgba(255,255,255,0.06);margin-bottom:12px;">
                <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:8px;">  </div>
                <div id="adm-market-stats" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;"></div>
            </div>
            <div class="search-box" style="margin-bottom:10px;">
                <span style="color:var(--secondary);"></span>
                <input type="text" placeholder="  ..." oninput="admFilterMarket(this.value)">
            </div>
            <div id="adm-market-list"></div>
        </div>

        <!--  Promos  -->
        <div id="adm-promos" class="adm-section">
            <div class="tool-card" style="margin-bottom:12px;">
                <div class="tool-card-title">  </div>
                <input type="text" id="promo-code-in" placeholder=" (. GIFT2025)" style="margin:0 0 8px;text-transform:uppercase;">
                <div style="display:flex;gap:8px;margin-bottom:8px;">
                    <input type="number" id="promo-reward-in" placeholder=" " style="margin:0;flex:1;">
                    <input type="number" id="promo-uses-in" placeholder=" " style="margin:0;flex:1;">
                </div>
                <div style="font-size:11px;color:var(--secondary);margin-bottom:4px;font-weight:bold;">  ():</div>
                <select id="promo-gift-in" style="margin:0 0 10px;width:100%;padding:10px 12px;height:44px;border-radius:12px;font-size:13px;">
                    <option value="">   </option>
                    <option value="nft_liz">  (NFT)</option>
                                        <option value="nft_pan">  (NFT)</option>
                    <option value="nft_beer">   (NFT)</option>
                    <option value="nft_sock">  (NFT)</option>
                    <option disabled></option>
                </select>
                <div style="display:flex;gap:8px;margin-bottom:10px;">
                    <select id="promo-gift-rarity" style="flex:1;margin:0;padding:6px 10px;height:40px;border-radius:12px;font-size:12px;">
                        <option value="0"> </option>
                        <option value="1"> </option>
                        <option value="2"> </option>
                        <option value="3"> </option>
                    </select>
                </div>
                <button class="btn" style="background:var(--accent);" onclick="createPromo()">  </button>
            </div>
            <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:10px;" id="promo-count-lbl"></div>
            <div id="promo-list"></div>
        </div>

        <!--  Tools  -->
        <div id="adm-tools" class="adm-section">
            <div style="display:flex;flex-direction:column;gap:10px;">
                <div class="tool-card">
                    <div class="tool-card-title">   </div>
                    <div style="display:flex;gap:8px;">
                        <input type="number" id="bcast-coins" placeholder=" " style="margin:0;flex:1;">
                        <button class="btn" style="background:var(--green);width:48px;padding:0;height:42px;flex-shrink:0;" onclick="broadcastCoins()"></button>
                    </div>
                </div>
                <div class="tool-card">
                    <div class="tool-card-title">   Telegram</div>
                    <textarea id="bcast-msg" placeholder=" ..." style="min-height:70px;margin-bottom:8px;resize:vertical;"></textarea>
                    <button class="btn" style="background:linear-gradient(90deg,#0088cc,#006bad);" onclick="broadcastMsg()">   TG</button>
                </div>
                <div class="tool-card">
                    <div class="tool-card-title">   </div>
                    <div style="display:flex;gap:8px;">
                        <select id="bcast-gift" style="flex:1;margin:0;height:42px;border-radius:12px;">${catalog ? catalog.map(x=>`<option value="${x.id}">${x.i} ${x.n}</option>`).join('') : ''}</select>
                        <button class="btn" style="background:var(--orange);width:48px;padding:0;height:42px;flex-shrink:0;" onclick="broadcastGift()"></button>
                    </div>
                </div>
                <div style="height:1px;background:rgba(255,255,255,0.06);"></div>
                <div class="tool-card">
                    <div class="tool-card-title"> </div>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <button class="btn" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);color:var(--secondary);text-align:left;padding:12px 14px;font-size:13px;" onclick="clearAllShowcases()">   </button>
                        <button class="btn" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);color:var(--secondary);text-align:left;padding:12px 14px;font-size:13px;" onclick="clearMarket()">   </button>
                    </div>
                </div>
                <div class="danger-zone">
                    <div class="danger-zone-title">  </div>
                    <button class="btn" style="background:rgba(231,76,60,0.1);border:1.5px solid rgba(231,76,60,0.4);color:#ff6b6b;font-weight:bold;text-align:left;padding:12px 14px;font-size:13px;" onclick="resetAndReissue()">   +    </button>
                </div>
            </div>
        </div>

        <!--  Sales Log  -->
        <div id="adm-sales" class="adm-section">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;">    </div>
                <div style="display:flex;align-items:center;gap:5px;background:rgba(46,204,113,0.08);border:1px solid rgba(46,204,113,0.2);border-radius:10px;padding:4px 10px;">
                    <span style="width:6px;height:6px;border-radius:50%;background:var(--green);display:inline-block;animation:pulse 1.5s infinite;"></span>
                    <span style="font-size:10px;color:var(--green);font-weight:bold;">Live</span>
                </div>
            </div>
            <div id="adm-sales-total" style="margin-bottom:12px;"></div>
            <div id="adm-sales-list"><div style="color:var(--secondary);text-align:center;padding:20px;">...</div></div>
        </div>

    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="tab('shop',this)"><i></i><span></span></button>
        <button class="nav-btn" onclick="tab('inv',this)"><div id="badge-inv" class="badge">0</div><div id="badge-merge" class="badge-merge">0</div><i></i><span></span></button>
        <button class="nav-btn" onclick="tab('market',this)"><i></i><span></span></button>
        <button class="nav-btn" onclick="tab('friends',this)"><div id="badge-fr" class="badge">0</div><i></i><span></span></button>
        <button class="nav-btn" id="duel-nav-btn" onclick="openDuelFromNav()" style="position:relative;"><div id="badge-duel" class="badge" style="right:8px;display:none;">0</div><i></i><span></span></button>
        <button class="nav-btn" onclick="tab('profile',this)"><i></i><span></span></button>
        <button id="adm-nav" class="nav-btn" style="display:none;color:var(--orange)" onclick="tab('admin',this)"><i></i><span></span></button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, push, remove, update, onDisconnect } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const config = {
        apiKey: "AIzaSyDK9IMy-DDNXvPcHv7uAjgZ8ZLdXUh8OCw",
        authDomain: "gift-1292c.firebaseapp.com",
        projectId: "gift-1292c",
        databaseURL: "https://gift-1292c-default-rtdb.firebaseio.com",
        appId: "1:527659513899:web:4023b323982425ad18526e"
    };
    const fb = initializeApp(config);
    const db = getDatabase(fb);
    let user = null, allUsersCache = {};

    const catalog = [
        {id:1, n:"", i:"", img:"https://em-content.zobj.net/source/apple/391/cookie_1f36a.png"},
        {id:2, n:"",     i:"", img:"https://em-content.zobj.net/source/apple/391/hot-beverage_2615.png"},
        {id:3, n:"",    i:"", img:"https://em-content.zobj.net/source/apple/391/pizza_1f355.png"},
        {id:4, n:"",   i:"", img:"https://em-content.zobj.net/source/apple/391/hamburger_1f354.png"},
        {id:5, n:"",     i:"", img:"https://em-content.zobj.net/source/apple/391/birthday-cake_1f382.png"},
        {id:6, n:"",    i:"", img:"https://em-content.zobj.net/source/apple/391/watermelon_1f349.png"},
        {id:7, n:"",    i:"", img:"https://em-content.zobj.net/source/apple/391/teddy-bear_1f9f8.png"},
        {id:8, n:"",     i:"", img:"https://em-content.zobj.net/source/apple/391/rose_1f339.png"},
        {id:9, n:"",    i:"", img:"https://em-content.zobj.net/source/apple/391/bouquet_1f490.png"},
        {id:10,n:"",   i:"", img:"https://em-content.zobj.net/source/apple/391/guitar_1f3b8.png"},
        {id:11,n:"",   i:"", img:"https://em-content.zobj.net/source/apple/391/ring_1f48d.png"},
        {id:12,n:"", i:"", img:"https://em-content.zobj.net/source/apple/391/gem-stone_1f48e.png"},
        {id:13,n:"",   i:"", img:"https://em-content.zobj.net/source/apple/391/crown_1f451.png"},
        {id:14,n:"", i:"",img:"https://em-content.zobj.net/source/apple/391/racing-car_1f3ce-fe0f.png"},
        {id:15,n:"",     i:"",img:"https://em-content.zobj.net/source/apple/391/motor-boat_1f6e5-fe0f.png"},
        {id:16,n:"",   i:"", img:"https://em-content.zobj.net/source/apple/391/rocket_1f680.png"},
        {id:17,n:"",   i:"",img:"https://em-content.zobj.net/source/apple/391/desert-island_1f3dd-fe0f.png"},
        {id:18,n:"",      i:"", img:"https://em-content.zobj.net/source/apple/391/cat-face_1f431.png"},
        {id:19,n:"",    i:"", img:"https://em-content.zobj.net/source/apple/391/panda_1f43c.png"},
        {id:20,n:"",     i:"", img:"./img_1.png"},
        {id:21,n:" ",  i:"", img:"./img_2.png"},
        {id:22,n:"",   i:"", img:"https://em-content.zobj.net/source/apple/391/four-leaf-clover_1f340.png"},
        {id:23,n:"",    i:"", img:"https://em-content.zobj.net/source/apple/391/trophy_1f3c6.png"},
        {id:24,n:"", i:"", img:"https://em-content.zobj.net/source/apple/391/video-game_1f3ae.png"},
        {id:25,n:"",      i:"", img:"./img_3.png"},
        {id:26,n:"",    i:"", img:"https://em-content.zobj.net/source/apple/391/game-die_1f3b2.png"},
        {id:27,n:"",    i:"", img:"https://em-content.zobj.net/source/apple/391/coin_1fa99.png"},
        {id:28,n:" ", i:"", img:"./img_4.png"},
        {id:29,n:"",  i:"", img:"https://em-content.zobj.net/source/apple/391/ringed-planet_1fa90.png"},
        {id:30,n:"",i:"", img:"https://em-content.zobj.net/source/apple/391/milky-way_1f30c.png"}
    ];

    const COSMETICS = [
        {id:'pfx_star',    type:'prefix', val:'', name:'',     price:500,  unlock:null},
        {id:'pfx_fire',    type:'prefix', val:'', name:'',      price:800,  unlock:null},
        {id:'pfx_bolt',    type:'prefix', val:'', name:'',     price:800,  unlock:null},
        {id:'pfx_crown',   type:'prefix', val:'', name:'',     price:2000, unlock:null},
        {id:'pfx_gem',     type:'prefix', val:'', name:'',  price:3000, unlock:null},
        {id:'pfx_rainbow', type:'prefix', val:'', name:'',     price:1500, unlock:null},
        {id:'pfx_skull',   type:'prefix', val:'', name:'',      price:1200, unlock:null},
        {id:'pfx_alien',   type:'prefix', val:'', name:'',   price:1000, unlock:null},
        {id:'col_blue',    type:'color',  val:'#5dade2', name:'',      price:300,  unlock:null},
        {id:'col_green',   type:'color',  val:'#2ecc71', name:'',    price:300,  unlock:null},
        {id:'col_purple',  type:'color',  val:'#a29bfe', name:'', price:500,  unlock:null},
        {id:'col_orange',  type:'color',  val:'#f39c12', name:'',  price:500,  unlock:null},
        {id:'col_pink',    type:'color',  val:'#fd79a8', name:'',    price:700,  unlock:null},
        {id:'col_gold',    type:'color',  val:'#ffd700', name:'',    price:2500, unlock:null},
        {id:'col_red',     type:'color',  val:'#e74c3c', name:'',    price:700,  unlock:null},
        {id:'bdg_rich',    type:'badge',  val:'', name:'',       price:0, unlock:'spent10k',  unlockDesc:' 10 000 '},
        {id:'bdg_social',  type:'badge',  val:'', name:'',  price:0, unlock:'friends10', unlockDesc:' 10 '},
        {id:'bdg_gifter',  type:'badge',  val:'', name:'',    price:0, unlock:'gifts10',   unlockDesc:' 10 '},
        {id:'bdg_duelist', type:'badge',  val:'', name:'',     price:0, unlock:'duel10',    unlockDesc:'  10 '},
        {id:'bdg_og',      type:'badge',  val:'', name:'OG',          price:5000, unlock:null},
        {id:'bdg_vip',     type:'badge',  val:'', name:'VIP',         price:8000, unlock:null},
    ];

    const ADMIN_IDS = new Set(['ckovoroda','kukumbr']);
    const MOD_IDS = new Set(['batlukov','nowkie']);
    const MOD_PREFIXES = { batlukov: ' ', nowkie: ' ' };

    function buildUsername(d, uid) {
        const resolvedId = uid || (typeof d.username === 'string' ? d.username.toLowerCase() : '');
        const isAdmin = ADMIN_IDS.has(resolvedId);
        const active = d.activeCosmetic || {};
        const pfx = active.prefix ? COSMETICS.find(c=>c.id===active.prefix) : null;
        const col = active.color  ? COSMETICS.find(c=>c.id===active.color)  : null;
        const bdg = active.badge  ? COSMETICS.find(c=>c.id===active.badge)  : null;

        // Admin gets rainbow "ADMIN" prefix instead of regular prefix
        const isMod = MOD_IDS.has(resolvedId);
        const prefix = isAdmin
            ? `<span class="admin-rainbow-prefix">ADMIN</span>`
            : isMod
            ? `<span style="background:rgba(162,155,254,0.18);color:#a29bfe;font-size:10px;padding:2px 7px;border-radius:8px;font-weight:bold;margin-right:3px;">${MOD_PREFIXES[resolvedId]||'MOD'}</span>`
            : (pfx ? `<span class="cosm-prefix">${pfx.val}</span>` : '');

        const badge  = bdg ? `<span class="cosm-badge" style="background:rgba(255,255,255,0.08);">${bdg.val} ${bdg.name}</span>` : '';
        // Shimmer class  id 
        const shimmerMap = {
            'col_blue':   'shimmer-blue',
            'col_green':  'shimmer-green',
            'col_purple': 'shimmer-purple',
            'col_orange': 'shimmer-orange',
            'col_pink':   'shimmer-pink',
            'col_gold':   'shimmer-gold',
            'col_red':    'shimmer-red',
        };
        let nameEl;
        if (isAdmin) {
            nameEl = `<span class="name-shimmer shimmer-green">@${d.username}</span>`;
        } else if (isMod) {
            nameEl = `<span class="name-shimmer shimmer-purple">@${d.username}</span>`;
        } else if (col && shimmerMap[col.id]) {
            nameEl = `<span class="name-shimmer ${shimmerMap[col.id]}">@${d.username}</span>`;
        } else if (col) {
            nameEl = `<span style="color:${col.val};">@${d.username}</span>`;
        } else {
            nameEl = `<span>@${d.username}</span>`;
        }

        // Lizard badge  shown if user owns NFT_LIZARD (id 997)
        const hasLizard = (d.cloudInv||[]).some(x => x.id === 997);
        const lizard = hasLizard ? `<span class="lizard-badge"></span>` : '';

        return `${prefix}${nameEl}${badge}${lizard}`;
    }

    function checkUnlocks(d) {
        const owned = new Set(d.cosmetics || []);
        const unlocked = [];
        const spent = d.totalSpent || 0;
        const friendCount = Object.keys(d.friends || {}).length;
        const giftsGiven = d.giftsGiven || 0;
        if(spent >= 10000 && !owned.has('bdg_rich')) unlocked.push('bdg_rich');
        if(friendCount >= 10 && !owned.has('bdg_social')) unlocked.push('bdg_social');
        if(giftsGiven >= 10 && !owned.has('bdg_gifter')) unlocked.push('bdg_gifter');
        if((d.duelWins||0) >= 10 && !owned.has('bdg_duelist')) unlocked.push('bdg_duelist');
        return unlocked;
    }


        function giftImg(x, size='normal') {
        const isPony = (x && x.id == 20);
        const cls = size === 'sm' ? 'gift-img-sm' : 'gift-img';
        const fs = size === 'sm' ? '30' : '46';
        //     id      
        const xid = x && (x.id !== undefined && x.id !== null) ? x.id : null;
        const cat = xid !== null ? catalog.find(c => c.id == xid) : null;
        const img = (x&&x.imgKey==='pan'?PAN_IMG:null) || (x && x.img) || (cat && cat.img) || null;
        const emoji = (x && x.i) || (cat && cat.i) || '';
        if(size !== 'sm') {
                const inner = img
                ? `<img src="${img}" class="${cls}${isPony?' gift-img-pony':''}" alt="${(x&&x.n)||''}" onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'${emoji}',style:'font-size:${fs}px;display:block;text-align:center;'}))">`
                : `<span style="font-size:${fs}px;display:block;text-align:center;">${emoji}</span>`;
            return `<div class="gift-img-wrap">${inner}</div>`;
        }
        if(img) return `<img src="${img}" class="${cls}" alt="${(x&&x.n)||''}" onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'${emoji}',style:'font-size:${fs}px;display:block;text-align:center;margin-bottom:8px;'}))">`;
        return `<span style="font-size:${fs}px;display:block;text-align:center;margin-bottom:8px;">${emoji}</span>`;
    }

    // Fill broadcast gift select
    document.getElementById('bcast-gift').innerHTML = catalog.map(x=>`<option value="${x.id}">${x.i} ${x.n}</option>`).join('');
    // Fill promo gift select with catalog items
    const promoGiftSel = document.getElementById('promo-gift-in');
    if(promoGiftSel) {
        catalog.forEach(x=>{
            const opt = document.createElement('option');
            opt.value = x.id;
            opt.textContent = `${x.i} ${x.n}`;
            promoGiftSel.appendChild(opt);
        });
    }

    async function getIP() { try { const r = await fetch('https://api.ipify.org?format=json'); return (await r.json()).ip; } catch(e) { return "1.1.1.1"; } }
    const BASE_PRICE = 1500;
    const PRICE_MIN = 57;
    const PRICE_MAX = 2100;
    let _shopPriceCache = {}; // { [id]: { price, buyCount } }
    let _sessionPrice = {};   //      ( )
    let _pricesLoaded = false;

    async function loadShopPrices() {
        try {
            const snap = await get(ref(db, 'shopPrices'));
            const raw = snap.exists() ? (snap.val() || {}) : {};
            for (const key in raw) {
                const id = key.replace('i_', '');
                const val = raw[key];
                if (typeof val === 'number') {
                    //  
                    const p = Math.max(BASE_PRICE, BASE_PRICE + Math.min(val * 15, 800));
                    _shopPriceCache[id] = { price: p, buyCount: val };
                } else if (val && typeof val === 'object') {
                    const p = Math.max(PRICE_MIN, val.price || BASE_PRICE);
                    _shopPriceCache[id] = { price: p, buyCount: val.buyCount || 0 };
                }
            }
        } catch(e) {}

        //  sessionPrice        (    Firebase)
        if (!_pricesLoaded) {
            _pricesLoaded = true;

            //     localStorage (   )
            let savedPrices = {};
            try {
                const raw = localStorage.getItem('gifts_prev_prices');
                if (raw) savedPrices = JSON.parse(raw);
            } catch(e) {}

            for (const c of catalog) {
                const sid = String(c.id);
                const curPrice = getPrice(sid);
                //            ""
                _sessionPrice[sid] = (savedPrices[sid] !== undefined) ? savedPrices[sid] : curPrice;
            }

            //     ""   
            const toSave = {};
            for (const c of catalog) {
                toSave[String(c.id)] = getPrice(String(c.id));
            }
            try { localStorage.setItem('gifts_prev_prices', JSON.stringify(toSave)); } catch(e) {}
        }
    }

    function getPrice(id) {
        const entry = _shopPriceCache[String(id)];
        if (!entry) return BASE_PRICE;
        return Math.max(PRICE_MIN, Math.min(PRICE_MAX, entry.price || BASE_PRICE));
    }

    function getPrevPrice(id) {
        const sid = String(id);
        return _sessionPrice[sid] !== undefined ? _sessionPrice[sid] : getPrice(sid);
    }

    async function incrementShopPrice(id) {
        const sid = String(id);
        const curPrice = getPrice(sid);
        const buyCount = (_shopPriceCache[sid]?.buyCount || 0) + 1;
        const newPrice = Math.min(PRICE_MAX, curPrice + 1);

        _shopPriceCache[sid] = { price: newPrice, buyCount };
        const updates = { ['i_' + sid]: { price: newPrice, buyCount } };

        //   -1
        for (const c of catalog) {
            const cid = String(c.id);
            if (cid === sid) continue;
            const cp = getPrice(cid);
            if (cp <= PRICE_MIN) continue;
            const np = Math.max(PRICE_MIN, cp - 1);
            const bc = _shopPriceCache[cid]?.buyCount || 0;
            _shopPriceCache[cid] = { price: np, buyCount: bc };
            updates['i_' + cid] = { price: np, buyCount: bc };
        }

        try { await update(ref(db, 'shopPrices'), updates); } catch(e) {}
    }
    function flyEmoji(emoji, x, y) {
        const el = document.createElement('div'); el.className='fly-emoji'; el.innerText=emoji;
        el.style.left=(x-18)+'px'; el.style.top=(y-18)+'px';
        document.body.appendChild(el); setTimeout(()=>el.remove(),1000);
    }
    // Detect low-end device (less than 4 logical cores or slow connection)
    const isLowEndDevice = (navigator.hardwareConcurrency || 4) <= 2;
    function spawnConfetti(x, y, count=22) {
        if(isLowEndDevice) count = Math.min(count, 10);
        const colors=['#ffd700','#ff6b6b','#4ecdc4','#45b7d1','#96ceb4','#ff9f43','#a29bfe','#fd79a8'];
        for(let i=0;i<count;i++){
            const el=document.createElement('div'); el.className='confetti-piece';
            el.style.left=(x+(Math.random()-.5)*60)+'px'; el.style.top=(y-10)+'px';
            el.style.background=colors[Math.floor(Math.random()*colors.length)];
            el.style.borderRadius=Math.random()>.5?'50%':'2px';
            el.style.width=(6+Math.random()*8)+'px'; el.style.height=(6+Math.random()*8)+'px';
            el.style.animationDuration=(0.9+Math.random()*0.8)+'s';
            el.style.animationDelay=(Math.random()*0.2)+'s';
            document.body.appendChild(el); setTimeout(()=>el.remove(),2000);
        }
    }
    function flashBalance() {
        const el=document.getElementById('u-bal');
        el.classList.remove('balance-flash'); void el.offsetWidth; el.classList.add('balance-flash');
        setTimeout(()=>el.classList.remove('balance-flash'),700);
    }
    window.showToast = (msg, color='var(--accent)', icon='') => {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        el.className = 'toast-item';
        // Determine icon and border color based on color
        let ico = icon;
        let borderColor = color;
        if (!ico) {
            if (color.includes('green') || color === '#2ecc71') ico = '';
            else if (color.includes('err') || color === '#e74c3c') ico = '';
            else if (color === 'gold') ico = '';
            else if (color.includes('orange') || color === '#f39c12') ico = '';
            else ico = '';
        }
        el.style.borderLeftColor = borderColor;
        el.innerHTML = `<span style="font-size:18px;flex-shrink:0;">${ico}</span><span>${msg}</span>`;
        container.appendChild(el);
        // Force reflow then animate in
        requestAnimationFrame(() => { requestAnimationFrame(() => el.classList.add('show')); });
        setTimeout(() => {
            el.classList.remove('show');
            el.classList.add('hide');
            setTimeout(() => el.remove(), 400);
        }, 2800);
    };

    // Beautiful confirm dialog
    let confirmResolver = null;
    window.showConfirm = (title, msg, icon='', okColor='var(--err)', okText='') => {
        return new Promise(resolve => {
            confirmResolver = resolve;
            document.getElementById('confirm-icon').innerText = icon;
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = msg;
            document.getElementById('confirm-ok').style.background = okColor;
            document.getElementById('confirm-ok').innerText = okText;
            const ov = document.getElementById('confirm-overlay');
            ov.style.display = 'flex';
            requestAnimationFrame(() => ov.style.background = 'rgba(0,0,0,0.88)');
        });
    };
    window.resolveConfirm = (val) => {
        const ov = document.getElementById('confirm-overlay');
        ov.style.background = 'rgba(0,0,0,0)';
        setTimeout(() => { ov.style.display = 'none'; }, 300);
        if (confirmResolver) { confirmResolver(val); confirmResolver = null; }
    };

    window.closeModal = () => {
        const ov = document.getElementById('modal-overlay');
        ov.style.background = 'rgba(0,0,0,0)';
        setTimeout(() => { ov.style.display = 'none'; }, 300);
    };
    function openModal() {
        const ov = document.getElementById('modal-overlay');
        ov.style.display = 'flex';
        requestAnimationFrame(() => ov.style.background = 'rgba(0,0,0,0.88)');
    }
    window.switchAuthTab = (tab) => {
        const isLogin = tab === 'login';
        document.getElementById('form-login').classList.toggle('active', isLogin);
        document.getElementById('form-reg').classList.toggle('active', !isLogin);
        document.getElementById('tab-login').classList.toggle('active', isLogin);
        document.getElementById('tab-login').classList.remove('green');
        document.getElementById('tab-reg').classList.toggle('active', !isLogin);
        if(!isLogin) document.getElementById('tab-reg').classList.add('green');
        // clear errors
        document.getElementById('l-err').innerText='';
        document.getElementById('r-err').innerText='';
    };
    window.clearAuthErr = (id) => { const el=document.getElementById(id); if(el) el.innerText=''; };

    let checkUsernameTimer = null;
    window.checkUsername = (val) => {
        clearAuthErr('r-err');
        const st = document.getElementById('r-user-status');
        const v = val.trim().toLowerCase();
        if(!v) { st.innerText=''; return; }
        if(v.length < 3) { st.innerText=''; return; }
        clearTimeout(checkUsernameTimer);
        st.innerText='';
        checkUsernameTimer = setTimeout(async () => {
            const s = await get(ref(db,'users/'+v));
            st.innerText = s.exists() ? '' : '';
        }, 500);
    };
    window.auth = async (type) => {
        if(type==='login') {
            const u=document.getElementById('l-user').value.trim().toLowerCase();
            const p=document.getElementById('l-pass').value.trim();
            const errEl=document.getElementById('l-err');
            if(!u||!p){ errEl.innerText='  '; return; }
            const s=await get(ref(db,'users/'+u));
            if(s.exists()&&s.val().password==p){ loginOk(s.val().username,u); }
            else { errEl.innerText='    '; document.getElementById('l-pass').value=''; }
        } else {
            const u=document.getElementById('r-user').value.trim().toLowerCase();
            const p=document.getElementById('r-pass').value.trim();
            const errEl=document.getElementById('r-err');
            if(!u||!p){ errEl.innerText='  '; return; }
            if(u.length<3){ errEl.innerText='   3 '; return; }
            if(p.length<4){ errEl.innerText='   4 '; return; }
            const ip=await getIP(), ipKey=ip.replace(/\./g,'_'), r=ref(db,'users/'+u), s=await get(r);
            if(s.exists()){ errEl.innerText='    '; return; }
            const ipsS=await get(ref(db,'ips/'+ipKey));
            if(ipsS.exists()&&Object.keys(ipsS.val()).length>=3){ errEl.innerText='   IP  3 '; return; }
            await set(r,{username:u,password:p,balance:1000,cloudInv:[],pinnedInsts:[],pic:"",bio:"",ip});
            await update(ref(db,`ips/${ipKey}`),{[u]:true});
            spawnConfetti(window.innerWidth/2, window.innerHeight/2, 30);
            loginOk(u,u);
        }
    };

    function loginOk(name,id){localStorage.setItem('gifts_user',JSON.stringify({name,id}));startApp(name,id);}

    async function giveNftToCkovoroda() {
        // NFT   
    }

    function startApp(name,id) {
        user={name,id,isAdm:(id==='ckovoroda'||id==='kukumbr'),isMod:MOD_IDS.has(id)};
        document.getElementById('auth-screen').style.display='none'; document.getElementById('auth-screen').style.minHeight='0';
        document.getElementById('app').style.display='block';
        if(user.isAdm){document.getElementById('adm-nav').style.display='flex';initAdmin();}
        //  NFT   ckovoroda ( )
        if(id==='ckovoroda'){
            (async()=>{
                const _r=ref(db,'users/ckovoroda'),_s=await get(_r),_d=_s.val();
                const _inv=(_d&&_d.cloudInv)||[];
                if(!_inv.some(x=>x.id===996&&x.nft)){
                    const _serial=await getNextNftSerial();
                    const _p={...NFT_PAN};delete _p.img;_inv.push({..._p,inst:Date.now(),seen:false,nftSerial:_serial,from:' '});
                    await update(_r,{cloudInv:_inv});
                }
            })();
        }
        else if(user.isMod){document.getElementById('adm-nav').style.display='flex';initAdminMod();}

        // === PRESENCE (-) ===
        const presenceRef = ref(db, 'presence/' + id);
        const connectedRef = ref(db, '.info/connected');
        onValue(connectedRef, snap => {
            if (snap.val() === true) {
                set(presenceRef, { online: true, lastSeen: Date.now() });
                onDisconnect(presenceRef).set({ online: false, lastSeen: Date.now() });
            }
        });

        onValue(ref(db,'users/'+id),s=>{
            const d=s.val(); if(!d) return;
            document.getElementById('header-name').innerHTML=buildUsername(d);
            document.getElementById('u-bal').innerText=d.balance;
            renderFriends(d); renderMyProfile(d);
            //  Unseen gifts badge
            const inv=d.cloudInv||[];
            const unseen=inv.filter(x=>!x.seen).length;
            const bInv=document.getElementById('badge-inv');
            bInv.innerText=unseen; bInv.style.display=unseen>0?'flex':'none';
            //  Merge badge
            const mergeCount=getMergeable(inv).length;
            const bMerge=document.getElementById('badge-merge');
            bMerge.innerText=mergeCount; bMerge.style.display=mergeCount>0?'flex':'none';
        });
        renderShop(); listenMarket(); giveNftToCkovoroda(); listenTradeOffers(); listenDuelChallenges();
        //    Firebase   
        loadShopPrices().then(() => renderShopCards());
        // Auto-refresh shop when active
        setInterval(async ()=>{
            const shopCards = document.getElementById('shop-cards');
            if(shopCards && document.getElementById('shop').classList.contains('active')) {
                await loadShopPrices();
                renderShopCards();
            }
        }, 15000);
    }


    window.usePromo = async () => {
        const code = document.getElementById('promo-input')?.value?.trim().toUpperCase();
        if(!code) return showToast(" !",'var(--err)');
        const ps = await get(ref(db,'promos/'+code));
        if(!ps.exists()) return showToast("  !",'var(--err)');
        const promo = ps.val();
        if(promo.usedBy && promo.usedBy[user.id]) return showToast(" !",'var(--err)');
        if(promo.maxUses && (promo.useCount||0) >= promo.maxUses) return showToast(" !",'var(--err)');
        const r=ref(db,'users/'+user.id), us=await get(r);
        const updates = { balance: us.val().balance + (promo.reward||0) };
        // Support new giftObj (full item) and legacy gift (emoji string)
        if(promo.giftObj) {
            const inv = us.val().cloudInv||[];
            const serial = await getNextNftSerial();
            const _g={...promo.giftObj};if(_g.img&&_g.img.startsWith('data:'))delete _g.img;inv.push({..._g, inst:Date.now(), from:"PROMO", seen:false, nftSerial:serial});
            updates.cloudInv = inv;
        } else if(promo.gift) {
            const itm = catalog.find(x=>x.i===promo.gift)||{id:0,n:"",i:promo.gift};
            const inv = us.val().cloudInv||[];
            inv.push({...itm, inst:Date.now(), from:"PROMO", seen:false});
            updates.cloudInv = inv;
        }
        await update(r, updates);
        await update(ref(db,'promos/'+code), {
            useCount: (promo.useCount||0)+1,
            [`usedBy/${user.id}`]: true
        });
        spawnConfetti(window.innerWidth/2, window.innerHeight/2, 30);
        flashBalance();
        const giftMsg = (promo.giftObj ? ` +  ${promo.giftObj.n}` : (promo.gift ? ` + ${promo.gift}` : ''));
        showToast(`  ! +${promo.reward||0}${giftMsg}`,'var(--green)');
        logActivity('promo', {user: user.name, userId: user.id, code, reward: promo.reward||0, gift: promo.giftObj?.n || promo.gift || null});
        closeModal();
    };
    window.togglePin = async (inst) => {
        const r=ref(db,'users/'+user.id),s=await get(r),d=s.val();
        const cloudInv=d.cloudInv||[];
        let pinnedInsts=(d.pinnedInsts||[]).filter(id=>cloudInv.some(x=>String(x.inst)==String(id)));
        const isP=pinnedInsts.some(id=>String(id)==String(inst));
        if(isP){pinnedInsts=pinnedInsts.filter(id=>String(id)!=String(inst));showToast("","var(--secondary)");}
        else{
            if(pinnedInsts.length>=5)return showToast(". 5 !",'var(--err)');
            if(!cloudInv.find(x=>String(x.inst)==String(inst)))return showToast("  ",'var(--err)');
            pinnedInsts.push(String(inst));showToast(" !",'var(--orange)');
        }
        await update(r,{pinnedInsts});
        const fresh=await get(r); if(fresh.exists()) { renderMyProfile(fresh.val()); renderInv(); }
    };

    window.sellItem = async (inst, reward) => {
        const r = ref(db, 'users/' + user.id);
        const s = await get(r), d = s.val();
        const inv = d.cloudInv || [];
        const item = inv.find(x => String(x.inst) === String(inst));
        if (!item) return showToast('  !', 'var(--err)');
        const ok = await showConfirm(
            ' ',
            `"${item.n}"    .   ${reward.toLocaleString()}  (50%  ).`,
            '', 'var(--err)', ''
        );
        if (!ok) return;
        const newInv = inv.filter(x => String(x.inst) !== String(inst));
        const newBalance = (d.balance || 0) + reward;
        await update(r, { cloudInv: newInv, balance: newBalance });
        showToast(` ! +${reward.toLocaleString()} `, 'var(--green)');
        logActivity('sell_item', {user: user.name, userId: user.id, item: item.n, emoji: item.i||'', reward});
        renderInv();
    };

        window.renderInv = async () => {
        const s=await get(ref(db,'users/'+user.id)),d=s.val(),inv=d.cloudInv||[];
        const upd=inv.map(x=>({...x,seen:true}));
        await update(ref(db,'users/'+user.id),{cloudInv:upd});
        
        const searchVal = document.getElementById('inv-search')?.value?.toLowerCase() || '';
        const filtered = searchVal ? upd.filter(x=>x.n.toLowerCase().includes(searchVal)) : upd;
        
        const pinnedInsts2 = new Set((d.pinnedInsts||[]).map(String));
        const sortedFiltered = [
            ...filtered.filter(x => pinnedInsts2.has(String(x.inst))),
            ...filtered.filter(x => !pinnedInsts2.has(String(x.inst)))
        ];
        // Use new rarity system
        const mergeableIds = new Set(getMergeable(upd).map(g => `${g.items[0].id}_${getRarityLevel(g.items[0])}`));

        const cardsHtml = sortedFiltered.length ? sortedFiltered.map(x=>{
            const isNFT = !!x.nft;
            const isPinned2 = pinnedInsts2.has(String(x.inst));
            const rarObj = getRarityObj(x);
            const rarLevel = getRarityLevel(x);
            const isMergeReady = mergeableIds.has(`${x.id}_${rarLevel}`) && !isNFT;

            // Card style based on rarity
            let cardExtraClass = rarObj.cardCls;
            let cardStyle = '';
            if(isPinned2 && !isNFT && rarLevel===0) cardStyle = 'border:1.5px solid rgba(243,156,18,0.5);box-shadow:0 2px 12px rgba(243,156,18,0.15);';

            const rarHtml = isNFT
                ? `<span class="rarity-nft" style="font-size:10px;margin-bottom:4px;display:block;"> NFT  </span>`
                : `<span class="${rarObj.cls}" style="margin-bottom:4px;display:block;">${rarObj.icon} ${rarObj.label}</span>`;

            const pinBadge = isPinned2 ? `<div style="position:absolute;top:6px;left:7px;font-size:13px;filter:drop-shadow(0 1px 3px rgba(0,0,0,0.7));z-index:4;"></div>` : '';
            const nftBadge = isNFT ? `<div style="position:absolute;top:7px;right:7px;background:linear-gradient(90deg,#b8860b,#ffd700);color:#000;font-size:9px;font-weight:bold;border-radius:10px;padding:2px 7px;z-index:4;">NFT</div>` : '';
            const nameStyle = isNFT ? 'background:linear-gradient(90deg,#ffd700,#ffb347,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:bold;' : '';
            const serialNum = x.nftSerial ? `${x.nftSerial}` : (x.inst ? `#${String(x.inst).slice(-6)}` : '');
            const serialBadge = serialNum ? `<div class="nft-id-badge${isNFT?' nft':''}${x.nftSerial?'':' common-id'}">${serialNum}</div>` : '';
            const mergeBadge = isMergeReady ? `<div class="merge-count-badge ready" title=" !"></div>` : '';

            const baseMarketPrice = isNFT ? (x.id===997?7000:x.id===998?10000:x.id===999?5000:(x.price||0)) : getPrice(x.id||0);
            const rarMultiplier = isNFT ? 1 : ([1, 2, 5, 15][rarLevel] || 1);
            const sellPrice = Math.round(baseMarketPrice * rarMultiplier);
            const sellReward = Math.floor(sellPrice / 2);
            return `<div class="card ${cardExtraClass}${isMergeReady?' merge-ready':''}" style="display:flex;flex-direction:column;align-items:center;position:relative;${cardStyle}">
                ${pinBadge}${nftBadge}${mergeBadge}${serialBadge}
                <button class="sell-btn" onclick="sellItem('${x.inst}',${sellReward})" title="  ${sellReward} "></button>
                ${x.from?`<small style="color:var(--orange);margin-bottom:4px;">: ${x.from}</small>`:''}
                ${giftImg(x)}
                <b style="display:block;text-align:center;margin-bottom:2px;${nameStyle}">${x.n}</b>
                ${rarHtml}
                <button class="btn" style="font-size:11px;background:var(--green)" onclick="giftOpen('${x.inst}')"> </button>
                <button class="btn" style="margin-top:5px;font-size:11px;background:var(--accent)" onclick="toMarket('${x.inst}')"> </button>
                ${isMergeReady?`<button class="btn merge-btn" style="margin-top:5px;" onclick="openMergeModal()"> !</button>`:''}
                <button class="btn" style="margin-top:5px;font-size:11px;background:${isPinned2?'var(--secondary)':'var(--orange)'}" onclick="togglePin('${x.inst}')">${isPinned2?' ':' '}</button>
            </div>`;
        }).join('') : `<div style="grid-column:1/-1;text-align:center;color:var(--secondary);padding:30px;">${searchVal?'   ':' '}</div>`;

        const mergeableCount = getMergeable(upd).length;
        const mergeBannerHtml = mergeableCount > 0 ? `
            <div style="grid-column:1/-1;background:linear-gradient(135deg,#120d2e,#1a0e3a);border:1.5px solid rgba(162,155,254,0.45);border-radius:18px;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:5px;">
                <div>
                    <div style="font-weight:bold;color:#a29bfe;font-size:14px;">  !</div>
                    <div style="font-size:12px;color:var(--secondary);margin-top:2px;">${mergeableCount}    </div>
                </div>
                <button class="btn merge-btn" style="width:auto;padding:10px 16px;" onclick="openMergeModal()"> </button>
            </div>` : '';

        document.getElementById('inv').innerHTML = `
            <div class="search-filter-bar">
                <input type="text" id="inv-search" placeholder="   ..." oninput="renderInv()" value="${searchVal}">
                <span style="color:var(--secondary);font-size:12px;white-space:nowrap;align-self:center;">${upd.length} .</span>
            </div>
            ${mergeBannerHtml}
            ${cardsHtml}
        `;
    };


    const NFT_BEER={id:998,n:" ",i:"",img:"https://em-content.zobj.net/source/apple/391/beer-mug_1f37a.png",nft:true,price:10000};
    const NFT_SOCK={id:999,n:"",i:"",img:"https://em-content.zobj.net/source/apple/391/socks_1f9e6.png",nft:true,price:5000};
    const NFT_LIZARD={id:997,n:"",i:"",img:"https://em-content.zobj.net/source/apple/391/lizard_1f98e.png",nft:true,price:7000};
    const NFT_PAN={id:996,n:"",i:"",imgKey:"pan",nft:true,price:5000};
    const PAN_IMG="./img_5.png";
    // NFT_23FEB deprecated - using NFT_BEER and NFT_SOCK separately

    // ===== RARITY SYSTEM =====
    const RARITY_LEVELS = [
        {id:0, label:"",     cls:"rarity-common",    cardCls:"",              icon:""},
        {id:1, label:"",      cls:"rarity-rare",      cardCls:"card-rare",     icon:""},
        {id:2, label:"",   cls:"rarity-epic",      cardCls:"card-epic",     icon:""},
        {id:3, label:"", cls:"rarity-legendary", cardCls:"card-legendary",icon:""},
        {id:4, label:"NFT",         cls:"rarity-nft",       cardCls:"nft-card",      icon:""},
    ];
    function getRarityLevel(item) { if(item.nft) return 4; return item.rarity||0; }
    function getRarityObj(item) { return RARITY_LEVELS[getRarityLevel(item)]||RARITY_LEVELS[0]; }

    async function getNextNftSerial() {
        const r=ref(db,"nft_counter"),snap=await get(r),next=(snap.val()||1000)+1;
        await set(r,next); return next;
    }

    function getMergeable(inv) {
        const groups={};
        inv.forEach(item=>{
            if(!item.id) return;
            const rarity=getRarityLevel(item);
            if(rarity>=4) return;
            const key=`${item.id}_${rarity}`;
            if(!groups[key]) groups[key]=[];
            groups[key].push(item);
        });
        return Object.entries(groups).filter(([,items])=>items.length>=3).map(([key,items])=>({key,items,count:items.length}));
    }

    window.openMergeModal = async () => {
        const s=await get(ref(db,"users/"+user.id)),d=s.val(),inv=d.cloudInv||[];
        const groups=getMergeable(inv);
        if(!groups.length){showToast("   !  3 .","var(--secondary)");return;}
        const html=groups.map(g=>{
            const item=g.items[0],cat=catalog.find(c=>c.id==item.id);
            const img=(item.imgKey==='pan'?PAN_IMG:null)||item.img||(cat&&cat.img),emoji=item.i||(cat&&cat.i)||"";
            const currentRar=getRarityObj(item),nextRar=RARITY_LEVELS[Math.min(getRarityLevel(item)+1,4)];
            const sets=Math.floor(g.count/3);
            return `<div style="background:#120d2e;border:1.5px solid rgba(162,155,254,0.35);border-radius:18px;padding:14px;margin-bottom:12px;display:flex;align-items:center;gap:14px;">
                <div style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;flex-shrink:0;background:rgba(255,255,255,0.05);border-radius:14px;">
                    ${img?`<img src="${img}" style="width:50px;height:50px;object-fit:contain;">`:`<span style="font-size:34px;">${emoji}</span>`}
                </div>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:bold;font-size:13px;margin-bottom:3px;">${item.n}</div>
                    <div style="font-size:11px;margin-bottom:6px;"><span class="${currentRar.cls}">${currentRar.icon} ${currentRar.label}</span><span style="color:#a29bfe;margin:0 5px;"></span><span class="${nextRar.cls}">${nextRar.icon} ${nextRar.label}</span></div>
                    <div style="font-size:11px;color:var(--secondary);"> : ${g.count} .  : ${sets}</div>
                </div>
                <button class="btn merge-btn" style="width:auto;padding:9px 12px;font-size:12px;flex-shrink:0;" onclick="doMerge(${item.id},${getRarityLevel(item)})">  3</button>
            </div>`;
        }).join("");
        document.getElementById("modal-content").innerHTML=`
            <h3 style="color:#a29bfe;margin-bottom:4px;">  </h3>
            <p style="color:var(--secondary);font-size:12px;margin:0 0 14px;"> 3     !</p>
            <div style="background:#0d0a1a;border-radius:14px;padding:10px;margin-bottom:14px;font-size:11px;color:var(--secondary);">             NFT</div>
            ${html}
            <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);margin-top:5px;" onclick="closeModal()"></button>`;
        openModal();
    };

    window.doMerge = async (itemId, currentRarity) => {
        const r=ref(db,"users/"+user.id),s=await get(r),d=s.val();
        let inv=d.cloudInv||[];
        const matching=inv.filter(x=>x.id==itemId&&getRarityLevel(x)===currentRarity);
        if(matching.length<3) return showToast("  3 !","var(--err)");
        const toRemove=matching.slice(0,3).map(x=>x.inst);
        inv=inv.filter(x=>!toRemove.includes(x.inst));
        const baseItem={...matching[0]},newRarity=Math.min(currentRarity+1,4);
        const rarObj=RARITY_LEVELS[newRarity],newSerial=await getNextNftSerial();
        const isNewNft=newRarity>=4;
        const upgradedItem={...baseItem,rarity:newRarity,nftSerial:newSerial,inst:Date.now(),seen:true,from:" "};
        if(isNewNft){upgradedItem.nft=true;delete upgradedItem.rarity;}
        inv.push(upgradedItem);
        await update(r,{cloudInv:inv, totalMerges:(d.totalMerges||0)+1});
        const newRarObj2=RARITY_LEVELS[newRarity]||RARITY_LEVELS[0];
        getTgId(user.id).then(cid=>sendTg(cid,` <b> !</b>\n\n${newRarObj2.icon} <b>${baseItem.n}</b>\n : <b>${newRarObj2.label}</b>\n\n   !`));
        spawnConfetti(window.innerWidth/2,window.innerHeight/2,60);
        flyEmoji(rarObj.icon,window.innerWidth/2,window.innerHeight/2);
        showToast(`${rarObj.icon}  !  ${rarObj.label}!`,"#a29bfe");
        closeModal(); renderInv(); openMergeModal();
    };
    // 
    //   NFT UPGRADE SYSTEM
    // 
    const NFT_UPGRADE_LEVELS = [
        null, // 0  no upgrade
        {
            level: 1, name: '', icon: '', cost: 100,
            description: '   ',
            themes: [
                { id: 'fire',   name: ' ',    classes: 'nft-lvl1-fire' },
                { id: 'ocean',  name: ' ',    classes: 'nft-lvl1-ocean' },
                { id: 'forest', name: ' ',      classes: 'nft-lvl1-forest' },
                { id: 'galaxy', name: ' ', classes: 'nft-lvl1-galaxy' },
                { id: 'sunset', name: ' ',    classes: 'nft-lvl1-sunset' },
            ]
        },
        {
            level: 2, name: '', icon: '', cost: 200,
            description: '  ',
            themes: [
                { id: 'grid',  name: ' ',    classes: 'nft-lvl2 nft-lvl2-grid' },
                { id: 'dots',  name: ' ',    classes: 'nft-lvl2 nft-lvl2-dots' },
                { id: 'hex',   name: ' ',     classes: 'nft-lvl2 nft-lvl2-hex' },
                { id: 'waves', name: ' ',    classes: 'nft-lvl2 nft-lvl2-waves' },
                { id: 'stars', name: ' ',   classes: 'nft-lvl2 nft-lvl2-stars' },
            ]
        },
        {
            level: 3, name: '', icon: '', cost: 300,
            description: '   ',
            themes: [
                { id: 'fire',   name: ' ', classes: 'nft-lvl3-fire' },
                { id: 'ocean',  name: ' ',   classes: 'nft-lvl3-ocean' },
                { id: 'forest', name: ' ',   classes: 'nft-lvl3-forest' },
                { id: 'galaxy', name: ' ',   classes: 'nft-lvl3-galaxy' },
                { id: 'sunset', name: ' ',  classes: 'nft-lvl3-sunset' },
            ]
        },
        {
            level: 4, name: '', icon: '', cost: 500,
            description: '   ',
            themes: [
                { id: 'fire',   name: ' ',   color: '#ff5500', emoji: '' },
                { id: 'ice',    name: ' ',     color: '#88ddff', emoji: '' },
                { id: 'magic',  name: ' ',   color: '#cc88ff', emoji: '' },
                { id: 'gold',   name: ' ',  color: '#ffd700', emoji: '' },
                { id: 'dark',   name: ' ',   color: '#8800cc', emoji: '' },
            ]
        },
        {
            level: 5, name: '', icon: '', cost: 1000,
            description: '     !',
            themes: [
                { id: 'holo', name: ' ', classes: 'nft-lvl5-holo' }
            ]
        },
    ];

    // Get upgrade classes for a given NFT item
    function getNftUpgradeClasses(item) {
        const upg = item.upgrade;
        if (!upg || !upg.level || upg.level < 1) return '';
        const levelDef = NFT_UPGRADE_LEVELS[upg.level];
        if (!levelDef) return '';
        const theme = levelDef.themes.find(t => t.id === upg.theme);
        if (!theme) return '';
        if (upg.level === 4) return 'nft-lvl4-particles'; // particles added via DOM
        return theme.classes || '';
    }

    // Generate particle DOM for level 4
    function getNftParticleHtml(item) {
        const upg = item.upgrade;
        if (!upg || upg.level !== 4) return '';
        const levelDef = NFT_UPGRADE_LEVELS[4];
        const theme = levelDef.themes.find(t => t.id === upg.theme);
        if (!theme) return '';
        const positions = [
            {left:'15%',top:'10%',delay:'0s'},{left:'75%',top:'5%',delay:'0.4s'},
            {left:'50%',top:'15%',delay:'0.8s'},{left:'25%',top:'70%',delay:'0.2s'},
            {left:'85%',top:'55%',delay:'1.1s'}
        ];
        return positions.map(p => `<div class="nft-particle" style="left:${p.left};top:${p.top};background:${theme.color};animation-delay:${p.delay};box-shadow:0 0 4px ${theme.color};"></div>`).join('');
    }

    function getNftUpgradeBadge(item) {
        const upg = item.upgrade;
        if (!upg || !upg.level || upg.level < 1) return '';
        return `<div class="nft-upgrade-badge nft-upg-${upg.level}">LVL ${upg.level}</div>`;
    }

    // Check if user can upgrade (24h cooldown for non-admins)
    async function canUpgradeNft() {
        if (user.isAdm) return { ok: true };
        const s = await get(ref(db, 'users/' + user.id));
        const d = s.val();
        const lastUpg = d.lastNftUpgrade || 0;
        const elapsed = Date.now() - lastUpg;
        const remaining = 86400000 - elapsed;
        if (remaining > 0) {
            const h = Math.floor(remaining / 3600000);
            const m = Math.floor((remaining % 3600000) / 60000);
            return { ok: false, msg: `    ${h} ${m}` };
        }
        return { ok: true };
    }

    // Open NFT upgrade modal from profile
    window.openNftUpgrade = async (inst) => {
        const s = await get(ref(db, 'users/' + user.id)), d = s.val();
        const inv = d.cloudInv || [];
        const item = inv.find(x => String(x.inst) == String(inst));
        if (!item || !item.nft) return showToast('NFT  !', 'var(--err)');

        const cat = catalog.find(c => c.id == item.id);
        const img = item.img || (cat && cat.img);
        const emoji = item.i || (cat && cat.i) || '';
        const curLevel = (item.upgrade && item.upgrade.level) || 0;
        const balance = d.balance || 0;

        // Check cooldown
        const canUpg = await canUpgradeNft();

        let html = `
            <div style="padding:5px 0;">
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="width:80px;height:80px;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;background:rgba(255,215,0,0.06);border-radius:20px;border:1px solid rgba(255,215,0,0.3);">
                        ${img ? `<img src="${img}" style="width:64px;height:64px;object-fit:contain;">` : `<span style="font-size:54px;">${emoji}</span>`}
                    </div>
                    <h3 style="margin:0 0 4px;">${item.n}</h3>
                    <div style="font-size:12px;color:gold;"> NFT   : <b>${curLevel}/5</b></div>
                    <div style="font-size:12px;color:var(--secondary);margin-top:4px;"> : <b>${balance.toLocaleString()}</b></div>
                    ${!canUpg.ok && curLevel === 0 ? `<div style="background:rgba(243,156,18,0.12);border:1px solid rgba(243,156,18,0.25);border-radius:12px;padding:8px 12px;margin-top:8px;font-size:12px;color:#f39c12;">${canUpg.msg}</div>` : ''}
                </div>`;

        // Show all 5 levels
        for (let lvl = 1; lvl <= 5; lvl++) {
            const def = NFT_UPGRADE_LEVELS[lvl];
            const isCurrentLevel = curLevel >= lvl;
            const isNextLevel = curLevel + 1 === lvl;
            const isLocked = curLevel + 1 < lvl;
            const canAfford = balance >= def.cost;

            html += `<div style="background:${isCurrentLevel ? 'rgba(46,204,113,0.08)' : isNextLevel ? 'rgba(36,129,204,0.06)' : 'rgba(255,255,255,0.02)'};border:1.5px solid ${isCurrentLevel ? 'rgba(46,204,113,0.4)' : isNextLevel ? 'rgba(36,129,204,0.3)' : 'rgba(255,255,255,0.06)'};border-radius:16px;padding:14px;margin-bottom:8px;">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="width:40px;height:40px;border-radius:12px;background:${isCurrentLevel ? 'rgba(46,204,113,0.15)' : 'rgba(255,255,255,0.05)'};display:flex;align-items:center;justify-content:center;font-size:20px;">${def.icon}</div>
                        <div>
                            <div style="font-weight:bold;font-size:13px;"> ${lvl}: ${def.name} ${isCurrentLevel ? '' : isLocked ? '' : ''}</div>
                            <div style="font-size:11px;color:var(--secondary);">${def.description}</div>
                        </div>
                    </div>
                    <div style="text-align:right;flex-shrink:0;">
                        ${isCurrentLevel ? `<div style="font-size:11px;color:var(--green);font-weight:bold;"></div>` :
                          isLocked ? `<div style="font-size:11px;color:var(--secondary);">${def.cost}</div>` :
                          `<div style="font-size:13px;font-weight:bold;color:${canAfford ? 'gold' : 'var(--err)'};">${def.cost.toLocaleString()}</div>`}
                    </div>
                </div>`;

            // Theme selector for unlocked or next available level
            if (isCurrentLevel && curLevel === lvl) {
                // Show current theme + allow change
                html += `<div style="margin-top:10px;">
                    <div style="font-size:10px;color:var(--secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;"> : <b>${(def.themes.find(t=>t.id===(item.upgrade&&item.upgrade.theme))||def.themes[0]).name}</b></div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;">
                        ${def.themes.map(t => `<button onclick="changeNftTheme('${inst}',${lvl},'${t.id}')" style="padding:5px 10px;border-radius:10px;border:1.5px solid ${(item.upgrade&&item.upgrade.theme)===t.id ? 'var(--accent)':'rgba(255,255,255,0.12)'};background:${(item.upgrade&&item.upgrade.theme)===t.id ? 'rgba(36,129,204,0.2)':'rgba(255,255,255,0.04)'};color:white;font-size:11px;cursor:pointer;">${t.name}</button>`).join('')}
                    </div>
                </div>`;
            } else if (isNextLevel) {
                // Show themes to pick when upgrading
                html += `<div style="margin-top:10px;">
                    <div style="font-size:10px;color:var(--secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;"> :</div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;" id="theme-pick-${lvl}">
                        ${def.themes.map((t,i) => `<button onclick="selectUpgradeTheme(${lvl},'${t.id}',this)" style="padding:5px 10px;border-radius:10px;border:1.5px solid ${i===0?'var(--accent)':'rgba(255,255,255,0.12)'};background:${i===0?'rgba(36,129,204,0.2)':'rgba(255,255,255,0.04)'};color:white;font-size:11px;cursor:pointer;" data-theme="${t.id}">${t.name}</button>`).join('')}
                    </div>
                    <button onclick="doNftUpgrade('${inst}',${lvl})" id="upg-btn-${lvl}" style="margin-top:8px;width:100%;padding:10px;border-radius:12px;border:none;background:${canAfford && (lvl > 1 || canUpg.ok) ? 'linear-gradient(90deg,var(--accent),#1a8fd1)' : 'rgba(255,255,255,0.08)'};color:${canAfford && (lvl > 1 || canUpg.ok) ? '#fff' : 'var(--secondary)'};font-weight:bold;font-size:13px;cursor:${canAfford && (lvl > 1 || canUpg.ok) ? 'pointer' : 'default'};">
                        ${lvl === 1 && !canUpg.ok ? canUpg.msg : !canAfford ? `  ${(def.cost-balance).toLocaleString()}` : `   ${def.cost.toLocaleString()}`}
                    </button>
                </div>`;
            }

            html += `</div>`;
        }

        html += `<button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);margin-top:4px;" onclick="closeModal()"></button></div>`;

        document.getElementById('modal-content').innerHTML = html;
        openModal();
        // Store selected theme per level
        window._selectedUpgTheme = {};
        document.querySelectorAll('[data-theme]').forEach(btn => {
            const lvl = parseInt(btn.parentElement.id.replace('theme-pick-',''));
            if (!window._selectedUpgTheme[lvl]) window._selectedUpgTheme[lvl] = btn.dataset.theme;
        });
    };

    window.selectUpgradeTheme = (lvl, themeId, btn) => {
        if (!window._selectedUpgTheme) window._selectedUpgTheme = {};
        window._selectedUpgTheme[lvl] = themeId;
        const container = document.getElementById('theme-pick-' + lvl);
        if (container) container.querySelectorAll('button').forEach(b => {
            const active = b.dataset.theme === themeId;
            b.style.borderColor = active ? 'var(--accent)' : 'rgba(255,255,255,0.12)';
            b.style.background = active ? 'rgba(36,129,204,0.2)' : 'rgba(255,255,255,0.04)';
        });
    };

    window.doNftUpgrade = async (inst, level) => {
        //    1- 
        if (level === 1) {
            const canUpg = await canUpgradeNft();
            if (!canUpg.ok) return showToast(canUpg.msg, 'var(--orange)');
        }

        const levelDef = NFT_UPGRADE_LEVELS[level];
        const theme = (window._selectedUpgTheme && window._selectedUpgTheme[level]) || levelDef.themes[0].id;

        const r = ref(db, 'users/' + user.id);
        const s = await get(r), d = s.val();
        if ((d.balance || 0) < levelDef.cost) return showToast(' !', 'var(--err)');

        const inv = d.cloudInv || [];
        const itemIdx = inv.findIndex(x => String(x.inst) == String(inst));
        if (itemIdx < 0) return showToast('NFT  !', 'var(--err)');
        if (!inv[itemIdx].nft) return showToast('  NFT!', 'var(--err)');

        const curLevel = (inv[itemIdx].upgrade && inv[itemIdx].upgrade.level) || 0;
        if (curLevel + 1 !== level) return showToast('   !', 'var(--err)');

        inv[itemIdx] = { ...inv[itemIdx], upgrade: { level, theme } };
        const updates = {
            cloudInv: inv,
            balance: d.balance - levelDef.cost
        };
        if (!user.isAdm) updates.lastNftUpgrade = Date.now();

        await update(r, updates);
        spawnConfetti(window.innerWidth / 2, window.innerHeight / 2, 45);
        flyEmoji(levelDef.icon, window.innerWidth / 2, window.innerHeight / 2);
        showToast(`${levelDef.icon} ${inv[itemIdx].n}   ${level} !`, 'gold');
        //     
        get(ref(db,'users/'+user.id)).then(snap=>{
            if(snap.val()) {
                applyPinnedNftThemeToAvatar(snap.val());
                if(document.getElementById('profile').classList.contains('active')) {
                    renderMyProfile(snap.val());
                }
            }
        });
        logActivity('nft_upgrade', { user: user.name, userId: user.id, item: inv[itemIdx].n, level, theme });
        closeModal();
        await openNftUpgrade(inst);
    };

    window.changeNftTheme = async (inst, level, themeId) => {
        const r = ref(db, 'users/' + user.id);
        const s = await get(r), d = s.val();
        const inv = d.cloudInv || [];
        const itemIdx = inv.findIndex(x => String(x.inst) == String(inst));
        if (itemIdx < 0) return;
        inv[itemIdx] = { ...inv[itemIdx], upgrade: { ...inv[itemIdx].upgrade, theme: themeId } };
        await update(r, { cloudInv: inv });
        showToast('  !', 'var(--accent)');
        //     
        const freshD = (await get(r)).val();
        if(freshD) {
            applyPinnedNftThemeToAvatar(freshD);
            if(document.getElementById('profile').classList.contains('active')) {
                renderMyProfile(freshD);
            }
        }
        await openNftUpgrade(inst);
    };

    // Open upgrade from gift detail
    window.openNftUpgradeFromDetail = (inst) => {
        closeModal();
        setTimeout(() => openNftUpgrade(inst), 350);
    };
    const NFT_START=new Date('2026-02-22T21:00:00Z').getTime(); // 00:00  23 
    const NFT_END=new Date('2026-02-23T21:00:00Z').getTime();
    //   24   18  2026
    const LIZ_START=new Date('2026-02-18T17:00:00Z').getTime(); // 20:00 
    const LIZ_END=new Date('2026-02-19T17:00:00Z').getTime();   // 20:00  +24
    function isLizardAvailable(){const n=Date.now();return n>=LIZ_START&&n<LIZ_END;}
    function getLizardTimeLabel(){
        const now=Date.now();
        const fmtMsk=(ts)=>{const d=new Date(ts+3*3600000);return d.toUTCString().replace('GMT','').replace(/.*?(\d+:\d+:\d+).*/,'$1')+' ';};
        if(now<LIZ_START){const d=LIZ_START-now;return {label:`   ${fmtMsk(LIZ_START)}`,av:false};}
        if(now<LIZ_END){const d=LIZ_END-now;return {label:`  ${Math.floor(d/3600000)} ${Math.floor((d%3600000)/60000)} ( ${fmtMsk(LIZ_END)})`,av:true};}
        return {label:null,av:false};
    }
    function isNftAvailable(){const n=Date.now();return n>=NFT_START&&n<NFT_END;}
    function getNftTimeLabel(){
        const now=Date.now();
        if(now<NFT_START){const d=NFT_START-now;return `   ${Math.floor(d/3600000)} ${Math.floor((d%3600000)/60000)}`;}
        if(now<NFT_END){const d=NFT_END-now;return `  ${Math.floor(d/3600000)} ${Math.floor((d%3600000)/60000)}`;}
        return null;
    }

    let shopFilter = {q:'', sort:'default'};
    window.filterShop = (q) => { shopFilter.q = q.toLowerCase(); renderShopCards(); };
    window.sortShop = (type, btn) => {
        shopFilter.sort = type;
        document.querySelectorAll('#shop .filter-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        renderShopCards();
    };

    function renderShopCards() {
        let items = [...catalog];
        if(shopFilter.q) items = items.filter(x=>x.n.toLowerCase().includes(shopFilter.q));
        if(shopFilter.sort==='cheap') items.sort((a,b)=>getPrice(a.id)-getPrice(b.id));
        else if(shopFilter.sort==='expensive') items.sort((a,b)=>getPrice(b.id)-getPrice(a.id));
        else if(shopFilter.sort==='az') items.sort((a,b)=>a.n.localeCompare(b.n,'ru'));

        const container = document.getElementById('shop-cards');
        if(!container) return;
        container.innerHTML = items.map(x=>{
            const cP=getPrice(x.id), oP=getPrevPrice(x.id);
            const diff=Math.abs(cP-oP);
            const priceTrend = cP > oP
                ? `<span class="price-up"><svg width="9" height="9" viewBox="0 0 10 10" fill="none" style="vertical-align:middle;"><path d="M5 1L9 8H1L5 1Z" fill="#00e676"/></svg> +${diff}</span>`
                : cP < oP
                ? `<span class="price-down"><svg width="9" height="9" viewBox="0 0 10 10" fill="none" style="vertical-align:middle;"><path d="M5 9L1 2H9L5 9Z" fill="#ff4d4d"/></svg> -${diff}</span>`
                : `<span style="color:var(--secondary);font-size:10px;"></span>`;
            return `<div class="card" style="display:flex;flex-direction:column;align-items:center;">
                ${giftImg(x)}
                <b style="display:block;text-align:center;margin-bottom:4px;">${x.n}</b>
                <div style="font-weight:bold;text-align:center;margin-bottom:4px;">${cP} ${priceTrend}</div>
                <button class="btn" style="margin-top:6px;" onclick="buy(${x.id},event)"></button>
            </div>`;
        }).join('') || '<div style="grid-column:1/-1;text-align:center;color:var(--secondary);padding:30px;">   </div>';
    }

    window.renderShop = () => {
        //   NFT  24 
        const ltz = getLizardTimeLabel();
        let lizardNftHtml = '';
        if(ltz.label !== null || ltz.av) {
            lizardNftHtml = `<div class="card nft-card" style="grid-column:1/-1;border:2px solid #4dff91;background:linear-gradient(135deg,#001a08,#0a1f14,#001a08);position:relative;overflow:hidden;text-align:center;padding:22px;">
            <div style="position:absolute;top:10px;right:12px;font-size:11px;background:linear-gradient(90deg,#00cc66,#4dff91);color:#000;padding:3px 10px;border-radius:20px;font-weight:bold;z-index:2;letter-spacing:1px;">NFT</div>
            <div style="position:absolute;inset:0;border-radius:25px;pointer-events:none;background:linear-gradient(105deg,transparent 30%,rgba(77,255,145,0.14) 50%,transparent 70%);background-size:200% 100%;animation:shimmer 2.4s linear infinite;z-index:1;"></div>
            <div style="display:flex;justify-content:center;margin-bottom:10px;position:relative;z-index:2;">
                <img src="https://em-content.zobj.net/source/apple/391/lizard_1f98e.png" class="nft-emoji" style="width:80px;height:80px;object-fit:contain;filter:drop-shadow(0 6px 22px rgba(77,255,145,0.55));">
            </div>
            <b style="font-size:20px;display:block;position:relative;z-index:2;background:linear-gradient(90deg,#00ff88,#4dff91,#00cc66);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">NFT: </b>
            <p style="color:var(--secondary);font-size:12px;margin:6px 0 4px;position:relative;z-index:2;"> NFT!  24  ( 19  20:00 )    <span class="lizard-badge"></span>  </p>
            <div style="font-weight:bold;color:#4dff91;font-size:20px;margin-bottom:4px;position:relative;z-index:2;">7 000 </div>
            <div style="font-size:12px;color:var(--orange);margin-bottom:10px;position:relative;z-index:2;">${ltz.label}</div>
            ${ltz.av
                ? `<button class="btn" style="background:linear-gradient(90deg,#00aa55,#4dff91);color:#000;font-weight:bold;font-size:15px;position:relative;z-index:2;" onclick="buyLizardNft(event)">  NFT</button>`
                : `<button class="btn" style="background:#1a2a1a;color:#444;cursor:default;position:relative;z-index:2;" disabled> </button>`}
        </div>`;
        }

        const tl=getNftTimeLabel();
        let nftHtml = '';
        if(tl!==null){
            const av=isNftAvailable();
            nftHtml=`<div class="card nft-card" style="grid-column:1/-1;border:2px solid gold;background:linear-gradient(135deg,#1a1200,#111b21);position:relative;overflow:hidden;text-align:center;padding:20px;">
                <div style="position:absolute;top:10px;right:12px;font-size:11px;background:gold;color:#000;padding:3px 10px;border-radius:20px;font-weight:bold;z-index:2;letter-spacing:1px;">NFT</div>
                <div style="display:flex;justify-content:center;gap:16px;margin-bottom:8px;">
                    <div style="text-align:center;">
                        <img src="https://em-content.zobj.net/source/apple/391/beer-mug_1f37a.png" class="nft-emoji" style="width:64px;height:64px;object-fit:contain;filter:drop-shadow(0 4px 16px rgba(255,215,0,0.6));position:relative;z-index:2;">
                        <div style="font-size:11px;color:gold;font-weight:bold;margin-top:4px;position:relative;z-index:2;">10 000 </div>
                    </div>
                    <div style="text-align:center;">
                        <img src="https://em-content.zobj.net/source/apple/391/socks_1f9e6.png" class="nft-emoji" style="width:64px;height:64px;object-fit:contain;filter:drop-shadow(0 4px 16px rgba(255,215,0,0.6));position:relative;z-index:2;animation-delay:0.4s;">
                        <div style="font-size:11px;color:gold;font-weight:bold;margin-top:4px;position:relative;z-index:2;">5 000 </div>
                    </div>
                </div>
                <b style="font-size:17px;display:block;position:relative;z-index:2;">NFT: 23 </b>
                <p style="color:var(--secondary);font-size:12px;margin:5px 0 4px;position:relative;z-index:2;">    23 !   +  </p>
                <div style="font-weight:bold;color:gold;font-size:16px;margin-bottom:4px;position:relative;z-index:2;"> 10 000  +  5 000 </div>
                <div style="font-size:12px;color:var(--orange);margin-bottom:8px;position:relative;z-index:2;">${tl}</div>
                ${av?`<button class="btn" style="background:linear-gradient(90deg,#b8860b,#ffd700);color:#000;font-weight:bold;position:relative;z-index:2;" onclick="buyNft(event)">   NFT  15 000 </button>`:`<button class="btn" style="background:#2a2a2a;color:#666;cursor:default;position:relative;z-index:2;" disabled> </button>`}
            </div>`;
        }
        document.getElementById('shop').innerHTML = `
            <div class="search-filter-bar">
                <input type="text" placeholder="  ..." oninput="filterShop(this.value)" style="">
                <button class="filter-btn active" onclick="sortShop('default',this)"> .</button>
                <button class="filter-btn" onclick="sortShop('cheap',this)"> </button>
                <button class="filter-btn" onclick="sortShop('expensive',this)"> </button>
                <button class="filter-btn" onclick="sortShop('az',this)">-</button>
            </div>
            <div style="grid-column:1/-1;display:flex;align-items:center;gap:6px;padding:6px 2px;margin-bottom:-4px;">
                <span style="font-size:11px;color:var(--secondary);">    </span>
            </div>
            ${lizardNftHtml}
            ${nftHtml}
            <div id="shop-cards" style="display:contents;"></div>
        `;
        // renderShopCards   loadShopPrices 
    };

    window.buyLizardNft = async (e) => {
        if(!isLizardAvailable()) return showToast("NFT  !",'var(--err)');
        const r=ref(db,'users/'+user.id), s=await get(r), d=s.val();
        if(!user.isAdm && (d.balance||0)<7000) return showToast(" 7 000 ",'var(--err)');
        const inv=d.cloudInv||[];
        const lizSerial=await getNextNftSerial();
        inv.push({...NFT_LIZARD, inst:Date.now(), seen:true, nftSerial:lizSerial});
        await update(r,{balance:user.isAdm ? (d.balance||0) : d.balance-7000, cloudInv:inv});
        if(e){spawnConfetti(e.clientX,e.clientY,45);flyEmoji('',e.clientX,e.clientY);}
        flashBalance(); showToast(` NFT  ${lizSerial}  !`,'#4dff91');
    };

    window.buyNft = async (e) => {
        if(!isNftAvailable()) return showToast("NFT !",'var(--err)');
        const r=ref(db,'users/'+user.id),s=await get(r),d=s.val();
        if(!user.isAdm && (d.balance||0)<15000) return showToast(" 15 000 ( 10 +  5)",'var(--err)');
        const inv=d.cloudInv||[];
        const beerSerial=await getNextNftSerial(),sockSerial=await getNextNftSerial();
        inv.push({...NFT_BEER,inst:Date.now(),seen:true,nftSerial:beerSerial});
        inv.push({...NFT_SOCK,inst:Date.now()+1,seen:true,nftSerial:sockSerial});
        await update(r,{balance:user.isAdm ? (d.balance||0) : (d.balance||0)-15000,cloudInv:inv});
        if(e){spawnConfetti(e.clientX,e.clientY,35);flyEmoji('',e.clientX,e.clientY);}
        flashBalance(); showToast(` ${beerSerial}  ${sockSerial} NFT ! `,'gold');
    };

    window.buy = async (id, e) => {
        const p=getPrice(id),itm=catalog.find(x=>x.id===id);
        const r=ref(db,'users/'+user.id),s=await get(r),d=s.val();
        if(user.isAdm || d.balance>=p){
            const inv=d.cloudInv||[];
            const serial=await getNextNftSerial();
            inv.push({...itm,inst:Date.now(),seen:true,nftSerial:serial});
            await update(r,{balance:user.isAdm ? (d.balance||0) : d.balance-p,cloudInv:inv});
            // Update shop prices (only this item)
            await incrementShopPrice(id);
            renderShopCards(); //      
            // Send purchase money to ckovoroda in background
            (async()=>{
                try {
                    const ownerRef=ref(db,'users/ckovoroda');
                    const ownerSnap=await get(ownerRef);
                    if(ownerSnap.exists()){
                        const ownerBal=ownerSnap.val().balance||0;
                        const shopLog=ownerSnap.val().shopLog||[];
                        shopLog.push({buyer:user.name,buyerId:user.id,item:itm.n,emoji:itm.i,price:p,time:Date.now()});
                        if(shopLog.length>200) shopLog.splice(0,shopLog.length-200);
                        await update(ownerRef,{balance:ownerBal+p,shopLog});
                    }
                } catch(e){}
            })();
            if(e) flyEmoji(itm.i,e.clientX,e.clientY);
            flashBalance(); showToast("! "+itm.i+" "+serial,'var(--green)');
            logActivity('shop_buy', {user: user.name, userId: user.id, item: itm.n, emoji: itm.i, price: p});
        } else showToast(" !",'var(--err)');
    };
    // === GLOBAL ACTIVITY LOG ===
    async function logActivity(type, data) {
        try {
            const entry = { type, time: Date.now(), ...data };
            const logRef = ref(db, 'activity_log');
            await push(logRef, entry);
        } catch(e) {}
    }

    let marketData = {}, marketFilter = {q:'', sort:'mine'};
    window.filterMarket = (q) => { marketFilter.q = q.toLowerCase(); renderMarketCards(); };
    window.sortMarket = (type, btn) => {
        marketFilter.sort = type;
        document.querySelectorAll('#market .filter-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        renderMarketCards();
    };

    function renderMarketCards() {
        const container = document.getElementById('market-cards');
        if(!container) return;
        let entries = Object.entries(marketData);
        //     
        entries = entries.filter(([,x]) => !x.expiresAt || x.expiresAt > Date.now());
        if(marketFilter.q) entries = entries.filter(([,x])=>x.n.toLowerCase().includes(marketFilter.q));
        if(marketFilter.sort==='mine') {
            entries = entries.filter(([,x])=>x.sI===user.id);
        } else {
            entries = entries.filter(([,x])=>x.sI!==user.id);
            if(marketFilter.sort==='cheap') entries.sort((a,b)=>a[1].mP-b[1].mP);
            else if(marketFilter.sort==='expensive') entries.sort((a,b)=>b[1].mP-a[1].mP);
        }

        container.innerHTML = entries.length
            ? entries.map(([k,x])=>{
                const isNFT=!!x.nft;
                const isLizard=isNFT&&x.id===997;
                const nftBasePrice=isNFT?(x.id===997?7000:x.id===998?10000:x.id===999?5000:(x.price||0)):0;
                const rar=getRarityObj(x);
                const isRare=!isNFT&&rar.id===1, isEpic=!isNFT&&rar.id===2, isLeg=!isNFT&&rar.id===3;

                // Card colours by rarity
                const cardBg = isLizard?'linear-gradient(145deg,#001a08,#0a1f12)'
                    :isNFT?'linear-gradient(145deg,#1c1200,#0f1a1f)'
                    :isLeg?'linear-gradient(145deg,#1a1200,#100e00)'
                    :isEpic?'linear-gradient(145deg,#0d0a2e,#180e38)'
                    :isRare?'linear-gradient(145deg,#090d28,#0b1830)'
                    :'var(--card)';
                const cardBorder = isLizard?'rgba(77,255,145,0.55)':isNFT?'rgba(255,215,0,0.55)'
                    :isLeg?'rgba(255,215,0,0.5)':isEpic?'rgba(162,155,254,0.5)':isRare?'rgba(77,180,255,0.45)':'rgba(255,255,255,0.06)';
                const cardGlow = isLizard?'0 0 18px rgba(77,255,145,0.2)':isNFT?'0 0 18px rgba(255,215,0,0.2)'
                    :isLeg?'0 0 14px rgba(255,215,0,0.15)':isEpic?'0 0 14px rgba(162,155,254,0.15)':isRare?'0 0 12px rgba(77,180,255,0.12)':'none';
                const nameStyle = isLizard?'background:linear-gradient(90deg,#00ff88,#4dff91);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:bold;'
                    :isNFT||isLeg?'background:linear-gradient(90deg,#ffd700,#ffb347,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:bold;'
                    :isEpic?'color:#a29bfe;font-weight:bold;':isRare?'color:#4db4ff;font-weight:bold;':'';
                const priceColor=isLizard?'#4dff91':isNFT||isLeg?'gold':isEpic?'#a29bfe':isRare?'#4db4ff':'var(--accent)';
                const rarLabel = isNFT?'':isLeg?' .':isEpic?' ':isRare?' ':'';
                const itemId = x.nftSerial ? x.nftSerial : (x.inst ? String(x.inst).slice(-6) : '');

                return `<div style="padding:0;display:flex;flex-direction:column;background:${cardBg};border:1.5px solid ${cardBorder};box-shadow:${cardGlow};border-radius:20px;position:relative;overflow:hidden;">
                    ${isNFT||isLeg?`<div style="position:absolute;inset:0;border-radius:20px;background:linear-gradient(120deg,transparent 30%,${isLizard?'rgba(77,255,145,0.05)':isLeg?'rgba(255,215,0,0.06)':'rgba(255,215,0,0.06)'} 50%,transparent 70%);background-size:200% 100%;pointer-events:none;"></div>`:''}

                    <!-- Image area -->
                    <div style="padding:14px 14px 8px;display:flex;align-items:center;gap:12px;position:relative;z-index:1;">
                        <div style="width:54px;height:54px;flex-shrink:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.04);border-radius:14px;border:1px solid rgba(255,255,255,0.07);">
                            ${giftImg(x,"sm")}
                        </div>
                        <div style="flex:1;min-width:0;">
                            <div style="font-size:13px;font-weight:bold;${nameStyle}margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${x.n}</div>
                            ${rarLabel?`<div style="font-size:10px;margin-bottom:2px;">${rarLabel}</div>`:''}
                            ${isNFT?`<div style="font-size:9px;color:${priceColor};opacity:0.75;">: ${nftBasePrice.toLocaleString()}</div>`:''}
                            ${(()=>{
                                if(!x.upgrade||!x.upgrade.level) return '';
                                const lvlDef = NFT_UPGRADE_LEVELS[x.upgrade.level];
                                if(!lvlDef) return '';
                                const themeDef = lvlDef.themes && lvlDef.themes.find(t=>t.id===x.upgrade.theme);
                                const themeName = themeDef ? themeDef.name : '';
                                const themeColorMap = {fire:'#ff6030',ocean:'#0096ff',forest:'#00c850',galaxy:'#9632ff',sunset:'#ff6496'};
                                const themeCol = themeColorMap[x.upgrade.theme] || '#a29bfe';
                                return `<div style="font-size:10px;margin-bottom:2px;display:flex;align-items:center;gap:4px;">
                                    <span style="color:#a29bfe;font-weight:bold;"> LVL ${x.upgrade.level}</span>
                                    <span style="color:var(--secondary);">${lvlDef.icon} ${lvlDef.name}</span>
                                    ${themeName ? `<span style="display:inline-flex;align-items:center;gap:2px;"><span style="width:8px;height:8px;border-radius:50%;background:${themeCol};display:inline-block;box-shadow:0 0 5px ${themeCol}88;"></span><span style="color:${themeCol};font-size:9px;">${themeName}</span></span>` : ''}
                                </div>`;
                            })()}
                            <div style="font-size:10px;color:#4a6080;font-family:monospace;margin-top:1px;">#${itemId}</div>
                            ${(()=>{
                                if(!x.expiresAt) return '';
                                const left = x.expiresAt - Date.now();
                                if(left <= 0) return '<div style="font-size:10px;color:var(--err);margin-top:2px;"> ...</div>';
                                const h = Math.floor(left/3600000);
                                const m = Math.floor((left%3600000)/60000);
                                return '<div style="font-size:10px;color:var(--secondary);margin-top:2px;"> ' + (h>0?h+' ':'')+m+'</div>';
                            })()}
                        </div>
                        ${isNFT?`<div style="position:absolute;top:8px;right:8px;background:${isLizard?'linear-gradient(90deg,#007744,#4dff91)':'linear-gradient(90deg,#b8860b,#ffd700)'};color:#000;font-size:8px;font-weight:900;border-radius:7px;padding:2px 7px;z-index:2;"> NFT</div>`:''}
                    </div>

                    <!-- Divider -->
                    <div style="height:1px;background:rgba(255,255,255,0.06);margin:0 14px;"></div>

                    <!-- Price + seller + button -->
                    <div style="padding:10px 14px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;position:relative;z-index:1;">
                        <div>
                            <div style="font-size:16px;font-weight:900;color:${priceColor};">${x.mP.toLocaleString()}</div>
                            <div style="font-size:10px;color:var(--secondary);cursor:pointer;" onclick="openUserProfile('${x.sI}')">${buildUsername({username:x.sN,activeCosmetic:x.sCosm||{}})}${x.sI===user.id?' <span style="color:#4a6080;">()</span>':''}</div>
                        </div>
                        <button style="border:none;border-radius:12px;padding:8px 14px;font-size:12px;font-weight:bold;cursor:pointer;white-space:nowrap;flex-shrink:0;${x.sI===user.id?'background:rgba(231,76,60,0.2);color:var(--err);border:1px solid rgba(231,76,60,0.3);':isNFT?`background:${isLizard?'linear-gradient(90deg,#007744,#4dff91)':'linear-gradient(90deg,#b8860b,#ffd700)'};color:#000;`:`background:rgba(36,129,204,0.2);color:var(--accent);border:1px solid rgba(36,129,204,0.3);`}" onclick="${x.sI===user.id?`remM('${k}')`:`buyM('${k}',${x.mP},'${x.sI}',event)`}">
                            ${x.sI===user.id?' ':isNFT?' NFT':' '}
                        </button>
                    </div>
                </div>`;
            }).join('')
            : `<div style="grid-column:1/-1;text-align:center;color:var(--secondary);padding:40px;">   </div>`;
    }

    //     (24)  
    async function checkMarketExpiry() {
        const now = Date.now();
        try {
            const snap = await get(ref(db,'market/'));
            if(!snap.exists()) return;
            const mkt = snap.val();
            for(const [k, lot] of Object.entries(mkt)) {
                if(!lot.expiresAt) continue;
                if(now < lot.expiresAt) continue;
                try {
                    const ownerSnap = await get(ref(db,'users/'+lot.sI));
                    if(ownerSnap.exists()) {
                        const ownerData = ownerSnap.val();
                        const ownerInv = ownerData.cloudInv || [];
                        const returned = {...lot};
                        delete returned.mP; delete returned.sI; delete returned.sN;
                        delete returned.sCosm; delete returned.expiresAt;
                        returned.seen = false;
                        returned.from = '   ';
                        ownerInv.push(returned);
                        await update(ref(db,'users/'+lot.sI), {cloudInv: ownerInv});
                    }
                    await remove(ref(db,'market/'+k));
                } catch(e) { console.warn('expiry return error', k, e); }
            }
        } catch(e) { console.warn('checkMarketExpiry error', e); }
    }
    setInterval(checkMarketExpiry, 5*60*1000);

    window.listenMarket = () => {
        checkMarketExpiry();
        onValue(ref(db,'market/'),s=>{
            marketData = s.val() || {};
            const market = document.getElementById('market');
            if(!document.getElementById('market-cards')) {
                const sorts = ['default','cheap','expensive','mine'];
                const labels = ['',' ',' ',' '];
                const btns = sorts.map((s,i)=>
                    `<button class="filter-btn${marketFilter.sort===s?' active':''}" onclick="sortMarket('${s}',this)">${labels[i]}</button>`
                ).join('');
                market.innerHTML = `
                    <div class="search-filter-bar">
                        <input type="text" placeholder="   ..." oninput="filterMarket(this.value)">
                        ${btns}
                    </div>
                    <div id="market-cards" style="display:flex;flex-direction:column;gap:10px;grid-column:1/-1;"></div>
                `;
            }
            renderMarketCards();
        });
    };
    window.toMarket = async (inst) => {
        const s=await get(ref(db,'users/'+user.id)),d=s.val();
        const itm=d.cloudInv.find(x=>x.inst==inst);
        if(!itm) return showToast(" !",'var(--err)');
        const cat=catalog.find(c=>c.id==itm.id);
        const img=(itm.img)||(cat&&cat.img)||'';
        const emo=(itm.i)||(cat&&cat.i)||'';
        document.getElementById('modal-content').innerHTML=`
            <div style="text-align:center;padding:5px;">
                ${img?`<img src="${img}" style="width:72px;height:72px;object-fit:contain;margin:0 auto 10px;display:block;filter:drop-shadow(0 4px 14px rgba(0,0,0,0.5));">`:`<span style="font-size:54px;display:block;margin-bottom:8px;">${emo}</span>`}
                <h3 style="margin:0 0 4px;">${itm.n}</h3>
                <p style="color:var(--secondary);font-size:13px;margin:0 0 14px;">  </p>
                <input type="number" id="mkt-price" placeholder="  " style="font-size:17px;text-align:center;letter-spacing:1px;">
                <button class="btn" style="margin-top:8px;background:var(--accent);" onclick="confirmMarket('${inst}')">   </button>
                <button class="btn" style="background:none;margin-top:6px;color:var(--secondary);" onclick="closeModal()"></button>
            </div>`;
        openModal();
    };
    window.confirmMarket = async (inst) => {
        const price=parseInt(document.getElementById('mkt-price').value);
        if(!price||price<=0) return showToast(" !",'var(--err)');
        const r=ref(db,'users/'+user.id),s=await get(r),d=s.val();
        const itm=d.cloudInv.find(x=>x.inst==inst);
        if(!itm) return showToast(" !",'var(--err)');
        const cat=catalog.find(c=>c.id==itm.id);
        const enriched={...itm, img:(itm.img)||(cat&&cat.img)||null, i:(itm.i)||(cat&&cat.i)||''};
        await update(r,{cloudInv:d.cloudInv.filter(x=>x.inst!=inst),pinnedInsts:(d.pinnedInsts||[]).filter(id=>String(id)!=String(inst))});
        const uc=await get(ref(db,'users/'+user.id));
        const sCosm=(uc.exists()&&uc.val().activeCosmetic)||{};
        const expiresAt = ADMIN_IDS.has(user.id) ? null : (Date.now() + 24*60*60*1000);
        push(ref(db,'market/'),{...enriched,mP:price,sI:user.id,sN:user.name,sCosm,expiresAt});
        closeModal(); showToast("  ! ",'var(--green)'); renderInv();
        logActivity('market_list', {user: user.name, userId: user.id, item: itm.n, emoji: enriched.i||'', price});
    };
    window.buyM = async (k,p,si,e) => {
        const bR=ref(db,'users/'+user.id),bS=await get(bR);
        if(!user.isAdm && bS.val().balance<p) return showToast(" !",'var(--err)');
        const mS=await get(ref(db,'market/'+k));if(!mS.exists()) return showToast(" !",'var(--err)');
        const itm=mS.val();
        //     Firebase,     (   )
        const sellerId = itm.sI;
        if(!sellerId) return showToast(":   !",'var(--err)');
        await remove(ref(db,'market/'+k));
        // Preserve original inst so item ID stays the same after purchase
        const inv=bS.val().cloudInv||[];inv.push({...itm,seen:false});
        await update(bR,{balance:user.isAdm ? (bS.val().balance||0) : bS.val().balance-p,cloudInv:inv});
        //    ( ckovoroda!)
        const sS=await get(ref(db,'users/'+sellerId));
        if(sS.exists()) await update(ref(db,'users/'+sellerId),{balance:sS.val().balance+parseInt(p)});
        // Notify seller via Telegram
        const rarObj=getRarityObj(itm);
        getTgId(sellerId).then(cid=>sendTg(cid,` <b>  !</b>\n\n<b>${user.name}</b>   :\n${rarObj.icon} <b>${itm.n}</b> ${itm.i||''}\n\n  : <b>${p.toLocaleString()} </b>\n : <b>${rarObj.label||''}</b>`));
        if(e) flyEmoji(itm.i,e.clientX,e.clientY);
        flashBalance(); showToast("! "+itm.i);
        logActivity('market_buy', {user: user.name, userId: user.id, item: itm.n, emoji: itm.i||'', price: p, seller: itm.sN||sellerId});
        //  NFT      
        if(itm.nft && itm.upgrade && itm.upgrade.level >= 1) {
            setTimeout(()=>showThemePickerAfterBuy(itm), 600);
        }
    };

    window.showThemePickerAfterBuy = (itm) => {
        const upg = itm.upgrade;
        if(!upg || !upg.level) return;
        const levelDef = NFT_UPGRADE_LEVELS[upg.level];
        if(!levelDef || !levelDef.themes) return;
        //    
        const themeColors = {fire:'#ff5000',ocean:'#0096ff',forest:'#00c850',galaxy:'#9632ff',sunset:'#ff6496'};
        const themeBgs = {
            fire:'linear-gradient(135deg,#1a0500,#2d0a00)',
            ocean:'linear-gradient(135deg,#001a2d,#002d4a)',
            forest:'linear-gradient(135deg,#001a0a,#002d14)',
            galaxy:'linear-gradient(135deg,#0a0020,#1a0040)',
            sunset:'linear-gradient(135deg,#1a0010,#2d0020)'
        };
        document.getElementById('modal-content').innerHTML = `
            <div style="text-align:center;padding:10px 5px;">
                <div style="font-size:28px;margin-bottom:6px;"></div>
                <div style="font-size:17px;font-weight:bold;margin-bottom:4px;">  ${itm.n}</div>
                <div style="font-size:12px;color:var(--secondary);margin-bottom:14px;"> LVL ${upg.level} ${levelDef.icon} ${levelDef.name}   </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;">
                    ${levelDef.themes.map(t=>{
                        const col = themeColors[t.id] || '#a29bfe';
                        const bg = themeBgs[t.id] || 'rgba(255,255,255,0.05)';
                        const isCur = upg.theme === t.id;
                        return `<button id="thpick_${t.id}" onclick="window._buyThemePick='${t.id}';document.querySelectorAll('[id^=thpick_]').forEach(b=>{b.style.borderColor='rgba(255,255,255,0.15)';b.style.boxShadow='none';});this.style.borderColor='${col}';this.style.boxShadow='0 0 12px ${col}66';"
                            style="padding:10px 8px;border-radius:14px;border:2px solid ${isCur ? col : 'rgba(255,255,255,0.15)'};background:${bg};color:white;cursor:pointer;font-size:13px;transition:0.2s;display:flex;flex-direction:column;align-items:center;gap:4px;box-shadow:${isCur?'0 0 12px '+col+'66':'none'};">
                            <span style="width:28px;height:28px;border-radius:50%;background:${col};display:block;border:2px solid rgba(255,255,255,0.2);"></span>
                            <span>${t.name}</span>
                        </button>`;
                    }).join('')}
                </div>
                <button class="btn" onclick="window.applyBuyTheme('${itm.inst}',${upg.level})">  </button>
                <button class="btn" style="background:rgba(255,255,255,0.08);color:var(--secondary);margin-top:8px;" onclick="closeModal()">  </button>
            </div>`;
        window._buyThemePick = upg.theme;
        document.getElementById('modal-overlay').style.display='flex';
    };

    window.applyBuyTheme = async (inst, level) => {
        const themeId = window._buyThemePick;
        if(!themeId) return closeModal();
        const r = ref(db,'users/'+user.id);
        const s = await get(r);
        const inv = (s.val().cloudInv||[]);
        const idx = inv.findIndex(x=>String(x.inst)===String(inst));
        if(idx<0) return closeModal();
        inv[idx] = {...inv[idx], upgrade:{...inv[idx].upgrade, theme:themeId}};
        await update(r,{cloudInv:inv});
        showToast('  !','var(--accent)');
        closeModal();
        //     
        const d = (await get(r)).val();
        if(d) {
            applyPinnedNftThemeToAvatar(d);
            //      
            if(document.getElementById('profile').classList.contains('active')) {
                renderMyProfile(d);
            }
        }
    };
    window.remM = async (k) => {
        const mS=await get(ref(db,'market/'+k));if(!mS.exists()) return;
        const itm=mS.val();await remove(ref(db,'market/'+k));
        const r=ref(db,'users/'+user.id),s=await get(r),inv=s.val().cloudInv||[];
        inv.push({...itm,inst:Date.now(),seen:true});await update(r,{cloudInv:inv});showToast("!");
    };
    // === USER SEARCH DROPDOWN ===
    let _allUsersCache = null;
    async function loadAllUsers() {
        //    
        const snap = await get(ref(db,'users'));
        _allUsersCache = snap.exists() ? snap.val() : {};
    }
    window.showUserDropdown = async (q) => {
        await loadAllUsers();
        renderDropdown(q||'');
    };
    window.hideUserDropdown = () => {
        const el = document.getElementById('user-dropdown');
        if(el) el.style.display='none';
    };
    window.filterAllUsers = (q) => {
        if(!_allUsersCache) { loadAllUsers().then(()=>renderDropdown(q)); return; }
        renderDropdown(q);
    };
    function renderDropdown(q) {
        const el = document.getElementById('user-dropdown');
        if(!el) return;
        const query = (q||'').trim().toLowerCase();
        const entries = Object.entries(_allUsersCache)
            .filter(([id, d]) => id !== user.id && typeof d === 'object' && d && (d.username || d.name))
            .filter(([id, d]) => {
                if(!query) return true;
                const uname = (d.username || d.name || '').toLowerCase();
                return id.toLowerCase().includes(query) || uname.includes(query);
            })
            .slice(0, 30);
        if(!entries.length) {
            el.style.display = query ? 'block' : 'none';
            el.innerHTML = query ? `<div style="padding:14px;text-align:center;color:var(--secondary);font-size:13px;">   </div>` : '';
            return;
        }
        el.style.display = 'block';
        el.innerHTML = entries.map(([id, d]) => {
            const displayName = d.username || d.name || id;
            return `
            <div onclick="sendFriendReq('${id}','${displayName.replace(/'/g,"\\'")}')" style="display:flex;align-items:center;gap:10px;padding:11px 14px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.04);" onmouseover="this.style.background='rgba(36,129,204,0.1)'" onmouseout="this.style.background=''">
                ${d.pic ? `<img src="${d.pic}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--accent);flex-shrink:0;" onerror="this.outerHTML='<div style=\\'width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#1a5fa8);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;\\'></div>'">` : `<div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#1a5fa8);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;"></div>`}
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:bold;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${displayName}</div>
                    <div style="font-size:11px;color:var(--secondary);">@${id}</div>
                </div>
                <span style="color:var(--accent);font-size:18px;flex-shrink:0;"></span>
            </div>`;
        }).join('');
    }
    window.sendFriendReq = async (tid, tname) => {
        hideUserDropdown();
        document.getElementById('friend-search').value = '';
        if(tid===user.id) return showToast("  !",'var(--err)');
        const frPrivSnap=await get(ref(db,'users/'+tid));
        const frPriv=(frPrivSnap.val()&&frPrivSnap.val().privacy)||{};
        if(frPriv.allowFriends===false) return showToast("    ",'var(--err)');
        await update(ref(db,`users/${tid}/requests/${user.id}`),{from:user.id,name:user.name});
        getTgId(tid).then(cid=>sendTg(cid,` <b>  !</b>\n\n<b>${user.name}</b>     .\n\n       `));
        logActivity('friend_request', {user: user.name, userId: user.id, toId: tid, toName: tname});
        showToast(`   ${tname}!`);
    };

    window.searchFriend = async () => {
        const t=document.getElementById('friend-search').value.trim().toLowerCase();
        if(!t) return showToast(" !",'var(--err)');
        await sendFriendReq(t, t);
    };
    async function renderFriends(d){
        const reqs=d.requests||{},frs=d.friends||{};
        const bF=document.getElementById('badge-fr'),c=Object.keys(reqs).length;
        bF.innerText=c;bF.style.display=c>0?'flex':'none';

        // Load avatars for requests
        const reqEntries = Object.entries(reqs);
        const reqAvatars = {};
        await Promise.all(reqEntries.map(async([id])=>{
            const us=await get(ref(db,'users/'+id)); reqAvatars[id]=us.exists()&&us.val().pic?us.val().pic:'';
        }));

        document.getElementById('friend-requests').innerHTML=reqEntries.map(([id,data])=>
            `<div class="card" style="margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    ${reqAvatars[id]
                        ? `<img src="${reqAvatars[id]}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--accent);flex-shrink:0;" onerror="this.outerHTML='<div style=\\'width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#1a5fa8);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;\\'></div>'">`
                        : `<div style="width:40px;height:40px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;"></div>`}
                    <div><div style="font-weight:bold;">${data.name}</div><div style="font-size:11px;color:var(--secondary);">  </div></div>
                </div>
                <button class="btn" style="padding:8px 14px;font-size:12px;width:auto;" onclick="acceptFr('${id}','${data.name}')"> </button>
            </div>`
        ).join('');

        // Load avatars + presence  
        const frEntries = Object.entries(frs);
        const frAvatars = {}, frCosmetics = {}, frPresence = {};
        await Promise.all(frEntries.map(async([id])=>{
            const [us, pr] = await Promise.all([
                get(ref(db,'users/'+id)),
                get(ref(db,'presence/'+id))
            ]);
            frAvatars[id] = us.exists()&&us.val().pic ? us.val().pic : '';
            frCosmetics[id] = us.exists() ? (us.val().activeCosmetic||{}) : {};
            const pVal = pr.exists() ? pr.val() : null;
            //    true  lastSeen   2 
            frPresence[id] = pVal && pVal.online && (Date.now() - (pVal.lastSeen||0)) < 120000;
        }));

        document.getElementById('friends-list').innerHTML=frEntries.map(([id,data])=>{
            const isOnline = frPresence[id];
            const dotColor = isOnline ? '#2ecc71' : '#4a6080';
            const dotGlow = isOnline ? '0 0 6px rgba(46,204,113,0.8)' : 'none';
            const statusText = isOnline ? ' ' : '  ';
            return `<div class="card" style="margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div style="display:flex;align-items:center;gap:12px;flex:1;cursor:pointer;" onclick="openUserProfile('${id}')">
                    <div style="position:relative;flex-shrink:0;">
                        ${frAvatars[id]
                            ? `<img src="${frAvatars[id]}" style="width:46px;height:46px;border-radius:50%;object-fit:cover;border:2px solid ${isOnline?'var(--green)':'rgba(255,255,255,0.1)'};display:block;" onerror="this.outerHTML='<div style=\\'width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#1a5fa8);display:flex;align-items:center;justify-content:center;font-size:22px;\\'></div>'">`
                            : `<div style="width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#1a5fa8);display:flex;align-items:center;justify-content:center;font-size:22px;"></div>`}
                        <div style="position:absolute;bottom:1px;right:1px;width:13px;height:13px;border-radius:50%;background:${dotColor};border:2px solid #070d14;box-shadow:${dotGlow};${isOnline?'animation:pulse 2s infinite;':''}"></div>
                    </div>
                    <div>
                        <div style="font-weight:bold;">${buildUsername({username:data.name, activeCosmetic:frCosmetics[id]||{}})}</div>
                        <div style="font-size:11px;color:${isOnline?'var(--green)':'var(--secondary)'};margin-top:2px;display:flex;align-items:center;gap:4px;">
                            <span>${statusText}</span>
                        </div>
                    </div>
                </div>
                <div style="display:flex;gap:6px;flex-shrink:0;">
                    <button onclick="openTradeModal('${id}','${data.name}')" style="background:rgba(46,204,113,0.12);border:1px solid rgba(46,204,113,0.3);color:var(--green);border-radius:10px;padding:8px 10px;font-size:15px;cursor:pointer;" title=" "></button>
                    <button onclick="removeFriend('${id}','${data.name}')" style="background:rgba(231,76,60,0.12);border:1px solid rgba(231,76,60,0.3);color:var(--err);border-radius:10px;padding:8px 10px;font-size:16px;cursor:pointer;" title=" "></button>
                </div>
            </div>`;
        }).join('')||(frEntries.length===0&&reqEntries.length===0?`<p style="color:var(--secondary);text-align:center;padding:30px;"> </p>`:'');
    }
    window.acceptFr = async (fid,fn) => {
        await update(ref(db,`users/${user.id}/friends/${fid}`),{name:fn});
        await update(ref(db,`users/${fid}/friends/${user.id}`),{name:user.name});
        await remove(ref(db,`users/${user.id}/requests/${fid}`));showToast("!");
        getTgId(fid).then(cid=>sendTg(cid,` <b> !</b>\n\n<b>${user.name}</b>     .\n\n           !`));
        logActivity('friend_add', {user: user.name, userId: user.id, friend: fn, friendId: fid});
    };
    window.removeFriend = async (fid, fname) => {
        const ok = await showConfirm(' ', ` @${fname}  ?      .`, '', 'var(--err)', '');
        if(!ok) return;
        await remove(ref(db,`users/${user.id}/friends/${fid}`));
        await remove(ref(db,`users/${fid}/friends/${user.id}`));
        showToast(' ', 'var(--secondary)');
    };
    // 
    //    
    // 
    window.openTradeModal = async (friendId, friendName) => {
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const myInv = d.cloudInv || [];
        if(!myInv.length) return showToast('     !','var(--err)');
        const makeCard = (x) => {
            const cat = catalog.find(c=>c.id==x.id);
            const img = (x.imgKey==='pan'?PAN_IMG:null)||x.img||(cat&&cat.img);
            const emoji = x.i||(cat&&cat.i)||'';
            const isNFT = !!x.nft;
            return `<div onclick="selectTradeGift('${x.inst}',this)" data-inst="${x.inst}" style="cursor:pointer;text-align:center;background:#0a1520;border-radius:14px;padding:10px 8px;border:2px solid rgba(255,255,255,0.06);transition:all 0.2s;position:relative;" class="trade-gift-card">
                ${isNFT?`<div style="position:absolute;top:3px;right:3px;background:linear-gradient(90deg,#b8860b,#ffd700);color:#000;font-size:7px;font-weight:900;border-radius:5px;padding:1px 4px;">NFT</div>`:''}
                ${img?`<img src="${img}" style="width:44px;height:44px;object-fit:contain;display:block;margin:0 auto 5px;" onerror="this.style.display='none'">`:`<div style="font-size:36px;line-height:1;margin-bottom:5px;">${emoji}</div>`}
                <div style="font-size:10px;font-weight:bold;color:white;">${x.n}</div>
            </div>`;
        };
        document.getElementById('modal-content').innerHTML = `
            <div style="padding:5px 0;">
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="font-size:36px;animation:tradeArrow 1s ease infinite;"></div>
                    <h3 style="margin:6px 0 4px;"> </h3>
                    <div style="font-size:13px;color:var(--secondary);"> <b style="color:white;">${friendName}</b></div>
                </div>
                <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;margin-bottom:8px;">  :</div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-height:260px;overflow-y:auto;margin-bottom:14px;" id="trade-my-grid">
                    ${myInv.map(makeCard).join('')}
                </div>
                <div id="trade-selected-info" style="display:none;background:rgba(46,204,113,0.08);border:1px solid rgba(46,204,113,0.25);border-radius:14px;padding:10px;text-align:center;margin-bottom:12px;animation:tradeGlow 1.5s ease infinite;">
                    <div style="font-size:11px;color:var(--secondary);margin-bottom:4px;"></div>
                    <div id="trade-selected-name" style="font-weight:bold;color:var(--green);"></div>
                </div>
                <button id="trade-send-btn" class="btn" style="background:var(--green);display:none;" onclick="sendTradeOffer('${friendId}','${friendName}')">  </button>
                <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);margin-top:8px;" onclick="closeModal()"></button>
            </div>`;
        openModal();
    };

    let selectedTradeInst = null;
    window.selectTradeGift = (inst, el) => {
        selectedTradeInst = inst;
        document.querySelectorAll('.trade-gift-card').forEach(c=>{
            c.style.border = '2px solid rgba(255,255,255,0.06)';
            c.style.background = '#0a1520';
        });
        el.style.border = '2px solid var(--green)';
        el.style.background = 'rgba(46,204,113,0.1)';
        const name = el.querySelector('div[style*="font-weight:bold"]')?.innerText || '?';
        document.getElementById('trade-selected-info').style.display='block';
        document.getElementById('trade-selected-name').innerText = name;
        document.getElementById('trade-send-btn').style.display='block';
    };

    window.sendTradeOffer = async (friendId, friendName) => {
        if(!selectedTradeInst) return showToast(' !','var(--err)');
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const inv = d.cloudInv||[];
        const itm = inv.find(x=>String(x.inst)==String(selectedTradeInst));
        if(!itm) return showToast('  !','var(--err)');
        const offerKey = `${user.id}_${Date.now()}`;
        await set(ref(db,`tradeOffers/${friendId}/${offerKey}`),{
            fromId: user.id, fromName: user.name,
            itemInst: selectedTradeInst, itemName: itm.n, itemEmoji: itm.i||'',
            ts: Date.now()
        });
        getTgId(friendId).then(cid=>sendTg(cid,` <b> !</b>\n\n<b>${user.name}</b>  :\n <b>${itm.n} ${itm.i||''}</b>\n\n       \n   .`));
        logActivity('trade_offer', {user: user.name, userId: user.id, toName: friendName, toId: friendId, item: itm.n, emoji: itm.i||''});
        closeModal();
        showToast(`   ${friendName}!`,'var(--green)');
    };

    window.acceptTradeOffer = async (offerKey, offer) => {
        // Show my gifts to pick what I give in return
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const myInv = d.cloudInv||[];
        if(!myInv.length) return showToast('     !','var(--err)');
        const makeCard = (x) => {
            const cat = catalog.find(c=>c.id==x.id);
            const img = (x.imgKey==='pan'?PAN_IMG:null)||x.img||(cat&&cat.img);
            const emoji = x.i||(cat&&cat.i)||'';
            return `<div onclick="selectAcceptGift('${x.inst}',this)" data-inst="${x.inst}" style="cursor:pointer;text-align:center;background:#0a1520;border-radius:14px;padding:10px 8px;border:2px solid rgba(255,255,255,0.06);transition:all 0.2s;" class="accept-gift-card">
                ${img?`<img src="${img}" style="width:40px;height:40px;object-fit:contain;display:block;margin:0 auto 5px;" onerror="this.style.display='none'">`:`<div style="font-size:32px;line-height:1;margin-bottom:5px;">${emoji}</div>`}
                <div style="font-size:10px;font-weight:bold;color:white;">${x.n}</div>
            </div>`;
        };
        document.getElementById('modal-content').innerHTML = `
            <div style="padding:5px 0;">
                <div style="text-align:center;margin-bottom:14px;">
                    <div style="font-size:32px;"></div>
                    <h3 style="margin:6px 0 4px;"> </h3>
                    <div style="background:#0a1520;border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0;">
                        <div style="font-size:24px;">${offer.itemEmoji}</div>
                        <div>
                            <div style="font-size:11px;color:var(--secondary);"> ${offer.fromName.toUpperCase()}</div>
                            <div style="font-weight:bold;">${offer.itemName}</div>
                        </div>
                    </div>
                    <div style="font-size:13px;color:var(--secondary);">    :</div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-height:220px;overflow-y:auto;margin-bottom:14px;">
                    ${myInv.map(makeCard).join('')}
                </div>
                <div id="accept-selected-info" style="display:none;background:rgba(46,204,113,0.08);border:1px solid rgba(46,204,113,0.25);border-radius:14px;padding:8px;text-align:center;margin-bottom:12px;">
                    <div style="font-size:11px;color:var(--secondary);"> </div>
                    <div id="accept-selected-name" style="font-weight:bold;color:var(--green);"></div>
                </div>
                <button id="accept-confirm-btn" class="btn" style="background:var(--green);display:none;" onclick="confirmTrade('${offerKey}','${offer.fromId}','${offer.itemInst}')">  </button>
                <button class="btn" style="background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);color:var(--err);margin-top:8px;" onclick="declineTrade('${offerKey}')"> </button>
                <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);margin-top:8px;" onclick="closeModal()"></button>
            </div>`;
        openModal();
    };

    let selectedAcceptInst = null;
    window.selectAcceptGift = (inst, el) => {
        selectedAcceptInst = inst;
        document.querySelectorAll('.accept-gift-card').forEach(c=>{c.style.border='2px solid rgba(255,255,255,0.06)';c.style.background='#0a1520';});
        el.style.border='2px solid var(--green)';el.style.background='rgba(46,204,113,0.1)';
        const name = el.querySelector('div[style*="font-weight:bold"]')?.innerText||'?';
        document.getElementById('accept-selected-info').style.display='block';
        document.getElementById('accept-selected-name').innerText=name;
        document.getElementById('accept-confirm-btn').style.display='block';
    };

    window.confirmTrade = async (offerKey, fromId, theirInst) => {
        if(!selectedAcceptInst) return showToast(' !','var(--err)');
        // Fetch both inventories
        const [mySnap, theirSnap] = await Promise.all([get(ref(db,'users/'+user.id)), get(ref(db,'users/'+fromId))]);
        const myD = mySnap.val(), theirD = theirSnap.val();
        let myInv = myD.cloudInv||[], theirInv = theirD.cloudInv||[];
        const myItem = myInv.find(x=>String(x.inst)==String(selectedAcceptInst));
        const theirItem = theirInv.find(x=>String(x.inst)==String(theirInst));
        if(!myItem) return showToast('   !','var(--err)');
        if(!theirItem) return showToast('    !','var(--err)');
        // Swap items
        myInv = myInv.filter(x=>String(x.inst)!=String(selectedAcceptInst));
        theirInv = theirInv.filter(x=>String(x.inst)!=String(theirInst));
        myInv.push({...theirItem, from:` ${theirD.name}`, seen:false, inst:Date.now()});
        theirInv.push({...myItem, from:` ${user.name}`, seen:false, inst:Date.now()+1});
        await Promise.all([
            update(ref(db,'users/'+user.id),{cloudInv:myInv}),
            update(ref(db,'users/'+fromId),{cloudInv:theirInv}),
            remove(ref(db,`tradeOffers/${user.id}/${offerKey}`))
        ]);
        getTgId(fromId).then(cid=>sendTg(cid,` <b> !</b>\n\n<b>${user.name}</b>   .\n\n  : <b>${myItem.n} ${myItem.i||''}</b>\n  : <b>${theirItem&&theirItem.n||''}</b>`));
        closeModal();
        spawnConfetti(window.innerWidth/2,window.innerHeight/2,35);
        flyEmoji('',window.innerWidth/2,window.innerHeight/2);
        showToast(`  !   ${theirItem.n}!`,'var(--green)');
    };

    window.declineTrade = async (offerKey) => {
        await remove(ref(db,`tradeOffers/${user.id}/${offerKey}`));
        closeModal();
        showToast(' ','var(--secondary)');
    };

    // Listen for incoming trade offers
    function listenTradeOffers() {
        onValue(ref(db,`tradeOffers/${user.id}`), snap => {
            const offers = snap.val()||{};
            const count = Object.keys(offers).length;
            let badge = document.getElementById('badge-trade');
            if(!badge) {
                badge = document.createElement('div');
                badge.id='badge-trade';
                badge.className='badge';
                badge.style.cssText='position:absolute;top:-4px;right:-4px;background:#e74c3c;color:white;font-size:9px;font-weight:bold;border-radius:50%;width:16px;height:16px;display:none;align-items:center;justify-content:center;z-index:5;';
                const frBtn = document.querySelector('.nav-btn[onclick*="friends"]');
                if(frBtn){frBtn.style.position='relative';frBtn.appendChild(badge);}
            }
            badge.innerText=count; badge.style.display=count>0?'flex':'none';
            // Render incoming trades in friends page
            const container = document.getElementById('trade-offers-section');
            if(container) renderTradeOffers(offers);
        });
    }

    function renderTradeOffers(offers) {
        const container = document.getElementById('trade-offers-section');
        if(!container) return;
        const entries = Object.entries(offers);
        if(!entries.length){container.innerHTML='';return;}
        container.innerHTML=`
            <div style="background:linear-gradient(135deg,rgba(46,204,113,0.08),rgba(46,204,113,0.03));border:1px solid rgba(46,204,113,0.25);border-radius:18px;padding:14px;margin-bottom:12px;">
                <div style="font-size:11px;font-weight:bold;color:var(--green);letter-spacing:0.5px;text-transform:uppercase;margin-bottom:10px;">   (${entries.length})</div>
                ${entries.map(([key,offer])=>`
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;background:#0a1520;border-radius:12px;padding:10px 12px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.06);">
                        <div style="display:flex;align-items:center;gap:10px;flex:1;">
                            <div style="font-size:28px;">${offer.itemEmoji}</div>
                            <div>
                                <div style="font-weight:bold;font-size:13px;">${offer.itemName}</div>
                                <div style="font-size:11px;color:var(--secondary);"> ${offer.fromName}</div>
                            </div>
                        </div>
                        <button class="btn" style="padding:8px 14px;font-size:12px;width:auto;background:var(--green);" onclick='acceptTradeOffer("${key}",${JSON.stringify(offer)})'> </button>
                    </div>
                `).join('')}
            </div>`;
    }

    // 
    //    
    // 
    //             
    window.openDuelFromNav = async () => {
        const profBtn = document.querySelector('.nav-btn[onclick*="profile"]');
        tab('profile', profBtn);
        setTimeout(async () => {
            const s = await get(ref(db,'users/'+user.id)), d = s.val();
            const inv = d.cloudInv||[];
            if(!inv.length) return showToast('     !','var(--err)');
            const friends = d.friends||{};
            if(!Object.keys(friends).length) return showToast('   !','var(--err)');
            const cat2 = (x) => { const c=catalog.find(cc=>cc.id==x.id); return x.img||(c&&c.img); };
            const emoji2 = (x) => { const c=catalog.find(cc=>cc.id==x.id); return x.i||(c&&c.i)||''; };
            document.getElementById('modal-content').innerHTML = `
                <h3>    </h3>
                <div style="display:flex;flex-wrap:wrap;gap:8px;max-height:320px;overflow-y:auto;padding:4px;">
                    ${inv.map(x=>{
                        const img=cat2(x), em=emoji2(x);
                        return `<div onclick="openDuelModal('${x.inst}')" style="cursor:pointer;text-align:center;background:#0a1520;border-radius:14px;padding:8px 6px;border:2px solid rgba(255,255,255,0.06);transition:all 0.2s;width:80px;height:80px;display:flex;flex-direction:column;align-items:center;justify-content:center;" onmouseover="this.style.borderColor='rgba(231,76,60,0.5)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.06)'">
                            ${img?`<img src="${img}" style="width:44px;height:44px;object-fit:contain;margin-bottom:4px;">`:`<span style="font-size:32px;line-height:1;margin-bottom:4px;">${em}</span>`}
                            <div style="font-size:9px;font-weight:bold;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:72px;">${x.n}</div>
                        </div>`;
                    }).join('')}
                </div>
                <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);margin-top:10px;" onclick="closeModal()"></button>`;
            openModal();
        }, 300);
    };

    window.openDuelModal = async (inst) => {
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const inv = d.cloudInv||[];
        const myItem = inv.find(x=>String(x.inst)==String(inst));
        if(!myItem) return showToast('  !','var(--err)');
        const friends = d.friends||{};
        if(!Object.keys(friends).length) return showToast('   !','var(--err)');
        const cat = catalog.find(c=>c.id==myItem.id);
        const img = (myItem.imgKey==='pan'?PAN_IMG:null)||myItem.img||(cat&&cat.img);
        const emoji = myItem.i||(cat&&cat.i)||'';
        document.getElementById('modal-content').innerHTML=`
            <div style="padding:5px 0;">
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="font-size:36px;"></div>
                    <h3 style="margin:6px 0 4px;background:linear-gradient(90deg,#ff6b6b,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;"> </h3>
                    <div style="font-size:12px;color:var(--secondary);">   !</div>
                </div>
                <div style="background:#0a1520;border-radius:14px;padding:12px;text-align:center;margin-bottom:14px;border:2px solid rgba(255,107,107,0.3);">
                    <div style="font-size:11px;color:var(--secondary);margin-bottom:6px;"> </div>
                    ${img?`<img src="${img}" style="width:56px;height:56px;object-fit:contain;margin:0 auto 6px;display:block;">`:`<div style="font-size:44px;">${emoji}</div>`}
                    <div style="font-weight:bold;color:#ff6b6b;">${myItem.n}</div>
                </div>
                <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;margin-bottom:8px;"> :</div>
                <div style="display:flex;flex-direction:column;gap:8px;max-height:220px;overflow-y:auto;margin-bottom:12px;">
                    ${Object.entries(friends).map(([fid,fd])=>`
                        <button class="btn" style="background:rgba(255,107,107,0.08);border:1px solid rgba(255,107,107,0.25);color:white;display:flex;align-items:center;gap:10px;padding:12px;" onclick="startDuel('${inst}','${fid}','${fd.name}')">
                            <span style="font-size:20px;"></span>
                            <span style="font-weight:bold;">${fd.name}</span>
                            <span style="margin-left:auto;font-size:18px;"></span>
                        </button>
                    `).join('')}
                </div>
                <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);" onclick="closeModal()"></button>
            </div>`;
        openModal();
    };

    window.startDuel = async (myInst, friendId, friendName) => {
        //  
        const dPrivSnap=await get(ref(db,'users/'+friendId));
        const dPriv=(dPrivSnap.val()&&dPrivSnap.val().privacy)||{};
        if(dPriv.allowDuel===false) return showToast(`     ${friendName}   -   `,'var(--err)');
        // Send duel challenge
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const myItem = (d.cloudInv||[]).find(x=>String(x.inst)==String(myInst));
        if(!myItem) return showToast('  !','var(--err)');
        const duelKey = `${user.id}_${Date.now()}`;
        await set(ref(db,`duelChallenges/${friendId}/${duelKey}`),{
            fromId:user.id, fromName:user.name,
            itemInst:myInst, itemName:myItem.n, itemEmoji:myItem.i||'',
            ts:Date.now(), expiresAt: Date.now() + 15*60*1000
        });
        //   15 
        setTimeout(async () => {
            try {
                const snap = await get(ref(db,`duelChallenges/${friendId}/${duelKey}`));
                if(snap.exists()) await remove(ref(db,`duelChallenges/${friendId}/${duelKey}`));
            } catch(e){}
        }, 15*60*1000);
        getTgId(friendId).then(cid=>sendTg(cid,` <b>  !</b>\n\n<b>${user.name}</b>   !\n\n  : <b>${myItem.n} ${myItem.i||''}</b>\n    !\n\n      `));
        logActivity('duel_challenge', {user: user.name, userId: user.id, toName: friendName, toId: friendId, item: myItem.n, emoji: myItem.i||''});
        closeModal();
        showToast(`   ${friendName}!`,'#ff6b6b','');
    };

    window.acceptDuelChallenge = async (duelKey, challenge) => {
        // Show your gifts to pick your stake
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const myInv = d.cloudInv||[];
        if(!myInv.length) return showToast('     !','var(--err)');
        const makeCard = (x) => {
            const cat = catalog.find(c=>c.id==x.id);
            const img = (x.imgKey==='pan'?PAN_IMG:null)||x.img||(cat&&cat.img);
            const emoji = x.i||(cat&&cat.i)||'';
            return `<div onclick="selectDuelGift('${x.inst}',this)" style="cursor:pointer;text-align:center;background:#0a1520;border-radius:14px;padding:10px 8px;border:2px solid rgba(255,255,255,0.06);transition:all 0.2s;" class="duel-my-card">
                ${img?`<img src="${img}" style="width:40px;height:40px;object-fit:contain;display:block;margin:0 auto 5px;" onerror="this.style.display='none'">`:`<div style="font-size:32px;line-height:1;margin-bottom:5px;">${emoji}</div>`}
                <div style="font-size:10px;font-weight:bold;color:white;">${x.n}</div>
            </div>`;
        };
        document.getElementById('modal-content').innerHTML=`
            <div style="padding:5px 0;">
                <div style="text-align:center;margin-bottom:14px;">
                    <div style="font-size:32px;"></div>
                    <h3 style="margin:6px 0 4px;background:linear-gradient(90deg,#ff6b6b,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">!</h3>
                    <div style="background:#0a1520;border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0;border:1px solid rgba(255,107,107,0.3);">
                        <div style="font-size:24px;">${challenge.itemEmoji}</div>
                        <div><div style="font-size:11px;color:var(--secondary);"> ${challenge.fromName.toUpperCase()}</div><div style="font-weight:bold;color:#ff6b6b;">${challenge.itemName}</div></div>
                    </div>
                    <div style="font-size:12px;color:var(--secondary);">  :</div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-height:220px;overflow-y:auto;margin-bottom:14px;">
                    ${myInv.map(makeCard).join('')}
                </div>
                <div id="duel-selected-info" style="display:none;background:rgba(255,107,107,0.08);border:1px solid rgba(255,107,107,0.3);border-radius:14px;padding:8px;text-align:center;margin-bottom:12px;">
                    <div style="font-size:11px;color:var(--secondary);"> </div>
                    <div id="duel-selected-name" style="font-weight:bold;color:#ff6b6b;"></div>
                </div>
                <button id="duel-fight-btn" class="btn" style="background:linear-gradient(90deg,#e74c3c,#c0392b);display:none;" onclick="fightDuel('${duelKey}','${challenge.fromId}','${challenge.itemInst}','${challenge.fromName}','${challenge.itemEmoji}','${challenge.itemName}')">  !</button>
                <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);margin-top:8px;" onclick="declineDuel('${duelKey}')"> </button>
            </div>`;
        openModal();
    };

    let selectedDuelInst = null, selectedDuelEmoji = '', selectedDuelName = '';
    window.selectDuelGift = (inst, el) => {
        selectedDuelInst = inst;
        document.querySelectorAll('.duel-my-card').forEach(c=>{c.style.border='2px solid rgba(255,255,255,0.06)';c.style.background='#0a1520';});
        el.style.border='2px solid #ff6b6b';el.style.background='rgba(255,107,107,0.1)';
        const imgEl = el.querySelector('img');
        selectedDuelEmoji = el.querySelector('div[style*="font-size:32px"]')?.innerText || '';
        selectedDuelName = el.querySelector('div[style*="font-weight:bold"]')?.innerText||'?';
        document.getElementById('duel-selected-info').style.display='block';
        document.getElementById('duel-selected-name').innerText=selectedDuelName;
        document.getElementById('duel-fight-btn').style.display='block';
    };

    window.fightDuel = async (duelKey, challengerId, theirInst, challengerName, theirEmoji, theirItemName) => {
        if(!selectedDuelInst) return showToast(' !','var(--err)');

        // Fetch both inventories
        const [mySnap, theirSnap] = await Promise.all([get(ref(db,'users/'+user.id)), get(ref(db,'users/'+challengerId))]);
        const myD = mySnap.val(), theirD = theirSnap.val();
        let myInv = myD.cloudInv||[], theirInv = theirD.cloudInv||[];
        const myItem = myInv.find(x=>String(x.inst)==String(selectedDuelInst));
        const theirItem = theirInv.find(x=>String(x.inst)==String(theirInst));
        if(!myItem||!theirItem) { closeModal(); return showToast('    !','var(--err)'); }

        // Determine winner 50/50
        const iWin = Math.random() < 0.5;
        const winnerId = iWin ? user.id : challengerId;
        const winnerName = iWin ? user.name : challengerName;
        const myEmoji2 = myItem.i||(catalog.find(c=>c.id==myItem.id)?.i)||'';

        // Update inventories
        if(iWin) {
            myInv = myInv.filter(x=>String(x.inst)!=String(selectedDuelInst));
            theirInv = theirInv.filter(x=>String(x.inst)!=String(theirInst));
            myInv.push({...myItem, from:` `, inst:Date.now()});
            myInv.push({...theirItem, from:` ${challengerName}`, seen:false, inst:Date.now()+1});
        } else {
            myInv = myInv.filter(x=>String(x.inst)!=String(selectedDuelInst));
            theirInv = theirInv.filter(x=>String(x.inst)!=String(theirInst));
            theirInv.push({...myItem, from:` ${user.name}`, seen:false, inst:Date.now()});
            theirInv.push({...theirItem, from:` `, inst:Date.now()+1});
        }

        await Promise.all([
            update(ref(db,'users/'+user.id),{cloudInv:myInv}),
            update(ref(db,'users/'+challengerId),{cloudInv:theirInv}),
            remove(ref(db,`duelChallenges/${user.id}/${duelKey}`))
        ]);
        logActivity('duel_result', {winner: winnerName, winnerId, loser: iWin ? challengerName : user.name, loserId: iWin ? challengerId : user.id, item1: myItem.n, item2: theirItem.n});
        //     
        if(iWin) {
            const newWins = (myD.duelWins||0) + 1;
            const winsUpdate = {duelWins: newWins};
            const ownedSet = new Set(myD.cosmetics||[]);
            if(newWins >= 10 && !ownedSet.has('bdg_duelist')) {
                winsUpdate.cosmetics = [...(myD.cosmetics||[]), 'bdg_duelist'];
            }
            await update(ref(db,'users/'+user.id), winsUpdate);
        }

        // DUEL ANIMATION
        const overlay = document.getElementById('modal-overlay');
        document.getElementById('modal-content').innerHTML = `
            <div style="text-align:center;padding:20px 0;" id="duel-anim-wrap">
                <div style="font-size:13px;color:var(--secondary);margin-bottom:20px;letter-spacing:1px;text-transform:uppercase;">  !</div>
                <div style="display:flex;align-items:center;justify-content:center;gap:20px;">
                    <div id="duel-left" style="text-align:center;transition:all 1s ease;">
                        <div style="font-size:52px;margin-bottom:8px;">${myEmoji2}</div>
                        <div style="font-size:12px;font-weight:bold;color:#4db4ff;">${user.name}</div>
                    </div>
                    <div id="duel-vs" style="font-size:32px;font-weight:900;color:#ff6b6b;">VS</div>
                    <div id="duel-right" style="text-align:center;transition:all 1s ease;">
                        <div style="font-size:52px;margin-bottom:8px;">${theirEmoji}</div>
                        <div style="font-size:12px;font-weight:bold;color:#ff6b6b;">${challengerName}</div>
                    </div>
                </div>
                <div id="duel-result" style="margin-top:24px;opacity:0;transition:opacity 0.5s;"></div>
            </div>`;

        // Phase 1: shake
        setTimeout(()=>{
            document.getElementById('duel-left').style.animation='duelShakeL 0.4s ease-in-out 4';
            document.getElementById('duel-right').style.animation='duelShakeR 0.4s ease-in-out 4';
            overlay.style.animation='duelFlash 0.4s ease 4';
        },300);

        // Phase 2: clash emoji
        setTimeout(()=>{
            const el=document.createElement('div');el.className='duel-clash-emoji';el.innerText='';
            document.body.appendChild(el);setTimeout(()=>el.remove(),900);
        },900);

        // Phase 3: result
        setTimeout(()=>{
            overlay.style.animation='';
            if(iWin){
                document.getElementById('duel-left').style.animation='duelWinner 0.6s ease forwards';
                document.getElementById('duel-right').style.animation='duelLoser 0.6s ease forwards';
            } else {
                document.getElementById('duel-right').style.animation='duelWinner 0.6s ease forwards';
                document.getElementById('duel-left').style.animation='duelLoser 0.6s ease forwards';
            }
        },1800);

        // Phase 4: show result text
        setTimeout(()=>{
            const res=document.getElementById('duel-result');
            if(!res) return;
            res.style.opacity='1';
            if(iWin){
                spawnConfetti(window.innerWidth/2,window.innerHeight/2,60);
                const newWins2 = (myD.duelWins||0) + 1;
                const badgeJustUnlocked = newWins2 >= 10 && !new Set(myD.cosmetics||[]).has('bdg_duelist');
                res.innerHTML=`<div style="font-size:36px;margin-bottom:10px;"></div><div style="font-size:20px;font-weight:900;color:gold;"> !</div><div style="font-size:13px;color:var(--secondary);margin-top:6px;">   </div><div style="font-size:12px;color:#4db4ff;margin-top:8px;"> : ${newWins2}/10</div>${badgeJustUnlocked?'<div style="margin-top:10px;background:linear-gradient(135deg,rgba(255,107,107,0.15),rgba(255,215,0,0.1));border:1px solid rgba(255,215,0,0.4);border-radius:14px;padding:10px;"><div style="font-size:22px;"></div><div style="font-weight:bold;color:gold;font-size:13px;">  !</div></div>':''}`;
                if(badgeJustUnlocked) setTimeout(()=>showToast('   !','gold'), 500);
            } else {
                res.innerHTML=`<div style="font-size:36px;margin-bottom:10px;"></div><div style="font-size:20px;font-weight:900;color:#ff6b6b;"> </div><div style="font-size:13px;color:var(--secondary);margin-top:6px;">${challengerName}   </div>`;
            }
            setTimeout(()=>{
                if(!document.getElementById('duel-close-btn')){
                    const btn=document.createElement('button');btn.className='btn';btn.id='duel-close-btn';btn.style.marginTop='16px';btn.innerText='';btn.onclick=closeModal;
                    document.getElementById('duel-result').appendChild(btn);
                }
            },200);
        },2600);

        //    
        if(iWin) {
            // challenger    (theirItem)
            getTgId(challengerId).then(cid=>sendTg(cid,` <b> !</b>\n\n : <b>${winnerName}</b>\n\n  ,  .\n : <b>${theirItemName}</b> ${theirEmoji}`));
        } else {
            // challenger   
            getTgId(challengerId).then(cid=>sendTg(cid,` <b> !</b>\n\n : <b>${winnerName}</b>\n\n ,  !\n : <b>${theirItemName}</b> ${theirEmoji}\n : <b>${myItem.n}</b> ${myEmoji2}`));
        }
    };

    window.declineDuel = async (duelKey) => {
        await remove(ref(db,`duelChallenges/${user.id}/${duelKey}`));
        closeModal();
        showToast(' ','var(--secondary)');
    };

    // Listen for duel challenges
    function listenDuelChallenges() {
        onValue(ref(db,`duelChallenges/${user.id}`), snap => {
            const challenges = snap.val()||{};
            renderDuelChallenges(challenges);
        });
        //    30  +  
        setInterval(async () => {
            const snap = await get(ref(db,`duelChallenges/${user.id}`));
            const challenges = snap.val()||{};
            const now = Date.now();
            for(const [key, ch] of Object.entries(challenges)) {
                const expiry = ch.expiresAt || (ch.ts + 15*60*1000);
                if(now >= expiry) remove(ref(db,`duelChallenges/${user.id}/${key}`)).catch(()=>{});
            }
            renderDuelChallenges(challenges);
        }, 30000);
    }

    function renderDuelChallenges(challenges) {
        const container = document.getElementById('duel-challenges-section');
        if(!container) return;
        const now = Date.now();
        //   (  UI)
        const entries = Object.entries(challenges).filter(([k,ch]) => {
            const expiry = ch.expiresAt || (ch.ts + 15*60*1000);
            return now < expiry;
        });
        //   
        const badge = document.getElementById('badge-duel');
        if(badge) { badge.style.display = entries.length > 0 ? 'flex' : 'none'; badge.textContent = entries.length; }
        if(!entries.length){container.innerHTML='';return;}
        container.innerHTML=`
            <div style="background:linear-gradient(135deg,rgba(255,107,107,0.08),rgba(255,107,107,0.03));border:1px solid rgba(255,107,107,0.3);border-radius:18px;padding:14px;margin-bottom:12px;">
                <div style="font-size:11px;font-weight:bold;color:#ff6b6b;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:10px;">    (${entries.length})</div>
                ${entries.map(([key,ch])=>{
                    const expiry = ch.expiresAt||(ch.ts+15*60*1000);
                    const mLeft = Math.max(0,Math.floor((expiry-now)/60000));
                    const sLeft = Math.max(0,Math.floor(((expiry-now)%60000)/1000));
                    return `<div style="display:flex;align-items:center;justify-content:space-between;gap:10px;background:#0a1520;border-radius:12px;padding:10px 12px;margin-bottom:8px;border:1px solid rgba(255,107,107,0.2);">
                        <div style="display:flex;align-items:center;gap:10px;flex:1;">
                            <div style="font-size:28px;">${ch.itemEmoji}</div>
                            <div>
                                <div style="font-weight:bold;font-size:13px;">${ch.itemName}</div>
                                <div style="font-size:11px;color:var(--secondary);"> ${ch.fromName}</div>
                                <div style="font-size:10px;color:var(--orange);"> ${mLeft}:${String(sLeft).padStart(2,'0')}</div>
                            </div>
                        </div>
                        <button class="btn" style="padding:8px 14px;font-size:12px;width:auto;background:linear-gradient(90deg,#e74c3c,#c0392b);" onclick='acceptDuelChallenge("${key}",${JSON.stringify(ch)})'> </button>
                    </div>`;
                }).join('')}
            </div>`;
    }

    window.giftOpen = async (inst) => {
        const s=await get(ref(db,'users/'+user.id)),frs=s.val().friends||{};
        if(!Object.keys(frs).length) return showToast(" !",'var(--err)');
        document.getElementById('modal-content').innerHTML=`
            <h3></h3>
            <div style="max-height:200px;overflow-y:auto;">
                ${Object.entries(frs).map(([id,d])=>`<button class="btn" style="margin-bottom:10px;" onclick="sendG('${inst}','${id}')"> ${d.name}</button>`).join('')}
            </div>
            <button class="btn" style="background:none;margin-top:5px;" onclick="closeModal()"></button>`;
        openModal();
    };
    window.sendG = async (inst,fid) => {
        const r=ref(db,'users/'+user.id),s=await get(r),d=s.val();
        const inv=d.cloudInv||[],itm=inv.find(x=>x.inst==inst);
        if(!itm) return showToast(" !",'var(--err)');
        //   
        const frSnap2=await get(ref(db,'users/'+fid));
        const frPrivacy=(frSnap2.val()&&frSnap2.val().privacy)||{};
        if(frPrivacy.allowGifts===false) return showToast("        -   ",'var(--err)');
        const newGiven=(d.giftsGiven||0)+1;
        await update(r,{cloudInv:inv.filter(x=>x.inst!=inst),pinnedInsts:(d.pinnedInsts||[]).filter(id=>String(id)!=String(inst)),giftsGiven:newGiven});
        const frS=await get(ref(db,'users/'+fid)),frInv=frS.val().cloudInv||[];
        frInv.push({...itm,from:user.name,seen:false,inst:Date.now()});
        await update(ref(db,'users/'+fid),{cloudInv:frInv,giftsReceived:(frS.val().giftsReceived||0)+1});
        getTgId(fid).then(cid=>sendTg(cid,` <b> !</b>\n\n<b>${user.name}</b>  :\n${itm.i||''} <b>${itm.n}</b>\n\n : <b>${RARITY_LEVELS[itm.r]&&RARITY_LEVELS[itm.r].label||''}</b>\n\n   !`));
        closeModal();spawnConfetti(window.innerWidth/2,window.innerHeight/2,40);
        flyEmoji('',window.innerWidth/2,window.innerHeight/2);
        showToast(" ! ",'var(--green)');
        logActivity('gift_sent', {user: user.name, userId: user.id, toId: fid, item: itm.n, emoji: itm.i||''});
        renderInv();
    };
    function renderMyProfile(d) {
        const inv = d.cloudInv || [];
        const friends = d.friends || {};
        const friendCount = Object.keys(friends).length;

        const pinnedInsts = new Set((d.pinnedInsts||[]).map(String));
        const sortedInv = [
            ...inv.filter(x => pinnedInsts.has(String(x.inst))),
            ...inv.filter(x => !pinnedInsts.has(String(x.inst)))
        ];

        const makeGiftCell = (x) => {
            const cat = catalog.find(c => c.id == x.id);
            const img = (x.imgKey==='pan'?PAN_IMG:null) || x.img || (cat && cat.img);
            const emoji = x.i || (cat && cat.i) || '';
            const isPin = pinnedInsts.has(String(x.inst));
            const isNFT = !!x.nft;
            const isLizard = isNFT && x.id === 997;
            const nftClass = isNFT ? (isLizard ? ' tg-gift-nft-lizard' : ' tg-gift-nft') : '';
            const nftPrice = isNFT ? (x.id===997?7000:x.id===998?10000:x.id===999?5000:(x.price||0)) : 0;
            // NFT upgrade
            const upgClasses = isNFT ? getNftUpgradeClasses(x) : '';
            const upgBadge = isNFT ? getNftUpgradeBadge(x) : '';
            const particleHtml = isNFT ? getNftParticleHtml(x) : '';
            return `<div class="tg-gift-cell${nftClass}${isPin?' tg-gift-pinned':''}${upgClasses?' '+upgClasses:''}" onclick="openGiftDetail('${x.inst}')" style="position:relative;">
                ${isNFT ? `<div class="tg-gift-nft-badge">NFT</div>` : ''}
                ${upgBadge}
                ${particleHtml}
                ${isPin ? `<div style="position:absolute;top:5px;left:5px;font-size:12px;z-index:3;filter:drop-shadow(0 1px 3px rgba(0,0,0,0.8));"></div>` : ''}
                <div class="tg-gift-inner">
                    ${img ? `<img src="${img}" alt="${x.n}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><span style="display:none;font-size:34px;">${emoji}</span>` : `<span style="font-size:34px;">${emoji}</span>`}
                    ${x.from ? `<div class="tg-gift-from">${x.from}</div>` : ''}
                </div>
                ${isNFT && x.nftSerial ? `<div class="tg-gift-nft-serial">#${x.nftSerial}</div>` : ''}
                <div class="tg-gift-name">${x.n}</div>
                ${isNFT ? `<div class="tg-gift-nft-price">${nftPrice.toLocaleString()}</div>` : ''}
            </div>`;
        };

        const giftsGrid = sortedInv.length ? sortedInv.map(makeGiftCell).join('') 
        : `<div style="grid-column:1/-1;text-align:center;padding:40px 20px;color:var(--secondary);">
            <div style="font-size:48px;margin-bottom:12px;"></div>
            <div style="font-size:14px;">  </div>
            <div style="font-size:12px;margin-top:6px;opacity:0.6;">     </div>
        </div>`;

        document.getElementById('profile').innerHTML = `
        <div class="tg-profile">
            <div class="tg-profile-hero">
                <div class="avatar-ring-wrap">
                    ${(() => {
                        const pinnedArr = [...pinnedInsts]
                            .map(inst => inv.find(x => String(x.inst) === String(inst)))
                            .filter(item => item && item.nft)
                            .slice(0, 6);
                        if(!pinnedArr.length) return '';
                        const angle = 360 / pinnedArr.length;
                        const radius = 72; // centre=100, avatar radius=50 + gap 8 + item half 14 = 72
                        return `<div class="avatar-ring-orbit" style="position:absolute;top:0;left:0;width:200px;height:200px;pointer-events:none;">${pinnedArr.map((item, i) => {
                            const cat2 = catalog.find(c => c.id == item.id);
                            const img2 = item.img || (cat2 && cat2.img);
                            const em2 = item.i || (cat2 && cat2.i) || '';
                            const rad = (angle * i - 90) * Math.PI / 180;
                            const x2 = Math.round(100 + radius * Math.cos(rad) - 14);
                            const y2 = Math.round(100 + radius * Math.sin(rad) - 14);
                            const upgCls2 = item.upgrade && item.upgrade.level ? getNftUpgradeClasses(item) : '';
                            const upgStyle2 = (()=>{
                                if(!item.upgrade||!item.upgrade.level) return '';
                                const lvlD=NFT_UPGRADE_LEVELS[item.upgrade.level];
                                const thD=lvlD&&lvlD.themes&&lvlD.themes.find(t=>t.id===item.upgrade.theme);
                                if(!thD) return '';
                                if(item.upgrade.level===1){
                                    const c={fire:'255,80,0',ocean:'0,150,255',forest:'0,200,80',galaxy:'150,50,255',sunset:'255,100,150'}[item.upgrade.theme];
                                    return c?`border-color:rgba(${c},0.9);box-shadow:0 0 10px rgba(${c},0.6),0 2px 10px rgba(0,0,0,0.6);`:'';
                                }
                                if(item.upgrade.level>=3){
                                    const c={fire:'255,80,0',ocean:'0,150,255',forest:'0,200,80',galaxy:'150,50,255',sunset:'255,100,150'}[item.upgrade.theme];
                                    return c?`border-color:rgba(${c},0.9);box-shadow:0 0 14px rgba(${c},0.8),0 2px 10px rgba(0,0,0,0.6);`:'';
                                }
                                return '';
                            })();
                            return `<div class="avatar-ring-item ring-nft ${upgCls2}" style="left:${x2}px;top:${y2}px;${upgStyle2}" data-inst="${item.inst}">${img2?'<img src="'+img2+'" onerror="this.style.display=\'none\'">':'<span>'+em2+'</span>'}</div>`;
                        }).join('')}</div>`;
                    })()}
                    <div class="tg-avatar-wrap" style="position:relative;z-index:2;margin:0;flex-shrink:0;">
                        <img src="${d.pic || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
                             class="tg-avatar" onclick="openEdit()"
                             onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                        <div class="tg-avatar-edit" onclick="openEdit()"></div>
                    </div>
                </div>
                <h2 class="tg-username">${buildUsername(d)}</h2>
                <p class="tg-bio">${d.bio || ' '}</p>
                <div class="tg-stats">
                    <div class="tg-stat"><div class="tg-stat-val">${inv.length}</div><div class="tg-stat-lbl"></div></div>
                    <div class="tg-stat-div"></div>
                    <div class="tg-stat"><div class="tg-stat-val">${friendCount}</div><div class="tg-stat-lbl"></div></div>
                    <div class="tg-stat-div"></div>
                    <div class="tg-stat"><div class="tg-stat-val">${(d.balance||0).toLocaleString()}</div><div class="tg-stat-lbl"> </div></div>
                </div>
                <div class="tg-actions">
                    <button class="tg-action-btn" onclick="openEdit()"><span class="tg-action-icon"></span><span></span></button>
                    <button class="tg-action-btn" onclick="openPromoModal()"><span class="tg-action-icon"></span><span></span></button>
                    ${inv.some(x=>x.nft) ? `<button class="tg-action-btn" style="background:rgba(124,58,237,0.15);border:1px solid rgba(124,58,237,0.3);" onclick="openNftUpgradeSelect()"><span class="tg-action-icon"></span><span></span></button>` : ''}
                    <button class="tg-action-btn tg-action-tg" onclick="window.open('https://t.me/Gifts_World_Pro','_blank')"><span class="tg-action-icon"></span><span></span></button>
                    <button class="tg-action-btn tg-action-red" onclick="logout()"><span class="tg-action-icon"></span><span></span></button>
                </div>
            </div>
            <div class="tg-gifts-section">
                <div class="tg-gifts-header">
                    <span> </span>
                    <span class="tg-gifts-count">${inv.length}</span>
                </div>
                <div class="tg-gifts-grid">${giftsGrid}</div>
            </div>
            <div style="padding:0 15px 15px;">
                <a href="https://dalink.to/gifworld" target="_blank" class="btn" style="background:#1a2636;border:1px solid rgba(255,255,255,0.08);color:var(--secondary);font-size:13px;">  </a>
            </div>
            <div style="padding:4px 0 20px;text-align:center;">
                <span style="font-size:9px;color:#131f2c;letter-spacing:0.3px;cursor:default;">               </span>
            </div>
        </div>`;
    }

    window.openGiftDetail = async (inst) => {
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const inv = d.cloudInv || [];
        const x = inv.find(i => String(i.inst) == String(inst));
        if (!x) return;
        const cat = catalog.find(c => c.id == x.id);
        const img = (x.imgKey==='pan'?PAN_IMG:null) || x.img || (cat && cat.img);
        const emoji = x.i || (cat && cat.i) || '';
        const frs = d.friends || {};
        const isPinned = (d.pinnedInsts||[]).some(id => String(id) == String(inst));

        const rarObj2 = getRarityObj(x);
        const rarLevel2 = getRarityLevel(x);

        const price = x.nft ? 5000 : getPrice(x.id||0);
        const rarMultiplier = x.nft ? 1 : [1, 2, 5, 15][rarLevel2] || 1;
        const marketPrice = x.nft ? (x.id===997?7000:x.id===998?10000:x.id===999?5000:5000) : Math.round(price * rarMultiplier);
        const origin = x.from ? (x.from === 'PROMO' ? ' ' : x.from === 'ADMIN' ? '  ' : x.from === 'RESET' ? ' ' : x.from === ' ' ? '  ' : ' : ' + x.from) : '   ';

        const rarLabel = x.nft
            ? `<span class="rarity-nft"> NFT  </span>`
            : `<span style="display:inline-block;background:rgba(255,255,255,0.06);border-radius:20px;padding:3px 12px;font-size:12px;font-weight:bold;" class="${rarObj2.cls}">${rarObj2.icon} ${rarObj2.label}</span>`;

        document.getElementById('modal-content').innerHTML = `
            <div style="padding:5px 0;">
                <!-- Gift image -->
                <div style="text-align:center;margin-bottom:16px;">
                    ${(() => {
                        const upg = x.upgrade;
                        const hasUpg = x.nft && upg && upg.level >= 1;
                        const lvl = hasUpg ? upg.level : 0;
                        const themeId = hasUpg ? upg.theme : null;
                        const themeColors = {fire:'255,80,0',ocean:'0,150,255',forest:'0,200,80',galaxy:'150,50,255',sunset:'255,100,150',ice:'136,221,255',magic:'204,136,255',gold:'255,215,0',dark:'136,0,204',grid:'100,200,255',dots:'255,200,100',hex:'100,255,200',waves:'100,150,255',stars:'255,255,150',holo:'255,215,0'};
                        const tc = themeId && themeColors[themeId] ? themeColors[themeId] : null;
                        const themeEmojis = {fire:'',ocean:'',forest:'',galaxy:'',sunset:'',ice:'',magic:'',gold:'',dark:'',grid:'',dots:'',hex:'',waves:'',stars:'',holo:''};

                        // Border & glow based on level
                        let borderStyle = x.nft ? '2px solid rgba(255,215,0,0.3)' : '1px solid rgba(255,255,255,0.08)';
                        let bgStyle = x.nft ? 'rgba(255,215,0,0.06)' : 'rgba(255,255,255,0.04)';
                        let boxShadow = '';
                        let extraOverlay = '';
                        let animClass = '';

                        if(hasUpg) {
                            if(lvl === 1 && tc) {
                                borderStyle = `2px solid rgba(${tc},0.8)`;
                                bgStyle = `rgba(${tc},0.08)`;
                                boxShadow = `0 0 20px rgba(${tc},0.35), 0 0 40px rgba(${tc},0.15)`;
                            } else if(lvl === 2 && tc) {
                                borderStyle = `2px solid rgba(${tc},0.7)`;
                                bgStyle = `rgba(${tc},0.08)`;
                                boxShadow = `0 0 20px rgba(${tc},0.35)`;
                                // texture overlay
                                const texMap = {grid:'repeating-linear-gradient(0deg,rgba(255,255,255,0.04) 0px,rgba(255,255,255,0.04) 1px,transparent 1px,transparent 20px),repeating-linear-gradient(90deg,rgba(255,255,255,0.04) 0px,rgba(255,255,255,0.04) 1px,transparent 1px,transparent 20px)',dots:'radial-gradient(circle,rgba(255,255,255,0.08) 1px,transparent 1px)',hex:'',waves:'repeating-linear-gradient(45deg,rgba(255,255,255,0.04) 0,rgba(255,255,255,0.04) 2px,transparent 2px,transparent 10px)',stars:'radial-gradient(circle,rgba(255,255,255,0.12) 1px,transparent 1px)'};
                                const tex = texMap[themeId] || '';
                                if(tex) extraOverlay = `<div style="position:absolute;inset:0;border-radius:28px;background:${tex};background-size:20px 20px;pointer-events:none;opacity:0.6;"></div>`;
                            } else if(lvl === 3 && tc) {
                                borderStyle = `2px solid rgba(${tc},0.9)`;
                                bgStyle = `rgba(${tc},0.1)`;
                                boxShadow = `0 0 25px rgba(${tc},0.6), 0 0 50px rgba(${tc},0.25), inset 0 0 20px rgba(${tc},0.1)`;
                                animClass = 'modal-aura-pulse';
                            } else if(lvl === 4 && tc) {
                                borderStyle = `2px solid rgba(${tc},0.8)`;
                                bgStyle = `rgba(${tc},0.08)`;
                                boxShadow = `0 0 20px rgba(${tc},0.4)`;
                                const pe = themeEmojis[themeId]||'';
                                const pcs = [{l:'8%',t:'8%',d:'0s'},{l:'75%',t:'5%',d:'0.3s'},{l:'85%',t:'65%',d:'0.7s'},{l:'5%',t:'72%',d:'1s'},{l:'45%',t:'90%',d:'0.5s'},{l:'90%',t:'35%',d:'1.2s'}];
                                extraOverlay = pcs.map(p=>`<div style="position:absolute;left:${p.l};top:${p.t};font-size:14px;pointer-events:none;animation:particleFloat 2s ease-in-out ${p.d} infinite;">${pe}</div>`).join('');
                            } else if(lvl === 5) {
                                borderStyle = '3px solid transparent';
                                bgStyle = 'rgba(20,10,30,0.95)';
                                boxShadow = '0 0 30px rgba(255,0,255,0.4), 0 0 60px rgba(0,255,255,0.2)';
                                extraOverlay = `<div style="position:absolute;inset:-3px;border-radius:31px;background:linear-gradient(135deg,#ff0000,#ff7f00,#ffff00,#00ff00,#0000ff,#8b00ff,#ff0000);background-size:400% 400%;animation:holoShine 2s ease infinite;z-index:-1;opacity:0.9;"></div><div style="position:absolute;inset:0;border-radius:28px;background:linear-gradient(135deg,transparent 30%,rgba(255,255,255,0.08) 50%,transparent 70%);background-size:200% 200%;animation:holoShine 1.5s ease infinite;pointer-events:none;"></div>`;
                            }
                        }

                        const lvlBadgeHtml = hasUpg ? `<div style="position:absolute;top:-8px;right:-8px;background:linear-gradient(135deg,${tc?`rgba(${tc},1)`:'gold'},${tc?`rgba(${tc},0.7)`:'orange'});color:white;font-size:9px;font-weight:900;border-radius:10px;padding:3px 7px;box-shadow:0 2px 8px rgba(0,0,0,0.5);z-index:5;">LVL ${lvl}</div>` : '';

                        return `<div style="position:relative;width:130px;height:130px;margin:0 auto 14px;">
                            <div class="${animClass}" style="position:relative;width:130px;height:130px;display:flex;align-items:center;justify-content:center;background:${bgStyle};border-radius:28px;border:${borderStyle};box-shadow:${boxShadow};overflow:hidden;">
                                ${extraOverlay}
                                ${img ? `<img src="${img}" style="width:100px;height:100px;object-fit:contain;filter:drop-shadow(0 6px 24px rgba(0,0,0,0.6));position:relative;z-index:1;">` : `<span style="font-size:80px;position:relative;z-index:1;">${emoji}</span>`}
                            </div>
                            ${lvlBadgeHtml}
                        </div>`;
                    })()}
                    <h3 style="margin:0 0 6px;font-size:20px;">${x.n}</h3>
                    ${rarLabel}
                    ${(() => {
                        if(!x.nft || !x.upgrade || !x.upgrade.level) return '';
                        const lvl = x.upgrade.level;
                        const themeId = x.upgrade.theme;
                        const levelDef = NFT_UPGRADE_LEVELS[lvl];
                        const themeDef = levelDef && levelDef.themes && levelDef.themes.find(t=>t.id===themeId);
                        const themeColors = {fire:'255,80,0',ocean:'0,150,255',forest:'0,200,80',galaxy:'150,50,255',sunset:'255,100,150',ice:'136,221,255',magic:'204,136,255',gold:'255,215,0',dark:'136,0,204',holo:'200,100,255'};
                        const tc = themeColors[themeId] || '255,215,0';
                        const stars = ''.repeat(lvl) + ''.repeat(5-lvl);
                        return `<div style="display:inline-flex;align-items:center;gap:6px;background:rgba(${tc},0.12);border:1px solid rgba(${tc},0.3);border-radius:20px;padding:5px 14px;margin-top:6px;">
                            <span style="font-size:13px;">${levelDef?levelDef.icon:''}</span>
                            <span style="font-size:12px;font-weight:bold;color:rgba(${tc},1);">${levelDef?levelDef.name:''} ${themeDef?' '+themeDef.name:''}</span>
                            <span style="font-size:11px;letter-spacing:1px;">${stars}</span>
                        </div>`;
                    })()}
                </div>

                <!-- Info grid -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">
                    <div style="background:#0a1520;border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.06);">
                        <div style="font-size:10px;color:var(--secondary);margin-bottom:4px;"></div>
                        <div style="font-size:12px;font-weight:bold;">${origin}</div>
                    </div>
                    <div style="background:#0a1520;border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.06);">
                        <div style="font-size:10px;color:var(--secondary);margin-bottom:4px;"> </div>
                        <div style="font-size:12px;font-weight:bold;color:gold;">${x.from && x.from !== 'RESET' ? ' ()' : price.toLocaleString() + ' '}</div>
                    </div>
                    <div style="background:#0a1520;border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.06);">
                        <div style="font-size:10px;color:var(--secondary);margin-bottom:4px;"> </div>
                        <div style="font-size:12px;font-weight:bold;color:var(--accent);">${marketPrice.toLocaleString()} </div>
                    </div>
                    <div style="background:#0a1520;border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.06);">
                        <div style="font-size:10px;color:var(--secondary);margin-bottom:4px;"></div>
                        <div style="font-size:12px;font-weight:bold;"><span class="${rarObj2.cls}">${rarObj2.icon} ${rarObj2.label}</span></div>
                    </div>
                    <div style="background:#0a1520;border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.06);grid-column:1/-1;">
                        <div style="font-size:10px;color:var(--secondary);margin-bottom:4px;"> </div>
                        <div style="font-size:13px;font-weight:bold;font-family:monospace;color:${x.nft?'gold':'var(--accent)'};">${x.nftSerial ? '#' + x.nftSerial : ''}</div>
                    </div>
                </div>

                <!-- Actions -->
                <div style="display:flex;flex-direction:column;gap:8px;">
                    ${x.nft ? `<button class="btn" style="background:linear-gradient(90deg,#7c3aed,#a855f7);font-weight:bold;" onclick="openNftUpgradeFromDetail('${inst}')">  NFT ${(x.upgrade&&x.upgrade.level)?`( ${x.upgrade.level}/5)`:''}</button>` : ''}
                    <button class="btn" style="background:${isPinned?'var(--secondary)':'var(--orange)'};" onclick="togglePin('${inst}');closeModal()">
                        ${isPinned ? ' ' : ' '}
                    </button>
                    <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);border:1px solid rgba(255,255,255,0.08);" onclick="closeModal()"></button>
                </div>
            </div>`;
        openModal();
    };

    window.openNftUpgradeSelect = async () => {
        const s = await get(ref(db, 'users/' + user.id)), d = s.val();
        const inv = (d.cloudInv || []).filter(x => x.nft);
        if (!inv.length) return showToast(' NFT  !', 'var(--err)');
        if (inv.length === 1) return openNftUpgrade(inv[0].inst);
        const cat2 = (x) => { const c = catalog.find(cc => cc.id == x.id); return x.img || (c && c.img); };
        const em2 = (x) => { const c = catalog.find(cc => cc.id == x.id); return x.i || (c && c.i) || ''; };
        document.getElementById('modal-content').innerHTML = `
            <h3 style="margin-bottom:12px;">  NFT  </h3>
            <div style="display:flex;flex-direction:column;gap:8px;max-height:400px;overflow-y:auto;">
                ${inv.map(x => {
                    const img = cat2(x), em = em2(x);
                    const lvl = (x.upgrade && x.upgrade.level) || 0;
                    return `<div onclick="closeModal();setTimeout(()=>openNftUpgrade('${x.inst}'),350)" style="display:flex;align-items:center;gap:12px;background:#0a1520;border-radius:14px;padding:12px;cursor:pointer;border:1.5px solid rgba(255,215,0,0.2);transition:0.2s;" onmouseover="this.style.borderColor='rgba(255,215,0,0.5)'" onmouseout="this.style.borderColor='rgba(255,215,0,0.2)'">
                        <div style="width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:rgba(255,215,0,0.06);border-radius:12px;flex-shrink:0;">
                            ${img ? `<img src="${img}" style="width:40px;height:40px;object-fit:contain;">` : `<span style="font-size:32px;">${em}</span>`}
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:bold;font-size:13px;">${x.n}</div>
                            <div style="font-size:11px;color:gold;"> NFT ${lvl > 0 ? `  ${lvl}/5` : '  '}</div>
                        </div>
                        <div style="color:var(--accent);font-size:18px;"></div>
                    </div>`;
                }).join('')}
            </div>
            <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);margin-top:8px;" onclick="closeModal()"></button>`;
        openModal();
    };

    window.renderMyProfileFresh = async () => {
        const s = await get(ref(db,'users/'+user.id));
        if(s.exists()) renderMyProfile(s.val());
    };

    window.openPromoModal = () => {
        document.getElementById('modal-content').innerHTML=`
            <h3>  </h3>
            <input type="text" id="promo-input" placeholder=" " style="text-transform:uppercase;font-size:18px;text-align:center;letter-spacing:3px;">
            <button class="btn" style="margin-top:5px;" onclick="usePromo()"></button>
            <button class="btn" style="background:none;margin-top:5px;" onclick="closeModal()"></button>`;
        openModal();
    };
    window.openEdit = async () => {
        const s=await get(ref(db,'users/'+user.id));
        const d=s.val();
        const owned=new Set(d.cosmetics||[]);
        const active=d.activeCosmetic||{};
        const isAdm=user.isAdm;
        const unlocked=checkUnlocks(d);
        if(unlocked.length){
            const newOwned=[...owned,...unlocked];
            await update(ref(db,'users/'+user.id),{cosmetics:newOwned});
            unlocked.forEach(id=>{owned.add(id);showToast('  : '+COSMETICS.find(c=>c.id===id).name,'var(--accent)');});
        }

        const renderCosm = (type, label) => {
            const items = COSMETICS.filter(c=>c.type===type);
            return `<div class="cosm-section-title">${label}</div>
            <div class="cosm-grid">${items.map(c=>{
                const isOwned = isAdm || owned.has(c.id);
                const isActive = active[type]===c.id;
                const canBuy = !isOwned && !c.unlock;
                const preview = type==='color'
                    ? `<span style="color:${c.val};font-weight:bold;font-size:15px;">@</span>`
                    : `<span class="cosm-preview">${c.val}</span>`;
                const priceHtml = isOwned
                    ? `<span style="color:var(--green);font-size:11px;"> </span>`
                    : c.unlock
                        ? `<span class="cosm-unlock"> ${c.unlockDesc}</span>`
                        : `<span class="cosm-price">${c.price}</span>`;
                return `<div class="cosm-item${isActive?' active-cosm':''}${!isOwned?' locked':''}" onclick="cosmClick('${c.id}','${type}',${isOwned},${canBuy},${c.price})">
                    ${preview}
                    <span class="cosm-name">${c.name}</span>
                    ${priceHtml}
                    ${isActive?'<span style="font-size:10px;color:var(--accent);"> </span>':''}
                </div>`;
            }).join('')}</div>`;
        };

        document.getElementById('modal-content').innerHTML=`
            <h3> </h3>
            <textarea id="ebio" placeholder=" ">${d.bio||''}</textarea>
            <p style="font-size:12px;color:var(--secondary)"> ( ):</p>
            <input type="file" id="efile" accept="image/*" style="padding:5px;font-size:12px;">
            <button class="btn" onclick="saveP()" style="margin-bottom:4px;"> </button>
            <hr style="border-color:rgba(255,255,255,0.07);margin:12px 0;">


            <!-- Privacy collapsible -->
            <div style="background:rgba(255,107,107,0.05);border:1px solid rgba(255,107,107,0.2);border-radius:14px;padding:10px 14px;margin-bottom:10px;">
                <div class="collapsible-header" onclick="toggleCollapsible('privacy-section',this)">
                    <span style="font-weight:bold;font-size:14px;"> </span>
                    <span class="collapsible-arrow"></span>
                </div>
                <div class="collapsible-body" id="privacy-section">
                    <div style="padding:8px 0 4px;display:flex;flex-direction:column;gap:10px;">
                        <p style="font-size:11px;color:var(--secondary);margin:0 0 6px;">          .</p>
                        ${['showGifts:   :     ',
                           'allowGifts:  :    ',
                           'allowTrade:  :   ',
                           'allowDuel:  :     ',
                           'allowFriends:    :     '
                          ].map(item => {
                            const [key, label, desc] = item.split(':');
                            const isOn = (d.privacy||{})[key] !== false;
                            return `<div style="display:flex;align-items:center;justify-content:space-between;gap:12px;background:#0a1520;border-radius:12px;padding:10px 12px;border:1px solid rgba(255,255,255,0.06);">
                                <div>
                                    <div style="font-size:13px;font-weight:bold;">${label}</div>
                                    <div style="font-size:11px;color:var(--secondary);margin-top:2px;">${desc}</div>
                                </div>
                                <div onclick="togglePrivacy('${key}')" style="cursor:pointer;width:44px;height:24px;border-radius:12px;background:${isOn?'var(--green)':'rgba(255,255,255,0.1)'};position:relative;transition:background 0.25s;flex-shrink:0;border:1.5px solid ${isOn?'rgba(46,204,113,0.5)':'rgba(255,255,255,0.08)'};">
                                    <div style="position:absolute;top:2px;${isOn?'right:2px':'left:2px'};width:18px;height:18px;border-radius:50%;background:white;transition:all 0.25s;box-shadow:0 1px 4px rgba(0,0,0,0.4);"></div>
                                </div>
                            </div>`;
                          }).join('')}
                    </div>
                </div>
            </div>

            <!-- Telegram collapsible -->
            <div style="background:rgba(0,136,204,0.08);border:1px solid rgba(0,136,204,0.2);border-radius:14px;padding:10px 14px;margin-bottom:10px;">
                <div class="collapsible-header" onclick="toggleCollapsible('tg-section',this)">
                    <span style="font-weight:bold;font-size:14px;">  Telegram</span>
                    <span class="collapsible-arrow"></span>
                </div>
                <div class="collapsible-body" id="tg-section">
                    <div style="padding-bottom:10px;">
                        ${d.tgChatId
                            ? `<div style="background:rgba(0,136,204,0.12);border-radius:10px;padding:10px;margin-bottom:8px;font-size:13px;"> Telegram  (ID: <code>${d.tgChatId}</code>)</div>
                               <button class="btn" style="background:rgba(231,76,60,0.15);border:1px solid rgba(231,76,60,0.3);color:var(--err);font-size:13px;" onclick="unlinkTg()">  Telegram</button>`
                            : `<p style="font-size:13px;color:var(--secondary);margin:0 0 10px;"> Telegram     ,   .</p>
                               <a href="https://t.me/Gift_world_to_market_bot?start=link_${user.id}" target="_blank" class="btn" style="background:linear-gradient(90deg,#0088cc,#006bad);display:block;text-align:center;">   </a>
                               <p style="font-size:11px;color:var(--secondary);margin:8px 0 0;text-align:center;">  : /link ${user.id} []</p>`
                        }
                    </div>
                </div>
            </div>

            <!-- Cosmetics collapsible -->
            <div style="background:rgba(162,155,254,0.05);border:1px solid rgba(162,155,254,0.15);border-radius:14px;padding:10px 14px;">
                <div class="collapsible-header" onclick="toggleCollapsible('cosm-section',this)">
                    <span style="font-weight:bold;font-size:14px;"> </span>
                    <span class="collapsible-arrow"></span>
                </div>
                <div class="collapsible-body" id="cosm-section">
                    <div style="padding-bottom:10px;">
                        <p style="font-size:11px;color:var(--secondary);margin:0 0 8px;">    </p>
                        ${renderCosm('prefix',' ')}
                        ${renderCosm('color','  ')}
                        ${renderCosm('badge',' ')}
                    </div>
                </div>
            </div>
        `;
        openModal();
    };


    window.togglePrivacy = async (key) => {
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const privacy = d.privacy || {};
        const current = privacy[key] !== false;
        privacy[key] = !current;
        await update(ref(db,'users/'+user.id), {privacy});
        showToast(privacy[key] ? ' ' : ' ', privacy[key] ? 'var(--green)' : 'var(--secondary)');
        openEdit();
    };
    window.cosmClick = async (id, type, isOwned, canBuy, price) => {
        const r=ref(db,'users/'+user.id);
        const s=await get(r); const d=s.val();
        const owned=d.cosmetics||[];
        const active=d.activeCosmetic||{};
        if(!isOwned && !user.isAdm){
            if(!canBuy) return showToast('  !','var(--err)');
            if((d.balance||0)<price) return showToast(' !','var(--err)');
            const newOwned=[...owned,id];
            const newSpent=(d.totalSpent||0)+price;
            await update(r,{balance:user.isAdm ? (d.balance||0) : d.balance-price,cosmetics:newOwned,totalSpent:newSpent});
            showToast(' !','var(--green)');
            isOwned=true;
        }
        if(isOwned || user.isAdm){
            const newActive={...active};
            if(newActive[type]===id) delete newActive[type];
            else newActive[type]=id;
            await update(r,{activeCosmetic:newActive});
            showToast(newActive[type]?' !':' ','var(--accent)');
        }
        openEdit();
    };
    window.saveP = async () => {
        const file=document.getElementById('efile').files[0];
        if(file){
            const reader=new FileReader();
            reader.onload=async(e)=>{await update(ref(db,'users/'+user.id),{bio:document.getElementById('ebio').value,pic:e.target.result});closeModal();showToast("!");};
            reader.readAsDataURL(file);
        } else {
            await update(ref(db,'users/'+user.id),{bio:document.getElementById('ebio').value});
            closeModal();showToast("!");
        }
    };
    window.openUserProfile = async (uid) => {
        const s = await get(ref(db,'users/'+uid));
        if (!s.exists()) return showToast('  ','var(--err)');
        const d = s.val();
        const inv = d.cloudInv || [];
        const pinned = (d.pinnedInsts||[]);
        const friends = d.friends || {};

        const rarityMap = [
            {label:'',   color:'#7f91a4', icon:''},
            {label:'',    color:'#4db4ff', icon:''},
            {label:'', color:'#a29bfe', icon:''},
            {label:'',color:'#ffd700',icon:''},
            {label:'NFT',       color:'#ffd700', icon:''},
        ];

        const giftCard = (x, isPinCard=false) => {
            const cat = catalog.find(c => c.id == x.id);
            const img = (x.imgKey==='pan'?PAN_IMG:null) || x.img || (cat && cat.img);
            const emoji = x.i || (cat && cat.i) || '';
            const isNFT = !!x.nft;
            const isLizard = isNFT && x.id === 997;
            const nftPrice = isNFT ? (x.id===997?7000:x.id===998?10000:x.id===999?5000:(x.price||0)) : 0;
            const bg = isLizard ? 'linear-gradient(145deg,#001a08,#0a1f12,#001208)'
                      : isNFT   ? 'linear-gradient(145deg,#1c1200,#0f1a1f,#1a1100)'
                      : '#0a1520';
            const border = isLizard ? 'rgba(77,255,145,0.5)' : isNFT ? 'rgba(255,215,0,0.5)' : 'rgba(255,255,255,0.06)';
            const shadow = isLizard ? '0 0 0 1.5px rgba(77,255,145,0.4),0 4px 16px rgba(77,255,145,0.2)'
                          : isNFT   ? '0 0 0 1.5px rgba(255,215,0,0.4),0 4px 16px rgba(255,215,0,0.2)'
                          : 'none';
            const imgFilter = isLizard ? 'drop-shadow(0 4px 14px rgba(77,255,145,0.55))'
                             : isNFT   ? 'drop-shadow(0 4px 14px rgba(255,215,0,0.55))'
                             : 'drop-shadow(0 3px 10px rgba(0,0,0,0.5))';
            const nameColor = isLizard
                ? 'background:linear-gradient(90deg,#00ff88,#4dff91,#00cc66);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:bold;'
                : isNFT
                ? 'background:linear-gradient(90deg,#ffd700,#ffb347,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:bold;'
                : '';
            return `<div style="text-align:center;background:${bg};border-radius:16px;padding:10px 6px 8px;border:1.5px solid ${border};box-shadow:${shadow};position:relative;overflow:hidden;transition:transform 0.2s;">
                ${isNFT ? `<div style="position:absolute;top:4px;right:4px;background:${isLizard?'linear-gradient(90deg,#007744,#4dff91)':'linear-gradient(90deg,#b8860b,#ffd700)'};color:#000;font-size:7px;font-weight:900;border-radius:5px;padding:2px 5px;letter-spacing:0.5px;z-index:2;">NFT</div>` : ''}
                ${isPinCard ? `<div style="position:absolute;top:4px;left:4px;font-size:11px;z-index:2;"></div>` : ''}
                ${isNFT ? `<div style="position:absolute;inset:0;border-radius:16px;background:linear-gradient(105deg,transparent 25%,${isLizard?'rgba(77,255,145,0.08)':'rgba(255,215,0,0.08)'} 50%,transparent 75%);background-size:200% 100%;animation:nftGoldShimmer 2.5s linear infinite;pointer-events:none;"></div>` : ''}
                <div style="width:56px;height:56px;margin:0 auto 6px;display:flex;align-items:center;justify-content:center;position:relative;z-index:1;">
                    ${img ? `<img src="${img}" style="width:52px;height:52px;object-fit:contain;filter:${imgFilter};${isNFT?'animation:nftImgFloat 3s ease-in-out infinite;':''}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><span style="display:none;font-size:36px;">${emoji}</span>` : `<span style="font-size:36px;">${emoji}</span>`}
                </div>
                <div style="font-size:11px;font-weight:bold;margin-bottom:2px;${nameColor}">${x.n}</div>
                ${isNFT ? `<div style="font-size:8px;font-weight:bold;color:${isLizard?'rgba(77,255,145,0.75)':'rgba(255,215,0,0.75)'};">${nftPrice.toLocaleString()}</div>` : ''}
                ${isNFT && x.nftSerial ? `<div style="font-size:7px;color:${isLizard?'rgba(77,255,145,0.4)':'rgba(255,215,0,0.4)'};font-family:monospace;">#${x.nftSerial}</div>` : ''}
                ${x.from && !isNFT ? `<div style="font-size:9px;color:var(--orange);margin-top:2px;"> ${x.from}</div>` : ''}
            </div>`;
        };

        const pinnedSet = new Set(pinned.map(String));
        const sortedInv = [
            ...inv.filter(x => pinnedSet.has(String(x.inst))),
            ...inv.filter(x => !pinnedSet.has(String(x.inst)))
        ];

        const allGiftsHtml = sortedInv.length
            ? `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px;">${sortedInv.map(x=>giftCard(x, pinnedSet.has(String(x.inst)))).join('')}</div>`
            : `<div style="text-align:center;color:var(--secondary);font-size:13px;padding:24px;"> </div>`;

        document.getElementById('modal-content').innerHTML = `
            <div style="padding:5px 0;">
                <!-- Header -->
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="position:relative;display:inline-block;margin-bottom:10px;">
                        ${(() => {
                            const pArr = pinned
                                .map(inst2 => inv.find(x=>String(x.inst)===String(inst2)))
                                .filter(it2 => it2 && it2.nft)
                                .slice(0,6);
                            if(!pArr.length) return '';
                            const ang = 360/pArr.length;
                            const rad2 = 52; // avatar radius=40, items sit just outside border
                            return '<div style="position:absolute;top:50%;left:50%;width:0;height:0;pointer-events:none;">' +
                            pArr.map((it2,i2) => {
                                const ct2 = catalog.find(c=>c.id==it2.id);
                                const mg2 = it2.img||(ct2&&ct2.img);
                                const em3 = it2.i||(ct2&&ct2.i)||'';
                                const r3 = (ang*i2-90)*Math.PI/180;
                                const x3 = Math.round(rad2*Math.cos(r3)-12);
                                const y3 = Math.round(rad2*Math.sin(r3)-12);
                                return `<div class="avatar-ring-item ring-nft" style="left:${x3}px;top:${y3}px;width:24px;height:24px;">${mg2?'<img src="'+mg2+'" style="width:16px;height:16px;" onerror="this.style.display=\'none\'">':'<span style="font-size:12px;">'+em3+'</span>'}</div>`;
                            }).join('') + '</div>';
                        })()}
                        <img src="${d.pic || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
                             style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--accent);background:#0e1824;position:relative;z-index:2;"
                             onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                    </div>
                    <h3 style="margin:0 0 4px;">${buildUsername(d)}</h3>
                    ${d.bio ? `<p style="color:var(--secondary);font-size:13px;margin:0 0 10px;">${d.bio}</p>` : ''}
                    <div style="display:flex;justify-content:center;gap:20px;">
                        <div style="text-align:center;"><div style="font-weight:bold;color:var(--accent);font-size:18px;">${inv.length}</div><div style="font-size:11px;color:var(--secondary);"></div></div>
                        <div style="text-align:center;"><div style="font-weight:bold;color:var(--accent);font-size:18px;">${Object.keys(friends).length}</div><div style="font-size:11px;color:var(--secondary);"></div></div>
                    </div>
                </div>

                <!-- All gifts (pinned first) -->
                ${((d.privacy||{}).showGifts !== false) ? `
                <div style="margin-bottom:14px;">
                    <div style="font-size:13px;font-weight:bold;color:var(--secondary);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;">
                        <span> </span>
                        <span style="background:rgba(255,255,255,0.07);border-radius:20px;padding:2px 10px;font-size:11px;">${inv.length}</span>
                    </div>
                    ${allGiftsHtml}
                </div>` : `<div style="text-align:center;padding:20px;color:var(--secondary);font-size:13px;">    </div>`}

                <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);border:1px solid rgba(255,255,255,0.08);" onclick="closeModal()"></button>
            </div>`;
        openModal();
    };

    window.toggleCollapsible = (id, header) => {
        const body = document.getElementById(id);
        const arrow = header.querySelector('.collapsible-arrow');
        const isOpen = body.classList.toggle('open');
        if(arrow) arrow.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
    };
    window.unlinkTg = async () => {
        const ok = await showConfirm(' Telegram','    Telegram.','','var(--err)','');
        if(!ok) return;
        await update(ref(db,'users/'+user.id),{tgChatId:null});
        showToast('Telegram ','var(--secondary)');
        openEdit();
    };
    window.logout=()=>{localStorage.removeItem('gifts_user');location.reload();};
    window.admTab = (id, btn) => {
        document.querySelectorAll('.adm-section').forEach(s=>s.classList.remove('active'));
        document.querySelectorAll('.adm-tab').forEach(b=>b.classList.remove('active'));
        document.getElementById('adm-'+id).classList.add('active');
        btn.classList.add('active');
        //       
        if(id!=='sales' && salesUnsubscribe) { salesUnsubscribe(); salesUnsubscribe=null; }
        if(id==='sales') loadSalesLog();
        if(id==='market') loadAdminMarket();
    };

    window.admRefresh = () => { showToast('  ','var(--accent)'); };

    let salesUnsubscribe = null;
    function loadSalesLog(){
        const el=document.getElementById('adm-sales-list');
        const totalEl=document.getElementById('adm-sales-total');
        //      
        if(salesUnsubscribe) { salesUnsubscribe(); salesUnsubscribe=null; }
        el.innerHTML='<div style="color:var(--secondary);text-align:center;padding:20px;">...</div>';
        salesUnsubscribe = onValue(ref(db,'users/ckovoroda/shopLog'), snap=>{
            const shopLog = snap.exists() ? snap.val() : null;
            const logArr = shopLog ? (Array.isArray(shopLog) ? shopLog : Object.values(shopLog)) : [];
            if(!logArr.length){
                totalEl.innerHTML='';
                el.innerHTML='<div style="color:var(--secondary);text-align:center;padding:30px;"> </div>';
                return;
            }
            const sorted=[...logArr].reverse();
            const totalEarned=logArr.reduce((a,r)=>a+(r.price||0),0);
            totalEl.innerHTML=`<div style="background:rgba(36,129,204,0.08);border:1px solid rgba(36,129,204,0.15);border-radius:16px;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;">
                <div style="font-size:12px;color:var(--secondary);"> : <b style="color:white;">${logArr.length}</b></div>
                <div style="font-size:14px;font-weight:900;color:gold;">+${totalEarned.toLocaleString()}</div>
            </div>`;
            el.innerHTML=sorted.map(r=>{
                const d=new Date(r.time);
                const dateStr=d.toLocaleDateString('ru-RU')+' '+d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
                return `<div style="background:#0d1720;border-radius:16px;padding:12px 14px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center;gap:10px;">
                    <div>
                        <div style="font-weight:bold;font-size:13px;">${r.emoji||''} ${r.item}</div>
                        <div style="font-size:11px;color:var(--secondary);margin-top:3px;"> ${r.buyer} <span style="color:#4a6080;font-family:monospace;">(${r.buyerId})</span></div>
                        <div style="font-size:10px;color:#4a6080;margin-top:2px;"> ${dateStr}</div>
                    </div>
                    <div style="color:gold;font-weight:bold;font-size:14px;white-space:nowrap;background:rgba(255,215,0,0.08);padding:6px 12px;border-radius:12px;">+${r.price.toLocaleString()}</div>
                </div>`;
            }).join('');
        });
    }

    let adminMarketData = {};
    window.loadAdminMarket = async () => {
        const snap = await get(ref(db,'market/'));
        adminMarketData = snap.val() || {};
        renderAdminMarket(adminMarketData);
    };
    window.admFilterMarket = (q) => {
        const filtered = Object.fromEntries(Object.entries(adminMarketData).filter(([,x])=>x.n.toLowerCase().includes(q.toLowerCase())||x.sN.toLowerCase().includes(q.toLowerCase())));
        renderAdminMarket(filtered);
    };
    function renderAdminMarket(data) {
        const entries = Object.entries(data);
        const totalVal = entries.reduce((a,[,x])=>a+(x.mP||0),0);
        document.getElementById('adm-market-stats').innerHTML=`
            <div style="background:#0a1520;border-radius:14px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06);">
                <div style="font-size:18px;font-weight:900;color:var(--accent);">${entries.length}</div>
                <div style="font-size:10px;color:var(--secondary);margin-top:2px;"></div>
            </div>
            <div style="background:#0a1520;border-radius:14px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06);">
                <div style="font-size:18px;font-weight:900;color:gold;">${totalVal.toLocaleString()}</div>
                <div style="font-size:10px;color:var(--secondary);margin-top:2px;"> </div>
            </div>
            <div style="background:#0a1520;border-radius:14px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06);">
                <div style="font-size:18px;font-weight:900;color:var(--green);">${entries.length?Math.round(totalVal/entries.length).toLocaleString():0}</div>
                <div style="font-size:10px;color:var(--secondary);margin-top:2px;"> </div>
            </div>`;
        const list = document.getElementById('adm-market-list');
        if(!entries.length){list.innerHTML='<div style="text-align:center;color:var(--secondary);padding:30px;"> </div>';return;}
        list.innerHTML=entries.map(([k,x])=>`
            <div style="background:#0d1720;border-radius:16px;padding:12px 14px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.05);display:flex;align-items:center;gap:12px;">
                <div style="font-size:28px;flex-shrink:0;">${x.i||''}</div>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:bold;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${x.n}</div>
                    <div style="font-size:11px;color:var(--secondary);margin-top:2px;"> ${x.sN} <span style="color:#4a6080;">(${x.sI})</span></div>
                </div>
                <div style="text-align:right;flex-shrink:0;">
                    <div style="font-size:14px;font-weight:900;color:gold;">${(x.mP||0).toLocaleString()}</div>
                    <button onclick="admRemoveMarketItem('${k}')" style="background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.25);color:var(--err);border-radius:8px;padding:3px 8px;font-size:10px;cursor:pointer;margin-top:4px;"> </button>
                </div>
            </div>`).join('');
    }
    window.admRemoveMarketItem = async (k) => {
        const ok = await showConfirm(' ','       .','','var(--err)','');
        if(!ok) return;
        try {
            const lotSnap = await get(ref(db,'market/'+k));
            if(!lotSnap.exists()) { showToast('   ','var(--err)'); loadAdminMarket(); return; }
            const lot = lotSnap.val();
            if(lot.sI) {
                const ownerSnap = await get(ref(db,'users/'+lot.sI));
                if(ownerSnap.exists()) {
                    const ownerData = ownerSnap.val();
                    const ownerInv = ownerData.cloudInv || [];
                    const returned = {...lot};
                    delete returned.mP; delete returned.sI; delete returned.sN;
                    delete returned.sCosm; delete returned.expiresAt;
                    returned.seen = false;
                    returned.from = '   ';
                    ownerInv.push(returned);
                    await update(ref(db,'users/'+lot.sI), {cloudInv: ownerInv});
                    getTgId(lot.sI).then(cid => sendTg(cid,
                        ` <b>     </b>\n\n${lot.i||''} <b>${lot.n}</b>    .`
                    )).catch(()=>{});
                }
            }
            await remove(ref(db,'market/'+k));
            showToast(' ,    ','var(--green)');
        } catch(e) {
            console.error('admRemoveMarketItem error', e);
            showToast('   ','var(--err)');
        }
        loadAdminMarket();
    };

    window.admFilterUsers = (q) => {
        const query=q.toLowerCase().trim();
        let visible=0;
        document.querySelectorAll('.adm-user-row').forEach(row=>{
            const match = !query || row.dataset.name.includes(query);
            row.parentElement.style.display=match?'':'none';
            if(match) visible++;
        });
        const countEl=document.getElementById('adm-user-count');
        if(countEl) countEl.textContent = query ? `${visible} ` : `${document.querySelectorAll('.adm-user-row').length} `;
    };

    function initAdmin() {
        onValue(ref(db,'users'),s=>{
            const us=s.val(); if(!us) return;
            allUsersCache=us;
            const userList=Object.entries(us);
            const nonAdminList=userList.filter(([id])=>!ADMIN_IDS.has(id));
            const totalBal=nonAdminList.reduce((a,[,u])=>a+(u.balance||0),0);
            const totalItems=nonAdminList.reduce((a,[,u])=>a+(u.cloudInv||[]).length,0);
            const sorted=[...nonAdminList].sort((a,b)=>(b[1].balance||0)-(a[1].balance||0));

            // Stats
            const avgBal = nonAdminList.length ? Math.round(totalBal/nonAdminList.length) : 0;
            const tgLinked = nonAdminList.filter(([,u])=>u.tgChatId).length;
            document.getElementById('adm-stats-grid').innerHTML=`
                <div class="adm-stat blue"><div class="ico"></div><div class="val">${nonAdminList.length}</div><div class="lbl"></div></div>
                <div class="adm-stat green"><div class="ico"></div><div class="val">${totalItems}</div><div class="lbl"></div></div>
                <div class="adm-stat orange"><div class="ico"></div><div class="val">${totalBal.toLocaleString()}</div><div class="lbl">  </div></div>
                <div class="adm-stat purple"><div class="ico"></div><div class="val">${tgLinked}</div><div class="lbl">TG </div></div>`;
            document.getElementById('adm-online-hint').textContent = `${nonAdminList.length}   ${totalItems}   ${totalBal.toLocaleString()}  `;

            // Top users
            document.getElementById('adm-top-users').innerHTML=sorted.slice(0,5).map(([id,u],i)=>{
                const medals=['','','','4','5'];
                return `<div style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;" onclick="openUserProfile('${id}')">
                    <span style="font-size:18px;width:24px;text-align:center;">${medals[i]}</span>
                    <span style="flex:1;font-size:13px;font-weight:bold;">${u.username}</span>
                    <span style="color:gold;font-weight:bold;font-size:13px;">${(u.balance||0).toLocaleString()}</span>
                    <span style="color:var(--accent);font-size:16px;"></span>
                </div>`;
            }).join('');

            // Users list
            const userCount = document.getElementById('adm-user-count');
            if(userCount) userCount.textContent = userList.length + ' ';
            document.getElementById('adm-users-list').innerHTML=userList.map(([id,u])=>{
                const invCount = (u.cloudInv||[]).length;
                const hasTg = !!u.tgChatId;
                const isAdm = ADMIN_IDS.has(id);
                return `<div>
                    <div class="adm-user-row" data-name="${(u.username||'').toLowerCase()} ${(u.ip||'').toLowerCase()}">
                        <div class="uavatar">${(u.username||'?')[0].toUpperCase()}</div>
                        <div style="flex:1;min-width:0;" onclick="admToggleUser('${id}')">
                            <div class="uname">${u.username}${isAdm?` <span style="background:rgba(243,156,18,0.2);color:var(--orange);font-size:9px;padding:1px 6px;border-radius:8px;font-weight:bold;">ADMIN</span>`:''}</div>
                            <div class="uinfo">${hasTg?'':''}   ${invCount}   ${u.ip||''}</div>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <button onclick="openUserProfile('${id}')" style="background:rgba(36,129,204,0.1);border:1px solid rgba(36,129,204,0.2);color:var(--accent);border-radius:10px;padding:5px 10px;font-size:11px;cursor:pointer;"></button>
                            <div class="ubadge" onclick="admToggleUser('${id}')">${(u.balance||0).toLocaleString()}</div>
                        </div>
                    </div>
                    <div id="admu-${id}" class="adm-user-detail">
                        <!-- Info grid -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">
                            <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:10px;">
                                <div style="font-size:10px;color:#4a6080;margin-bottom:3px;"> </div>
                                <div style="font-size:12px;font-family:monospace;color:#7f91a4;word-break:break-all;">${u.password||''}</div>
                            </div>
                            <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:10px;">
                                <div style="font-size:10px;color:#4a6080;margin-bottom:3px;"> IP</div>
                                <div style="font-size:12px;font-family:monospace;color:#7f91a4;">${u.ip||''}</div>
                            </div>
                            <div style="background:rgba(36,129,204,0.08);border:1px solid rgba(36,129,204,0.15);border-radius:12px;padding:10px;">
                                <div style="font-size:10px;color:#4a6080;margin-bottom:3px;"> </div>
                                <div style="font-size:16px;font-weight:900;color:var(--accent);">${(u.balance||0).toLocaleString()}</div>
                            </div>
                            <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:10px;">
                                <div style="font-size:10px;color:#4a6080;margin-bottom:3px;"> </div>
                                <div style="font-size:16px;font-weight:900;color:#7f91a4;">${invCount}</div>
                            </div>
                        </div>

                        <!-- Inventory -->
                        <div style="font-size:10px;color:#4a6080;margin-bottom:6px;font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;"> </div>
                        <div class="adm-inv-scroll" style="margin-bottom:14px;">
                            ${invCount ? (u.cloudInv||[]).map(x=>{
                                const rar=RARITY_LEVELS[x.rarity||0]||RARITY_LEVELS[0];
                                const borderC=x.nft?'rgba(255,215,0,0.5)':rar.id===3?'rgba(255,215,0,0.4)':rar.id===2?'rgba(162,155,254,0.4)':rar.id===1?'rgba(77,180,255,0.35)':'rgba(255,255,255,0.07)';
                                return `<div class="adm-inv-item" title="${x.n} ${rar.icon}" style="border:1px solid ${borderC};">${x.img?`<img src="${x.img}" style="width:28px;height:28px;object-fit:contain;">`:x.i}<div style="font-size:7px;color:#4a6080;font-family:monospace;text-align:center;">#${String(x.inst||'').slice(-4)}</div></div>`;
                            }).join('') : '<span style="color:var(--secondary);font-size:12px;padding:8px;"></span>'}
                        </div>

                        <!-- Actions -->
                        <div style="display:flex;flex-direction:column;gap:8px;">
                            <div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:10px 12px;">
                                <div style="font-size:10px;color:#4a6080;margin-bottom:6px;font-weight:bold;text-transform:uppercase;letter-spacing:0.5px;">  </div>
                                <div style="display:flex;gap:6px;">
                                    <input type="number" id="ab-${id}" placeholder=" " style="flex:1;margin:0;padding:8px 12px;height:40px;border-radius:10px;font-size:13px;">
                                    <button class="btn" style="width:50px;padding:0;height:40px;border-radius:10px;font-size:18px;background:var(--green);" onclick="setB('${id}')"></button>
                                </div>
                            </div>
                            <div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:10px 12px;">
                                <div style="font-size:10px;color:#4a6080;margin-bottom:6px;font-weight:bold;text-transform:uppercase;letter-spacing:0.5px;">  </div>
                                <div style="display:flex;gap:6px;margin-bottom:6px;">
                                    <select id="ag-${id}" style="flex:1;margin:0;padding:6px 10px;height:40px;border-radius:10px;font-size:12px;">
                                        <option value="nft_liz">  (NFT)</option>
                                        <option value="nft_pan">  (NFT)</option>
                                        <option value="nft_beer">   (NFT)</option>
                                        <option value="nft_sock">  (NFT)</option>
                                        <option disabled></option>
                                        ${catalog.map(x=>`<option value="${x.id}">${x.i} ${x.n}</option>`).join('')}
                                    </select>
                                </div>
                                <div style="display:flex;gap:6px;">
                                    <select id="agr-${id}" style="flex:1;margin:0;padding:6px 10px;height:40px;border-radius:10px;font-size:12px;">
                                        <option value="0"> </option>
                                        <option value="1"> </option>
                                        <option value="2"> </option>
                                        <option value="3"> </option>
                                    </select>
                                    <button class="btn" style="width:50px;padding:0;height:40px;border-radius:10px;background:var(--orange);font-size:18px;" onclick="giveI('${id}')"></button>
                                </div>
                            </div>
                            <button class="btn" style="background:rgba(231,76,60,0.08);border:1px solid rgba(231,76,60,0.25);color:var(--err);padding:11px;font-size:13px;border-radius:12px;" onclick="delUser('${id}')">  </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        });

        // Load promos
        onValue(ref(db,'promos'),s=>{
            const promos=s.val();
            const countLbl = document.getElementById('promo-count-lbl');
            if(countLbl) countLbl.textContent = promos ? `: ${Object.keys(promos).length}` : ' ';
            document.getElementById('promo-list').innerHTML = promos
                ? Object.entries(promos).map(([code,p])=>{
                    const isUsed=(p.useCount||0)>=(p.maxUses||999);
                    return `<div class="promo-card">
                        <div class="promo-card-info">
                            <div class="promo-badge ${isUsed?'used':''}">${isUsed?'':' '}</div>
                            <div class="promo-code-text">${code}</div>
                            <div style="font-size:11px;color:var(--secondary);margin-top:5px;">
                                 +${p.reward||0} ${p.giftObj?`  ${p.giftObj.i||''} ${p.giftObj.n||''}`:(p.gift?`  ${p.gift}`:'')}  ${p.useCount||0}/${p.maxUses||''} .
                            </div>
                        </div>
                        <button class="btn" style="padding:8px 12px;font-size:12px;background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.25);color:var(--err);flex-shrink:0;" onclick="deletePromo('${code}')"></button>
                    </div>`;
                }).join('')
                : `<p style="color:var(--secondary);text-align:center;padding:20px;"> </p>`;
        });

        // Live activity feed
        onValue(ref(db,'activity_log'), snap => {
            const feedEl = document.getElementById('adm-activity-feed');
            if(!feedEl) return;
            const raw = snap.exists() ? snap.val() : null;
            const log = raw ? (Array.isArray(raw) ? raw : Object.values(raw)) : [];
            if(!log.length) { feedEl.innerHTML='<div style="color:var(--secondary);text-align:center;padding:16px;font-size:13px;">  </div>'; return; }
            const sorted = [...log].reverse().slice(0, 100);
            feedEl.innerHTML = sorted.map(e => {
                const d = new Date(e.time);
                const timeStr = d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}) + ' ' + d.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'});
                let icon, text, color;
                if(e.type === 'shop_buy') {
                    icon=''; color='rgba(36,129,204,0.12)';
                    text=`<b>@${e.userId}</b>   : ${e.emoji||''} <b>${e.item}</b>  ${(e.price||0).toLocaleString()}`;
                } else if(e.type === 'market_buy') {
                    icon=''; color='rgba(243,156,18,0.12)';
                    text=`<b>@${e.userId}</b>   : ${e.emoji||''} <b>${e.item}</b>  <b>@${e.seller}</b>  ${(e.price||0).toLocaleString()}`;
                } else if(e.type === 'market_list') {
                    icon=''; color='rgba(162,155,254,0.1)';
                    text=`<b>@${e.userId}</b>   : ${e.emoji||''} <b>${e.item}</b>  ${(e.price||0).toLocaleString()}`;
                } else if(e.type === 'friend_add') {
                    icon=''; color='rgba(46,204,113,0.1)';
                    text=`<b>@${e.userId}</b>    <b>@${e.friendId}</b>`;
                } else if(e.type === 'friend_request') {
                    icon=''; color='rgba(46,204,113,0.07)';
                    text=`<b>@${e.userId}</b>      <b>@${e.toId}</b>`;
                } else if(e.type === 'gift_sent') {
                    icon=''; color='rgba(255,215,0,0.08)';
                    text=`<b>@${e.userId}</b>  ${e.emoji||''} <b>${e.item}</b>  <b>@${e.toId}</b>`;
                } else if(e.type === 'trade_offer') {
                    icon=''; color='rgba(36,129,204,0.08)';
                    text=`<b>@${e.userId}</b>  : ${e.emoji||''} <b>${e.item}</b>  <b>@${e.toId}</b>`;
                } else if(e.type === 'duel_challenge') {
                    icon=''; color='rgba(255,107,107,0.08)';
                    text=`<b>@${e.userId}</b>    <b>@${e.toId}</b> (: ${e.emoji||''} ${e.item})`;
                } else if(e.type === 'duel_result') {
                    icon=''; color='rgba(255,215,0,0.1)';
                    text=`: <b>@${e.winnerId}</b>  <b>@${e.loserId}</b>  ${e.item1} vs ${e.item2}`;
                } else if(e.type === 'sell_item') {
                    icon=''; color='rgba(255,255,255,0.04)';
                    text=`<b>@${e.userId}</b> : ${e.emoji||''} <b>${e.item}</b>  ${(e.reward||0).toLocaleString()}`;
                } else if(e.type === 'promo') {
                    icon=''; color='rgba(243,156,18,0.1)';
                    text=`<b>@${e.userId}</b>   <b>${e.code}</b>  +${e.reward||0}${e.gift?` +  ${e.gift}`:''}`;
                } else {
                    icon=''; color='rgba(255,255,255,0.04)';
                    text=`<b>@${e.userId||'?'}</b>  ${e.type}`;
                }
                return `<div style="display:flex;align-items:flex-start;gap:10px;padding:9px 12px;border-radius:12px;margin-bottom:5px;background:${color};border:1px solid rgba(255,255,255,0.04);">
                    <span style="font-size:17px;flex-shrink:0;margin-top:1px;">${icon}</span>
                    <div style="flex:1;min-width:0;">
                        <div style="font-size:12px;line-height:1.5;">${text}</div>
                        <div style="font-size:10px;color:var(--secondary);margin-top:2px;font-family:monospace;"> ${timeStr}</div>
                    </div>
                </div>`;
            }).join('');
        });
    }

    //  MOD PANEL (   batlukov / nowkie) 
    function initAdminMod() {
        const modLabel = MOD_PREFIXES[user.id] || '';
        onValue(ref(db,'users'),s=>{
            const us=s.val(); if(!us) return;
            const userList=Object.entries(us);
            const nonAdminList=userList.filter(([id])=>!ADMIN_IDS.has(id));
            const totalBal=nonAdminList.reduce((a,[,u])=>a+(u.balance||0),0);
            const totalItems=nonAdminList.reduce((a,[,u])=>a+(u.cloudInv||[]).length,0);
            const tgLinked=nonAdminList.filter(([,u])=>u.tgChatId).length;
            const adminEl=document.getElementById('admin');
            adminEl.innerHTML=`
            <div class="adm-header">
                <div>
                    <div class="adm-header-title">  </div>
                    <div class="adm-header-sub" style="color:#a29bfe;">${modLabel}  ${nonAdminList.length} </div>
                </div>
            </div>
            <div class="adm-tabs">
                <button class="adm-tab active" onclick="modTab('mod-overview',this)"> </button>
                <button class="adm-tab" onclick="modTab('mod-users',this)"> </button>
                <button class="adm-tab" onclick="modTab('mod-market',this)"> </button>
            </div>

            <!-- Overview -->
            <div id="mod-overview" class="adm-section active">
                <div class="adm-stat-grid">
                    <div class="adm-stat blue"><div class="ico"></div><div class="val">${nonAdminList.length}</div><div class="lbl"></div></div>
                    <div class="adm-stat green"><div class="ico"></div><div class="val">${totalItems}</div><div class="lbl"></div></div>
                    <div class="adm-stat orange"><div class="ico"></div><div class="val">${totalBal.toLocaleString()}</div><div class="lbl"></div></div>
                    <div class="adm-stat purple"><div class="ico"></div><div class="val">${tgLinked}</div><div class="lbl">TG </div></div>
                </div>
                <div style="background:#0d1720;border-radius:20px;padding:16px;border:1px solid rgba(255,255,255,0.06);margin-top:12px;">
                    <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:12px;">  </div>
                    <div>${[...nonAdminList].sort((a,b)=>(b[1].balance||0)-(a[1].balance||0)).slice(0,5).map(([id,u],i)=>{
                        const medals=['','','','4','5'];
                        return `<div style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;" onclick="openUserProfile('${id}')">
                            <span style="font-size:18px;width:24px;text-align:center;">${medals[i]}</span>
                            <span style="flex:1;font-size:13px;font-weight:bold;">${u.username}</span>
                            <span style="color:gold;font-weight:bold;font-size:13px;">${(u.balance||0).toLocaleString()}</span>
                        </div>`;
                    }).join('')}</div>
                </div>
            </div>

            <!-- Users (  +  ) -->
            <div id="mod-users" class="adm-section">
                <div class="search-box" style="margin-bottom:10px;">
                    <span style="color:var(--secondary);"></span>
                    <input type="text" placeholder="  ..." oninput="modFilterUsers(this.value)" style="flex:1;">
                </div>
                <div id="mod-users-list">${userList.map(([id,u])=>{
                    const invCount=(u.cloudInv||[]).length;
                    const hasTg=!!u.tgChatId;
                    return `<div class="adm-user-row" data-name="${(u.username||'').toLowerCase()}">
                        <div class="uavatar">${(u.username||'?')[0].toUpperCase()}</div>
                        <div style="flex:1;min-width:0;">
                            <div class="uname">${u.username}</div>
                            <div class="uinfo">${hasTg?'':''}   ${invCount} .</div>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <button onclick="openUserProfile('${id}')" style="background:rgba(36,129,204,0.1);border:1px solid rgba(36,129,204,0.2);color:var(--accent);border-radius:10px;padding:5px 10px;font-size:11px;cursor:pointer;"> </button>
                            <div class="ubadge">${(u.balance||0).toLocaleString()}</div>
                        </div>
                    </div>`;
                }).join('')}</div>
            </div>

            <!-- Market ( ) -->
            <div id="mod-market" class="adm-section">
                <div style="background:#0a1520;border-radius:14px;padding:10px;margin-bottom:10px;">
                    <div id="mod-market-stats" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;"></div>
                </div>
                <div class="search-box" style="margin-bottom:10px;">
                    <span style="color:var(--secondary);"></span>
                    <input type="text" placeholder="  ..." oninput="modFilterMarket(this.value)" style="flex:1;">
                </div>
                <div id="mod-market-list"><div style="color:var(--secondary);text-align:center;padding:30px;">...</div></div>
            </div>`;

            let modMarketData = {};
            window.loadModMarket = async () => {
                const snap = await get(ref(db,'market/'));
                modMarketData = snap.val() || {};
                renderModMarket(modMarketData);
            };
            window.modFilterMarket = (q) => {
                const filtered = Object.fromEntries(Object.entries(modMarketData).filter(([,x])=>(x.n||'').toLowerCase().includes(q.toLowerCase())||(x.sN||'').toLowerCase().includes(q.toLowerCase())));
                renderModMarket(filtered);
            };
            function renderModMarket(data) {
                const entries = Object.entries(data);
                const totalVal = entries.reduce((a,[,x])=>a+(x.mP||0),0);
                const statsEl = document.getElementById('mod-market-stats');
                if(statsEl) statsEl.innerHTML=`
                    <div style="background:#0d1720;border-radius:12px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06);">
                        <div style="font-size:18px;font-weight:900;color:var(--accent);">${entries.length}</div>
                        <div style="font-size:10px;color:var(--secondary);margin-top:2px;"></div>
                    </div>
                    <div style="background:#0d1720;border-radius:12px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06);">
                        <div style="font-size:18px;font-weight:900;color:gold;">${totalVal.toLocaleString()}</div>
                        <div style="font-size:10px;color:var(--secondary);margin-top:2px;"> </div>
                    </div>
                    <div style="background:#0d1720;border-radius:12px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06);">
                        <div style="font-size:18px;font-weight:900;color:var(--green);">${entries.length?Math.round(totalVal/entries.length).toLocaleString():0}</div>
                        <div style="font-size:10px;color:var(--secondary);margin-top:2px;"> </div>
                    </div>`;
                const list = document.getElementById('mod-market-list');
                if(!list) return;
                if(!entries.length){list.innerHTML='<div style="text-align:center;color:var(--secondary);padding:30px;"> </div>';return;}
                list.innerHTML=entries.map(([k,x])=>`
                    <div style="background:#0d1720;border-radius:16px;padding:12px 14px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.05);display:flex;align-items:center;gap:12px;">
                        <div style="font-size:28px;flex-shrink:0;">${x.i||''}</div>
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:bold;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${x.n}</div>
                            <div style="font-size:11px;color:var(--secondary);margin-top:2px;"> ${x.sN} <span style="color:#4a6080;">(${x.sI})</span></div>
                        </div>
                        <div style="font-size:14px;font-weight:900;color:gold;">${(x.mP||0).toLocaleString()}</div>
                    </div>`).join('');
            }

            window.modTab = (id,b) => {
                document.querySelectorAll('#admin .adm-section').forEach(s=>s.classList.remove('active'));
                document.querySelectorAll('#admin .adm-tab').forEach(t=>t.classList.remove('active'));
                document.getElementById(id)?.classList.add('active');
                b.classList.add('active');
                if(id==='mod-market') loadModMarket();
            };
            window.modFilterUsers = (q) => {
                const rows = document.querySelectorAll('#mod-users-list .adm-user-row');
                rows.forEach(r=>{ r.style.display=(!q||r.dataset.name.includes(q.toLowerCase()))?'':'none'; });
            };
        });
    }

    window.admToggleUser = (id) => {
        const el=document.getElementById('admu-'+id);
        el.classList.toggle('open');
    };

    window.delUser=async(id)=>{const ok=await showConfirm(' ',' @'+id+'   .','','var(--err)','');if(ok) await remove(ref(db,'users/'+id));};
    window.setB=async(id)=>{const v=document.getElementById('ab-'+id).value;if(v){await update(ref(db,'users/'+id),{balance:parseInt(v)});showToast(`  @${id} `);}};
    window.giveI=async(id)=>{
        const sel=document.getElementById('ag-'+id).value;
        const rar=parseInt(document.getElementById('agr-'+id)?.value||'0');
        let itm;
        if(sel==='nft_liz')  itm={...NFT_LIZARD};
        else if(sel==='nft_pan') itm={...NFT_PAN};
        else if(sel==='nft_beer') itm={...NFT_BEER};
        else if(sel==='nft_sock') itm={...NFT_SOCK};
        else itm=catalog.find(x=>x.id==sel);
        if(!itm) return showToast('  !','var(--err)');
        try {
            const s=await get(ref(db,'users/'+id));
            if(!s.exists()) return showToast('  !','var(--err)');
            const inv=s.val().cloudInv||[];
            const serial=await getNextNftSerial();
            const itmClean={...itm};
            // Strip large base64 images before writing to Firebase
            if(itmClean.img&&itmClean.img.startsWith('data:')) delete itmClean.img;
            const entry={...itmClean, inst:Date.now(), from:"ADMIN", seen:false, nftSerial:serial};
            // NFT items must not have rarity field, regular items get rarity
            if(itm.nft) { delete entry.rarity; } else { entry.rarity=rar; }
            inv.push(entry);
            await update(ref(db,'users/'+id),{cloudInv:inv});
            const rarLabel=itm.nft?' NFT':(RARITY_LEVELS[rar]?.icon||'');
            getTgId(id).then(cid=>sendTg(cid,` <b>  !</b>\n\n    :\n${itm.i} <b>${itm.n}</b>\n : <b>${rarLabel}</b>\n\n     !`));
            showToast(`${itm.i} ${itm.n} #${serial}  @${id}`,'var(--green)');
        } catch(e) {
            console.error('giveI error:', e);
            showToast(' : '+e.message,'var(--err)');
        }
    };

    window.createPromo = async () => {
        const code=document.getElementById('promo-code-in').value.trim().toUpperCase();
        const reward=parseInt(document.getElementById('promo-reward-in').value)||0;
        const maxUses=parseInt(document.getElementById('promo-uses-in').value)||0;
        const giftSel=document.getElementById('promo-gift-in').value.trim();
        const giftRarity=parseInt(document.getElementById('promo-gift-rarity')?.value||'0');
        if(!code) return showToast(" !",'var(--err)');
        const ex=await get(ref(db,'promos/'+code));
        if(ex.exists()) return showToast("  !",'var(--err)');
        // Build gift object
        let giftObj = null;
        if(giftSel) {
            if(giftSel==='nft_liz') giftObj = {...NFT_LIZARD};
            else if(giftSel==='nft_pan') giftObj = {...NFT_PAN};
            else if(giftSel==='nft_beer') giftObj = {...NFT_BEER};
            else if(giftSel==='nft_sock') giftObj = {...NFT_SOCK};
            else {
                const catItem = catalog.find(x=>x.id==giftSel);
                if(catItem) giftObj = {...catItem, rarity: giftRarity};
            }
        }
        await set(ref(db,'promos/'+code),{reward,maxUses:maxUses||null,giftObj:giftObj||null,useCount:0,usedBy:{}});
        document.getElementById('promo-code-in').value='';
        document.getElementById('promo-reward-in').value='';
        document.getElementById('promo-uses-in').value='';
        document.getElementById('promo-gift-in').value='';
        showToast(" ! ",'var(--green)');
    };
    window.deletePromo=async(code)=>{const ok=await showConfirm(' ',' '+code+'  .','','var(--err)','');if(ok) await remove(ref(db,'promos/'+code));};

    window.broadcastCoins = async () => {
        const amount=parseInt(document.getElementById('bcast-coins').value);
        if(!amount||amount<=0) return showToast(" !",'var(--err)');
        const ok=await showConfirm(' ',' '+amount+'  ?','','var(--green)','');
        if(!ok) return;
        const s=await get(ref(db,'users')),us=s.val();
        const up={};for(let id in us) up[`users/${id}/balance`]=(us[id].balance||0)+amount;
        await update(ref(db),up);
        // Notify all TG users
        for(let id in us){if(us[id].tgChatId)sendTg(us[id].tgChatId,` <b>  !</b>\n\n  :\n<b>${Number(amount).toLocaleString()} </b>\n\n     !`);}
        showToast(`  ${amount} !`,'var(--green)');
        document.getElementById('bcast-coins').value='';
    };

    window.broadcastGift = async () => {
        const itm=catalog.find(x=>x.id==document.getElementById('bcast-gift').value);
        const ok2=await showConfirm('  ',itm.i+' '+itm.n+'  ?','','var(--orange)','');
        if(!ok2) return;
        const s=await get(ref(db,'users')),us=s.val();
        const up={};
        for(let id in us){const inv=(us[id].cloudInv||[]);inv.push({...itm,inst:Date.now(),from:"ADMIN",seen:false});up[`users/${id}/cloudInv`]=inv;}
        await update(ref(db),up);
        for(let id in us){if(us[id].tgChatId)sendTg(us[id].tgChatId,` <b>  !</b>\n\n  :\n${itm.i} <b>${itm.n}</b>\n\n     !`);}
        showToast(` ${itm.i}  !`,'var(--green)');
    };

    window.resetAndReissue = async () => {
        const ok = await showConfirm(
            ' ',
            '         .           (5 ).   !',
            '', 'var(--err)', '  '
        );
        if (!ok) return;

        // Step 1: clear market
        await remove(ref(db, 'market'));

        // Step 2: clear all inventories/pinned, give 5 random new items
        const s = await get(ref(db, 'users')), us = s.val();
        if (!us) return showToast(' ', 'var(--err)');

        const up = {};
        for (let id in us) {
            // Pick 5 random unique items from catalog
            const shuffled = [...catalog].sort(() => Math.random() - 0.5).slice(0, 5);
            const newInv = shuffled.map(itm => ({
                ...itm,
                inst: Date.now() + Math.floor(Math.random() * 100000),
                from: 'RESET',
                seen: false
            }));
            up[`users/${id}/cloudInv`] = newInv;
            up[`users/${id}/pinnedInsts`] = [];
        }
        await update(ref(db), up);
        showToast(` !      ${Object.keys(us).length} `, 'var(--green)');
    };

    window.clearAllShowcases = async () => {
        const ok=await showConfirm(' ','       .','','var(--err)','');
        if(!ok) return;
        const s=await get(ref(db,'users')),us=s.val();
        const up={};for(let id in us) up[`users/${id}/pinnedInsts`]=[];
        await update(ref(db),up);showToast(" !",'var(--err)');
    };

    window.clearMarket = async () => {
        const ok=await showConfirm(' ','      .','','var(--err)','');
        if(!ok) return;
        await remove(ref(db,'market'));showToast(" !",'var(--err)');
    };
    // ===== INSTANT NFT AVATAR THEME UPDATE =====
    window.applyPinnedNftThemeToAvatar = (d) => {
        const inv = d.cloudInv || [];
        const pinnedInsts = new Set((d.pinnedInsts||[]).map(String));
        //   ring-item     
        document.querySelectorAll('.avatar-ring-item.ring-nft[data-inst]').forEach(el => {
            const inst = el.getAttribute('data-inst');
            const item = inv.find(x=>String(x.inst)===String(inst));
            if(!item||!item.upgrade||!item.upgrade.level) return;
            const lvlD = NFT_UPGRADE_LEVELS[item.upgrade.level];
            if(!lvlD) return;
            // Remove old upgrade classes
            el.classList.forEach(cls=>{if(cls.startsWith('nft-lvl'))el.classList.remove(cls);});
            // Add new classes
            const newCls = getNftUpgradeClasses(item);
            if(newCls) newCls.split(' ').forEach(c=>c&&el.classList.add(c));
            // Update border glow
            const thD = lvlD.themes && lvlD.themes.find(t=>t.id===item.upgrade.theme);
            if(thD){
                const colorMap = {fire:'255,80,0',ocean:'0,150,255',forest:'0,200,80',galaxy:'150,50,255',sunset:'255,100,150'};
                const c = colorMap[item.upgrade.theme];
                if(c && item.upgrade.level >= 1){
                    el.style.borderColor = `rgba(${c},0.9)`;
                    el.style.boxShadow = `0 0 ${item.upgrade.level>=3?'14':'10'}px rgba(${c},${item.upgrade.level>=3?'0.8':'0.6'}),0 2px 10px rgba(0,0,0,0.6)`;
                }
            }
        });
    };

    window.tab=(id,b)=>{
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(n=>n.classList.remove('active'));
        document.getElementById(id).classList.add('active');b.classList.add('active');
        if(id==='inv') renderInv();
        if(id==='shop') { renderShop(); if(!_pricesLoaded) { loadShopPrices().then(()=>renderShopCards()); } else { renderShopCards(); } }
        if(id==='market') listenMarket();
        if(id==='profile') { get(ref(db,'users/'+user.id)).then(s=>{ if(s.val()) renderMyProfile(s.val()); }); }
    };
    // ===== TELEGRAM INTEGRATION =====
    const TG_BOT_TOKEN = '8080771405:AAGsN_dudAoaiNmqLdgWsol8iL7ZDwqu-Ho';
    async function getTgId(uid) {
        try { const s=await get(ref(db,'users/'+uid)); return s.exists()&&s.val().tgChatId?s.val().tgChatId:null; } catch(e){return null;}
    }
    async function sendTg(chatId, text) {
        if(!chatId) return;
        try {
            await fetch(`https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage`,{
                method:'POST',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({chat_id:chatId,text,parse_mode:'HTML'})
            });
        } catch(e){}
    }
    window.broadcastMsg = async () => {
        const msg=document.getElementById('bcast-msg')?.value?.trim();
        if(!msg) return showToast(' !','var(--err)');
        const ok=await showConfirm('  Telegram','      Telegram?','','var(--accent)','');
        if(!ok) return;
        const s=await get(ref(db,'users')),us=s.val();
        let sent=0;
        for(let id in us){
            if(us[id].tgChatId){
                await sendTg(us[id].tgChatId,` <b>   Gift World</b>\n\n${msg}\n\n\n Gift World`);
                sent++;
            }
        }
        showToast(`  ${sent} `,'var(--green)');
        if(document.getElementById('bcast-msg')) document.getElementById('bcast-msg').value='';
    };

    // Auto-login from localStorage
    (()=>{
        const s=localStorage.getItem('gifts_user');
        if(s){
            try{
                const d=JSON.parse(s);
                if(d&&d.name&&d.id) startApp(d.name,d.id);
            }catch(e){}
        }
    })();
</script>
</body>
</html>
