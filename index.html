<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÅ</text></svg>">
    <title>Gifts World Pro</title>
    <style>
        :root { 
            --bg: #070d14; --card: #111b21; --accent: #2481cc; --text: #ffffff; 
            --secondary: #7f91a4; --err: #e74c3c; --green: #2ecc71; --orange: #f39c12;
            --glass: rgba(23, 33, 43, 0.95); --tg: #229ED9;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 0; overflow-x: hidden; }

        .btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 18px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; font-size: 14px; display: inline-block; text-decoration: none; text-align: center; position: relative; overflow: hidden; }
        .btn:hover:not(:disabled) { box-shadow: 0 5px 22px rgba(36,129,204,0.45); transform: translateY(-1px); }
        .btn:active:not(:disabled) { transform: scale(0.93) !important; opacity: 0.82; }
        input, textarea, select { width: 100%; padding: 14px; margin: 10px 0; border-radius: 15px; border: 2px solid #2b3a4a; background: #0e1621; color: white; outline: none; font-size: 16px; }

        .page { display: none; padding: 15px; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding-bottom: 120px; }
        .page.active { display: grid; animation: fadeInUp 0.3s ease both; }
        #friends, #admin { display: none; flex-direction: column; width: 100%; max-width: 600px; margin: 0 auto; }
        #friends.active, #admin.active { display: flex; animation: fadeInUp 0.3s ease both; }

        .card { background: var(--card); border-radius: 25px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.05); position: relative; transition: transform 0.22s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.22s ease; animation: fadeInScale 0.35s ease both; }
        .card:hover { transform: translateY(-5px) scale(1.025); box-shadow: 0 14px 44px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.09); }
        .card .item-emoji { display: inline-block; transition: transform 0.2s cubic-bezier(0.34,1.56,0.64,1); }
        .card:hover .item-emoji { animation: wiggle 0.55s ease; }

        .nav { display: flex; background: var(--glass); backdrop-filter: blur(20px); position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; border-radius: 30px; padding: 10px; z-index: 1000; border: 1px solid rgba(255,255,255,0.1); animation: slideInNav 0.55s cubic-bezier(0.34,1.56,0.64,1) 0.1s both; }
        .nav-btn { flex: 1; background: none; border: none; color: var(--secondary); cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 11px; position: relative; transition: color 0.2s, transform 0.2s cubic-bezier(0.34,1.56,0.64,1); }
        .nav-btn:active { transform: scale(0.82); }
        .nav-btn.active { color: var(--accent); }
        .nav-btn.active i { animation: bounceIn 0.38s cubic-bezier(0.34,1.56,0.64,1); }
        .nav-btn i { font-size: 22px; margin-bottom: 4px; font-style: normal; }

        .badge { position: absolute; top: -2px; right: 15px; background: var(--err); color: white; font-size: 10px; min-width: 18px; height: 18px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; border: 2px solid var(--bg); }
        .badge-merge { position: absolute; top: -2px; left: 15px; background: #7c3aed; color: white; font-size: 10px; min-width: 18px; height: 18px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; border: 2px solid var(--bg); }
        .collapsible-header { display:flex; align-items:center; justify-content:space-between; cursor:pointer; padding:10px 0 6px; user-select:none; }
        .collapsible-header:hover { opacity:0.8; }
        .collapsible-arrow { transition:transform 0.25s; font-size:14px; color:var(--secondary); }
        .collapsible-body { overflow:hidden; max-height:0; transition:max-height 0.35s ease; }
        .collapsible-body.open { max-height:3000px; }
        .avatar { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent); object-fit: cover; background: #0e1621; margin-bottom: 15px; transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1), border-color 0.3s; }
        .avatar:hover { transform: scale(1.08) rotate(4deg); border-color: gold; }

        #toast-container .toast-item {
            background: var(--glass);
            backdrop-filter: blur(20px);
            color: white;
            padding: 13px 20px;
            border-radius: 18px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.08);
            transform: translateY(20px) scale(0.9);
            opacity: 0;
            transition: all 0.38s cubic-bezier(0.34,1.56,0.64,1);
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: all;
            border-left: 3px solid var(--accent);
            max-width: 100%;
            word-break: break-word;
        }
        #toast-container .toast-item.show {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        #toast-container .toast-item.hide {
            transform: translateY(-10px) scale(0.9);
            opacity: 0;
        }
        #modal-content { animation: popIn 0.32s cubic-bezier(0.34,1.56,0.64,1) both; }

        .pinned-section { width: 100%; background: rgba(255,255,255,0.03); border-radius: 25px; padding: 15px; margin: 10px 0; display: flex; overflow-x: auto; gap: 15px; min-height: 80px; align-items: center; }
        .pinned-section > div { transition: transform 0.2s cubic-bezier(0.34,1.56,0.64,1); }
        .pinned-section > div:hover { transform: translateY(-6px) scale(1.12); }
        .price-up { color: var(--err); font-size: 12px; }
        .price-down { color: var(--green); font-size: 12px; }
        .tg-btn { background: var(--tg); margin-bottom: 8px; }
        /* === ADMIN PANEL === */
        .adm-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; }
        .adm-header-title { font-size:20px; font-weight:900; letter-spacing:-0.5px; }
        .adm-header-sub { font-size:11px; color:var(--secondary); margin-top:2px; }

        .adm-tabs { display: flex; gap: 6px; margin-bottom: 18px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .adm-tabs::-webkit-scrollbar { display: none; }
        .adm-tab { flex-shrink: 0; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); color: var(--secondary); border-radius: 22px; padding: 7px 14px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; display:flex;align-items:center;gap:4px; }
        .adm-tab:hover { background: rgba(255,255,255,0.08); color: white; }
        .adm-tab.active { background: var(--accent); color: white; border-color: transparent; box-shadow: 0 4px 14px rgba(36,129,204,0.35); }
        .adm-section { display: none; }
        .adm-section.active { display: block; animation: fadeInUp 0.25s ease both; }

        /* Stats grid */
        .adm-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
        .adm-stat { position:relative; overflow:hidden; border-radius: 20px; padding: 16px 14px; text-align: center; border: 1px solid rgba(255,255,255,0.06); background: #0d1720; }
        .adm-stat::before { content:''; position:absolute; inset:0; opacity:0.06; }
        .adm-stat.blue::before { background: radial-gradient(circle at top right, var(--accent), transparent 70%); }
        .adm-stat.green::before { background: radial-gradient(circle at top right, var(--green), transparent 70%); }
        .adm-stat.orange::before { background: radial-gradient(circle at top right, var(--orange), transparent 70%); }
        .adm-stat.purple::before { background: radial-gradient(circle at top right, #a29bfe, transparent 70%); }
        .adm-stat .val { font-size: 24px; font-weight: 900; color: white; position:relative; }
        .adm-stat .lbl { font-size: 10px; color: var(--secondary); margin-top: 4px; position:relative; letter-spacing:0.5px; text-transform:uppercase; }
        .adm-stat .ico { font-size:28px; position:absolute; right:12px; top:12px; opacity:0.15; }

        /* User rows */
        .adm-user-row { background: #0d1720; border-radius: 16px; padding: 12px 14px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .adm-user-row:hover { background: #111f2e; border-color: rgba(36,129,204,0.2); transform: translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,0.3); }
        .adm-user-row .uname { font-weight: bold; font-size: 14px; }
        .adm-user-row .uinfo { font-size: 11px; color: var(--secondary); margin-top: 3px; }
        .adm-user-row .ubadge { font-size: 11px; background: rgba(36,129,204,0.12); color: var(--accent); padding: 4px 10px; border-radius: 20px; font-weight: bold; white-space: nowrap; border:1px solid rgba(36,129,204,0.15); }
        .adm-user-row .uavatar { width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#1a2a3a,#0a1520);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;margin-right:10px;border:1px solid rgba(255,255,255,0.08); }

        .adm-user-detail { background: #0a1520; border-radius: 20px; padding: 16px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.06); display: none; }
        .adm-user-detail.open { display: block; animation: fadeInUp 0.2s ease both; }

        .adm-inv-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 8px 0; scrollbar-width: none; }
        .adm-inv-scroll::-webkit-scrollbar { display:none; }
        .adm-inv-item { flex-shrink: 0; background: #070d14; border-radius: 12px; padding: 8px 10px; text-align: center; font-size: 20px; min-width: 46px; border:1px solid rgba(255,255,255,0.06); transition:0.15s; cursor:default; }
        .adm-inv-item:hover { border-color:rgba(36,129,204,0.3); transform:scale(1.05); }

        /* Promo cards */
        .promo-card { background: #0d1720; border-radius: 18px; padding: 14px 16px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.06); display:flex; align-items:center; gap:12px; }
        .promo-card-info { flex:1; min-width:0; }
        .promo-badge { display: inline-block; background: rgba(46,204,113,0.15); color: var(--green); border-radius: 20px; padding: 2px 10px; font-size: 10px; font-weight: bold; margin-bottom: 5px; border:1px solid rgba(46,204,113,0.2); }
        .promo-badge.used { background: rgba(127,145,164,0.1); color: var(--secondary); border-color: rgba(127,145,164,0.15); }
        .promo-code-text { font-family: monospace; font-size: 15px; font-weight: bold; letter-spacing: 2px; color: gold; }

        /* Tool cards */
        .tool-card { background: #0d1720; border-radius: 20px; padding: 16px; border: 1px solid rgba(255,255,255,0.06); margin-bottom: 10px; }
        .tool-card-title { font-weight: bold; font-size: 13px; margin-bottom: 10px; display:flex;align-items:center;gap:6px; }

        /* Danger zone */
        .danger-zone { border: 1px solid rgba(231,76,60,0.2); border-radius: 20px; padding: 16px; background: rgba(231,76,60,0.04); margin-top:4px; }
        .danger-zone-title { font-size:11px; color:var(--err); font-weight:bold; letter-spacing:0.5px; text-transform:uppercase; margin-bottom:10px; display:flex;align-items:center;gap:5px; }

        .search-box { background: #0e1824; border: 1px solid #2b3a4a; border-radius: 14px; padding: 10px 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .search-box input { background: none; border: none; margin: 0; padding: 0; font-size: 14px; flex: 1; } 
        .search-filter-bar { 
            grid-column: 1/-1;
            display: flex; 
            gap: 10px; 
            margin-bottom: 5px; 
            flex-wrap: wrap;
            align-items: center;
        }
        .search-filter-bar input { 
            flex: 1; 
            min-width: 140px; 
            background: #0e1824; 
            border: 1px solid #2b3a4a; 
            border-radius: 14px; 
            padding: 11px 16px; 
            margin: 0; 
            font-size: 14px; 
            color: white; 
            outline: none;
        }
        .search-filter-bar input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(36,129,204,0.15); }
        .filter-btn { 
            background: #0e1824; 
            border: 1px solid #2b3a4a; 
            border-radius: 12px; 
            padding: 9px 14px; 
            color: var(--secondary); 
            font-size: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            white-space: nowrap;
            transition: 0.2s;
            flex-shrink: 0;
        }
        .filter-btn:hover { background: #1a2636; color: white; }
        .filter-btn.active { background: var(--accent); border-color: var(--accent); color: white; box-shadow: 0 4px 12px rgba(36,129,204,0.35); }

        @keyframes rainbow { 0%{color:#ff6b6b} 16%{color:#ffd93d} 33%{color:#6bcb77} 50%{color:#4d96ff} 66%{color:#c77dff} 83%{color:#ff6bcd} 100%{color:#ff6b6b} }
        .rarity-nft { animation: rainbow 2s linear infinite; font-weight:bold; }

        /* ===== MERGE SYSTEM ===== */
        @keyframes mergeGlow { 0%,100%{box-shadow:0 0 0 0 rgba(255,215,0,0)} 50%{box-shadow:0 0 30px 8px rgba(255,215,0,0.5)} }
        @keyframes mergeUpgrade { 0%{transform:scale(1) rotate(0)} 30%{transform:scale(1.4) rotate(-5deg)} 60%{transform:scale(0.9) rotate(5deg)} 100%{transform:scale(1) rotate(0)} }
        @keyframes epicPulse { 0%,100%{box-shadow:0 0 0 0 rgba(162,155,254,0)} 50%{box-shadow:0 0 20px 5px rgba(162,155,254,0.4)} }
        @keyframes legendaryShimmer { 0%{background-position:-200% center} 100%{background-position:200% center} }
        @keyframes rarePulse { 0%,100%{box-shadow:0 0 0 0 rgba(77,180,255,0)} 50%{box-shadow:0 0 16px 4px rgba(77,180,255,0.35)} }

        .rarity-common  { color:#7f91a4; font-size:10px; font-weight:bold; }
        .rarity-rare    { color:#4db4ff; font-size:10px; font-weight:bold; }
        .rarity-epic    { color:#a29bfe; font-size:10px; font-weight:bold; }
        .rarity-legendary { background:linear-gradient(90deg,#ffd700,#ffb347,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text; font-size:10px; font-weight:bold; background-size:200% auto; animation:legendaryShimmer 3s linear infinite; }

        /* Performance: will-change only on animated elements */
        .nft-card { will-change: box-shadow; }
        .nft-emoji { will-change: transform; }
        .fly-emoji, .confetti-piece { will-change: transform, opacity; }

        /* Reduce animations on low-end devices */
        @media (prefers-reduced-motion: reduce) {
            .nft-card, .nft-emoji, .rarity-nft, .rarity-legendary { animation: none !important; }
            .card-rare, .card-epic, .card-legendary { animation: none !important; }
            .merge-ready { animation: none !important; }
            * { transition-duration: 0.01ms !important; animation-duration: 0.01ms !important; }
        }

        .card-rare     { border:1.5px solid rgba(77,180,255,0.5)!important; background:linear-gradient(135deg,#0a0d2e,#0c1a30)!important; box-shadow:0 0 10px 2px rgba(77,180,255,0.18); }
        .card-epic     { border:1.5px solid rgba(162,155,254,0.55)!important; background:linear-gradient(135deg,#0d0a2e,#1a0e3a)!important; box-shadow:0 0 10px 2px rgba(162,155,254,0.2); }
        .card-legendary{ border:2px solid rgba(255,215,0,0.7)!important; background:linear-gradient(135deg,#1a1200,#0e1824,#1a1200)!important; box-shadow:0 0 14px 3px rgba(255,215,0,0.22); }
        .card-legendary::before { content:''; position:absolute; inset:0; border-radius:25px; background:linear-gradient(105deg,transparent 30%,rgba(255,215,0,0.12) 50%,transparent 70%); pointer-events:none; z-index:1; }

        .nft-id-badge { position:absolute; bottom:6px; left:8px; font-size:9px; color:rgba(255,255,255,0.35); font-family:monospace; letter-spacing:0.5px; z-index:3; }
        .nft-id-badge.nft { color:rgba(255,215,0,0.55); }
        .nft-id-badge.common-id { color:rgba(255,255,255,0.22); }

        .merge-btn { background:linear-gradient(90deg,#7c3aed,#a855f7)!important; margin-top:5px!important; font-size:11px!important; position:relative; overflow:hidden; }
        .merge-ready { box-shadow:0 0 18px 4px rgba(255,215,0,0.35); border-color:rgba(255,215,0,0.7)!important; }

        .merge-count-badge { position:absolute; top:7px; left:7px; background:rgba(162,155,254,0.9); color:#fff; font-size:9px; font-weight:bold; border-radius:10px; padding:1px 6px; z-index:3; backdrop-filter:blur(4px); }
        .merge-count-badge.ready { background:linear-gradient(90deg,#7c3aed,#a855f7); }

        .merge-panel { grid-column:1/-1; background:linear-gradient(135deg,#0d0a20,#120d2e); border:1.5px solid rgba(162,155,254,0.4); border-radius:22px; padding:18px; margin-bottom:5px; }
        .merge-panel h4 { margin:0 0 10px; color:#a29bfe; font-size:15px; display:flex; align-items:center; gap:8px; }
        .merge-items-row { display:flex; gap:10px; overflow-x:auto; padding:6px 0; }
        .merge-slot { width:80px; height:80px; border-radius:16px; border:2px dashed rgba(162,155,254,0.4); display:flex; align-items:center; justify-content:center; font-size:32px; flex-shrink:0; background:rgba(162,155,254,0.05); transition:0.2s; cursor:pointer; }
        .merge-slot.filled { border-color:rgba(162,155,254,0.8); background:rgba(162,155,254,0.12); }
        .merge-slot:hover { border-color:#a29bfe; background:rgba(162,155,254,0.2); }
        .pin-badge { position:absolute;top:4px;right:4px;font-size:14px;line-height:1;filter:drop-shadow(0 1px 3px rgba(0,0,0,0.7)); }
        .gift-cell-wrap { position:relative; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(18px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.88); } to { opacity: 1; transform: scale(1); } }
        @keyframes popIn { 0% { transform: scale(0) rotate(-10deg); opacity: 0; } 70% { transform: scale(1.12) rotate(3deg); opacity: 1; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-130px) scale(1.8); opacity: 0; } }
        @keyframes shimmer { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }
        @keyframes pulseGold { 0%, 100% { box-shadow: 0 0 0 0 rgba(255,215,0,0.55), 0 8px 32px rgba(0,0,0,0.4); } 50% { box-shadow: 0 0 0 12px rgba(255,215,0,0), 0 8px 32px rgba(0,0,0,0.4); } }
        @keyframes pulse { 0%, 100% { opacity:1; transform:scale(1); } 50% { opacity:0.4; transform:scale(0.8); } }
        @keyframes wiggle { 0%,100% { transform: rotate(0deg) scale(1); } 20% { transform: rotate(-10deg) scale(1.15); } 40% { transform: rotate(10deg) scale(1.2); } 60% { transform: rotate(-6deg) scale(1.1); } 80% { transform: rotate(6deg) scale(1.05); } }
        @keyframes confettiFall { 0% { transform: translateY(-10px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        @keyframes slideInNav { from { transform: translateX(-50%) translateY(50px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.15); opacity: 1; } 70% { transform: scale(0.92); } 100% { transform: scale(1); } }
        @keyframes float { 0%,100% { transform: translateY(0px); } 50% { transform: translateY(-7px); } }
        @keyframes balanceFlash { 0% { color: var(--accent); transform: scale(1); } 35% { color: #2ecc71; transform: scale(1.3); } 100% { color: var(--accent); transform: scale(1); } }

        /* ===== DUEL & TRADE ANIMATIONS ===== */
        @keyframes duelShakeL { 0%,100%{transform:translateX(0) rotate(0deg)} 20%{transform:translateX(-18px) rotate(-8deg)} 40%{transform:translateX(12px) rotate(5deg)} 60%{transform:translateX(-8px) rotate(-4deg)} 80%{transform:translateX(5px) rotate(2deg)} }
        @keyframes duelShakeR { 0%,100%{transform:translateX(0) rotate(0deg)} 20%{transform:translateX(18px) rotate(8deg)} 40%{transform:translateX(-12px) rotate(-5deg)} 60%{transform:translateX(8px) rotate(4deg)} 80%{transform:translateX(-5px) rotate(-2deg)} }
        @keyframes duelClash { 0%{transform:translate(-50%,-50%) scale(1) rotate(0deg);opacity:1} 25%{transform:translate(-50%,-50%) scale(2.5) rotate(15deg);opacity:1} 50%{transform:translate(-50%,-50%) scale(3.2) rotate(-10deg);opacity:0.9} 75%{transform:translate(-50%,-50%) scale(2) rotate(5deg);opacity:0.5} 100%{transform:translate(-50%,-50%) scale(0) rotate(0deg);opacity:0} }
        @keyframes duelWinner { 0%{transform:translateY(0) scale(1)} 30%{transform:translateY(-22px) scale(1.35)} 60%{transform:translateY(-12px) scale(1.25)} 100%{transform:translateY(-6px) scale(1.2)} }
        @keyframes duelLoser { 0%{transform:scale(1);opacity:1;filter:none} 100%{transform:scale(0.4) translateY(25px);opacity:0.15;filter:grayscale(1) blur(2px)} }
        @keyframes duelFlash { 0%,100%{background:rgba(0,0,0,0.88)} 30%{background:rgba(255,80,0,0.3)} 60%{background:rgba(255,30,0,0.4)} }
        @keyframes swordSpin { 0%{transform:translate(-50%,-50%) rotate(0deg) scale(1)} 50%{transform:translate(-50%,-50%) rotate(200deg) scale(2)} 100%{transform:translate(-50%,-50%) rotate(360deg) scale(1)} }
        @keyframes tradeArrow { 0%,100%{transform:translateX(0);opacity:1} 50%{transform:translateX(6px);opacity:0.6} }
        @keyframes tradeGlow { 0%,100%{box-shadow:0 0 0 0 rgba(46,204,113,0)} 50%{box-shadow:0 0 0 8px rgba(46,204,113,0.15)} }
        .duel-clash-emoji { position:fixed; top:50%; left:50%; font-size:64px; pointer-events:none; z-index:9999; animation: duelClash 0.85s ease forwards; }
        .duel-sword-spin { position:fixed; top:50%; left:50%; font-size:52px; pointer-events:none; z-index:9999; animation: swordSpin 0.6s ease-in-out; }


        /* ‚ïê‚ïê‚ïê PINNED GIFTS RING AROUND AVATAR ‚ïê‚ïê‚ïê */
        @keyframes orbitRing {
            from { transform: rotate(0deg); }
            to   { transform: rotate(0deg); }
        }
        @keyframes counterOrbit {
            from { transform: rotate(0deg) scale(1); }
            to   { transform: rotate(0deg) scale(1); }
        }
        @keyframes ringPulse {
            0%,100% { opacity:0.6; transform: scale(1); }
            50%      { opacity:1;   transform: scale(1.15); }
        }
        .avatar-ring-wrap {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 200px;
            height: 200px;
            margin: 0 auto 18px;
        }
        .avatar-ring-orbit {
            position: absolute;
            top: 0; left: 0;
            width: 200px; height: 200px;
            pointer-events: none;
            overflow: visible;
        }
        .avatar-ring-item {
            position: absolute;
            width: 28px; height: 28px;
            border-radius: 50%;
            background: rgba(10,21,32,0.92);
            border: 1.5px solid rgba(255,255,255,0.18);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.6);
            overflow: hidden;
        }
        .avatar-ring-item img {
            width: 22px; height: 22px;
            object-fit: contain;
            filter: drop-shadow(0 1px 4px rgba(0,0,0,0.5));
        }
        .avatar-ring-item span { font-size: 16px; line-height: 1; }
        .avatar-ring-item.ring-nft {
            border-color: rgba(255,215,0,0.7);
            background: rgba(26,18,0,0.95);
            box-shadow: 0 0 8px rgba(255,215,0,0.4), 0 2px 10px rgba(0,0,0,0.6);
        }
        .nft-card { animation: pulseGold 4s ease-in-out infinite, fadeInScale 0.4s ease both !important; }
        .nft-card::before { content: ''; position: absolute; inset: 0; border-radius: 25px; pointer-events: none; background: linear-gradient(105deg, transparent 30%, rgba(255,215,0,0.12) 50%, transparent 70%); z-index: 1; }
        .nft-emoji { animation: float 3.5s ease-in-out infinite; }
        .fly-emoji { position: fixed; font-size: 38px; pointer-events: none; z-index: 9999; animation: floatUp 0.95s cubic-bezier(0.25,0.46,0.45,0.94) forwards; }
        .confetti-piece { position: fixed; width: 9px; height: 9px; pointer-events: none; z-index: 9999; border-radius: 2px; animation: confettiFall linear forwards; }
        .balance-flash { animation: balanceFlash 0.65s cubic-bezier(0.34,1.56,0.64,1); }
        .gift-img { width:74px; height:74px; object-fit:contain; display:block; margin:0 auto 8px; transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1); filter:drop-shadow(0 4px 12px rgba(0,0,0,0.4)); flex-shrink:0; }
        .gift-img-wrap { width:100%; height:96px; display:flex; align-items:center; justify-content:center; margin-bottom:6px; flex-shrink:0; overflow:hidden; }
        .gift-img-wrap .gift-img { margin:0; width:74px; height:74px; }
        .gift-img-wrap .gift-img-pony { width:90px; height:90px; }
        .card:hover .gift-img { transform:scale(1.18) translateY(-5px) rotate(3deg); }
        .gift-img-sm { width:46px; height:46px; object-fit:contain; display:block; margin:0 auto 4px; filter:drop-shadow(0 2px 6px rgba(0,0,0,0.3)); flex-shrink:0; }
        .card-inner { display:flex; flex-direction:column; align-items:center; width:100%; }
        #shop .card:nth-child(1){animation-delay:.04s} #shop .card:nth-child(2){animation-delay:.08s} #shop .card:nth-child(3){animation-delay:.12s} #shop .card:nth-child(4){animation-delay:.16s} #shop .card:nth-child(5){animation-delay:.2s} #shop .card:nth-child(6){animation-delay:.24s} #shop .card:nth-child(n+7){animation-delay:.28s}
        #profile { display:none; flex-direction:column; padding:0; padding-bottom:120px; }
        #profile.active { display:flex; }
        .tg-profile { display:flex; flex-direction:column; width:100%; }

        .tg-profile-hero {
            background: linear-gradient(180deg, #0d1f35 0%, var(--card) 100%);
            padding: 30px 20px 24px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            position: relative;
        }
        .tg-avatar-wrap { position:relative; display:inline-block; margin-bottom:0; }
        .tg-avatar {
            width:100px; height:100px; border-radius:50%;
            object-fit:cover; border:3px solid var(--accent);
            cursor:pointer; display:block;
            transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1), border-color 0.3s;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        }
        .tg-avatar:hover { transform:scale(1.06); border-color:gold; }
        .tg-avatar-edit {
            position:absolute; bottom:2px; right:2px;
            width:28px; height:28px; border-radius:50%;
            background:var(--accent); display:flex; align-items:center; justify-content:center;
            font-size:13px; cursor:pointer; border:2px solid var(--bg);
            box-shadow:0 2px 8px rgba(0,0,0,0.4);
        }
        .tg-username { font-size:22px; font-weight:700; margin:0 0 6px; letter-spacing:0.3px; color:var(--text); }
        .tg-bio { color:var(--secondary); font-size:13px; margin:0 0 20px; line-height:1.5; max-width:280px; margin-left:auto; margin-right:auto; }

        .tg-stats {
            display:flex; align-items:center; justify-content:center; gap:0;
            background:rgba(255,255,255,0.04); border-radius:18px; padding:14px 10px;
            margin-bottom:20px; border:1px solid rgba(255,255,255,0.07);
        }
        .tg-stat { flex:1; text-align:center; }
        .tg-stat-val { font-size:20px; font-weight:700; color:white; }
        .tg-stat-lbl { font-size:10px; color:var(--secondary); margin-top:2px; }
        .tg-stat-div { width:1px; height:32px; background:rgba(255,255,255,0.1); flex-shrink:0; }

        .tg-actions { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
        .tg-action-btn {
            display:flex; flex-direction:column; align-items:center; gap:4px;
            background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.09);
            border-radius:16px; padding:10px 14px; cursor:pointer; color:white;
            font-size:11px; font-weight:600; min-width:68px;
            transition:0.2s cubic-bezier(0.34,1.56,0.64,1);
        }
        .tg-action-btn:active { transform:scale(0.9); }
        .tg-action-btn:hover { background:rgba(255,255,255,0.1); }
        .tg-action-icon { font-size:20px; }
        .tg-action-tg { background:rgba(34,158,217,0.15); border-color:rgba(34,158,217,0.3); color:#229ED9; }
        .tg-action-red { background:rgba(231,76,60,0.12); border-color:rgba(231,76,60,0.25); color:#e74c3c; }

        .tg-gifts-section { padding:0 0 10px; }
        .tg-gifts-header {
            display:flex; justify-content:space-between; align-items:center;
            padding:16px 16px 10px; font-size:13px; font-weight:700;
            color:var(--secondary); text-transform:uppercase; letter-spacing:0.8px;
        }
        .tg-gifts-count {
            background:rgba(36,129,204,0.2); color:var(--accent);
            border-radius:10px; padding:2px 8px; font-size:12px; font-weight:700;
        }
        .tg-gifts-grid {
            display:grid; grid-template-columns:repeat(3,1fr); gap:5px;
            padding:0 6px 6px;
        }
        /* NFT animations */
        @keyframes nftGoldPulse{0%,100%{box-shadow:0 0 0 1.5px rgba(255,215,0,0.55),0 4px 20px rgba(255,215,0,0.25)}50%{box-shadow:0 0 0 2.5px rgba(255,215,0,0.9),0 6px 30px rgba(255,215,0,0.5)}}
        @keyframes nftGoldShimmer{0%{background-position:-200% center}100%{background-position:200% center}}
        @keyframes nftImgFloat{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-5px) scale(1.06)}}
        @keyframes nftLizPulse{0%,100%{box-shadow:0 0 0 1.5px rgba(77,255,145,0.55),0 4px 20px rgba(77,255,145,0.25)}50%{box-shadow:0 0 0 2.5px rgba(77,255,145,0.9),0 6px 30px rgba(77,255,145,0.5)}}
        @keyframes nftStars{0%{opacity:0;transform:scale(0) rotate(0deg)}50%{opacity:1}100%{opacity:0;transform:scale(1.5) rotate(180deg)}}

        .tg-gift-cell {
            background:var(--card); cursor:pointer; aspect-ratio:1;
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            gap:3px; transition:0.22s cubic-bezier(0.34,1.56,0.64,1);
            border-radius:18px; overflow:hidden; position:relative;
            border:1.5px solid rgba(255,255,255,0.07);
            box-shadow:0 2px 10px rgba(0,0,0,0.3);
        }
        .tg-gift-cell:hover { border-color:rgba(255,255,255,0.22); box-shadow:0 8px 24px rgba(0,0,0,0.55); transform:scale(1.05) translateY(-3px); }
        .tg-gift-cell:active { transform:scale(0.91); }
        .tg-gift-inner {
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            width:100%; flex:1; padding:8px 4px 0; position:relative;
        }
        .tg-gift-inner img { width:58px; height:58px; object-fit:contain; filter:drop-shadow(0 3px 12px rgba(0,0,0,0.45)); transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1); }
        .tg-gift-cell:hover .tg-gift-inner img { transform:scale(1.15) translateY(-3px); }
        .tg-gift-name { font-size:10px; color:var(--secondary); text-align:center; padding:0 4px 3px; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%; }

        /* NFT GOLD */
        .tg-gift-nft {
            background:linear-gradient(145deg,#1c1200,#0f1a1f,#1a1100) !important;
            animation:nftGoldPulse 2.5s ease-in-out infinite;
            border-color:rgba(255,215,0,0.6) !important;
            will-change:box-shadow;
        }
        .tg-gift-nft::before {
            content:''; position:absolute; inset:0; border-radius:18px; pointer-events:none; z-index:0;
            background:linear-gradient(105deg,transparent 25%,rgba(255,215,0,0.12) 50%,transparent 75%);
            background-size:200% 100%; animation:nftGoldShimmer 2.5s linear infinite;
            will-change:background-position;
        }
        .tg-gift-nft .tg-gift-inner { z-index:1; }
        .tg-gift-nft .tg-gift-inner img { animation:nftImgFloat 3s ease-in-out infinite; filter:drop-shadow(0 4px 16px rgba(255,215,0,0.55)); will-change:transform; }
        .tg-gift-nft .tg-gift-name {
            background:linear-gradient(90deg,#ffd700,#ffb347,#ffd700);
            background-size:200% auto;
            animation:nftGoldShimmer 2s linear infinite;
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
            font-weight:bold;
        }
        .tg-gift-nft-badge {
            position:absolute; top:5px; right:5px; z-index:3;
            background:linear-gradient(90deg,#b8860b,#ffd700,#b8860b);
            background-size:200% auto; animation:nftGoldShimmer 1.8s linear infinite;
            color:#000; font-size:7px; font-weight:900; border-radius:6px; padding:2px 5px;
            letter-spacing:0.5px; box-shadow:0 1px 6px rgba(255,215,0,0.5);
            will-change:background-position;
        }
        .tg-gift-nft-serial {
            position:absolute; bottom:22px; left:0; right:0; text-align:center; z-index:3;
            font-size:7px; color:rgba(255,215,0,0.5); font-family:monospace; letter-spacing:0.3px;
        }
        .tg-gift-nft-price {
            font-size:8px; color:rgba(255,215,0,0.7); font-weight:bold; padding-bottom:4px; z-index:1;
        }

        /* NFT LIZARD */
        .tg-gift-nft-lizard {
            background:linear-gradient(145deg,#001a08,#0a1f12,#001208) !important;
            animation:nftLizPulse 2.5s ease-in-out infinite;
            border-color:rgba(77,255,145,0.6) !important;
            will-change:box-shadow;
        }
        .tg-gift-nft-lizard::before {
            content:''; position:absolute; inset:0; border-radius:18px; pointer-events:none; z-index:0;
            background:linear-gradient(105deg,transparent 25%,rgba(77,255,145,0.12) 50%,transparent 75%);
            background-size:200% 100%; animation:nftGoldShimmer 2.5s linear infinite;
            will-change:background-position;
        }
        .tg-gift-nft-lizard .tg-gift-inner { z-index:1; }
        .tg-gift-nft-lizard .tg-gift-inner img { animation:nftImgFloat 3s ease-in-out infinite; filter:drop-shadow(0 4px 16px rgba(77,255,145,0.6)); will-change:transform; }
        .tg-gift-nft-lizard .tg-gift-name {
            background:linear-gradient(90deg,#00ff88,#4dff91,#00cc66);
            background-size:200% auto; animation:nftGoldShimmer 2s linear infinite;
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; font-weight:bold;
        }
        .tg-gift-nft-lizard .tg-gift-nft-badge { background:linear-gradient(90deg,#007744,#4dff91,#007744); }
        .tg-gift-nft-lizard .tg-gift-nft-serial { color:rgba(77,255,145,0.45); }
        .tg-gift-nft-lizard .tg-gift-nft-price { color:rgba(77,255,145,0.7); }

        .tg-gift-from {
            position:absolute; top:6px; left:5px; z-index:3;
            background:rgba(243,156,18,0.9); color:white;
            font-size:7px; font-weight:700; border-radius:7px; padding:2px 5px;
            backdrop-filter:blur(4px); max-width:48px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
        }
        .tg-gift-pinned { border-color:rgba(243,156,18,0.6) !important; box-shadow:0 0 0 1px rgba(243,156,18,0.25), 0 4px 14px rgba(243,156,18,0.2) !important; }

        /* ===== DESKTOP / PC STYLES ===== */
        @media (min-width: 768px) {
            body { max-width: 1200px; margin: 0 auto; }

            .nav {
                width: 480px;
                max-width: 480px;
                bottom: 28px;
                border-radius: 32px;
            }
            .nav-btn { font-size: 12px; padding: 4px 6px; }
            .nav-btn i { font-size: 24px; }

            .page { 
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
                gap: 20px; 
                padding: 20px 20px 140px;
                max-width: 1200px;
                margin: 0 auto;
            }
            .card { padding: 24px; border-radius: 28px; }
            .gift-img { width: 90px; height: 90px; }
            .gift-img-wrap { height: 110px; }
            .gift-img-wrap .gift-img { width: 90px; height: 90px; }

            #friends, #admin { 
                max-width: 800px; 
                margin: 0 auto; 
                padding: 20px 20px 140px;
            }
            #profile { 
                max-width: 700px; 
                margin: 0 auto; 
                padding: 20px; 
            }
            #profile.active { padding-bottom: 140px; }

            .tg-gifts-grid { grid-template-columns: repeat(4, 1fr); gap: 8px; }

            .adm-stat-grid { grid-template-columns: repeat(4, 1fr); }
            .adm-stat .val { font-size: 30px; }

            input, textarea, select { font-size: 15px; }

            #toast-container { 
                bottom: 130px; 
                max-width: 500px; 
            }

            #modal-content { max-width: 500px; }
            #modal-overlay { padding: 30px; }

            .search-filter-bar { gap: 12px; }
            .search-filter-bar input { font-size: 15px; }

            .pinned-section { gap: 20px; padding: 20px; }

            .adm-tabs { gap: 10px; }
            .adm-tab { padding: 10px 20px; font-size: 14px; }
        }

        @media (min-width: 1100px) {
            .page { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
            .tg-gifts-grid { grid-template-columns: repeat(5, 1fr); }
        }
    </style>
</head>
<body>


<!-- Toast notifications container -->
<div id="toast-container" style="position:fixed;bottom:110px;left:50%;transform:translateX(-50%);z-index:5000;display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none;width:92%;max-width:400px;"></div>

<!-- Beautiful modal overlay -->
<div id="modal-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0);display:none;align-items:center;justify-content:center;z-index:2000;padding:20px;transition:background 0.3s;" onclick="if(event.target==this) closeModal()">
    <div id="modal-content" class="card" style="width:100%;max-width:400px;background:var(--card);max-height:85vh;overflow-y:auto;"></div>
</div>

<!-- Confirm dialog -->
<div id="confirm-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0);display:none;align-items:center;justify-content:center;z-index:6000;padding:20px;transition:background 0.3s;">
    <div id="confirm-box" style="width:100%;max-width:340px;background:var(--card);border-radius:24px;padding:24px;border:1px solid rgba(255,255,255,0.1);box-shadow:0 30px 80px rgba(0,0,0,0.8);animation:popIn 0.32s cubic-bezier(0.34,1.56,0.64,1) both;">
        <div id="confirm-icon" style="font-size:44px;text-align:center;margin-bottom:10px;"></div>
        <h3 id="confirm-title" style="text-align:center;margin:0 0 8px;font-size:17px;"></h3>
        <p id="confirm-msg" style="text-align:center;color:var(--secondary);font-size:13px;margin:0 0 20px;line-height:1.5;"></p>
        <div style="display:flex;gap:10px;">
            <button id="confirm-cancel" class="btn" style="background:#1a2636;color:var(--secondary);border:1px solid rgba(255,255,255,0.08);flex:1;" onclick="resolveConfirm(false)">–û—Ç–º–µ–Ω–∞</button>
            <button id="confirm-ok" class="btn" style="flex:1;" onclick="resolveConfirm(true)">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
    </div>
</div>

<style>
    @keyframes authSlideIn { from{opacity:0;transform:translateY(30px) scale(0.95)} to{opacity:1;transform:translateY(0) scale(1)} }
    @keyframes titlePulse { 0%,100%{text-shadow:0 0 20px rgba(36,129,204,0.4)} 50%{text-shadow:0 0 40px rgba(36,129,204,0.8)} }
    @keyframes formSlide { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

    .auth-wrap { min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; gap:16px; }
    .auth-logo { text-align:center; animation:authSlideIn 0.5s cubic-bezier(0.34,1.56,0.64,1) both; }
    .auth-logo h1 { font-size:32px; color:var(--accent); margin:8px 0 4px; animation:titlePulse 3s ease-in-out infinite; }
    .auth-logo p { color:var(--secondary); font-size:13px; margin:0; }

    .auth-card {
        width:100%; max-width:360px;
        background:var(--card);
        border-radius:26px;
        padding:6px 6px 20px;
        border:1px solid rgba(255,255,255,0.07);
        animation:authSlideIn 0.5s cubic-bezier(0.34,1.56,0.64,1) 0.08s both;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    /* Tab switcher */
    .auth-tabs { display:flex; background:#0a1520; border-radius:20px; padding:5px; margin-bottom:16px; }
    .auth-tab {
        flex:1; padding:10px; border:none; background:none; color:var(--secondary);
        font-size:14px; font-weight:bold; border-radius:16px; cursor:pointer;
        transition:all 0.25s cubic-bezier(0.34,1.56,0.64,1);
    }
    .auth-tab.active { background:var(--accent); color:white; box-shadow:0 4px 15px rgba(36,129,204,0.4); transform:scale(1.03); }
    .auth-tab.active.green { background:var(--green); box-shadow:0 4px 15px rgba(46,204,113,0.4); }

    /* Form */
    .auth-form { display:none; padding:0 6px; animation:formSlide 0.25s ease both; }
    .auth-form.active { display:block; }
    .auth-form input { margin:6px 0; padding:13px 40px 13px 14px; font-size:15px; border-radius:14px; }
    .auth-form .btn { border-radius:14px; padding:13px; margin-top:8px; font-size:15px; font-weight:bold; }
    .auth-err { font-size:12px; color:var(--err); margin-top:6px; min-height:16px; text-align:center; padding:0 4px; }
    .input-wrap { position:relative; }
    .input-status { position:absolute; right:13px; top:50%; transform:translateY(-50%); font-size:14px; pointer-events:none; }

    .auth-links { width:100%; max-width:360px; display:flex; gap:10px; animation:authSlideIn 0.5s cubic-bezier(0.34,1.56,0.64,1) 0.18s both; }
    .auth-links a { flex:1; padding:10px; font-size:13px; border-radius:14px; }

        /* ===== NFT UPGRADE LEVELS ===== */
        .nft-lvl1-fire { background:linear-gradient(145deg,#1a0500,#2d0a00,#1a0500) !important; border-color:rgba(255,80,0,0.7) !important; }
        .nft-lvl1-ocean { background:linear-gradient(145deg,#001a2d,#002d4a,#001a2d) !important; border-color:rgba(0,150,255,0.7) !important; }
        .nft-lvl1-forest { background:linear-gradient(145deg,#001a08,#002d12,#001a08) !important; border-color:rgba(0,200,80,0.7) !important; }
        .nft-lvl1-galaxy { background:linear-gradient(145deg,#0a0015,#150020,#0a0015) !important; border-color:rgba(180,0,255,0.7) !important; }
        .nft-lvl1-sunset { background:linear-gradient(145deg,#1a0820,#2d0d10,#1a0820) !important; border-color:rgba(255,100,150,0.7) !important; }
        .nft-lvl2::after { content:''; position:absolute; inset:0; border-radius:18px; pointer-events:none; z-index:0; opacity:0.25; }
        .nft-lvl2-grid::after { background-image: repeating-linear-gradient(0deg,rgba(255,255,255,0.08) 0px,transparent 1px,transparent 20px),repeating-linear-gradient(90deg,rgba(255,255,255,0.08) 0px,transparent 1px,transparent 20px); }
        .nft-lvl2-dots::after { background-image: radial-gradient(circle,rgba(255,255,255,0.15) 1px,transparent 1px); background-size:12px 12px; }
        .nft-lvl2-hex::after { background-image: repeating-linear-gradient(60deg,rgba(255,255,255,0.06) 0,rgba(255,255,255,0.06) 1px,transparent 0,transparent 50%),repeating-linear-gradient(120deg,rgba(255,255,255,0.06) 0,rgba(255,255,255,0.06) 1px,transparent 0,transparent 50%); background-size:20px 35px; }
        .nft-lvl2-waves::after { background-image: repeating-linear-gradient(45deg,rgba(255,255,255,0.05) 0px,rgba(255,255,255,0.05) 2px,transparent 2px,transparent 10px); }
        .nft-lvl2-stars::after { background-image: radial-gradient(circle,rgba(255,255,255,0.3) 1px,transparent 1px),radial-gradient(circle,rgba(255,255,255,0.15) 1px,transparent 1px); background-size:25px 25px,13px 13px; background-position:0 0,12px 12px; }
        @keyframes auPulseF { 0%,100%{box-shadow:0 0 20px 3px rgba(255,80,0,0.3)} 50%{box-shadow:0 0 40px 10px rgba(255,80,0,0.7)} }
        @keyframes auPulseO { 0%,100%{box-shadow:0 0 20px 3px rgba(0,150,255,0.3)} 50%{box-shadow:0 0 40px 10px rgba(0,150,255,0.7)} }
        @keyframes auPulseG { 0%,100%{box-shadow:0 0 20px 3px rgba(0,200,80,0.3)} 50%{box-shadow:0 0 40px 10px rgba(0,200,80,0.7)} }
        @keyframes auPulseV { 0%,100%{box-shadow:0 0 20px 3px rgba(180,0,255,0.3)} 50%{box-shadow:0 0 40px 10px rgba(180,0,255,0.7)} }
        @keyframes auPulseP { 0%,100%{box-shadow:0 0 20px 3px rgba(255,100,150,0.3)} 50%{box-shadow:0 0 40px 10px rgba(255,100,150,0.7)} }
        .nft-lvl3-fire { animation:auPulseF 2.5s ease-in-out infinite !important; }
        .nft-lvl3-ocean { animation:auPulseO 2.5s ease-in-out infinite !important; }
        .nft-lvl3-forest { animation:auPulseG 2.5s ease-in-out infinite !important; }
        .nft-lvl3-galaxy { animation:auPulseV 2.5s ease-in-out infinite !important; }
        .nft-lvl3-sunset { animation:auPulseP 2.5s ease-in-out infinite !important; }
        @keyframes particleFloat { 0%{transform:translateY(0) scale(1);opacity:0.9} 100%{transform:translateY(-28px) scale(0.3);opacity:0} }
        .nft-lvl4-particles { overflow:visible !important; }
        .nft-particle { position:absolute; width:5px; height:5px; border-radius:50%; pointer-events:none; z-index:10; animation:particleFloat 1.8s ease-in-out infinite; }
        @keyframes holoShine { 0%{background-position:0% 50%;opacity:0.55} 50%{background-position:100% 50%;opacity:1} 100%{background-position:0% 50%;opacity:0.55} }
        .nft-lvl5-holo::before { content:''; position:absolute; inset:-2px; border-radius:20px; background:linear-gradient(105deg,#ff0000,#ff7f00,#ffff00,#00ff00,#0000ff,#8b00ff,#ff0000); background-size:400% 400%; animation:holoShine 3s ease infinite; z-index:0; opacity:0.5; }
        .nft-lvl5-holo { position:relative; overflow:visible !important; }
        .nft-lvl5-holo .tg-gift-inner,.nft-lvl5-holo .tg-gift-name,.nft-lvl5-holo .tg-gift-nft-badge { z-index:2 !important; position:relative; }
        /* Ring items: block all upgrade side-effects that break absolute positioning */
        .avatar-ring-item { position:absolute !important; }
        .avatar-ring-item.nft-lvl3-fire,
        .avatar-ring-item.nft-lvl3-ocean,
        .avatar-ring-item.nft-lvl3-forest,
        .avatar-ring-item.nft-lvl3-galaxy,
        .avatar-ring-item.nft-lvl3-sunset { animation: none !important; }
        .avatar-ring-item.nft-lvl5-holo { overflow:hidden !important; }
        .avatar-ring-item.nft-lvl5-holo::before { display:none !important; }
        .avatar-ring-item.nft-lvl4-particles { overflow:hidden !important; }
        .nft-upgrade-badge { position:absolute; bottom:5px; right:5px; z-index:5; font-size:8px; font-weight:900; border-radius:8px; padding:2px 5px; letter-spacing:0.3px; }
        .nft-upg-1 { background:linear-gradient(90deg,#555,#888); color:#fff; }
        .nft-upg-2 { background:linear-gradient(90deg,#1a5fa8,#4db4ff); color:#fff; }
        .nft-upg-3 { background:linear-gradient(90deg,#7c3aed,#a855f7); color:#fff; }
        .nft-upg-4 { background:linear-gradient(90deg,#b8860b,#ffd700); color:#000; }
        .nft-upg-5 { background:linear-gradient(90deg,#ff0044,#ff7700,#ffee00,#00ff88,#0088ff,#aa00ff); background-size:300% 100%; animation:shimmer 2s linear infinite; color:#fff; }

        .cosm-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin:8px 0; }
        .cosm-item { background:#0a1520; border:1.5px solid rgba(255,255,255,0.07); border-radius:14px; padding:10px 12px; cursor:pointer; transition:0.18s; display:flex; flex-direction:column; gap:4px; }
        .cosm-item:hover { border-color:rgba(36,129,204,0.4); }
        .cosm-item.active-cosm { border-color:var(--accent); background:rgba(36,129,204,0.12); box-shadow:0 0 0 1px rgba(36,129,204,0.3); }
        .cosm-item.locked { opacity:0.5; cursor:default; }
        .cosm-preview { font-size:18px; font-weight:bold; }
        .cosm-name { font-size:12px; color:var(--secondary); }
        .cosm-price { font-size:11px; color:var(--accent); margin-top:2px; }
        .cosm-unlock { font-size:10px; color:#a29bfe; margin-top:2px; }
        .cosm-section-title { font-size:13px; color:var(--secondary); margin:12px 0 4px; font-weight:bold; }
        .cosm-badge { display:inline-block; font-size:11px; padding:1px 6px; border-radius:8px; margin-left:4px; vertical-align:middle; font-weight:bold; }
        .cosm-prefix { margin-right:4px; }

        /* ‚îÄ‚îÄ Color shimmer –¥–ª—è –Ω–∏–∫–æ–≤ ‚îÄ‚îÄ */
        @keyframes shimmer {
            0%   { background-position: 0%   50% }
            50%  { background-position: 100% 50% }
            100% { background-position: 0%   50% }
        }
        .name-shimmer {
            display:inline-block;
            background-size:300% 100%;
            animation:shimmer 2.5s ease infinite;
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
            font-weight:700;
            color:transparent; /* fallback —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å —Ä–æ–¥–∏—Ç–µ–ª–µ–º */
        }
        .shimmer-blue    { background-image: linear-gradient(90deg, #5dade2, #aed6f1, #2e86c1, #85c1e9, #5dade2); }
        .shimmer-green   { background-image: linear-gradient(90deg, #2ecc71, #a9dfbf, #27ae60, #82e0aa, #2ecc71); }
        .shimmer-purple  { background-image: linear-gradient(90deg, #a29bfe, #dcd6ff, #6c5ce7, #c5b9ff, #a29bfe); }
        .shimmer-orange  { background-image: linear-gradient(90deg, #f39c12, #fde3a7, #e67e22, #fad7a0, #f39c12); }
        .shimmer-pink    { background-image: linear-gradient(90deg, #fd79a8, #ffd6e7, #e84393, #ffb3d1, #fd79a8); }
        .shimmer-gold    { background-image: linear-gradient(90deg, #ffd700, #fff4b3, #ffaa00, #ffe680, #ffd700); }
        .shimmer-red     { background-image: linear-gradient(90deg, #e74c3c, #f1948a, #c0392b, #ec7063, #e74c3c); }
        /* ‚îÄ‚îÄ Admin rainbow prefix ‚îÄ‚îÄ */
        @keyframes adminRainbow {
            0%   {background-position:0%   50%}
            50%  {background-position:100% 50%}
            100% {background-position:0%   50%}
        }
        .admin-rainbow-prefix {
            display:inline-block;
            background:linear-gradient(90deg,#ff6b6b,#ffd93d,#6bcb77,#4d96ff,#c77dff,#ff6bcd,#ff6b6b);
            background-size:300% 100%;
            animation:adminRainbow 2s linear infinite;
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
            font-weight:900;
            font-size:0.95em;
            letter-spacing:0.5px;
            margin-right:4px;
        }
        /* ‚îÄ‚îÄ Sell (trash) button ‚îÄ‚îÄ */
        .sell-btn {
            position:absolute;top:6px;left:6px;z-index:5;
            background:rgba(231,76,60,0.75);
            border:none;border-radius:8px;
            width:26px;height:26px;
            cursor:pointer;font-size:13px;
            display:flex;align-items:center;justify-content:center;
            transition:background 0.2s, transform 0.15s;
        }
        .sell-btn:hover { background:rgba(231,76,60,1); transform:scale(1.15); }
        .sell-btn:active { transform:scale(0.9); }
        /* ‚îÄ‚îÄ Lizard badge ‚îÄ‚îÄ */
        .lizard-badge {
            display:inline-block;
            font-size:14px;
            vertical-align:middle;
            margin-left:3px;
            filter:drop-shadow(0 0 5px rgba(80,255,120,0.8));
            animation:wiggle 3.5s ease-in-out infinite;
        }
        /* ‚îÄ‚îÄ Pinned outline - moved to main css above ‚îÄ‚îÄ */
</style>

<div id="auth-screen" class="auth-wrap">
    <div class="auth-logo">
        <div style="font-size:52px;">üéÅ</div>
        <h1>Gifts World</h1>
        <p>–î–∞—Ä–∏ –ø–æ–¥–∞—Ä–∫–∏ –¥—Ä—É–∑—å—è–º</p>
    </div>

    <div class="auth-card">
        <!-- Tabs -->
        <div class="auth-tabs">
            <button class="auth-tab active" id="tab-login" onclick="switchAuthTab('login')">üîë –í—Ö–æ–¥</button>
            <button class="auth-tab" id="tab-reg" onclick="switchAuthTab('reg')">‚ú® –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>

        <!-- Login form -->
        <div class="auth-form active" id="form-login">
            <div class="input-wrap">
                <input type="text" id="l-user" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username" oninput="clearAuthErr('l-err')">
            </div>
            <div class="input-wrap">
                <input type="password" id="l-pass" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password" oninput="clearAuthErr('l-err')" onkeydown="if(event.key==='Enter') auth('login')">
            </div>
            <div class="auth-err" id="l-err"></div>
            <button class="btn" style="background:var(--accent);" onclick="auth('login')">–í–æ–π—Ç–∏ ‚Üí</button>
        </div>

        <!-- Register form -->
        <div class="auth-form" id="form-reg">
            <div class="input-wrap">
                <input type="text" id="r-user" placeholder="–ü—Ä–∏–¥—É–º–∞–π –ª–æ–≥–∏–Ω" autocomplete="off" oninput="checkUsername(this.value)">
                <span class="input-status" id="r-user-status"></span>
            </div>
            <div class="input-wrap">
                <input type="password" id="r-pass" placeholder="–ü—Ä–∏–¥—É–º–∞–π –ø–∞—Ä–æ–ª—å" autocomplete="new-password" oninput="clearAuthErr('r-err')" onkeydown="if(event.key==='Enter') auth('reg')">
            </div>
            <div class="auth-err" id="r-err"></div>
            <button class="btn" style="background:var(--green);" onclick="auth('reg')">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è ‚Üí</button>
        </div>
    </div>

    <div class="auth-links">
        <a href="https://t.me/Gifts_World_Pro" target="_blank" class="btn" style="background:var(--tg);">üì¢ –ö–∞–Ω–∞–ª</a>
        <a href="https://dalink.to/gifworld" target="_blank" class="btn" style="background:#505050;">üíé –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
    </div>
</div>


<div id="app" style="display:none">
    <div style="padding:15px 20px;background:var(--glass);position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.05);">
        <b id="header-name" style="display:inline-block;">...</b>
        <div style="font-weight:bold;"><span id="u-bal" style="color:var(--accent);">0</span> üí∞</div>
    </div>

    <div id="shop" class="page active"></div>
    <div id="inv" class="page"></div>
    <div id="market" class="page"></div>

    <div id="friends" class="page">
        <div id="duel-challenges-section"></div>
        <div id="trade-offers-section"></div>
        <div style="position:relative;margin-bottom:12px;">
            <input type="text" id="friend-search" placeholder="üîç –ù–∞–π—Ç–∏ –∏–≥—Ä–æ–∫–∞ –ø–æ –Ω–∏–∫—É..."
                oninput="filterAllUsers(this.value)"
                onfocus="showUserDropdown(this.value)"
                onblur="setTimeout(hideUserDropdown,200)"
                style="width:100%;box-sizing:border-box;">
            <div id="user-dropdown" style="display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:#0e1824;border:1px solid #2b3a4a;border-radius:14px;z-index:100;max-height:280px;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.5);"></div>
        </div>
        <div id="friend-requests"></div>
        <div id="friends-list"></div>
    </div>

    <div id="profile" class="page"></div>

    <!-- ===== ADMIN PANEL ===== -->
    <div id="admin" class="page" style="padding:15px;padding-bottom:120px;">

        <!-- Header -->
        <div class="adm-header">
            <div>
                <div class="adm-header-title">‚öôÔ∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
                <div class="adm-header-sub" id="adm-online-hint">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            </div>
            <button onclick="admRefresh()" style="background:rgba(36,129,204,0.12);border:1px solid rgba(36,129,204,0.2);color:var(--accent);border-radius:12px;padding:8px 14px;font-size:12px;cursor:pointer;font-weight:bold;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>

        <!-- Tabs -->
        <div class="adm-tabs">
            <button class="adm-tab active" onclick="admTab('overview',this)">üìä –û–±–∑–æ—Ä</button>
            <button class="adm-tab" onclick="admTab('users',this)">üë• –ò–≥—Ä–æ–∫–∏</button>
            <button class="adm-tab" onclick="admTab('market',this)">‚öñÔ∏è –†—ã–Ω–æ–∫</button>
            <button class="adm-tab" onclick="admTab('promos',this)">üéüÔ∏è –ü—Ä–æ–º–æ</button>
            <button class="adm-tab" onclick="admTab('tools',this)">üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</button>
            <button class="adm-tab" onclick="admTab('sales',this)">üõí –ü—Ä–æ–¥–∞–∂–∏</button>
        </div>

        <!-- ‚îÄ‚îÄ Overview ‚îÄ‚îÄ -->
        <div id="adm-overview" class="adm-section active">
            <div class="adm-stat-grid" id="adm-stats-grid"></div>

            <!-- Top players -->
            <div style="background:#0d1720;border-radius:20px;padding:16px;border:1px solid rgba(255,255,255,0.06);margin-bottom:12px;">
                <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:12px;">üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –±–∞–ª–∞–Ω—Å—É</div>
                <div id="adm-top-users"></div>
            </div>

            <!-- Quick actions -->
            <div style="background:#0d1720;border-radius:20px;padding:16px;border:1px solid rgba(255,255,255,0.06);margin-bottom:12px;">
                <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:12px;">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <button class="btn" style="background:rgba(46,204,113,0.12);border:1px solid rgba(46,204,113,0.2);color:var(--green);font-size:12px;padding:10px;" onclick="admTab('tools',document.querySelectorAll('.adm-tab')[4])">üì¢ –†–∞—Å—Å—ã–ª–∫–∞</button>
                    <button class="btn" style="background:rgba(243,156,18,0.12);border:1px solid rgba(243,156,18,0.2);color:var(--orange);font-size:12px;padding:10px;" onclick="admTab('promos',document.querySelectorAll('.adm-tab')[3])">üéüÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥—ã</button>
                    <button class="btn" style="background:rgba(36,129,204,0.12);border:1px solid rgba(36,129,204,0.2);color:var(--accent);font-size:12px;padding:10px;" onclick="admTab('users',document.querySelectorAll('.adm-tab')[1])">üë• –ò–≥—Ä–æ–∫–∏</button>
                    <button class="btn" style="background:rgba(36,129,204,0.12);border:1px solid rgba(36,129,204,0.2);color:var(--accent);font-size:12px;padding:10px;" onclick="admTab('sales',document.querySelectorAll('.adm-tab')[5])">üõí –ü—Ä–æ–¥–∞–∂–∏</button>
                </div>
            </div>

            <!-- Activity Feed -->
            <div style="background:#0d1720;border-radius:20px;padding:16px;border:1px solid rgba(255,255,255,0.06);">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                    <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;">üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
                    <div style="display:flex;align-items:center;gap:5px;background:rgba(46,204,113,0.08);border:1px solid rgba(46,204,113,0.2);border-radius:10px;padding:3px 9px;">
                        <span style="width:6px;height:6px;border-radius:50%;background:var(--green);display:inline-block;animation:pulse 1.5s infinite;"></span>
                        <span style="font-size:10px;color:var(--green);font-weight:bold;">Live</span>
                    </div>
                </div>
                <div id="adm-activity-feed"><div style="color:var(--secondary);text-align:center;padding:16px;font-size:13px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ Users ‚îÄ‚îÄ -->
        <div id="adm-users" class="adm-section">
            <div class="search-box" style="margin-bottom:10px;">
                <span style="color:var(--secondary);">üîç</span>
                <input type="text" id="adm-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É, IP..." oninput="admFilterUsers(this.value)" style="flex:1;">
                <span id="adm-user-count" style="font-size:11px;color:var(--secondary);white-space:nowrap;"></span>
            </div>
            <div id="adm-users-list"></div>
        </div>

        <!-- ‚îÄ‚îÄ Market ‚îÄ‚îÄ -->
        <div id="adm-market" class="adm-section">
            <div style="background:#0d1720;border-radius:20px;padding:16px;border:1px solid rgba(255,255,255,0.06);margin-bottom:12px;">
                <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:8px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä—ã–Ω–∫–∞</div>
                <div id="adm-market-stats" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;"></div>
            </div>
            <div class="search-box" style="margin-bottom:10px;">
                <span style="color:var(--secondary);">üîç</span>
                <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º..." oninput="admFilterMarket(this.value)">
            </div>
            <div id="adm-market-list"></div>
        </div>

        <!-- ‚îÄ‚îÄ Promos ‚îÄ‚îÄ -->
        <div id="adm-promos" class="adm-section">
            <div class="tool-card" style="margin-bottom:12px;">
                <div class="tool-card-title">‚ú® –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</div>
                <input type="text" id="promo-code-in" placeholder="–ö–æ–¥ (–Ω–∞–ø—Ä. GIFT2025)" style="margin:0 0 8px;text-transform:uppercase;">
                <div style="display:flex;gap:8px;margin-bottom:8px;">
                    <input type="number" id="promo-reward-in" placeholder="üí∞ –ú–æ–Ω–µ—Ç—ã" style="margin:0;flex:1;">
                    <input type="number" id="promo-uses-in" placeholder="üî¢ –õ–∏–º–∏—Ç" style="margin:0;flex:1;">
                </div>
                <div style="font-size:11px;color:var(--secondary);margin-bottom:4px;font-weight:bold;">üéÅ –ü–æ–¥–∞—Ä–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</div>
                <select id="promo-gift-in" style="margin:0 0 10px;width:100%;padding:10px 12px;height:44px;border-radius:12px;font-size:13px;">
                    <option value="">‚Äî –ë–µ–∑ –ø–æ–¥–∞—Ä–∫–∞ ‚Äî</option>
                    <option value="nft_liz">ü¶é –Ø—â–µ—Ä–∏—Ü–∞ (NFT)</option>
                                        <option value="nft_pan">üç≥ –°–∫–æ–≤–æ—Ä–æ–¥–∞ (NFT)</option>
                    <option value="nft_beer">üç∫ –ö—Ä—É–∂–∫–∞ –ü–∏–≤–∞ (NFT)</option>
                    <option value="nft_sock">üß¶ –ù–æ—Å–æ–∫ (NFT)</option>
                    <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                </select>
                <div style="display:flex;gap:8px;margin-bottom:10px;">
                    <select id="promo-gift-rarity" style="flex:1;margin:0;padding:6px 10px;height:40px;border-radius:12px;font-size:12px;">
                        <option value="0">‚¨ú –û–±—ã—á–Ω—ã–π</option>
                        <option value="1">üîµ –†–µ–¥–∫–∏–π</option>
                        <option value="2">üü£ –≠–ø–∏—á–µ—Å–∫–∏–π</option>
                        <option value="3">üü° –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π</option>
                    </select>
                </div>
                <button class="btn" style="background:var(--accent);" onclick="createPromo()">‚ú® –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
            </div>
            <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:10px;" id="promo-count-lbl"></div>
            <div id="promo-list"></div>
        </div>

        <!-- ‚îÄ‚îÄ Tools ‚îÄ‚îÄ -->
        <div id="adm-tools" class="adm-section">
            <div style="display:flex;flex-direction:column;gap:10px;">
                <div class="tool-card">
                    <div class="tool-card-title">üì¢ –†–∞—Å—Å—ã–ª–∫–∞ –º–æ–Ω–µ—Ç –≤—Å–µ–º</div>
                    <div style="display:flex;gap:8px;">
                        <input type="number" id="bcast-coins" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç" style="margin:0;flex:1;">
                        <button class="btn" style="background:var(--green);width:48px;padding:0;height:42px;flex-shrink:0;" onclick="broadcastCoins()">‚úì</button>
                    </div>
                </div>
                <div class="tool-card">
                    <div class="tool-card-title">‚úàÔ∏è –†–∞—Å—Å—ã–ª–∫–∞ –≤ Telegram</div>
                    <textarea id="bcast-msg" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..." style="min-height:70px;margin-bottom:8px;resize:vertical;"></textarea>
                    <button class="btn" style="background:linear-gradient(90deg,#0088cc,#006bad);" onclick="broadcastMsg()">üì® –†–∞–∑–æ—Å–ª–∞—Ç—å –≤ TG</button>
                </div>
                <div class="tool-card">
                    <div class="tool-card-title">üéÅ –í—ã–¥–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫ –≤—Å–µ–º</div>
                    <div style="display:flex;gap:8px;">
                        <select id="bcast-gift" style="flex:1;margin:0;height:42px;border-radius:12px;">${catalog ? catalog.map(x=>`<option value="${x.id}">${x.i} ${x.n}</option>`).join('') : ''}</select>
                        <button class="btn" style="background:var(--orange);width:48px;padding:0;height:42px;flex-shrink:0;" onclick="broadcastGift()">üéÅ</button>
                    </div>
                </div>
                <div style="height:1px;background:rgba(255,255,255,0.06);"></div>
                <div class="tool-card">
                    <div class="tool-card-title">üßπ –û—á–∏—Å—Ç–∏—Ç—å</div>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <button class="btn" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);color:var(--secondary);text-align:left;padding:12px 14px;font-size:13px;" onclick="clearAllShowcases()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –≤–∏—Ç—Ä–∏–Ω—ã</button>
                        <button class="btn" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);color:var(--secondary);text-align:left;padding:12px 14px;font-size:13px;" onclick="clearMarket()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Ä—ã–Ω–æ–∫</button>
                    </div>
                </div>
                <div class="danger-zone">
                    <div class="danger-zone-title">‚ö†Ô∏è –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</div>
                    <button class="btn" style="background:rgba(231,76,60,0.1);border:1.5px solid rgba(231,76,60,0.4);color:#ff6b6b;font-weight:bold;text-align:left;padding:12px 14px;font-size:13px;" onclick="resetAndReissue()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏ + —Ä—ã–Ω–æ–∫ –∏ –≤—ã–¥–∞—Ç—å –Ω–æ–≤—ã–µ</button>
                </div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ Sales Log ‚îÄ‚îÄ -->
        <div id="adm-sales" class="adm-section">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;">üõí –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞</div>
                <div style="display:flex;align-items:center;gap:5px;background:rgba(46,204,113,0.08);border:1px solid rgba(46,204,113,0.2);border-radius:10px;padding:4px 10px;">
                    <span style="width:6px;height:6px;border-radius:50%;background:var(--green);display:inline-block;animation:pulse 1.5s infinite;"></span>
                    <span style="font-size:10px;color:var(--green);font-weight:bold;">Live</span>
                </div>
            </div>
            <div id="adm-sales-total" style="margin-bottom:12px;"></div>
            <div id="adm-sales-list"><div style="color:var(--secondary);text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
        </div>

    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="tab('shop',this)"><i>üõçÔ∏è</i><span>–ú–∞–≥–∞–∑–∏–Ω</span></button>
        <button class="nav-btn" onclick="tab('inv',this)"><div id="badge-inv" class="badge">0</div><div id="badge-merge" class="badge-merge">0</div><i>üì¶</i><span>–°–∫–ª–∞–¥</span></button>
        <button class="nav-btn" onclick="tab('market',this)"><i>‚öñÔ∏è</i><span>–†—ã–Ω–æ–∫</span></button>
        <button class="nav-btn" onclick="tab('friends',this)"><div id="badge-fr" class="badge">0</div><i>üë•</i><span>–î—Ä—É–∑—å—è</span></button>
        <button class="nav-btn" id="duel-nav-btn" onclick="openDuelFromNav()" style="position:relative;"><div id="badge-duel" class="badge" style="right:8px;display:none;">0</div><i>‚öîÔ∏è</i><span>–î—É—ç–ª—å</span></button>
        <button class="nav-btn" onclick="tab('profile',this)"><i>üë§</i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
        <button id="adm-nav" class="nav-btn" style="display:none;color:var(--orange)" onclick="tab('admin',this)"><i>‚öôÔ∏è</i><span>–ê–¥–º–∏–Ω</span></button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, push, remove, update, onDisconnect } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const config = {
        apiKey: "AIzaSyDK9IMy-DDNXvPcHv7uAjgZ8ZLdXUh8OCw",
        authDomain: "gift-1292c.firebaseapp.com",
        projectId: "gift-1292c",
        databaseURL: "https://gift-1292c-default-rtdb.firebaseio.com",
        appId: "1:527659513899:web:4023b323982425ad18526e"
    };
    const fb = initializeApp(config);
    const db = getDatabase(fb);
    let user = null, allUsersCache = {};

    const catalog = [
        {id:1, n:"–ü–µ—á–µ–Ω—å–∫–∞", i:"üç™", img:"https://em-content.zobj.net/source/apple/391/cookie_1f36a.png"},
        {id:2, n:"–ö–æ—Ñ–µ",     i:"‚òï", img:"https://em-content.zobj.net/source/apple/391/hot-beverage_2615.png"},
        {id:3, n:"–ü–∏—Ü—Ü–∞",    i:"üçï", img:"https://em-content.zobj.net/source/apple/391/pizza_1f355.png"},
        {id:4, n:"–ë—É—Ä–≥–µ—Ä",   i:"üçî", img:"https://em-content.zobj.net/source/apple/391/hamburger_1f354.png"},
        {id:5, n:"–¢–æ—Ä—Ç",     i:"üéÇ", img:"https://em-content.zobj.net/source/apple/391/birthday-cake_1f382.png"},
        {id:6, n:"–ê—Ä–±—É–∑",    i:"üçâ", img:"https://em-content.zobj.net/source/apple/391/watermelon_1f349.png"},
        {id:7, n:"–ú–∏—à–∫–∞",    i:"üß∏", img:"https://em-content.zobj.net/source/apple/391/teddy-bear_1f9f8.png"},
        {id:8, n:"–†–æ–∑–∞",     i:"üåπ", img:"https://em-content.zobj.net/source/apple/391/rose_1f339.png"},
        {id:9, n:"–ë—É–∫–µ—Ç",    i:"üíê", img:"https://em-content.zobj.net/source/apple/391/bouquet_1f490.png"},
        {id:10,n:"–ì–∏—Ç–∞—Ä–∞",   i:"üé∏", img:"https://em-content.zobj.net/source/apple/391/guitar_1f3b8.png"},
        {id:11,n:"–ö–æ–ª—å—Ü–æ",   i:"üíç", img:"https://em-content.zobj.net/source/apple/391/ring_1f48d.png"},
        {id:12,n:"–ö—Ä–∏—Å—Ç–∞–ª–ª", i:"üíé", img:"https://em-content.zobj.net/source/apple/391/gem-stone_1f48e.png"},
        {id:13,n:"–ö–æ—Ä–æ–Ω–∞",   i:"üëë", img:"https://em-content.zobj.net/source/apple/391/crown_1f451.png"},
        {id:14,n:"–°–ø–æ—Ä—Ç–∫–∞—Ä", i:"üèéÔ∏è",img:"https://em-content.zobj.net/source/apple/391/racing-car_1f3ce-fe0f.png"},
        {id:15,n:"–Ø—Ö—Ç–∞",     i:"üõ•Ô∏è",img:"https://em-content.zobj.net/source/apple/391/motor-boat_1f6e5-fe0f.png"},
        {id:16,n:"–†–∞–∫–µ—Ç–∞",   i:"üöÄ", img:"https://em-content.zobj.net/source/apple/391/rocket_1f680.png"},
        {id:17,n:"–û—Å—Ç—Ä–æ–≤",   i:"üèùÔ∏è",img:"https://em-content.zobj.net/source/apple/391/desert-island_1f3dd-fe0f.png"},
        {id:18,n:"–ö–æ—Ç",      i:"üê±", img:"https://em-content.zobj.net/source/apple/391/cat-face_1f431.png"},
        {id:19,n:"–ü–∞–Ω–¥–∞",    i:"üêº", img:"https://em-content.zobj.net/source/apple/391/panda_1f43c.png"},
        {id:20,n:"–ü–æ–Ω–∏",     i:"üê¥", img:"./img_1.png"},
        {id:21,n:"–ù–µ–∑–µ—Ä–∏—Ç –º–µ—á",  i:"‚öîÔ∏è", img:"./img_2.png"},
        {id:22,n:"–ö–ª–µ–≤–µ—Ä",   i:"üçÄ", img:"https://em-content.zobj.net/source/apple/391/four-leaf-clover_1f340.png"},
        {id:23,n:"–ö—É–±–æ–∫",    i:"üèÜ", img:"https://em-content.zobj.net/source/apple/391/trophy_1f3c6.png"},
        {id:24,n:"–î–∂–æ–π—Å—Ç–∏–∫", i:"üéÆ", img:"https://em-content.zobj.net/source/apple/391/video-game_1f3ae.png"},
        {id:25,n:"–ü–µ–ø–µ",      i:"üê∏", img:"./img_3.png"},
        {id:26,n:"–ö–æ—Å—Ç–∏",    i:"üé≤", img:"https://em-content.zobj.net/source/apple/391/game-die_1f3b2.png"},
        {id:27,n:"–§–∏—à–∫–∏",    i:"ü™ô", img:"https://em-content.zobj.net/source/apple/391/coin_1fa99.png"},
        {id:28,n:"–ó–æ–ª–æ—Ç–æ–π —Å–ª–∏—Ç–æ–∫", i:"üèÖ", img:"./img_4.png"},
        {id:29,n:"–ü–ª–∞–Ω–µ—Ç–∞",  i:"ü™ê", img:"https://em-content.zobj.net/source/apple/391/ringed-planet_1fa90.png"},
        {id:30,n:"–ì–∞–ª–∞–∫—Ç–∏–∫–∞",i:"üåå", img:"https://em-content.zobj.net/source/apple/391/milky-way_1f30c.png"}
    ];

    const COSMETICS = [
        {id:'pfx_star',    type:'prefix', val:'üåü', name:'–ó–≤–µ–∑–¥–∞',     price:500,  unlock:null},
        {id:'pfx_fire',    type:'prefix', val:'üî•', name:'–û–≥–æ–Ω—å',      price:800,  unlock:null},
        {id:'pfx_bolt',    type:'prefix', val:'‚ö°', name:'–ú–æ–ª–Ω–∏—è',     price:800,  unlock:null},
        {id:'pfx_crown',   type:'prefix', val:'üëë', name:'–ö–æ—Ä–æ–Ω–∞',     price:2000, unlock:null},
        {id:'pfx_gem',     type:'prefix', val:'üíé', name:'–ë—Ä–∏–ª–ª–∏–∞–Ω—Ç',  price:3000, unlock:null},
        {id:'pfx_rainbow', type:'prefix', val:'üåà', name:'–†–∞–¥—É–≥–∞',     price:1500, unlock:null},
        {id:'pfx_skull',   type:'prefix', val:'üíÄ', name:'–ß–µ—Ä–µ–ø',      price:1200, unlock:null},
        {id:'pfx_alien',   type:'prefix', val:'üëΩ', name:'–ü—Ä–∏—à–µ–ª–µ—Ü',   price:1000, unlock:null},
        {id:'col_blue',    type:'color',  val:'#5dade2', name:'–°–∏–Ω–∏–π',      price:300,  unlock:null},
        {id:'col_green',   type:'color',  val:'#2ecc71', name:'–ó–µ–ª—ë–Ω—ã–π',    price:300,  unlock:null},
        {id:'col_purple',  type:'color',  val:'#a29bfe', name:'–§–∏–æ–ª–µ—Ç–æ–≤—ã–π', price:500,  unlock:null},
        {id:'col_orange',  type:'color',  val:'#f39c12', name:'–û—Ä–∞–Ω–∂–µ–≤—ã–π',  price:500,  unlock:null},
        {id:'col_pink',    type:'color',  val:'#fd79a8', name:'–†–æ–∑–æ–≤—ã–π',    price:700,  unlock:null},
        {id:'col_gold',    type:'color',  val:'#ffd700', name:'–ó–æ–ª–æ—Ç–æ–π',    price:2500, unlock:null},
        {id:'col_red',     type:'color',  val:'#e74c3c', name:'–ö—Ä–∞—Å–Ω—ã–π',    price:700,  unlock:null},
        {id:'bdg_rich',    type:'badge',  val:'üí∏', name:'–ë–æ–≥–∞—á',       price:0, unlock:'spent10k',  unlockDesc:'–ü–æ—Ç—Ä–∞—Ç—å 10 000 –º–æ–Ω–µ—Ç'},
        {id:'bdg_social',  type:'badge',  val:'ü§ù', name:'–ü–æ–ø—É–ª—è—Ä–Ω—ã–π',  price:0, unlock:'friends10', unlockDesc:'–î–æ–±–∞–≤—å 10 –¥—Ä—É–∑–µ–π'},
        {id:'bdg_gifter',  type:'badge',  val:'üéÅ', name:'–î–∞—Ä–∏—Ç–µ–ª—å',    price:0, unlock:'gifts10',   unlockDesc:'–ü–æ–¥–∞—Ä–∏ 10 –ø–æ–¥–∞—Ä–∫–æ–≤'},
        {id:'bdg_duelist', type:'badge',  val:'‚öîÔ∏è', name:'–î—É—ç–ª—è–Ω—Ç',     price:0, unlock:'duel10',    unlockDesc:'–ü–æ–±–µ–¥–∏ –≤ 10 –¥—É—ç–ª—è—Ö'},
        {id:'bdg_og',      type:'badge',  val:'‚≠ê', name:'OG',          price:5000, unlock:null},
        {id:'bdg_vip',     type:'badge',  val:'üíú', name:'VIP',         price:8000, unlock:null},
    ];

    const ADMIN_IDS = new Set(['ckovoroda','kukumbr']);
    const MOD_IDS = new Set(['batlukov','nowkie']);
    const MOD_PREFIXES = { batlukov: 'üé® –•—É–¥–æ–∂–Ω–∏–∫', nowkie: 'üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫' };

    function buildUsername(d, uid) {
        const resolvedId = uid || (typeof d.username === 'string' ? d.username.toLowerCase() : '');
        const isAdmin = ADMIN_IDS.has(resolvedId);
        const active = d.activeCosmetic || {};
        const pfx = active.prefix ? COSMETICS.find(c=>c.id===active.prefix) : null;
        const col = active.color  ? COSMETICS.find(c=>c.id===active.color)  : null;
        const bdg = active.badge  ? COSMETICS.find(c=>c.id===active.badge)  : null;

        // Admin gets rainbow "ADMIN" prefix instead of regular prefix
        const isMod = MOD_IDS.has(resolvedId);
        const prefix = isAdmin
            ? `<span class="admin-rainbow-prefix">ADMIN</span>`
            : isMod
            ? `<span style="background:rgba(162,155,254,0.18);color:#a29bfe;font-size:10px;padding:2px 7px;border-radius:8px;font-weight:bold;margin-right:3px;">${MOD_PREFIXES[resolvedId]||'MOD'}</span>`
            : (pfx ? `<span class="cosm-prefix">${pfx.val}</span>` : '');

        const badge  = bdg ? `<span class="cosm-badge" style="background:rgba(255,255,255,0.08);">${bdg.val} ${bdg.name}</span>` : '';
        // Shimmer class –ø–æ id —Ü–≤–µ—Ç–∞
        const shimmerMap = {
            'col_blue':   'shimmer-blue',
            'col_green':  'shimmer-green',
            'col_purple': 'shimmer-purple',
            'col_orange': 'shimmer-orange',
            'col_pink':   'shimmer-pink',
            'col_gold':   'shimmer-gold',
            'col_red':    'shimmer-red',
        };
        let nameEl;
        if (isAdmin) {
            nameEl = `<span class="name-shimmer shimmer-green">@${d.username}</span>`;
        } else if (isMod) {
            nameEl = `<span class="name-shimmer shimmer-purple">@${d.username}</span>`;
        } else if (col && shimmerMap[col.id]) {
            nameEl = `<span class="name-shimmer ${shimmerMap[col.id]}">@${d.username}</span>`;
        } else if (col) {
            nameEl = `<span style="color:${col.val};">@${d.username}</span>`;
        } else {
            nameEl = `<span>@${d.username}</span>`;
        }

        // Lizard badge ‚Äî shown if user owns NFT_LIZARD (id 997)
        const hasLizard = (d.cloudInv||[]).some(x => x.id === 997);
        const lizard = hasLizard ? `<span class="lizard-badge">ü¶é</span>` : '';

        return `${prefix}${nameEl}${badge}${lizard}`;
    }

    function checkUnlocks(d) {
        const owned = new Set(d.cosmetics || []);
        const unlocked = [];
        const spent = d.totalSpent || 0;
        const friendCount = Object.keys(d.friends || {}).length;
        const giftsGiven = d.giftsGiven || 0;
        if(spent >= 10000 && !owned.has('bdg_rich')) unlocked.push('bdg_rich');
        if(friendCount >= 10 && !owned.has('bdg_social')) unlocked.push('bdg_social');
        if(giftsGiven >= 10 && !owned.has('bdg_gifter')) unlocked.push('bdg_gifter');
        if((d.duelWins||0) >= 10 && !owned.has('bdg_duelist')) unlocked.push('bdg_duelist');
        return unlocked;
    }


        function giftImg(x, size='normal') {
        const isPony = (x && x.id == 20);
        const cls = size === 'sm' ? 'gift-img-sm' : 'gift-img';
        const fs = size === 'sm' ? '30' : '46';
        // –ò—â–µ–º –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –ø–æ id ‚Äî —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∏ —á–∏—Å–ª–∞ –∏ —Å—Ç—Ä–æ–∫–∏
        const xid = x && (x.id !== undefined && x.id !== null) ? x.id : null;
        const cat = xid !== null ? catalog.find(c => c.id == xid) : null;
        const img = (x&&x.imgKey==='pan'?PAN_IMG:null) || (x && x.img) || (cat && cat.img) || null;
        const emoji = (x && x.i) || (cat && cat.i) || 'üéÅ';
        if(size !== 'sm') {
                const inner = img
                ? `<img src="${img}" class="${cls}${isPony?' gift-img-pony':''}" alt="${(x&&x.n)||''}" onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'${emoji}',style:'font-size:${fs}px;display:block;text-align:center;'}))">`
                : `<span style="font-size:${fs}px;display:block;text-align:center;">${emoji}</span>`;
            return `<div class="gift-img-wrap">${inner}</div>`;
        }
        if(img) return `<img src="${img}" class="${cls}" alt="${(x&&x.n)||''}" onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'${emoji}',style:'font-size:${fs}px;display:block;text-align:center;margin-bottom:8px;'}))">`;
        return `<span style="font-size:${fs}px;display:block;text-align:center;margin-bottom:8px;">${emoji}</span>`;
    }

    // Fill broadcast gift select
    document.getElementById('bcast-gift').innerHTML = catalog.map(x=>`<option value="${x.id}">${x.i} ${x.n}</option>`).join('');
    // Fill promo gift select with catalog items
    const promoGiftSel = document.getElementById('promo-gift-in');
    if(promoGiftSel) {
        catalog.forEach(x=>{
            const opt = document.createElement('option');
            opt.value = x.id;
            opt.textContent = `${x.i} ${x.n}`;
            promoGiftSel.appendChild(opt);
        });
    }

    async function getIP() { try { const r = await fetch('https://api.ipify.org?format=json'); return (await r.json()).ip; } catch(e) { return "1.1.1.1"; } }
    function getPrice(id, ts=0) { const now = Date.now()+ts; const val = Math.abs(Math.sin(id*777 + Math.floor(now/900000)*888)); return Math.floor(val*1532+67); }
    function flyEmoji(emoji, x, y) {
        const el = document.createElement('div'); el.className='fly-emoji'; el.innerText=emoji;
        el.style.left=(x-18)+'px'; el.style.top=(y-18)+'px';
        document.body.appendChild(el); setTimeout(()=>el.remove(),1000);
    }
    // Detect low-end device (less than 4 logical cores or slow connection)
    const isLowEndDevice = (navigator.hardwareConcurrency || 4) <= 2;
    function spawnConfetti(x, y, count=22) {
        if(isLowEndDevice) count = Math.min(count, 10);
        const colors=['#ffd700','#ff6b6b','#4ecdc4','#45b7d1','#96ceb4','#ff9f43','#a29bfe','#fd79a8'];
        for(let i=0;i<count;i++){
            const el=document.createElement('div'); el.className='confetti-piece';
            el.style.left=(x+(Math.random()-.5)*60)+'px'; el.style.top=(y-10)+'px';
            el.style.background=colors[Math.floor(Math.random()*colors.length)];
            el.style.borderRadius=Math.random()>.5?'50%':'2px';
            el.style.width=(6+Math.random()*8)+'px'; el.style.height=(6+Math.random()*8)+'px';
            el.style.animationDuration=(0.9+Math.random()*0.8)+'s';
            el.style.animationDelay=(Math.random()*0.2)+'s';
            document.body.appendChild(el); setTimeout(()=>el.remove(),2000);
        }
    }
    function flashBalance() {
        const el=document.getElementById('u-bal');
        el.classList.remove('balance-flash'); void el.offsetWidth; el.classList.add('balance-flash');
        setTimeout(()=>el.classList.remove('balance-flash'),700);
    }
    window.showToast = (msg, color='var(--accent)', icon='') => {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        el.className = 'toast-item';
        // Determine icon and border color based on color
        let ico = icon;
        let borderColor = color;
        if (!ico) {
            if (color.includes('green') || color === '#2ecc71') ico = '‚úÖ';
            else if (color.includes('err') || color === '#e74c3c') ico = '‚ùå';
            else if (color === 'gold') ico = '‚≠ê';
            else if (color.includes('orange') || color === '#f39c12') ico = '‚ö†Ô∏è';
            else ico = 'üí¨';
        }
        el.style.borderLeftColor = borderColor;
        el.innerHTML = `<span style="font-size:18px;flex-shrink:0;">${ico}</span><span>${msg}</span>`;
        container.appendChild(el);
        // Force reflow then animate in
        requestAnimationFrame(() => { requestAnimationFrame(() => el.classList.add('show')); });
        setTimeout(() => {
            el.classList.remove('show');
            el.classList.add('hide');
            setTimeout(() => el.remove(), 400);
        }, 2800);
    };

    // Beautiful confirm dialog
    let confirmResolver = null;
    window.showConfirm = (title, msg, icon='‚ùì', okColor='var(--err)', okText='–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å') => {
        return new Promise(resolve => {
            confirmResolver = resolve;
            document.getElementById('confirm-icon').innerText = icon;
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = msg;
            document.getElementById('confirm-ok').style.background = okColor;
            document.getElementById('confirm-ok').innerText = okText;
            const ov = document.getElementById('confirm-overlay');
            ov.style.display = 'flex';
            requestAnimationFrame(() => ov.style.background = 'rgba(0,0,0,0.88)');
        });
    };
    window.resolveConfirm = (val) => {
        const ov = document.getElementById('confirm-overlay');
        ov.style.background = 'rgba(0,0,0,0)';
        setTimeout(() => { ov.style.display = 'none'; }, 300);
        if (confirmResolver) { confirmResolver(val); confirmResolver = null; }
    };

    window.closeModal = () => {
        const ov = document.getElementById('modal-overlay');
        ov.style.background = 'rgba(0,0,0,0)';
        setTimeout(() => { ov.style.display = 'none'; }, 300);
    };
    function openModal() {
        const ov = document.getElementById('modal-overlay');
        ov.style.display = 'flex';
        requestAnimationFrame(() => ov.style.background = 'rgba(0,0,0,0.88)');
    }
    window.switchAuthTab = (tab) => {
        const isLogin = tab === 'login';
        document.getElementById('form-login').classList.toggle('active', isLogin);
        document.getElementById('form-reg').classList.toggle('active', !isLogin);
        document.getElementById('tab-login').classList.toggle('active', isLogin);
        document.getElementById('tab-login').classList.remove('green');
        document.getElementById('tab-reg').classList.toggle('active', !isLogin);
        if(!isLogin) document.getElementById('tab-reg').classList.add('green');
        // clear errors
        document.getElementById('l-err').innerText='';
        document.getElementById('r-err').innerText='';
    };
    window.clearAuthErr = (id) => { const el=document.getElementById(id); if(el) el.innerText=''; };

    let checkUsernameTimer = null;
    window.checkUsername = (val) => {
        clearAuthErr('r-err');
        const st = document.getElementById('r-user-status');
        const v = val.trim().toLowerCase();
        if(!v) { st.innerText=''; return; }
        if(v.length < 3) { st.innerText='‚ö†Ô∏è'; return; }
        clearTimeout(checkUsernameTimer);
        st.innerText='‚è≥';
        checkUsernameTimer = setTimeout(async () => {
            const s = await get(ref(db,'users/'+v));
            st.innerText = s.exists() ? '‚ùå' : '‚úÖ';
        }, 500);
    };
    window.auth = async (type) => {
        if(type==='login') {
            const u=document.getElementById('l-user').value.trim().toLowerCase();
            const p=document.getElementById('l-pass').value.trim();
            const errEl=document.getElementById('l-err');
            if(!u||!p){ errEl.innerText='–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è'; return; }
            const s=await get(ref(db,'users/'+u));
            if(s.exists()&&s.val().password==p){ loginOk(s.val().username,u); }
            else { errEl.innerText='‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'; document.getElementById('l-pass').value=''; }
        } else {
            const u=document.getElementById('r-user').value.trim().toLowerCase();
            const p=document.getElementById('r-pass').value.trim();
            const errEl=document.getElementById('r-err');
            if(!u||!p){ errEl.innerText='–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è'; return; }
            if(u.length<3){ errEl.innerText='‚ùå –õ–æ–≥–∏–Ω –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞'; return; }
            if(p.length<4){ errEl.innerText='‚ùå –ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞'; return; }
            const ip=await getIP(), ipKey=ip.replace(/\./g,'_'), r=ref(db,'users/'+u), s=await get(r);
            if(s.exists()){ errEl.innerText='‚ùå –≠—Ç–æ—Ç –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç'; return; }
            const ipsS=await get(ref(db,'ips/'+ipKey));
            if(ipsS.exists()&&Object.keys(ipsS.val()).length>=3){ errEl.innerText='‚ùå –° —ç—Ç–æ–≥–æ IP —É–∂–µ 3 –∞–∫–∫–∞—É–Ω—Ç–∞'; return; }
            await set(r,{username:u,password:p,balance:1000,cloudInv:[],pinnedInsts:[],pic:"",bio:"",ip});
            await update(ref(db,`ips/${ipKey}`),{[u]:true});
            spawnConfetti(window.innerWidth/2, window.innerHeight/2, 30);
            loginOk(u,u);
        }
    };

    function loginOk(name,id){localStorage.setItem('gifts_user',JSON.stringify({name,id}));startApp(name,id);}

    async function giveNftToCkovoroda() {
        // NFT –ø—Ä–∏ –≤—Ö–æ–¥–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã
    }

    function startApp(name,id) {
        user={name,id,isAdm:(id==='ckovoroda'||id==='kukumbr'),isMod:MOD_IDS.has(id)};
        document.getElementById('auth-screen').style.display='none'; document.getElementById('auth-screen').style.minHeight='0';
        document.getElementById('app').style.display='block';
        if(user.isAdm){document.getElementById('adm-nav').style.display='flex';initAdmin();}
        // –í—ã–¥–∞—Ç—å NFT –°–∫–æ–≤–æ—Ä–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ckovoroda (–æ–¥–∏–Ω —Ä–∞–∑)
        if(id==='ckovoroda'){
            (async()=>{
                const _r=ref(db,'users/ckovoroda'),_s=await get(_r),_d=_s.val();
                const _inv=(_d&&_d.cloudInv)||[];
                if(!_inv.some(x=>x.id===996&&x.nft)){
                    const _serial=await getNextNftSerial();
                    const _p={...NFT_PAN};delete _p.img;_inv.push({..._p,inst:Date.now(),seen:false,nftSerial:_serial,from:'üéÅ –ü–æ–¥–∞—Ä–æ–∫'});
                    await update(_r,{cloudInv:_inv});
                }
            })();
        }
        else if(user.isMod){document.getElementById('adm-nav').style.display='flex';initAdminMod();}

        // === PRESENCE (–æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å) ===
        const presenceRef = ref(db, 'presence/' + id);
        const connectedRef = ref(db, '.info/connected');
        onValue(connectedRef, snap => {
            if (snap.val() === true) {
                set(presenceRef, { online: true, lastSeen: Date.now() });
                onDisconnect(presenceRef).set({ online: false, lastSeen: Date.now() });
            }
        });

        onValue(ref(db,'users/'+id),s=>{
            const d=s.val(); if(!d) return;
            document.getElementById('header-name').innerHTML=buildUsername(d);
            document.getElementById('u-bal').innerText=d.balance;
            renderFriends(d); renderMyProfile(d);
            // üî¥ Unseen gifts badge
            const inv=d.cloudInv||[];
            const unseen=inv.filter(x=>!x.seen).length;
            const bInv=document.getElementById('badge-inv');
            bInv.innerText=unseen; bInv.style.display=unseen>0?'flex':'none';
            // üü£ Merge badge
            const mergeCount=getMergeable(inv).length;
            const bMerge=document.getElementById('badge-merge');
            bMerge.innerText=mergeCount; bMerge.style.display=mergeCount>0?'flex':'none';
        });
        renderShop(); listenMarket(); giveNftToCkovoroda(); listenTradeOffers(); listenDuelChallenges();
        // Auto-refresh shop prices every 15 seconds (live prices)
        setInterval(()=>{
            const shopCards = document.getElementById('shop-cards');
            if(shopCards && document.getElementById('shop').classList.contains('active')) {
                renderShopCards();
            }
        }, 15000);
        // Shop timer countdown (prices change every 15 minutes = 900000ms)
        setInterval(()=>{
            const timerEl = document.getElementById('shop-timer');
            if(!timerEl) return;
            const now = Date.now();
            const msLeft = 900000 - (now % 900000);
            const m = Math.floor(msLeft/60000);
            const s = Math.floor((msLeft%60000)/1000);
            timerEl.textContent = `${m}–º ${s < 10 ? '0'+s : s}—Å`;
        }, isLowEndDevice ? 5000 : 1000);
    }


    window.usePromo = async () => {
        const code = document.getElementById('promo-input')?.value?.trim().toUpperCase();
        if(!code) return showToast("–í–≤–µ–¥–∏ –ø—Ä–æ–º–æ–∫–æ–¥!",'var(--err)');
        const ps = await get(ref(db,'promos/'+code));
        if(!ps.exists()) return showToast("–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω!",'var(--err)');
        const promo = ps.val();
        if(promo.usedBy && promo.usedBy[user.id]) return showToast("–£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!",'var(--err)');
        if(promo.maxUses && (promo.useCount||0) >= promo.maxUses) return showToast("–ü—Ä–æ–º–æ–∫–æ–¥ –∏—Å—á–µ—Ä–ø–∞–Ω!",'var(--err)');
        const r=ref(db,'users/'+user.id), us=await get(r);
        const updates = { balance: us.val().balance + (promo.reward||0) };
        // Support new giftObj (full item) and legacy gift (emoji string)
        if(promo.giftObj) {
            const inv = us.val().cloudInv||[];
            const serial = await getNextNftSerial();
            const _g={...promo.giftObj};if(_g.img&&_g.img.startsWith('data:'))delete _g.img;inv.push({..._g, inst:Date.now(), from:"PROMO", seen:false, nftSerial:serial});
            updates.cloudInv = inv;
        } else if(promo.gift) {
            const itm = catalog.find(x=>x.i===promo.gift)||{id:0,n:"–ü–æ–¥–∞—Ä–æ–∫",i:promo.gift};
            const inv = us.val().cloudInv||[];
            inv.push({...itm, inst:Date.now(), from:"PROMO", seen:false});
            updates.cloudInv = inv;
        }
        await update(r, updates);
        await update(ref(db,'promos/'+code), {
            useCount: (promo.useCount||0)+1,
            [`usedBy/${user.id}`]: true
        });
        spawnConfetti(window.innerWidth/2, window.innerHeight/2, 30);
        flashBalance();
        const giftMsg = (promo.giftObj ? ` + üéÅ ${promo.giftObj.n}` : (promo.gift ? ` + ${promo.gift}` : ''));
        showToast(`üéâ –ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! +${promo.reward||0}üí∞${giftMsg}`,'var(--green)');
        logActivity('promo', {user: user.name, userId: user.id, code, reward: promo.reward||0, gift: promo.giftObj?.n || promo.gift || null});
        closeModal();
    };
    window.togglePin = async (inst) => {
        const r=ref(db,'users/'+user.id),s=await get(r),d=s.val();
        const cloudInv=d.cloudInv||[];
        let pinnedInsts=(d.pinnedInsts||[]).filter(id=>cloudInv.some(x=>String(x.inst)==String(id)));
        const isP=pinnedInsts.some(id=>String(id)==String(inst));
        if(isP){pinnedInsts=pinnedInsts.filter(id=>String(id)!=String(inst));showToast("–°–Ω—è—Ç–æ","var(--secondary)");}
        else{
            if(pinnedInsts.length>=5)return showToast("–ú–∞–∫—Å. 5 –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ!",'var(--err)');
            if(!cloudInv.find(x=>String(x.inst)==String(inst)))return showToast("–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω",'var(--err)');
            pinnedInsts.push(String(inst));showToast("üìå –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ!",'var(--orange)');
        }
        await update(r,{pinnedInsts});
        const fresh=await get(r); if(fresh.exists()) { renderMyProfile(fresh.val()); renderInv(); }
    };

    window.sellItem = async (inst, reward) => {
        const r = ref(db, 'users/' + user.id);
        const s = await get(r), d = s.val();
        const inv = d.cloudInv || [];
        const item = inv.find(x => String(x.inst) === String(inst));
        if (!item) return showToast('–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'var(--err)');
        const ok = await showConfirm(
            '–ü—Ä–æ–¥–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç',
            `"${item.n}" –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è. –¢—ã –ø–æ–ª—É—á–∏—à—å ${reward.toLocaleString()} –º–æ–Ω–µ—Ç (50% —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω—ã).`,
            'üóëÔ∏è', 'var(--err)', '–ü—Ä–æ–¥–∞—Ç—å'
        );
        if (!ok) return;
        const newInv = inv.filter(x => String(x.inst) !== String(inst));
        const newBalance = (d.balance || 0) + reward;
        await update(r, { cloudInv: newInv, balance: newBalance });
        showToast(`üóëÔ∏è –ü—Ä–æ–¥–∞–Ω–æ! +${reward.toLocaleString()} üí∞`, 'var(--green)');
        logActivity('sell_item', {user: user.name, userId: user.id, item: item.n, emoji: item.i||'üéÅ', reward});
        renderInv();
    };

        window.renderInv = async () => {
        const s=await get(ref(db,'users/'+user.id)),d=s.val(),inv=d.cloudInv||[];
        const upd=inv.map(x=>({...x,seen:true}));
        await update(ref(db,'users/'+user.id),{cloudInv:upd});
        
        const searchVal = document.getElementById('inv-search')?.value?.toLowerCase() || '';
        const filtered = searchVal ? upd.filter(x=>x.n.toLowerCase().includes(searchVal)) : upd;
        
        const pinnedInsts2 = new Set((d.pinnedInsts||[]).map(String));
        const sortedFiltered = [
            ...filtered.filter(x => pinnedInsts2.has(String(x.inst))),
            ...filtered.filter(x => !pinnedInsts2.has(String(x.inst)))
        ];
        // Use new rarity system
        const mergeableIds = new Set(getMergeable(upd).map(g => `${g.items[0].id}_${getRarityLevel(g.items[0])}`));

        const cardsHtml = sortedFiltered.length ? sortedFiltered.map(x=>{
            const isNFT = !!x.nft;
            const isPinned2 = pinnedInsts2.has(String(x.inst));
            const rarObj = getRarityObj(x);
            const rarLevel = getRarityLevel(x);
            const isMergeReady = mergeableIds.has(`${x.id}_${rarLevel}`) && !isNFT;

            // Card style based on rarity
            let cardExtraClass = rarObj.cardCls;
            let cardStyle = '';
            if(isPinned2 && !isNFT && rarLevel===0) cardStyle = 'border:1.5px solid rgba(243,156,18,0.5);box-shadow:0 2px 12px rgba(243,156,18,0.15);';

            const rarHtml = isNFT
                ? `<span class="rarity-nft" style="font-size:10px;margin-bottom:4px;display:block;">‚ú¶ NFT ‚Äî –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π</span>`
                : `<span class="${rarObj.cls}" style="margin-bottom:4px;display:block;">${rarObj.icon} ${rarObj.label}</span>`;

            const pinBadge = isPinned2 ? `<div style="position:absolute;top:6px;left:7px;font-size:13px;filter:drop-shadow(0 1px 3px rgba(0,0,0,0.7));z-index:4;">üìå</div>` : '';
            const nftBadge = isNFT ? `<div style="position:absolute;top:7px;right:7px;background:linear-gradient(90deg,#b8860b,#ffd700);color:#000;font-size:9px;font-weight:bold;border-radius:10px;padding:2px 7px;z-index:4;">NFT</div>` : '';
            const nameStyle = isNFT ? 'background:linear-gradient(90deg,#ffd700,#ffb347,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:bold;' : '';
            const serialNum = x.nftSerial ? `‚Ññ${x.nftSerial}` : (x.inst ? `#${String(x.inst).slice(-6)}` : '');
            const serialBadge = serialNum ? `<div class="nft-id-badge${isNFT?' nft':''}${x.nftSerial?'':' common-id'}">${serialNum}</div>` : '';
            const mergeBadge = isMergeReady ? `<div class="merge-count-badge ready" title="–ú–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å!">‚öóÔ∏è</div>` : '';

            const sellPrice = isNFT ? (x.id===997?7000:x.id===998?10000:x.id===999?5000:(x.price||0)) : getPrice(x.id||0);
            const sellReward = Math.floor(sellPrice / 2);
            return `<div class="card ${cardExtraClass}${isMergeReady?' merge-ready':''}" style="display:flex;flex-direction:column;align-items:center;position:relative;${cardStyle}">
                ${pinBadge}${nftBadge}${mergeBadge}${serialBadge}
                <button class="sell-btn" onclick="sellItem('${x.inst}',${sellReward})" title="–ü—Ä–æ–¥–∞—Ç—å –∑–∞ ${sellReward} –º–æ–Ω–µ—Ç">üóëÔ∏è</button>
                ${x.from?`<small style="color:var(--orange);margin-bottom:4px;">–û—Ç: ${x.from}</small>`:''}
                ${giftImg(x)}
                <b style="display:block;text-align:center;margin-bottom:2px;${nameStyle}">${x.n}</b>
                ${rarHtml}
                <button class="btn" style="font-size:11px;background:var(--green)" onclick="giftOpen('${x.inst}')">üéÅ –ü–æ–¥–∞—Ä–∏—Ç—å</button>
                <button class="btn" style="margin-top:5px;font-size:11px;background:var(--accent)" onclick="toMarket('${x.inst}')">‚öñÔ∏è –†—ã–Ω–æ–∫</button>
                ${isMergeReady?`<button class="btn merge-btn" style="margin-top:5px;" onclick="openMergeModal()">‚öóÔ∏è –°–ª–∏—è–Ω–∏–µ!</button>`:''}
                <button class="btn" style="margin-top:5px;font-size:11px;background:${isPinned2?'var(--secondary)':'var(--orange)'}" onclick="togglePin('${x.inst}')">${isPinned2?'üìå –°–Ω—è—Ç—å':'üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å'}</button>
            </div>`;
        }).join('') : `<div style="grid-column:1/-1;text-align:center;color:var(--secondary);padding:30px;">${searchVal?'–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üîç':'–°–∫–ª–∞–¥ –ø—É—Å—Ç'}</div>`;

        const mergeableCount = getMergeable(upd).length;
        const mergeBannerHtml = mergeableCount > 0 ? `
            <div style="grid-column:1/-1;background:linear-gradient(135deg,#120d2e,#1a0e3a);border:1.5px solid rgba(162,155,254,0.45);border-radius:18px;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:5px;">
                <div>
                    <div style="font-weight:bold;color:#a29bfe;font-size:14px;">‚öóÔ∏è –î–æ—Å—Ç—É–ø–Ω–æ —Å–ª–∏—è–Ω–∏–µ!</div>
                    <div style="font-size:12px;color:var(--secondary);margin-top:2px;">${mergeableCount} –≥—Ä—É–ø–ø –≥–æ—Ç–æ–≤–æ –∫ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é</div>
                </div>
                <button class="btn merge-btn" style="width:auto;padding:10px 16px;" onclick="openMergeModal()">‚öóÔ∏è –°–ª–∏—Ç—å</button>
            </div>` : '';

        document.getElementById('inv').innerHTML = `
            <div class="search-filter-bar">
                <input type="text" id="inv-search" placeholder="üîç –ü–æ–∏—Å–∫ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ..." oninput="renderInv()" value="${searchVal}">
                <span style="color:var(--secondary);font-size:12px;white-space:nowrap;align-self:center;">${upd.length} –ø—Ä–µ–¥.</span>
            </div>
            ${mergeBannerHtml}
            ${cardsHtml}
        `;
    };


    const NFT_BEER={id:998,n:"–ö—Ä—É–∂–∫–∞ –ü–∏–≤–∞",i:"üç∫",img:"https://em-content.zobj.net/source/apple/391/beer-mug_1f37a.png",nft:true,price:10000};
    const NFT_SOCK={id:999,n:"–ù–æ—Å–æ–∫",i:"üß¶",img:"https://em-content.zobj.net/source/apple/391/socks_1f9e6.png",nft:true,price:5000};
    const NFT_LIZARD={id:997,n:"–Ø—â–µ—Ä–∏—Ü–∞",i:"ü¶é",img:"https://em-content.zobj.net/source/apple/391/lizard_1f98e.png",nft:true,price:7000};
    const NFT_PAN={id:996,n:"–°–∫–æ–≤–æ—Ä–æ–¥–∞",i:"üç≥",imgKey:"pan",nft:true,price:5000};
    const PAN_IMG="./img_5.png";
    // NFT_23FEB deprecated - using NFT_BEER and NFT_SOCK separately

    // ===== RARITY SYSTEM =====
    const RARITY_LEVELS = [
        {id:0, label:"–û–±—ã—á–Ω—ã–π",     cls:"rarity-common",    cardCls:"",              icon:"‚¨ú"},
        {id:1, label:"–†–µ–¥–∫–∏–π",      cls:"rarity-rare",      cardCls:"card-rare",     icon:"üîµ"},
        {id:2, label:"–≠–ø–∏—á–µ—Å–∫–∏–π",   cls:"rarity-epic",      cardCls:"card-epic",     icon:"üü£"},
        {id:3, label:"–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π", cls:"rarity-legendary", cardCls:"card-legendary",icon:"üü°"},
        {id:4, label:"NFT",         cls:"rarity-nft",       cardCls:"nft-card",      icon:"‚ú¶"},
    ];
    function getRarityLevel(item) { if(item.nft) return 4; return item.rarity||0; }
    function getRarityObj(item) { return RARITY_LEVELS[getRarityLevel(item)]||RARITY_LEVELS[0]; }

    async function getNextNftSerial() {
        const r=ref(db,"nft_counter"),snap=await get(r),next=(snap.val()||1000)+1;
        await set(r,next); return next;
    }

    function getMergeable(inv) {
        const groups={};
        inv.forEach(item=>{
            if(!item.id) return;
            const rarity=getRarityLevel(item);
            if(rarity>=4) return;
            const key=`${item.id}_${rarity}`;
            if(!groups[key]) groups[key]=[];
            groups[key].push(item);
        });
        return Object.entries(groups).filter(([,items])=>items.length>=3).map(([key,items])=>({key,items,count:items.length}));
    }

    window.openMergeModal = async () => {
        const s=await get(ref(db,"users/"+user.id)),d=s.val(),inv=d.cloudInv||[];
        const groups=getMergeable(inv);
        if(!groups.length){showToast("–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –¥–ª—è —Å–ª–∏—è–Ω–∏—è! –ù—É–∂–Ω–æ 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö.","var(--secondary)");return;}
        const html=groups.map(g=>{
            const item=g.items[0],cat=catalog.find(c=>c.id==item.id);
            const img=(item.imgKey==='pan'?PAN_IMG:null)||item.img||(cat&&cat.img),emoji=item.i||(cat&&cat.i)||"üéÅ";
            const currentRar=getRarityObj(item),nextRar=RARITY_LEVELS[Math.min(getRarityLevel(item)+1,4)];
            const sets=Math.floor(g.count/3);
            return `<div style="background:#120d2e;border:1.5px solid rgba(162,155,254,0.35);border-radius:18px;padding:14px;margin-bottom:12px;display:flex;align-items:center;gap:14px;">
                <div style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;flex-shrink:0;background:rgba(255,255,255,0.05);border-radius:14px;">
                    ${img?`<img src="${img}" style="width:50px;height:50px;object-fit:contain;">`:`<span style="font-size:34px;">${emoji}</span>`}
                </div>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:bold;font-size:13px;margin-bottom:3px;">${item.n}</div>
                    <div style="font-size:11px;margin-bottom:6px;"><span class="${currentRar.cls}">${currentRar.icon} ${currentRar.label}</span><span style="color:#a29bfe;margin:0 5px;">‚Üí</span><span class="${nextRar.cls}">${nextRar.icon} ${nextRar.label}</span></div>
                    <div style="font-size:11px;color:var(--secondary);">–£ —Ç–µ–±—è: ${g.count} —à—Ç. ¬∑ –ú–æ–∂–Ω–æ: ${sets}√ó</div>
                </div>
                <button class="btn merge-btn" style="width:auto;padding:9px 12px;font-size:12px;flex-shrink:0;" onclick="doMerge(${item.id},${getRarityLevel(item)})">‚öóÔ∏è –°–ª–∏—Ç—å 3</button>
            </div>`;
        }).join("");
        document.getElementById("modal-content").innerHTML=`
            <h3 style="color:#a29bfe;margin-bottom:4px;">‚öóÔ∏è –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–æ–≤</h3>
            <p style="color:var(--secondary);font-size:12px;margin:0 0 14px;">–û–±—ä–µ–¥–∏–Ω–∏ 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö ‚Üí –ø–æ–ª—É—á–∏ –±–æ–ª–µ–µ —Ä–µ–¥–∫–∏–π!</p>
            <div style="background:#0d0a1a;border-radius:14px;padding:10px;margin-bottom:14px;font-size:11px;color:var(--secondary);">‚¨ú –û–±—ã—á–Ω—ã–π ‚Üí üîµ –†–µ–¥–∫–∏–π ‚Üí üü£ –≠–ø–∏—á–µ—Å–∫–∏–π ‚Üí üü° –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π ‚Üí ‚ú¶ NFT</div>
            ${html}
            <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);margin-top:5px;" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>`;
        openModal();
    };

    window.doMerge = async (itemId, currentRarity) => {
        const r=ref(db,"users/"+user.id),s=await get(r),d=s.val();
        let inv=d.cloudInv||[];
        const matching=inv.filter(x=>x.id==itemId&&getRarityLevel(x)===currentRarity);
        if(matching.length<3) return showToast("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö!","var(--err)");
        const toRemove=matching.slice(0,3).map(x=>x.inst);
        inv=inv.filter(x=>!toRemove.includes(x.inst));
        const baseItem={...matching[0]},newRarity=Math.min(currentRarity+1,4);
        const rarObj=RARITY_LEVELS[newRarity],newSerial=await getNextNftSerial();
        const isNewNft=newRarity>=4;
        const upgradedItem={...baseItem,rarity:newRarity,nftSerial:newSerial,inst:Date.now(),seen:true,from:"‚öóÔ∏è –°–ª–∏—è–Ω–∏–µ"};
        if(isNewNft){upgradedItem.nft=true;delete upgradedItem.rarity;}
        inv.push(upgradedItem);
        await update(r,{cloudInv:inv, totalMerges:(d.totalMerges||0)+1});
        const newRarObj2=RARITY_LEVELS[newRarity]||RARITY_LEVELS[0];
        getTgId(user.id).then(cid=>sendTg(cid,`‚öóÔ∏è <b>–°–ª–∏—è–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</b>\n\n${newRarObj2.icon} <b>${baseItem.n}</b>\n‚¨ÜÔ∏è –†–µ–¥–∫–æ—Å—Ç—å: <b>${newRarObj2.label}</b>\n\nüéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å —É–ª—É—á—à–µ–Ω–∏–µ–º!`));
        spawnConfetti(window.innerWidth/2,window.innerHeight/2,60);
        flyEmoji(rarObj.icon,window.innerWidth/2,window.innerHeight/2);
        showToast(`${rarObj.icon} –°–ª–∏—è–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ! –ü–æ–ª—É—á–µ–Ω ${rarObj.label}!`,"#a29bfe");
        closeModal(); renderInv(); openMergeModal();
    };
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ‚ö° NFT UPGRADE SYSTEM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const NFT_UPGRADE_LEVELS = [
        null, // 0 ‚Äî no upgrade
        {
            level: 1, name: '–§–æ–Ω', icon: 'üé®', cost: 100,
            description: '–ú–µ–Ω—è–µ—Ç —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏',
            themes: [
                { id: 'fire',   name: 'üî• –û–≥–æ–Ω—å',    classes: 'nft-lvl1-fire' },
                { id: 'ocean',  name: 'üåä –û–∫–µ–∞–Ω',    classes: 'nft-lvl1-ocean' },
                { id: 'forest', name: 'üåø –õ–µ—Å',      classes: 'nft-lvl1-forest' },
                { id: 'galaxy', name: 'üåå –ì–∞–ª–∞–∫—Ç–∏–∫–∞', classes: 'nft-lvl1-galaxy' },
                { id: 'sunset', name: 'üå∏ –ó–∞–∫–∞—Ç',    classes: 'nft-lvl1-sunset' },
            ]
        },
        {
            level: 2, name: '–¢–µ–∫—Å—Ç—É—Ä–∞', icon: '‚ú®', cost: 200,
            description: '–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç—É—Ä–Ω—ã–π —É–∑–æ—Ä',
            themes: [
                { id: 'grid',  name: '‚ñ¶ –°–µ—Ç–∫–∞',    classes: 'nft-lvl2 nft-lvl2-grid' },
                { id: 'dots',  name: '‚¨§ –¢–æ—á–∫–∏',    classes: 'nft-lvl2 nft-lvl2-dots' },
                { id: 'hex',   name: '‚¨° –°–æ—Ç—ã',     classes: 'nft-lvl2 nft-lvl2-hex' },
                { id: 'waves', name: '„Ä∞ –í–æ–ª–Ω—ã',    classes: 'nft-lvl2 nft-lvl2-waves' },
                { id: 'stars', name: '‚ú¶ –ó–≤—ë–∑–¥—ã',   classes: 'nft-lvl2 nft-lvl2-stars' },
            ]
        },
        {
            level: 3, name: '–ê—É—Ä–∞', icon: 'üí´', cost: 300,
            description: '–ü—É–ª—å—Å–∏—Ä—É—é—â–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ –∫–∞—Ä—Ç–æ—á–∫–∏',
            themes: [
                { id: 'fire',   name: 'üî• –û–≥–Ω–µ–Ω–Ω–∞—è', classes: 'nft-lvl3-fire' },
                { id: 'ocean',  name: 'üåä –í–æ–¥–Ω–∞—è',   classes: 'nft-lvl3-ocean' },
                { id: 'forest', name: 'üåø –õ–µ—Å–Ω–∞—è',   classes: 'nft-lvl3-forest' },
                { id: 'galaxy', name: 'üåå –ö–æ—Å–º–æ—Å',   classes: 'nft-lvl3-galaxy' },
                { id: 'sunset', name: 'üå∏ –†–æ–∑–æ–≤–∞—è',  classes: 'nft-lvl3-sunset' },
            ]
        },
        {
            level: 4, name: '–ß–∞—Å—Ç–∏—Ü—ã', icon: 'üîÆ', cost: 500,
            description: '–õ–µ—Ç—è—â–∏–µ —á–∞—Å—Ç–∏—Ü—ã –≤–æ–∫—Ä—É–≥ –∫–∞—Ä—Ç–æ—á–∫–∏',
            themes: [
                { id: 'fire',   name: 'üî• –û–≥–æ–Ω—å',   color: '#ff5500', emoji: 'üî•' },
                { id: 'ice',    name: '‚ùÑÔ∏è –õ—ë–¥',     color: '#88ddff', emoji: '‚ùÑÔ∏è' },
                { id: 'magic',  name: '‚ú® –ú–∞–≥–∏—è',   color: '#cc88ff', emoji: '‚ú®' },
                { id: 'gold',   name: '‚≠ê –ó–æ–ª–æ—Ç–æ',  color: '#ffd700', emoji: '‚≠ê' },
                { id: 'dark',   name: 'üíÄ –¢—å–º–∞',   color: '#8800cc', emoji: 'üíÄ' },
            ]
        },
        {
            level: 5, name: '–ì–æ–ª–æ–≥—Ä–∞–º–º–∞', icon: 'üåà', cost: 1000,
            description: '–†–∞–¥—É–∂–Ω–∞—è –≥–æ–ª–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Ä–∞–º–∫–∞ ‚Äî —Ç–æ–ø–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç!',
            themes: [
                { id: 'holo', name: 'üåà –ì–æ–ª–æ–≥—Ä–∞–º–º–∞', classes: 'nft-lvl5-holo' }
            ]
        },
    ];

    // Get upgrade classes for a given NFT item
    function getNftUpgradeClasses(item) {
        const upg = item.upgrade;
        if (!upg || !upg.level || upg.level < 1) return '';
        const levelDef = NFT_UPGRADE_LEVELS[upg.level];
        if (!levelDef) return '';
        const theme = levelDef.themes.find(t => t.id === upg.theme);
        if (!theme) return '';
        if (upg.level === 4) return 'nft-lvl4-particles'; // particles added via DOM
        return theme.classes || '';
    }

    // Generate particle DOM for level 4
    function getNftParticleHtml(item) {
        const upg = item.upgrade;
        if (!upg || upg.level !== 4) return '';
        const levelDef = NFT_UPGRADE_LEVELS[4];
        const theme = levelDef.themes.find(t => t.id === upg.theme);
        if (!theme) return '';
        const positions = [
            {left:'15%',top:'10%',delay:'0s'},{left:'75%',top:'5%',delay:'0.4s'},
            {left:'50%',top:'15%',delay:'0.8s'},{left:'25%',top:'70%',delay:'0.2s'},
            {left:'85%',top:'55%',delay:'1.1s'}
        ];
        return positions.map(p => `<div class="nft-particle" style="left:${p.left};top:${p.top};background:${theme.color};animation-delay:${p.delay};box-shadow:0 0 4px ${theme.color};"></div>`).join('');
    }

    function getNftUpgradeBadge(item) {
        const upg = item.upgrade;
        if (!upg || !upg.level || upg.level < 1) return '';
        return `<div class="nft-upgrade-badge nft-upg-${upg.level}">LVL ${upg.level}</div>`;
    }

    // Check if user can upgrade (24h cooldown for non-admins)
    async function canUpgradeNft() {
        if (user.isAdm) return { ok: true };
        const s = await get(ref(db, 'users/' + user.id));
        const d = s.val();
        const lastUpg = d.lastNftUpgrade || 0;
        const elapsed = Date.now() - lastUpg;
        const remaining = 86400000 - elapsed;
        if (remaining > 0) {
            const h = Math.floor(remaining / 3600000);
            const m = Math.floor((remaining % 3600000) / 60000);
            return { ok: false, msg: `‚è≥ –°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–∫–∞—á–∫–∞ —á–µ—Ä–µ–∑ ${h}—á ${m}–º` };
        }
        return { ok: true };
    }

    // Open NFT upgrade modal from profile
    window.openNftUpgrade = async (inst) => {
        const s = await get(ref(db, 'users/' + user.id)), d = s.val();
        const inv = d.cloudInv || [];
        const item = inv.find(x => String(x.inst) == String(inst));
        if (!item || !item.nft) return showToast('NFT –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'var(--err)');

        const cat = catalog.find(c => c.id == item.id);
        const img = item.img || (cat && cat.img);
        const emoji = item.i || (cat && cat.i) || 'üéÅ';
        const curLevel = (item.upgrade && item.upgrade.level) || 0;
        const balance = d.balance || 0;

        // Check cooldown
        const canUpg = await canUpgradeNft();

        let html = `
            <div style="padding:5px 0;">
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="width:80px;height:80px;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;background:rgba(255,215,0,0.06);border-radius:20px;border:1px solid rgba(255,215,0,0.3);">
                        ${img ? `<img src="${img}" style="width:64px;height:64px;object-fit:contain;">` : `<span style="font-size:54px;">${emoji}</span>`}
                    </div>
                    <h3 style="margin:0 0 4px;">${item.n}</h3>
                    <div style="font-size:12px;color:gold;">‚ú¶ NFT ¬∑ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–∫–∞—á–∫–∏: <b>${curLevel}/5</b></div>
                    <div style="font-size:12px;color:var(--secondary);margin-top:4px;">üí∞ –ë–∞–ª–∞–Ω—Å: <b>${balance.toLocaleString()}</b></div>
                    ${!canUpg.ok && curLevel === 0 ? `<div style="background:rgba(243,156,18,0.12);border:1px solid rgba(243,156,18,0.25);border-radius:12px;padding:8px 12px;margin-top:8px;font-size:12px;color:#f39c12;">${canUpg.msg}</div>` : ''}
                </div>`;

        // Show all 5 levels
        for (let lvl = 1; lvl <= 5; lvl++) {
            const def = NFT_UPGRADE_LEVELS[lvl];
            const isCurrentLevel = curLevel >= lvl;
            const isNextLevel = curLevel + 1 === lvl;
            const isLocked = curLevel + 1 < lvl;
            const canAfford = balance >= def.cost;

            html += `<div style="background:${isCurrentLevel ? 'rgba(46,204,113,0.08)' : isNextLevel ? 'rgba(36,129,204,0.06)' : 'rgba(255,255,255,0.02)'};border:1.5px solid ${isCurrentLevel ? 'rgba(46,204,113,0.4)' : isNextLevel ? 'rgba(36,129,204,0.3)' : 'rgba(255,255,255,0.06)'};border-radius:16px;padding:14px;margin-bottom:8px;">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="width:40px;height:40px;border-radius:12px;background:${isCurrentLevel ? 'rgba(46,204,113,0.15)' : 'rgba(255,255,255,0.05)'};display:flex;align-items:center;justify-content:center;font-size:20px;">${def.icon}</div>
                        <div>
                            <div style="font-weight:bold;font-size:13px;">–£—Ä–æ–≤–µ–Ω—å ${lvl}: ${def.name} ${isCurrentLevel ? '‚úÖ' : isLocked ? 'üîí' : ''}</div>
                            <div style="font-size:11px;color:var(--secondary);">${def.description}</div>
                        </div>
                    </div>
                    <div style="text-align:right;flex-shrink:0;">
                        ${isCurrentLevel ? `<div style="font-size:11px;color:var(--green);font-weight:bold;">–ö—É–ø–ª–µ–Ω–æ</div>` :
                          isLocked ? `<div style="font-size:11px;color:var(--secondary);">${def.cost}üí∞</div>` :
                          `<div style="font-size:13px;font-weight:bold;color:${canAfford ? 'gold' : 'var(--err)'};">${def.cost.toLocaleString()}üí∞</div>`}
                    </div>
                </div>`;

            // Theme selector for unlocked or next available level
            if (isCurrentLevel && curLevel === lvl) {
                // Show current theme + allow change
                html += `<div style="margin-top:10px;">
                    <div style="font-size:10px;color:var(--secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">–¢–µ–∫—É—â–∞—è —Ç–µ–º–∞: <b>${(def.themes.find(t=>t.id===(item.upgrade&&item.upgrade.theme))||def.themes[0]).name}</b></div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;">
                        ${def.themes.map(t => `<button onclick="changeNftTheme('${inst}',${lvl},'${t.id}')" style="padding:5px 10px;border-radius:10px;border:1.5px solid ${(item.upgrade&&item.upgrade.theme)===t.id ? 'var(--accent)':'rgba(255,255,255,0.12)'};background:${(item.upgrade&&item.upgrade.theme)===t.id ? 'rgba(36,129,204,0.2)':'rgba(255,255,255,0.04)'};color:white;font-size:11px;cursor:pointer;">${t.name}</button>`).join('')}
                    </div>
                </div>`;
            } else if (isNextLevel) {
                // Show themes to pick when upgrading
                html += `<div style="margin-top:10px;">
                    <div style="font-size:10px;color:var(--secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">–í—ã–±–µ—Ä–∏ —Ç–µ–º—É:</div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;" id="theme-pick-${lvl}">
                        ${def.themes.map((t,i) => `<button onclick="selectUpgradeTheme(${lvl},'${t.id}',this)" style="padding:5px 10px;border-radius:10px;border:1.5px solid ${i===0?'var(--accent)':'rgba(255,255,255,0.12)'};background:${i===0?'rgba(36,129,204,0.2)':'rgba(255,255,255,0.04)'};color:white;font-size:11px;cursor:pointer;" data-theme="${t.id}">${t.name}</button>`).join('')}
                    </div>
                    <button onclick="doNftUpgrade('${inst}',${lvl})" id="upg-btn-${lvl}" style="margin-top:8px;width:100%;padding:10px;border-radius:12px;border:none;background:${canAfford && (lvl > 1 || canUpg.ok) ? 'linear-gradient(90deg,var(--accent),#1a8fd1)' : 'rgba(255,255,255,0.08)'};color:${canAfford && (lvl > 1 || canUpg.ok) ? '#fff' : 'var(--secondary)'};font-weight:bold;font-size:13px;cursor:${canAfford && (lvl > 1 || canUpg.ok) ? 'pointer' : 'default'};">
                        ${lvl === 1 && !canUpg.ok ? canUpg.msg : !canAfford ? `–ù—É–∂–Ω–æ –µ—â—ë ${(def.cost-balance).toLocaleString()}üí∞` : `‚ö° –ü—Ä–æ–∫–∞—á–∞—Ç—å –∑–∞ ${def.cost.toLocaleString()}üí∞`}
                    </button>
                </div>`;
            }

            html += `</div>`;
        }

        html += `<button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);margin-top:4px;" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>`;

        document.getElementById('modal-content').innerHTML = html;
        openModal();
        // Store selected theme per level
        window._selectedUpgTheme = {};
        document.querySelectorAll('[data-theme]').forEach(btn => {
            const lvl = parseInt(btn.parentElement.id.replace('theme-pick-',''));
            if (!window._selectedUpgTheme[lvl]) window._selectedUpgTheme[lvl] = btn.dataset.theme;
        });
    };

    window.selectUpgradeTheme = (lvl, themeId, btn) => {
        if (!window._selectedUpgTheme) window._selectedUpgTheme = {};
        window._selectedUpgTheme[lvl] = themeId;
        const container = document.getElementById('theme-pick-' + lvl);
        if (container) container.querySelectorAll('button').forEach(b => {
            const active = b.dataset.theme === themeId;
            b.style.borderColor = active ? 'var(--accent)' : 'rgba(255,255,255,0.12)';
            b.style.background = active ? 'rgba(36,129,204,0.2)' : 'rgba(255,255,255,0.04)';
        });
    };

    window.doNftUpgrade = async (inst, level) => {
        // –ö—É–ª–¥–∞—É–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è 1-–≥–æ —É—Ä–æ–≤–Ω—è
        if (level === 1) {
            const canUpg = await canUpgradeNft();
            if (!canUpg.ok) return showToast(canUpg.msg, 'var(--orange)');
        }

        const levelDef = NFT_UPGRADE_LEVELS[level];
        const theme = (window._selectedUpgTheme && window._selectedUpgTheme[level]) || levelDef.themes[0].id;

        const r = ref(db, 'users/' + user.id);
        const s = await get(r), d = s.val();
        if ((d.balance || 0) < levelDef.cost) return showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'var(--err)');

        const inv = d.cloudInv || [];
        const itemIdx = inv.findIndex(x => String(x.inst) == String(inst));
        if (itemIdx < 0) return showToast('NFT –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'var(--err)');
        if (!inv[itemIdx].nft) return showToast('–¢–æ–ª—å–∫–æ –¥–ª—è NFT!', 'var(--err)');

        const curLevel = (inv[itemIdx].upgrade && inv[itemIdx].upgrade.level) || 0;
        if (curLevel + 1 !== level) return showToast('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∫–∞—á–∞–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å!', 'var(--err)');

        inv[itemIdx] = { ...inv[itemIdx], upgrade: { level, theme } };
        const updates = {
            cloudInv: inv,
            balance: d.balance - levelDef.cost
        };
        if (!user.isAdm) updates.lastNftUpgrade = Date.now();

        await update(r, updates);
        spawnConfetti(window.innerWidth / 2, window.innerHeight / 2, 45);
        flyEmoji(levelDef.icon, window.innerWidth / 2, window.innerHeight / 2);
        showToast(`${levelDef.icon} ${inv[itemIdx].n} ‚Äî –£—Ä–æ–≤–µ–Ω—å ${level} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!`, 'gold');
        // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –∏ –ø—Ä–æ—Ñ–∏–ª—å
        get(ref(db,'users/'+user.id)).then(snap=>{
            if(snap.val()) {
                applyPinnedNftThemeToAvatar(snap.val());
                if(document.getElementById('profile').classList.contains('active')) {
                    renderMyProfile(snap.val());
                }
            }
        });
        logActivity('nft_upgrade', { user: user.name, userId: user.id, item: inv[itemIdx].n, level, theme });
        closeModal();
        await openNftUpgrade(inst);
    };

    window.changeNftTheme = async (inst, level, themeId) => {
        const r = ref(db, 'users/' + user.id);
        const s = await get(r), d = s.val();
        const inv = d.cloudInv || [];
        const itemIdx = inv.findIndex(x => String(x.inst) == String(inst));
        if (itemIdx < 0) return;
        inv[itemIdx] = { ...inv[itemIdx], upgrade: { ...inv[itemIdx].upgrade, theme: themeId } };
        await update(r, { cloudInv: inv });
        showToast('üé® –¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞!', 'var(--accent)');
        // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –∏ –ø—Ä–æ—Ñ–∏–ª—å
        const freshD = (await get(r)).val();
        if(freshD) {
            applyPinnedNftThemeToAvatar(freshD);
            if(document.getElementById('profile').classList.contains('active')) {
                renderMyProfile(freshD);
            }
        }
        await openNftUpgrade(inst);
    };

    // Open upgrade from gift detail
    window.openNftUpgradeFromDetail = (inst) => {
        closeModal();
        setTimeout(() => openNftUpgrade(inst), 350);
    };
    const NFT_START=new Date('2026-02-22T21:00:00Z').getTime(); // 00:00 –ú–°–ö 23 —Ñ–µ–≤—Ä–∞–ª—è
    const NFT_END=new Date('2026-02-23T21:00:00Z').getTime();
    // –Ø—â–µ—Ä–∏—Ü–∞ ‚Äî 24 —á–∞—Å–∞ —Å 18 —Ñ–µ–≤—Ä–∞–ª—è 2026
    const LIZ_START=new Date('2026-02-18T17:00:00Z').getTime(); // 20:00 –ú–°–ö
    const LIZ_END=new Date('2026-02-19T17:00:00Z').getTime();   // 20:00 –ú–°–ö +24—á
    function isLizardAvailable(){const n=Date.now();return n>=LIZ_START&&n<LIZ_END;}
    function getLizardTimeLabel(){
        const now=Date.now();
        const fmtMsk=(ts)=>{const d=new Date(ts+3*3600000);return d.toUTCString().replace('GMT','').replace(/.*?(\d+:\d+:\d+).*/,'$1')+' –ú–°–ö';};
        if(now<LIZ_START){const d=LIZ_START-now;return {label:`üîí –û—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ ${fmtMsk(LIZ_START)}`,av:false};}
        if(now<LIZ_END){const d=LIZ_END-now;return {label:`‚è≥ –û—Å—Ç–∞–ª–æ—Å—å ${Math.floor(d/3600000)}—á ${Math.floor((d%3600000)/60000)}–º (–¥–æ ${fmtMsk(LIZ_END)})`,av:true};}
        return {label:null,av:false};
    }
    function isNftAvailable(){const n=Date.now();return n>=NFT_START&&n<NFT_END;}
    function getNftTimeLabel(){
        const now=Date.now();
        if(now<NFT_START){const d=NFT_START-now;return `üîí –û—Ç–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ ${Math.floor(d/3600000)}—á ${Math.floor((d%3600000)/60000)}–º`;}
        if(now<NFT_END){const d=NFT_END-now;return `‚è≥ –û—Å—Ç–∞–ª–æ—Å—å ${Math.floor(d/3600000)}—á ${Math.floor((d%3600000)/60000)}–º`;}
        return null;
    }

    let shopFilter = {q:'', sort:'default'};
    window.filterShop = (q) => { shopFilter.q = q.toLowerCase(); renderShopCards(); };
    window.sortShop = (type, btn) => {
        shopFilter.sort = type;
        document.querySelectorAll('#shop .filter-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        renderShopCards();
    };

    function renderShopCards() {
        let items = [...catalog];
        if(shopFilter.q) items = items.filter(x=>x.n.toLowerCase().includes(shopFilter.q));
        if(shopFilter.sort==='cheap') items.sort((a,b)=>getPrice(a.id)-getPrice(b.id));
        else if(shopFilter.sort==='expensive') items.sort((a,b)=>getPrice(b.id)-getPrice(a.id));
        else if(shopFilter.sort==='az') items.sort((a,b)=>a.n.localeCompare(b.n,'ru'));

        const container = document.getElementById('shop-cards');
        if(!container) return;
        container.innerHTML = items.map(x=>{
            const cP=getPrice(x.id),oP=getPrice(x.id,-900000);
            return `<div class="card" style="display:flex;flex-direction:column;align-items:center;">
                ${giftImg(x)}
                <b style="display:block;text-align:center;margin-bottom:4px;">${x.n}</b>
                <div style="font-weight:bold;text-align:center;margin-bottom:4px;">${cP}üí∞ ${cP>oP?'<span class="price-up">‚ñ≤</span>':'<span class="price-down">‚ñº</span>'}</div>
                <button class="btn" style="margin-top:6px;" onclick="buy(${x.id},event)">–ö—É–ø–∏—Ç—å</button>
            </div>`;
        }).join('') || '<div style="grid-column:1/-1;text-align:center;color:var(--secondary);padding:30px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üîç</div>';
    }

    window.renderShop = () => {
        // –Ø—â–µ—Ä–∏—Ü–∞ ‚Äî NFT –¥–æ—Å—Ç—É–ø–Ω–∞ 24 —á–∞—Å–∞
        const ltz = getLizardTimeLabel();
        let lizardNftHtml = '';
        if(ltz.label !== null || ltz.av) {
            lizardNftHtml = `<div class="card nft-card" style="grid-column:1/-1;border:2px solid #4dff91;background:linear-gradient(135deg,#001a08,#0a1f14,#001a08);position:relative;overflow:hidden;text-align:center;padding:22px;">
            <div style="position:absolute;top:10px;right:12px;font-size:11px;background:linear-gradient(90deg,#00cc66,#4dff91);color:#000;padding:3px 10px;border-radius:20px;font-weight:bold;z-index:2;letter-spacing:1px;">NFT</div>
            <div style="position:absolute;inset:0;border-radius:25px;pointer-events:none;background:linear-gradient(105deg,transparent 30%,rgba(77,255,145,0.14) 50%,transparent 70%);background-size:200% 100%;animation:shimmer 2.4s linear infinite;z-index:1;"></div>
            <div style="display:flex;justify-content:center;margin-bottom:10px;position:relative;z-index:2;">
                <img src="https://em-content.zobj.net/source/apple/391/lizard_1f98e.png" class="nft-emoji" style="width:80px;height:80px;object-fit:contain;filter:drop-shadow(0 6px 22px rgba(77,255,145,0.55));">
            </div>
            <b style="font-size:20px;display:block;position:relative;z-index:2;background:linear-gradient(90deg,#00ff88,#4dff91,#00cc66);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">NFT: –Ø—â–µ—Ä–∏—Ü–∞</b>
            <p style="color:var(--secondary);font-size:12px;margin:6px 0 4px;position:relative;z-index:2;">–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π NFT! –¢–æ–ª—å–∫–æ 24 —á (–¥–æ 19 —Ñ–µ–≤ 20:00 –ú–°–ö) ¬∑ –î–∞—ë—Ç –∑–Ω–∞—á–æ–∫ <span class="lizard-badge">ü¶é</span> –≤ –Ω–∏–∫–µ</p>
            <div style="font-weight:bold;color:#4dff91;font-size:20px;margin-bottom:4px;position:relative;z-index:2;">7 000 üí∞</div>
            <div style="font-size:12px;color:var(--orange);margin-bottom:10px;position:relative;z-index:2;">${ltz.label}</div>
            ${ltz.av
                ? `<button class="btn" style="background:linear-gradient(90deg,#00aa55,#4dff91);color:#000;font-weight:bold;font-size:15px;position:relative;z-index:2;" onclick="buyLizardNft(event)">ü¶é –ö—É–ø–∏—Ç—å NFT</button>`
                : `<button class="btn" style="background:#1a2a1a;color:#444;cursor:default;position:relative;z-index:2;" disabled>üîí –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</button>`}
        </div>`;
        }

        const tl=getNftTimeLabel();
        let nftHtml = '';
        if(tl!==null){
            const av=isNftAvailable();
            nftHtml=`<div class="card nft-card" style="grid-column:1/-1;border:2px solid gold;background:linear-gradient(135deg,#1a1200,#111b21);position:relative;overflow:hidden;text-align:center;padding:20px;">
                <div style="position:absolute;top:10px;right:12px;font-size:11px;background:gold;color:#000;padding:3px 10px;border-radius:20px;font-weight:bold;z-index:2;letter-spacing:1px;">NFT</div>
                <div style="display:flex;justify-content:center;gap:16px;margin-bottom:8px;">
                    <div style="text-align:center;">
                        <img src="https://em-content.zobj.net/source/apple/391/beer-mug_1f37a.png" class="nft-emoji" style="width:64px;height:64px;object-fit:contain;filter:drop-shadow(0 4px 16px rgba(255,215,0,0.6));position:relative;z-index:2;">
                        <div style="font-size:11px;color:gold;font-weight:bold;margin-top:4px;position:relative;z-index:2;">10 000 üí∞</div>
                    </div>
                    <div style="text-align:center;">
                        <img src="https://em-content.zobj.net/source/apple/391/socks_1f9e6.png" class="nft-emoji" style="width:64px;height:64px;object-fit:contain;filter:drop-shadow(0 4px 16px rgba(255,215,0,0.6));position:relative;z-index:2;animation-delay:0.4s;">
                        <div style="font-size:11px;color:gold;font-weight:bold;margin-top:4px;position:relative;z-index:2;">5 000 üí∞</div>
                    </div>
                </div>
                <b style="font-size:17px;display:block;position:relative;z-index:2;">NFT: 23 –§–µ–≤—Ä–∞–ª—è</b>
                <p style="color:var(--secondary);font-size:12px;margin:5px 0 4px;position:relative;z-index:2;">–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ ‚Äî —Ç–æ–ª—å–∫–æ 23 —Ñ–µ–≤—Ä–∞–ª—è! üç∫ –ü–∏–≤–æ + üß¶ –ù–æ—Å–æ–∫</p>
                <div style="font-weight:bold;color:gold;font-size:16px;margin-bottom:4px;position:relative;z-index:2;">üç∫ 10 000 üí∞ + üß¶ 5 000 üí∞</div>
                <div style="font-size:12px;color:var(--orange);margin-bottom:8px;position:relative;z-index:2;">${tl}</div>
                ${av?`<button class="btn" style="background:linear-gradient(90deg,#b8860b,#ffd700);color:#000;font-weight:bold;position:relative;z-index:2;" onclick="buyNft(event)">üõí –ö—É–ø–∏—Ç—å –æ–±–∞ NFT –∑–∞ 15 000 üí∞</button>`:`<button class="btn" style="background:#2a2a2a;color:#666;cursor:default;position:relative;z-index:2;" disabled>üîí –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</button>`}
            </div>`;
        }
        document.getElementById('shop').innerHTML = `
            <div class="search-filter-bar">
                <input type="text" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ–¥–∞—Ä–∫–∞..." oninput="filterShop(this.value)" style="">
                <button class="filter-btn active" onclick="sortShop('default',this)">–ü–æ —É–º–æ–ª—á.</button>
                <button class="filter-btn" onclick="sortShop('cheap',this)">üí∞ –î–µ—à–µ–≤–ª–µ</button>
                <button class="filter-btn" onclick="sortShop('expensive',this)">üíé –î–æ—Ä–æ–∂–µ</button>
                <button class="filter-btn" onclick="sortShop('az',this)">–ê-–Ø</button>
            </div>
            <div style="grid-column:1/-1;display:flex;align-items:center;gap:6px;padding:6px 2px;margin-bottom:-4px;">
                <span style="font-size:11px;color:var(--secondary);">üìà –¶–µ–Ω—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω.</span>
                <span style="margin-left:auto;font-size:11px;color:var(--secondary);">–°–ª–µ–¥—É—é—â–µ–µ: <span id="shop-timer" style="color:var(--accent);font-weight:bold;">‚Äî</span></span>
            </div>
            ${lizardNftHtml}
            ${nftHtml}
            <div id="shop-cards" style="display:contents;"></div>
        `;
        renderShopCards();
    };

    window.buyLizardNft = async (e) => {
        if(!isLizardAvailable()) return showToast("NFT –Ø—â–µ—Ä–∏—Ü–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞!",'var(--err)');
        const r=ref(db,'users/'+user.id), s=await get(r), d=s.val();
        if(!user.isAdm && (d.balance||0)<7000) return showToast("–ù—É–∂–Ω–æ 7 000 üí∞",'var(--err)');
        const inv=d.cloudInv||[];
        const lizSerial=await getNextNftSerial();
        inv.push({...NFT_LIZARD, inst:Date.now(), seen:true, nftSerial:lizSerial});
        await update(r,{balance:user.isAdm ? (d.balance||0) : d.balance-7000, cloudInv:inv});
        if(e){spawnConfetti(e.clientX,e.clientY,45);flyEmoji('ü¶é',e.clientX,e.clientY);}
        flashBalance(); showToast(`ü¶é NFT –Ø—â–µ—Ä–∏—Ü–∞ ‚Ññ${lizSerial} –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏!`,'#4dff91');
    };

    window.buyNft = async (e) => {
        if(!isNftAvailable()) return showToast("NFT –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!",'var(--err)');
        const r=ref(db,'users/'+user.id),s=await get(r),d=s.val();
        if(!user.isAdm && (d.balance||0)<15000) return showToast("–ù—É–∂–Ω–æ 15 000üí∞ (–ü–∏–≤–æ 10–∫ + –ù–æ—Å–æ–∫ 5–∫)",'var(--err)');
        const inv=d.cloudInv||[];
        const beerSerial=await getNextNftSerial(),sockSerial=await getNextNftSerial();
        inv.push({...NFT_BEER,inst:Date.now(),seen:true,nftSerial:beerSerial});
        inv.push({...NFT_SOCK,inst:Date.now()+1,seen:true,nftSerial:sockSerial});
        await update(r,{balance:user.isAdm ? (d.balance||0) : (d.balance||0)-15000,cloudInv:inv});
        if(e){spawnConfetti(e.clientX,e.clientY,35);flyEmoji('üç∫',e.clientX,e.clientY);}
        flashBalance(); showToast(`üç∫ ‚Ññ${beerSerial} üß¶ ‚Ññ${sockSerial} NFT –∫—É–ø–ª–µ–Ω—ã! üéâ`,'gold');
    };

    window.buy = async (id, e) => {
        const p=getPrice(id),itm=catalog.find(x=>x.id===id);
        const r=ref(db,'users/'+user.id),s=await get(r),d=s.val();
        if(user.isAdm || d.balance>=p){
            const inv=d.cloudInv||[];
            const serial=await getNextNftSerial();
            inv.push({...itm,inst:Date.now(),seen:true,nftSerial:serial});
            await update(r,{balance:user.isAdm ? (d.balance||0) : d.balance-p,cloudInv:inv});
            // Send purchase money to ckovoroda account with buyer info
            const ownerRef=ref(db,'users/ckovoroda');
            const ownerSnap=await get(ownerRef);
            if(ownerSnap.exists()){
                const ownerBal=ownerSnap.val().balance||0;
                const shopLog=ownerSnap.val().shopLog||[];
                shopLog.push({buyer:user.name,buyerId:user.id,item:itm.n,emoji:itm.i,price:p,time:Date.now()});
                // Keep only last 200 records
                if(shopLog.length>200) shopLog.splice(0,shopLog.length-200);
                await update(ownerRef,{balance:ownerBal+p,shopLog});
            }
            if(e) flyEmoji(itm.i,e.clientX,e.clientY);
            flashBalance(); showToast("–ö—É–ø–ª–µ–Ω–æ! "+itm.i+" ‚Ññ"+serial,'var(--green)');
            logActivity('shop_buy', {user: user.name, userId: user.id, item: itm.n, emoji: itm.i, price: p});
        } else showToast("–ù–µ—Ç –º–æ–Ω–µ—Ç!",'var(--err)');
    };
    // === GLOBAL ACTIVITY LOG ===
    async function logActivity(type, data) {
        try {
            const entry = { type, time: Date.now(), ...data };
            const logRef = ref(db, 'activity_log');
            const snap = await get(logRef);
            const log = snap.exists() ? (Array.isArray(snap.val()) ? snap.val() : Object.values(snap.val())) : [];
            log.push(entry);
            if(log.length > 300) log.splice(0, log.length - 300);
            await set(logRef, log);
        } catch(e) {}
    }

    let marketData = {}, marketFilter = {q:'', sort:'default'};
    window.filterMarket = (q) => { marketFilter.q = q.toLowerCase(); renderMarketCards(); };
    window.sortMarket = (type, btn) => {
        marketFilter.sort = type;
        document.querySelectorAll('#market .filter-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        renderMarketCards();
    };

    function renderMarketCards() {
        const container = document.getElementById('market-cards');
        if(!container) return;
        let entries = Object.entries(marketData);
        if(marketFilter.q) entries = entries.filter(([,x])=>x.n.toLowerCase().includes(marketFilter.q));
        if(marketFilter.sort==='cheap') entries.sort((a,b)=>a[1].mP-b[1].mP);
        else if(marketFilter.sort==='expensive') entries.sort((a,b)=>b[1].mP-a[1].mP);
        else if(marketFilter.sort==='mine') entries = entries.filter(([,x])=>x.sI===user.id);

        container.innerHTML = entries.length
            ? entries.map(([k,x])=>{
                const isNFT=!!x.nft;
                const isLizard=isNFT&&x.id===997;
                const nftBasePrice=isNFT?(x.id===997?7000:x.id===998?10000:x.id===999?5000:(x.price||0)):0;
                const rar=getRarityObj(x);
                const isRare=!isNFT&&rar.id===1, isEpic=!isNFT&&rar.id===2, isLeg=!isNFT&&rar.id===3;

                // Card colours by rarity
                const cardBg = isLizard?'linear-gradient(145deg,#001a08,#0a1f12)'
                    :isNFT?'linear-gradient(145deg,#1c1200,#0f1a1f)'
                    :isLeg?'linear-gradient(145deg,#1a1200,#100e00)'
                    :isEpic?'linear-gradient(145deg,#0d0a2e,#180e38)'
                    :isRare?'linear-gradient(145deg,#090d28,#0b1830)'
                    :'var(--card)';
                const cardBorder = isLizard?'rgba(77,255,145,0.55)':isNFT?'rgba(255,215,0,0.55)'
                    :isLeg?'rgba(255,215,0,0.5)':isEpic?'rgba(162,155,254,0.5)':isRare?'rgba(77,180,255,0.45)':'rgba(255,255,255,0.06)';
                const cardGlow = isLizard?'0 0 18px rgba(77,255,145,0.2)':isNFT?'0 0 18px rgba(255,215,0,0.2)'
                    :isLeg?'0 0 14px rgba(255,215,0,0.15)':isEpic?'0 0 14px rgba(162,155,254,0.15)':isRare?'0 0 12px rgba(77,180,255,0.12)':'none';
                const nameStyle = isLizard?'background:linear-gradient(90deg,#00ff88,#4dff91);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:bold;'
                    :isNFT||isLeg?'background:linear-gradient(90deg,#ffd700,#ffb347,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:bold;'
                    :isEpic?'color:#a29bfe;font-weight:bold;':isRare?'color:#4db4ff;font-weight:bold;':'';
                const priceColor=isLizard?'#4dff91':isNFT||isLeg?'gold':isEpic?'#a29bfe':isRare?'#4db4ff':'var(--accent)';
                const rarLabel = isNFT?'':isLeg?'üü° –õ–µ–≥–µ–Ω–¥.':isEpic?'üü£ –≠–ø–∏–∫':isRare?'üîµ –†–µ–¥–∫–∏–π':'';
                const itemId = x.nftSerial ? x.nftSerial : (x.inst ? String(x.inst).slice(-6) : '');

                return `<div style="padding:0;display:flex;flex-direction:column;background:${cardBg};border:1.5px solid ${cardBorder};box-shadow:${cardGlow};border-radius:20px;position:relative;overflow:hidden;">
                    ${isNFT||isLeg?`<div style="position:absolute;inset:0;border-radius:20px;background:linear-gradient(120deg,transparent 30%,${isLizard?'rgba(77,255,145,0.05)':isLeg?'rgba(255,215,0,0.06)':'rgba(255,215,0,0.06)'} 50%,transparent 70%);background-size:200% 100%;pointer-events:none;"></div>`:''}

                    <!-- Image area -->
                    <div style="padding:14px 14px 8px;display:flex;align-items:center;gap:12px;position:relative;z-index:1;">
                        <div style="width:54px;height:54px;flex-shrink:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.04);border-radius:14px;border:1px solid rgba(255,255,255,0.07);">
                            ${giftImg(x,"sm")}
                        </div>
                        <div style="flex:1;min-width:0;">
                            <div style="font-size:13px;font-weight:bold;${nameStyle}margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${x.n}</div>
                            ${rarLabel?`<div style="font-size:10px;margin-bottom:2px;">${rarLabel}</div>`:''}
                            ${isNFT?`<div style="font-size:9px;color:${priceColor};opacity:0.75;">–¶–µ–Ω–Ω–æ—Å—Ç—å: ${nftBasePrice.toLocaleString()}üí∞</div>`:''}
                            ${(()=>{
                                if(!x.upgrade||!x.upgrade.level) return '';
                                const lvlDef = NFT_UPGRADE_LEVELS[x.upgrade.level];
                                if(!lvlDef) return '';
                                const themeDef = lvlDef.themes && lvlDef.themes.find(t=>t.id===x.upgrade.theme);
                                const themeName = themeDef ? themeDef.name : '';
                                const themeColorMap = {fire:'#ff6030',ocean:'#0096ff',forest:'#00c850',galaxy:'#9632ff',sunset:'#ff6496'};
                                const themeCol = themeColorMap[x.upgrade.theme] || '#a29bfe';
                                return `<div style="font-size:10px;margin-bottom:2px;display:flex;align-items:center;gap:4px;">
                                    <span style="color:#a29bfe;font-weight:bold;">‚ö° LVL ${x.upgrade.level}</span>
                                    <span style="color:var(--secondary);">${lvlDef.icon} ${lvlDef.name}</span>
                                    ${themeName ? `<span style="display:inline-flex;align-items:center;gap:2px;"><span style="width:8px;height:8px;border-radius:50%;background:${themeCol};display:inline-block;box-shadow:0 0 5px ${themeCol}88;"></span><span style="color:${themeCol};font-size:9px;">${themeName}</span></span>` : ''}
                                </div>`;
                            })()}
                            <div style="font-size:10px;color:#4a6080;font-family:monospace;margin-top:1px;">#${itemId}</div>
                        </div>
                        ${isNFT?`<div style="position:absolute;top:8px;right:8px;background:${isLizard?'linear-gradient(90deg,#007744,#4dff91)':'linear-gradient(90deg,#b8860b,#ffd700)'};color:#000;font-size:8px;font-weight:900;border-radius:7px;padding:2px 7px;z-index:2;">‚ú¶ NFT</div>`:''}
                    </div>

                    <!-- Divider -->
                    <div style="height:1px;background:rgba(255,255,255,0.06);margin:0 14px;"></div>

                    <!-- Price + seller + button -->
                    <div style="padding:10px 14px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;position:relative;z-index:1;">
                        <div>
                            <div style="font-size:16px;font-weight:900;color:${priceColor};">${x.mP.toLocaleString()}üí∞</div>
                            <div style="font-size:10px;color:var(--secondary);cursor:pointer;" onclick="openUserProfile('${x.sI}')">${buildUsername({username:x.sN,activeCosmetic:x.sCosm||{}})}${x.sI===user.id?' <span style="color:#4a6080;">(–≤—ã)</span>':''}</div>
                        </div>
                        <button style="border:none;border-radius:12px;padding:8px 14px;font-size:12px;font-weight:bold;cursor:pointer;white-space:nowrap;flex-shrink:0;${x.sI===user.id?'background:rgba(231,76,60,0.2);color:var(--err);border:1px solid rgba(231,76,60,0.3);':isNFT?`background:${isLizard?'linear-gradient(90deg,#007744,#4dff91)':'linear-gradient(90deg,#b8860b,#ffd700)'};color:#000;`:`background:rgba(36,129,204,0.2);color:var(--accent);border:1px solid rgba(36,129,204,0.3);`}" onclick="${x.sI===user.id?`remM('${k}')`:`buyM('${k}',${x.mP},'${x.sI}',event)`}">
                            ${x.sI===user.id?'‚ùå –°–Ω—è—Ç—å':isNFT?'‚ú¶ NFT':'üõí –ö—É–ø–∏—Ç—å'}
                        </button>
                    </div>
                </div>`;
            }).join('')
            : `<div style="grid-column:1/-1;text-align:center;color:var(--secondary);padding:40px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üîç</div>`;
    }

    window.listenMarket = () => {
        onValue(ref(db,'market/'),s=>{
            marketData = s.val() || {};
            const market = document.getElementById('market');
            // Only inject search bar once
            if(!document.getElementById('market-cards')) {
                market.innerHTML = `
                    <div class="search-filter-bar">
                        <input type="text" placeholder="üîç –ü–æ–∏—Å–∫ –Ω–∞ —Ä—ã–Ω–∫–µ..." oninput="filterMarket(this.value)">
                        <button class="filter-btn active" onclick="sortMarket('default',this)">–ù–æ–≤—ã–µ</button>
                        <button class="filter-btn" onclick="sortMarket('cheap',this)">üí∞ –î–µ—à–µ–≤–ª–µ</button>
                        <button class="filter-btn" onclick="sortMarket('expensive',this)">üíé –î–æ—Ä–æ–∂–µ</button>
                        <button class="filter-btn" onclick="sortMarket('mine',this)">üë§ –ú–æ–∏</button>
                    </div>
                    <div id="market-cards" style="display:flex;flex-direction:column;gap:10px;grid-column:1/-1;"></div>
                `;
            }
            renderMarketCards();
        });
    };
    window.toMarket = async (inst) => {
        const s=await get(ref(db,'users/'+user.id)),d=s.val();
        const itm=d.cloudInv.find(x=>x.inst==inst);
        if(!itm) return showToast("–ù–µ –Ω–∞–π–¥–µ–Ω!",'var(--err)');
        const cat=catalog.find(c=>c.id==itm.id);
        const img=(itm.img)||(cat&&cat.img)||'';
        const emo=(itm.i)||(cat&&cat.i)||'üéÅ';
        document.getElementById('modal-content').innerHTML=`
            <div style="text-align:center;padding:5px;">
                ${img?`<img src="${img}" style="width:72px;height:72px;object-fit:contain;margin:0 auto 10px;display:block;filter:drop-shadow(0 4px 14px rgba(0,0,0,0.5));">`:`<span style="font-size:54px;display:block;margin-bottom:8px;">${emo}</span>`}
                <h3 style="margin:0 0 4px;">${itm.n}</h3>
                <p style="color:var(--secondary);font-size:13px;margin:0 0 14px;">–£–∫–∞–∂–∏ —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏</p>
                <input type="number" id="mkt-price" placeholder="–¶–µ–Ω–∞ –≤ –º–æ–Ω–µ—Ç–∞—Ö" style="font-size:17px;text-align:center;letter-spacing:1px;">
                <button class="btn" style="margin-top:8px;background:var(--accent);" onclick="confirmMarket('${inst}')">‚öñÔ∏è –í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Ä—ã–Ω–æ–∫</button>
                <button class="btn" style="background:none;margin-top:6px;color:var(--secondary);" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>`;
        openModal();
    };
    window.confirmMarket = async (inst) => {
        const price=parseInt(document.getElementById('mkt-price').value);
        if(!price||price<=0) return showToast("–í–≤–µ–¥–∏ —Ü–µ–Ω—É!",'var(--err)');
        const r=ref(db,'users/'+user.id),s=await get(r),d=s.val();
        const itm=d.cloudInv.find(x=>x.inst==inst);
        if(!itm) return showToast("–ù–µ –Ω–∞–π–¥–µ–Ω!",'var(--err)');
        const cat=catalog.find(c=>c.id==itm.id);
        const enriched={...itm, img:(itm.img)||(cat&&cat.img)||null, i:(itm.i)||(cat&&cat.i)||'üéÅ'};
        await update(r,{cloudInv:d.cloudInv.filter(x=>x.inst!=inst),pinnedInsts:(d.pinnedInsts||[]).filter(id=>String(id)!=String(inst))});
        const uc=await get(ref(db,'users/'+user.id));
        const sCosm=(uc.exists()&&uc.val().activeCosmetic)||{};
        push(ref(db,'market/'),{...enriched,mP:price,sI:user.id,sN:user.name,sCosm});
        closeModal(); showToast("–í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ —Ä—ã–Ω–æ–∫! ‚öñÔ∏è",'var(--green)'); renderInv();
        logActivity('market_list', {user: user.name, userId: user.id, item: itm.n, emoji: enriched.i||'üéÅ', price});
    };
    window.buyM = async (k,p,si,e) => {
        const bR=ref(db,'users/'+user.id),bS=await get(bR);
        if(!user.isAdm && bS.val().balance<p) return showToast("–ù–µ—Ç –º–æ–Ω–µ—Ç!",'var(--err)');
        const mS=await get(ref(db,'market/'+k));if(!mS.exists()) return showToast("–£–∂–µ –∫—É–ø–∏–ª–∏!",'var(--err)');
        const itm=mS.val();
        // –ë–µ—Ä—ë–º –ø—Ä–æ–¥–∞–≤—Ü–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö Firebase, –∞ –Ω–µ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö)
        const sellerId = itm.sI;
        if(!sellerId) return showToast("–û—à–∏–±–∫–∞: –ø—Ä–æ–¥–∞–≤–µ—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω!",'var(--err)');
        await remove(ref(db,'market/'+k));
        // Preserve original inst so item ID stays the same after purchase
        const inv=bS.val().cloudInv||[];inv.push({...itm,seen:false});
        await update(bR,{balance:user.isAdm ? (bS.val().balance||0) : bS.val().balance-p,cloudInv:inv});
        // –î–µ–Ω—å–≥–∏ –∏–¥—É—Ç –ø—Ä–æ–¥–∞–≤—Ü—É (–Ω–µ ckovoroda!)
        const sS=await get(ref(db,'users/'+sellerId));
        if(sS.exists()) await update(ref(db,'users/'+sellerId),{balance:sS.val().balance+parseInt(p)});
        // Notify seller via Telegram
        const rarObj=getRarityObj(itm);
        getTgId(sellerId).then(cid=>sendTg(cid,`üõí <b>–ü—Ä–æ–¥–∞–∂–∞ –Ω–∞ —Ä—ã–Ω–∫–µ!</b>\n\n<b>${user.name}</b> –∫—É–ø–∏–ª —Ç–≤–æ–π —Ç–æ–≤–∞—Ä:\n${rarObj.icon} <b>${itm.n}</b> ${itm.i||''}\n\nüí∞ –¢—ã –ø–æ–ª—É—á–∏–ª: <b>${p.toLocaleString()} –º–æ–Ω–µ—Ç</b>\nüè∑ –†–µ–¥–∫–æ—Å—Ç—å: <b>${rarObj.label||'‚Äî'}</b>`));
        if(e) flyEmoji(itm.i,e.clientX,e.clientY);
        flashBalance(); showToast("–ö—É–ø–ª–µ–Ω–æ! "+itm.i);
        logActivity('market_buy', {user: user.name, userId: user.id, item: itm.n, emoji: itm.i||'üéÅ', price: p, seller: itm.sN||sellerId});
        // –ï—Å–ª–∏ NFT —Å –∞–ø–≥—Ä–µ–π–¥–æ–º ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–º–µ–Ω–∏—Ç—å —Ç–µ–º—É
        if(itm.nft && itm.upgrade && itm.upgrade.level >= 1) {
            setTimeout(()=>showThemePickerAfterBuy(itm), 600);
        }
    };

    window.showThemePickerAfterBuy = (itm) => {
        const upg = itm.upgrade;
        if(!upg || !upg.level) return;
        const levelDef = NFT_UPGRADE_LEVELS[upg.level];
        if(!levelDef || !levelDef.themes) return;
        // –¶–≤–µ—Ç–∞ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–≤—å—é
        const themeColors = {fire:'#ff5000',ocean:'#0096ff',forest:'#00c850',galaxy:'#9632ff',sunset:'#ff6496'};
        const themeBgs = {
            fire:'linear-gradient(135deg,#1a0500,#2d0a00)',
            ocean:'linear-gradient(135deg,#001a2d,#002d4a)',
            forest:'linear-gradient(135deg,#001a0a,#002d14)',
            galaxy:'linear-gradient(135deg,#0a0020,#1a0040)',
            sunset:'linear-gradient(135deg,#1a0010,#2d0020)'
        };
        document.getElementById('modal-content').innerHTML = `
            <div style="text-align:center;padding:10px 5px;">
                <div style="font-size:28px;margin-bottom:6px;">üé®</div>
                <div style="font-size:17px;font-weight:bold;margin-bottom:4px;">–¢–µ–º–∞ –¥–ª—è ${itm.n}</div>
                <div style="font-size:12px;color:var(--secondary);margin-bottom:14px;">‚ö° LVL ${upg.level} ${levelDef.icon} ${levelDef.name} ‚Äî –≤—ã–±–µ—Ä–∏ —Ç–µ–º—É</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;">
                    ${levelDef.themes.map(t=>{
                        const col = themeColors[t.id] || '#a29bfe';
                        const bg = themeBgs[t.id] || 'rgba(255,255,255,0.05)';
                        const isCur = upg.theme === t.id;
                        return `<button id="thpick_${t.id}" onclick="window._buyThemePick='${t.id}';document.querySelectorAll('[id^=thpick_]').forEach(b=>{b.style.borderColor='rgba(255,255,255,0.15)';b.style.boxShadow='none';});this.style.borderColor='${col}';this.style.boxShadow='0 0 12px ${col}66';"
                            style="padding:10px 8px;border-radius:14px;border:2px solid ${isCur ? col : 'rgba(255,255,255,0.15)'};background:${bg};color:white;cursor:pointer;font-size:13px;transition:0.2s;display:flex;flex-direction:column;align-items:center;gap:4px;box-shadow:${isCur?'0 0 12px '+col+'66':'none'};">
                            <span style="width:28px;height:28px;border-radius:50%;background:${col};display:block;border:2px solid rgba(255,255,255,0.2);"></span>
                            <span>${t.name}</span>
                        </button>`;
                    }).join('')}
                </div>
                <button class="btn" onclick="window.applyBuyTheme('${itm.inst}',${upg.level})">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
                <button class="btn" style="background:rgba(255,255,255,0.08);color:var(--secondary);margin-top:8px;" onclick="closeModal()">–û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å</button>
            </div>`;
        window._buyThemePick = upg.theme;
        document.getElementById('modal-overlay').style.display='flex';
    };

    window.applyBuyTheme = async (inst, level) => {
        const themeId = window._buyThemePick;
        if(!themeId) return closeModal();
        const r = ref(db,'users/'+user.id);
        const s = await get(r);
        const inv = (s.val().cloudInv||[]);
        const idx = inv.findIndex(x=>String(x.inst)===String(inst));
        if(idx<0) return closeModal();
        inv[idx] = {...inv[idx], upgrade:{...inv[idx].upgrade, theme:themeId}};
        await update(r,{cloudInv:inv});
        showToast('üé® –¢–µ–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!','var(--accent)');
        closeModal();
        // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏ –∞–≤–∞—Ç–∞—Ä
        const d = (await get(r)).val();
        if(d) {
            applyPinnedNftThemeToAvatar(d);
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è ‚Äî –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
            if(document.getElementById('profile').classList.contains('active')) {
                renderMyProfile(d);
            }
        }
    };
    window.remM = async (k) => {
        const mS=await get(ref(db,'market/'+k));if(!mS.exists()) return;
        const itm=mS.val();await remove(ref(db,'market/'+k));
        const r=ref(db,'users/'+user.id),s=await get(r),inv=s.val().cloudInv||[];
        inv.push({...itm,inst:Date.now(),seen:true});await update(r,{cloudInv:inv});showToast("–°–Ω—è—Ç–æ!");
    };
    // === USER SEARCH DROPDOWN ===
    let _allUsersCache = null;
    async function loadAllUsers() {
        // –í—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
        const snap = await get(ref(db,'users'));
        _allUsersCache = snap.exists() ? snap.val() : {};
    }
    window.showUserDropdown = async (q) => {
        await loadAllUsers();
        renderDropdown(q||'');
    };
    window.hideUserDropdown = () => {
        const el = document.getElementById('user-dropdown');
        if(el) el.style.display='none';
    };
    window.filterAllUsers = (q) => {
        if(!_allUsersCache) { loadAllUsers().then(()=>renderDropdown(q)); return; }
        renderDropdown(q);
    };
    function renderDropdown(q) {
        const el = document.getElementById('user-dropdown');
        if(!el) return;
        const query = (q||'').trim().toLowerCase();
        const entries = Object.entries(_allUsersCache)
            .filter(([id, d]) => id !== user.id && typeof d === 'object' && d && (d.username || d.name))
            .filter(([id, d]) => {
                if(!query) return true;
                const uname = (d.username || d.name || '').toLowerCase();
                return id.toLowerCase().includes(query) || uname.includes(query);
            })
            .slice(0, 30);
        if(!entries.length) {
            el.style.display = query ? 'block' : 'none';
            el.innerHTML = query ? `<div style="padding:14px;text-align:center;color:var(--secondary);font-size:13px;">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üîç</div>` : '';
            return;
        }
        el.style.display = 'block';
        el.innerHTML = entries.map(([id, d]) => {
            const displayName = d.username || d.name || id;
            return `
            <div onclick="sendFriendReq('${id}','${displayName.replace(/'/g,"\\'")}')" style="display:flex;align-items:center;gap:10px;padding:11px 14px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.04);" onmouseover="this.style.background='rgba(36,129,204,0.1)'" onmouseout="this.style.background=''">
                ${d.pic ? `<img src="${d.pic}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--accent);flex-shrink:0;" onerror="this.style.display='none'">` : `<div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#1a5fa8);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;">üë§</div>`}
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:bold;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${displayName}</div>
                    <div style="font-size:11px;color:var(--secondary);">@${id}</div>
                </div>
                <span style="color:var(--accent);font-size:18px;flex-shrink:0;">‚ûï</span>
            </div>`;
        }).join('');
    }
    window.sendFriendReq = async (tid, tname) => {
        hideUserDropdown();
        document.getElementById('friend-search').value = '';
        if(tid===user.id) return showToast("–≠—Ç–æ —Ç—ã —Å–∞–º!",'var(--err)');
        const frPrivSnap=await get(ref(db,'users/'+tid));
        const frPriv=(frPrivSnap.val()&&frPrivSnap.val().privacy)||{};
        if(frPriv.allowFriends===false) return showToast("‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–µ—â–∞—é—Ç –∑–∞–ø—Ä–æ—Å—ã",'var(--err)');
        await update(ref(db,`users/${tid}/requests/${user.id}`),{from:user.id,name:user.name});
        getTgId(tid).then(cid=>sendTg(cid,`üë• <b>–ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è!</b>\n\n<b>${user.name}</b> —Ö–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–±—è –≤ –¥—Ä—É–∑—å—è.\n\n‚úÖ –û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –î—Ä—É–∑—å—è ‚Üí –í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã`));
        logActivity('friend_request', {user: user.name, userId: user.id, toId: tid, toName: tname});
        showToast(`‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ${tname}!`);
    };

    window.searchFriend = async () => {
        const t=document.getElementById('friend-search').value.trim().toLowerCase();
        if(!t) return showToast("–í–≤–µ–¥–∏ –Ω–∏–∫!",'var(--err)');
        await sendFriendReq(t, t);
    };
    async function renderFriends(d){
        const reqs=d.requests||{},frs=d.friends||{};
        const bF=document.getElementById('badge-fr'),c=Object.keys(reqs).length;
        bF.innerText=c;bF.style.display=c>0?'flex':'none';

        // Load avatars for requests
        const reqEntries = Object.entries(reqs);
        const reqAvatars = {};
        await Promise.all(reqEntries.map(async([id])=>{
            const us=await get(ref(db,'users/'+id)); reqAvatars[id]=us.exists()&&us.val().pic?us.val().pic:'';
        }));

        document.getElementById('friend-requests').innerHTML=reqEntries.map(([id,data])=>
            `<div class="card" style="margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    ${reqAvatars[id]
                        ? `<img src="${reqAvatars[id]}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--accent);flex-shrink:0;" onerror="this.style.display='none'">`
                        : `<div style="width:40px;height:40px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">üë§</div>`}
                    <div><div style="font-weight:bold;">${data.name}</div><div style="font-size:11px;color:var(--secondary);">–•–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å</div></div>
                </div>
                <button class="btn" style="padding:8px 14px;font-size:12px;width:auto;" onclick="acceptFr('${id}','${data.name}')">‚úì –ü—Ä–∏–Ω—è—Ç—å</button>
            </div>`
        ).join('');

        // Load avatars + presence –¥–ª—è –¥—Ä—É–∑–µ–π
        const frEntries = Object.entries(frs);
        const frAvatars = {}, frCosmetics = {}, frPresence = {};
        await Promise.all(frEntries.map(async([id])=>{
            const [us, pr] = await Promise.all([
                get(ref(db,'users/'+id)),
                get(ref(db,'presence/'+id))
            ]);
            frAvatars[id] = us.exists()&&us.val().pic ? us.val().pic : '';
            frCosmetics[id] = us.exists() ? (us.val().activeCosmetic||{}) : {};
            const pVal = pr.exists() ? pr.val() : null;
            // –û–Ω–ª–∞–π–Ω –µ—Å–ª–∏ —Ñ–ª–∞–≥ true –∏ lastSeen –Ω–µ —Å—Ç–∞—Ä—à–µ 2 –º–∏–Ω—É—Ç
            frPresence[id] = pVal && pVal.online && (Date.now() - (pVal.lastSeen||0)) < 120000;
        }));

        document.getElementById('friends-list').innerHTML=frEntries.map(([id,data])=>{
            const isOnline = frPresence[id];
            const dotColor = isOnline ? '#2ecc71' : '#4a6080';
            const dotGlow = isOnline ? '0 0 6px rgba(46,204,113,0.8)' : 'none';
            const statusText = isOnline ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏';
            return `<div class="card" style="margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div style="display:flex;align-items:center;gap:12px;flex:1;cursor:pointer;" onclick="openUserProfile('${id}')">
                    <div style="position:relative;flex-shrink:0;">
                        ${frAvatars[id]
                            ? `<img src="${frAvatars[id]}" style="width:46px;height:46px;border-radius:50%;object-fit:cover;border:2px solid ${isOnline?'var(--green)':'rgba(255,255,255,0.1)'};display:block;" onerror="this.style.display='none'">`
                            : `<div style="width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#1a5fa8);display:flex;align-items:center;justify-content:center;font-size:22px;">üë§</div>`}
                        <div style="position:absolute;bottom:1px;right:1px;width:13px;height:13px;border-radius:50%;background:${dotColor};border:2px solid #070d14;box-shadow:${dotGlow};${isOnline?'animation:pulse 2s infinite;':''}"></div>
                    </div>
                    <div>
                        <div style="font-weight:bold;">${buildUsername({username:data.name, activeCosmetic:frCosmetics[id]||{}})}</div>
                        <div style="font-size:11px;color:${isOnline?'var(--green)':'var(--secondary)'};margin-top:2px;display:flex;align-items:center;gap:4px;">
                            <span>${statusText}</span>
                        </div>
                    </div>
                </div>
                <div style="display:flex;gap:6px;flex-shrink:0;">
                    <button onclick="openTradeModal('${id}','${data.name}')" style="background:rgba(46,204,113,0.12);border:1px solid rgba(46,204,113,0.3);color:var(--green);border-radius:10px;padding:8px 10px;font-size:15px;cursor:pointer;" title="–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–±–º–µ–Ω">üîÑ</button>
                    <button onclick="removeFriend('${id}','${data.name}')" style="background:rgba(231,76,60,0.12);border:1px solid rgba(231,76,60,0.3);color:var(--err);border-radius:10px;padding:8px 10px;font-size:16px;cursor:pointer;" title="–£–¥–∞–ª–∏—Ç—å –¥—Ä—É–≥–∞">üóëÔ∏è</button>
                </div>
            </div>`;
        }).join('')||(frEntries.length===0&&reqEntries.length===0?`<p style="color:var(--secondary);text-align:center;padding:30px;">–ù–µ—Ç –¥—Ä—É–∑–µ–π</p>`:'');
    }
    window.acceptFr = async (fid,fn) => {
        await update(ref(db,`users/${user.id}/friends/${fid}`),{name:fn});
        await update(ref(db,`users/${fid}/friends/${user.id}`),{name:user.name});
        await remove(ref(db,`users/${user.id}/requests/${fid}`));showToast("–î–æ–±–∞–≤–ª–µ–Ω!");
        getTgId(fid).then(cid=>sendTg(cid,`‚úÖ <b>–ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç!</b>\n\n<b>${user.name}</b> –ø—Ä–∏–Ω—è–ª —Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è.\n\nüë• –¢–µ–ø–µ—Ä—å –≤—ã –¥—Ä—É–∑—å—è ‚Äî –º–æ–∂–µ—Ç–µ –æ–±–º–µ–Ω–∏–≤–∞—Ç—å—Å—è –ø–æ–¥–∞—Ä–∫–∞–º–∏ –∏ –≤—ã–∑—ã–≤–∞—Ç—å –Ω–∞ –¥—É—ç–ª—å!`));
        logActivity('friend_add', {user: user.name, userId: user.id, friend: fn, friendId: fid});
    };
    window.removeFriend = async (fid, fname) => {
        const ok = await showConfirm('–£–¥–∞–ª–∏—Ç—å –¥—Ä—É–≥–∞', `–£–¥–∞–ª–∏—Ç—å @${fname} –∏–∑ –¥—Ä—É–∑–µ–π? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤–∞—Å –¥—Ä—É–≥ —É –¥—Ä—É–≥–∞.`, 'üóëÔ∏è', 'var(--err)', '–£–¥–∞–ª–∏—Ç—å');
        if(!ok) return;
        await remove(ref(db,`users/${user.id}/friends/${fid}`));
        await remove(ref(db,`users/${fid}/friends/${user.id}`));
        showToast('–î—Ä—É–≥ —É–¥–∞–ª—ë–Ω', 'var(--secondary)');
    };
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  üîÑ –û–ë–ú–ï–ù –ü–û–î–ê–†–ö–ê–ú–ò
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.openTradeModal = async (friendId, friendName) => {
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const myInv = d.cloudInv || [];
        if(!myInv.length) return showToast('–£ —Ç–µ–±—è –Ω–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤ –¥–ª—è –æ–±–º–µ–Ω–∞!','var(--err)');
        const makeCard = (x) => {
            const cat = catalog.find(c=>c.id==x.id);
            const img = (x.imgKey==='pan'?PAN_IMG:null)||x.img||(cat&&cat.img);
            const emoji = x.i||(cat&&cat.i)||'üéÅ';
            const isNFT = !!x.nft;
            return `<div onclick="selectTradeGift('${x.inst}',this)" data-inst="${x.inst}" style="cursor:pointer;text-align:center;background:#0a1520;border-radius:14px;padding:10px 8px;border:2px solid rgba(255,255,255,0.06);transition:all 0.2s;position:relative;" class="trade-gift-card">
                ${isNFT?`<div style="position:absolute;top:3px;right:3px;background:linear-gradient(90deg,#b8860b,#ffd700);color:#000;font-size:7px;font-weight:900;border-radius:5px;padding:1px 4px;">NFT</div>`:''}
                ${img?`<img src="${img}" style="width:44px;height:44px;object-fit:contain;display:block;margin:0 auto 5px;" onerror="this.style.display='none'">`:`<div style="font-size:36px;line-height:1;margin-bottom:5px;">${emoji}</div>`}
                <div style="font-size:10px;font-weight:bold;color:white;">${x.n}</div>
            </div>`;
        };
        document.getElementById('modal-content').innerHTML = `
            <div style="padding:5px 0;">
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="font-size:36px;animation:tradeArrow 1s ease infinite;">üîÑ</div>
                    <h3 style="margin:6px 0 4px;">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–±–º–µ–Ω</h3>
                    <div style="font-size:13px;color:var(--secondary);">—Å <b style="color:white;">${friendName}</b></div>
                </div>
                <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;margin-bottom:8px;">–í–´–ë–ï–†–ò –°–í–û–ô –ü–û–î–ê–†–û–ö:</div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-height:260px;overflow-y:auto;margin-bottom:14px;" id="trade-my-grid">
                    ${myInv.map(makeCard).join('')}
                </div>
                <div id="trade-selected-info" style="display:none;background:rgba(46,204,113,0.08);border:1px solid rgba(46,204,113,0.25);border-radius:14px;padding:10px;text-align:center;margin-bottom:12px;animation:tradeGlow 1.5s ease infinite;">
                    <div style="font-size:11px;color:var(--secondary);margin-bottom:4px;">–í–´–ë–†–ê–ù–û</div>
                    <div id="trade-selected-name" style="font-weight:bold;color:var(--green);"></div>
                </div>
                <button id="trade-send-btn" class="btn" style="background:var(--green);display:none;" onclick="sendTradeOffer('${friendId}','${friendName}')">üîÑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</button>
                <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);margin-top:8px;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>`;
        openModal();
    };

    let selectedTradeInst = null;
    window.selectTradeGift = (inst, el) => {
        selectedTradeInst = inst;
        document.querySelectorAll('.trade-gift-card').forEach(c=>{
            c.style.border = '2px solid rgba(255,255,255,0.06)';
            c.style.background = '#0a1520';
        });
        el.style.border = '2px solid var(--green)';
        el.style.background = 'rgba(46,204,113,0.1)';
        const name = el.querySelector('div[style*="font-weight:bold"]')?.innerText || '?';
        document.getElementById('trade-selected-info').style.display='block';
        document.getElementById('trade-selected-name').innerText = name;
        document.getElementById('trade-send-btn').style.display='block';
    };

    window.sendTradeOffer = async (friendId, friendName) => {
        if(!selectedTradeInst) return showToast('–í—ã–±–µ—Ä–∏ –ø–æ–¥–∞—Ä–æ–∫!','var(--err)');
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const inv = d.cloudInv||[];
        const itm = inv.find(x=>String(x.inst)==String(selectedTradeInst));
        if(!itm) return showToast('–ü–æ–¥–∞—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!','var(--err)');
        const offerKey = `${user.id}_${Date.now()}`;
        await set(ref(db,`tradeOffers/${friendId}/${offerKey}`),{
            fromId: user.id, fromName: user.name,
            itemInst: selectedTradeInst, itemName: itm.n, itemEmoji: itm.i||'üéÅ',
            ts: Date.now()
        });
        getTgId(friendId).then(cid=>sendTg(cid,`üîÑ <b>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞!</b>\n\n<b>${user.name}</b> –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ç–µ–±–µ:\nüéÅ <b>${itm.n} ${itm.i||''}</b>\n\nüì± –û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –î—Ä—É–∑—å—è ‚Üí –í—Ö–æ–¥—è—â–∏–µ –æ–±–º–µ–Ω—ã\n—á—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å.`));
        logActivity('trade_offer', {user: user.name, userId: user.id, toName: friendName, toId: friendId, item: itm.n, emoji: itm.i||'üéÅ'});
        closeModal();
        showToast(`üîÑ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${friendName}!`,'var(--green)');
    };

    window.acceptTradeOffer = async (offerKey, offer) => {
        // Show my gifts to pick what I give in return
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const myInv = d.cloudInv||[];
        if(!myInv.length) return showToast('–£ —Ç–µ–±—è –Ω–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤ –¥–ª—è –æ–±–º–µ–Ω–∞!','var(--err)');
        const makeCard = (x) => {
            const cat = catalog.find(c=>c.id==x.id);
            const img = (x.imgKey==='pan'?PAN_IMG:null)||x.img||(cat&&cat.img);
            const emoji = x.i||(cat&&cat.i)||'üéÅ';
            return `<div onclick="selectAcceptGift('${x.inst}',this)" data-inst="${x.inst}" style="cursor:pointer;text-align:center;background:#0a1520;border-radius:14px;padding:10px 8px;border:2px solid rgba(255,255,255,0.06);transition:all 0.2s;" class="accept-gift-card">
                ${img?`<img src="${img}" style="width:40px;height:40px;object-fit:contain;display:block;margin:0 auto 5px;" onerror="this.style.display='none'">`:`<div style="font-size:32px;line-height:1;margin-bottom:5px;">${emoji}</div>`}
                <div style="font-size:10px;font-weight:bold;color:white;">${x.n}</div>
            </div>`;
        };
        document.getElementById('modal-content').innerHTML = `
            <div style="padding:5px 0;">
                <div style="text-align:center;margin-bottom:14px;">
                    <div style="font-size:32px;">üîÑ</div>
                    <h3 style="margin:6px 0 4px;">–ü—Ä–∏–Ω—è—Ç—å –æ–±–º–µ–Ω</h3>
                    <div style="background:#0a1520;border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0;">
                        <div style="font-size:24px;">${offer.itemEmoji}</div>
                        <div>
                            <div style="font-size:11px;color:var(--secondary);">–û–¢ ${offer.fromName.toUpperCase()}</div>
                            <div style="font-weight:bold;">${offer.itemName}</div>
                        </div>
                    </div>
                    <div style="font-size:13px;color:var(--secondary);">‚ÜïÔ∏è –í—ã–±–µ—Ä–∏ —á—Ç–æ –æ—Ç–¥–∞—à—å –≤–∑–∞–º–µ–Ω:</div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-height:220px;overflow-y:auto;margin-bottom:14px;">
                    ${myInv.map(makeCard).join('')}
                </div>
                <div id="accept-selected-info" style="display:none;background:rgba(46,204,113,0.08);border:1px solid rgba(46,204,113,0.25);border-radius:14px;padding:8px;text-align:center;margin-bottom:12px;">
                    <div style="font-size:11px;color:var(--secondary);">–¢–´ –û–¢–î–ê–Å–®–¨</div>
                    <div id="accept-selected-name" style="font-weight:bold;color:var(--green);"></div>
                </div>
                <button id="accept-confirm-btn" class="btn" style="background:var(--green);display:none;" onclick="confirmTrade('${offerKey}','${offer.fromId}','${offer.itemInst}')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–±–º–µ–Ω</button>
                <button class="btn" style="background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);color:var(--err);margin-top:8px;" onclick="declineTrade('${offerKey}')">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);margin-top:8px;" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>`;
        openModal();
    };

    let selectedAcceptInst = null;
    window.selectAcceptGift = (inst, el) => {
        selectedAcceptInst = inst;
        document.querySelectorAll('.accept-gift-card').forEach(c=>{c.style.border='2px solid rgba(255,255,255,0.06)';c.style.background='#0a1520';});
        el.style.border='2px solid var(--green)';el.style.background='rgba(46,204,113,0.1)';
        const name = el.querySelector('div[style*="font-weight:bold"]')?.innerText||'?';
        document.getElementById('accept-selected-info').style.display='block';
        document.getElementById('accept-selected-name').innerText=name;
        document.getElementById('accept-confirm-btn').style.display='block';
    };

    window.confirmTrade = async (offerKey, fromId, theirInst) => {
        if(!selectedAcceptInst) return showToast('–í—ã–±–µ—Ä–∏ –ø–æ–¥–∞—Ä–æ–∫!','var(--err)');
        // Fetch both inventories
        const [mySnap, theirSnap] = await Promise.all([get(ref(db,'users/'+user.id)), get(ref(db,'users/'+fromId))]);
        const myD = mySnap.val(), theirD = theirSnap.val();
        let myInv = myD.cloudInv||[], theirInv = theirD.cloudInv||[];
        const myItem = myInv.find(x=>String(x.inst)==String(selectedAcceptInst));
        const theirItem = theirInv.find(x=>String(x.inst)==String(theirInst));
        if(!myItem) return showToast('–¢–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!','var(--err)');
        if(!theirItem) return showToast('–ü–æ–¥–∞—Ä–æ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ —É–∂–µ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω!','var(--err)');
        // Swap items
        myInv = myInv.filter(x=>String(x.inst)!=String(selectedAcceptInst));
        theirInv = theirInv.filter(x=>String(x.inst)!=String(theirInst));
        myInv.push({...theirItem, from:`üîÑ ${theirD.name}`, seen:false, inst:Date.now()});
        theirInv.push({...myItem, from:`üîÑ ${user.name}`, seen:false, inst:Date.now()+1});
        await Promise.all([
            update(ref(db,'users/'+user.id),{cloudInv:myInv}),
            update(ref(db,'users/'+fromId),{cloudInv:theirInv}),
            remove(ref(db,`tradeOffers/${user.id}/${offerKey}`))
        ]);
        getTgId(fromId).then(cid=>sendTg(cid,`üîÑ <b>–û–±–º–µ–Ω –∑–∞–≤–µ—Ä—à—ë–Ω!</b>\n\n<b>${user.name}</b> –ø—Ä–∏–Ω—è–ª —Ç–≤–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.\n\nüì• –¢—ã –ø–æ–ª—É—á–∏–ª: <b>${myItem.n} ${myItem.i||''}</b>\nüì§ –¢—ã –æ—Ç–¥–∞–ª: <b>${theirItem&&theirItem.n||'–ø–æ–¥–∞—Ä–æ–∫'}</b>`));
        closeModal();
        spawnConfetti(window.innerWidth/2,window.innerHeight/2,35);
        flyEmoji('üîÑ',window.innerWidth/2,window.innerHeight/2);
        showToast(`üîÑ –û–±–º–µ–Ω –∑–∞–≤–µ—Ä—à—ë–Ω! –¢—ã –ø–æ–ª—É—á–∏–ª ${theirItem.n}!`,'var(--green)');
    };

    window.declineTrade = async (offerKey) => {
        await remove(ref(db,`tradeOffers/${user.id}/${offerKey}`));
        closeModal();
        showToast('–û–±–º–µ–Ω –æ—Ç–∫–ª–æ–Ω—ë–Ω','var(--secondary)');
    };

    // Listen for incoming trade offers
    function listenTradeOffers() {
        onValue(ref(db,`tradeOffers/${user.id}`), snap => {
            const offers = snap.val()||{};
            const count = Object.keys(offers).length;
            let badge = document.getElementById('badge-trade');
            if(!badge) {
                badge = document.createElement('div');
                badge.id='badge-trade';
                badge.className='badge';
                badge.style.cssText='position:absolute;top:-4px;right:-4px;background:#e74c3c;color:white;font-size:9px;font-weight:bold;border-radius:50%;width:16px;height:16px;display:none;align-items:center;justify-content:center;z-index:5;';
                const frBtn = document.querySelector('.nav-btn[onclick*="friends"]');
                if(frBtn){frBtn.style.position='relative';frBtn.appendChild(badge);}
            }
            badge.innerText=count; badge.style.display=count>0?'flex':'none';
            // Render incoming trades in friends page
            const container = document.getElementById('trade-offers-section');
            if(container) renderTradeOffers(offers);
        });
    }

    function renderTradeOffers(offers) {
        const container = document.getElementById('trade-offers-section');
        if(!container) return;
        const entries = Object.entries(offers);
        if(!entries.length){container.innerHTML='';return;}
        container.innerHTML=`
            <div style="background:linear-gradient(135deg,rgba(46,204,113,0.08),rgba(46,204,113,0.03));border:1px solid rgba(46,204,113,0.25);border-radius:18px;padding:14px;margin-bottom:12px;">
                <div style="font-size:11px;font-weight:bold;color:var(--green);letter-spacing:0.5px;text-transform:uppercase;margin-bottom:10px;">üîÑ –í—Ö–æ–¥—è—â–∏–µ –æ–±–º–µ–Ω—ã (${entries.length})</div>
                ${entries.map(([key,offer])=>`
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;background:#0a1520;border-radius:12px;padding:10px 12px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.06);">
                        <div style="display:flex;align-items:center;gap:10px;flex:1;">
                            <div style="font-size:28px;">${offer.itemEmoji}</div>
                            <div>
                                <div style="font-weight:bold;font-size:13px;">${offer.itemName}</div>
                                <div style="font-size:11px;color:var(--secondary);">–æ—Ç ${offer.fromName}</div>
                            </div>
                        </div>
                        <button class="btn" style="padding:8px 14px;font-size:12px;width:auto;background:var(--green);" onclick='acceptTradeOffer("${key}",${JSON.stringify(offer)})'>üîÑ –ü—Ä–∏–Ω—è—Ç—å</button>
                    </div>
                `).join('')}
            </div>`;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ‚öîÔ∏è –î–£–≠–õ–¨ –ü–û–î–ê–†–ö–ê–ú–ò
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –û—Ç–∫—Ä—ã—Ç—å –¥—É—ç–ª—å –∏–∑ –Ω–∞–≤–±–∞—Ä–∞ ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ø–æ–¥–∞—Ä–∫–∞
    window.openDuelFromNav = async () => {
        const profBtn = document.querySelector('.nav-btn[onclick*="profile"]');
        tab('profile', profBtn);
        setTimeout(async () => {
            const s = await get(ref(db,'users/'+user.id)), d = s.val();
            const inv = d.cloudInv||[];
            if(!inv.length) return showToast('–£ —Ç–µ–±—è –Ω–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤ –¥–ª—è –¥—É—ç–ª–∏!','var(--err)');
            const friends = d.friends||{};
            if(!Object.keys(friends).length) return showToast('–ù–µ—Ç –¥—Ä—É–∑–µ–π –¥–ª—è –¥—É—ç–ª–∏!','var(--err)');
            const cat2 = (x) => { const c=catalog.find(cc=>cc.id==x.id); return x.img||(c&&c.img); };
            const emoji2 = (x) => { const c=catalog.find(cc=>cc.id==x.id); return x.i||(c&&c.i)||'üéÅ'; };
            document.getElementById('modal-content').innerHTML = `
                <h3>‚öîÔ∏è –í—ã–±–µ—Ä–∏ –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è –¥—É—ç–ª–∏</h3>
                <div style="display:flex;flex-wrap:wrap;gap:8px;max-height:320px;overflow-y:auto;padding:4px;">
                    ${inv.map(x=>{
                        const img=cat2(x), em=emoji2(x);
                        return `<div onclick="openDuelModal('${x.inst}')" style="cursor:pointer;text-align:center;background:#0a1520;border-radius:14px;padding:8px 6px;border:2px solid rgba(255,255,255,0.06);transition:all 0.2s;width:80px;height:80px;display:flex;flex-direction:column;align-items:center;justify-content:center;" onmouseover="this.style.borderColor='rgba(231,76,60,0.5)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.06)'">
                            ${img?`<img src="${img}" style="width:44px;height:44px;object-fit:contain;margin-bottom:4px;">`:`<span style="font-size:32px;line-height:1;margin-bottom:4px;">${em}</span>`}
                            <div style="font-size:9px;font-weight:bold;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:72px;">${x.n}</div>
                        </div>`;
                    }).join('')}
                </div>
                <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);margin-top:10px;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>`;
            openModal();
        }, 300);
    };

    window.openDuelModal = async (inst) => {
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const inv = d.cloudInv||[];
        const myItem = inv.find(x=>String(x.inst)==String(inst));
        if(!myItem) return showToast('–ü–æ–¥–∞—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!','var(--err)');
        const friends = d.friends||{};
        if(!Object.keys(friends).length) return showToast('–ù–µ—Ç –¥—Ä—É–∑–µ–π –¥–ª—è –¥—É—ç–ª–∏!','var(--err)');
        const cat = catalog.find(c=>c.id==myItem.id);
        const img = (myItem.imgKey==='pan'?PAN_IMG:null)||myItem.img||(cat&&cat.img);
        const emoji = myItem.i||(cat&&cat.i)||'üéÅ';
        document.getElementById('modal-content').innerHTML=`
            <div style="padding:5px 0;">
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="font-size:36px;">‚öîÔ∏è</div>
                    <h3 style="margin:6px 0 4px;background:linear-gradient(90deg,#ff6b6b,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">–î—É—ç–ª—å –ø–æ–¥–∞—Ä–∫–∞–º–∏</h3>
                    <div style="font-size:12px;color:var(--secondary);">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –∑–∞–±–∏—Ä–∞–µ—Ç –æ–±–∞ –ø–æ–¥–∞—Ä–∫–∞!</div>
                </div>
                <div style="background:#0a1520;border-radius:14px;padding:12px;text-align:center;margin-bottom:14px;border:2px solid rgba(255,107,107,0.3);">
                    <div style="font-size:11px;color:var(--secondary);margin-bottom:6px;">–¢–í–û–π –°–¢–ê–í–ö–ê</div>
                    ${img?`<img src="${img}" style="width:56px;height:56px;object-fit:contain;margin:0 auto 6px;display:block;">`:`<div style="font-size:44px;">${emoji}</div>`}
                    <div style="font-weight:bold;color:#ff6b6b;">${myItem.n}</div>
                </div>
                <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;margin-bottom:8px;">–í–´–ë–ï–†–ò –ü–†–û–¢–ò–í–ù–ò–ö–ê:</div>
                <div style="display:flex;flex-direction:column;gap:8px;max-height:220px;overflow-y:auto;margin-bottom:12px;">
                    ${Object.entries(friends).map(([fid,fd])=>`
                        <button class="btn" style="background:rgba(255,107,107,0.08);border:1px solid rgba(255,107,107,0.25);color:white;display:flex;align-items:center;gap:10px;padding:12px;" onclick="startDuel('${inst}','${fid}','${fd.name}')">
                            <span style="font-size:20px;">üë§</span>
                            <span style="font-weight:bold;">${fd.name}</span>
                            <span style="margin-left:auto;font-size:18px;">‚öîÔ∏è</span>
                        </button>
                    `).join('')}
                </div>
                <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>`;
        openModal();
    };

    window.startDuel = async (myInst, friendId, friendName) => {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
        const dPrivSnap=await get(ref(db,'users/'+friendId));
        const dPriv=(dPrivSnap.val()&&dPrivSnap.val().privacy)||{};
        if(dPriv.allowDuel===false) return showToast(`‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤—ã–∑–≤–∞—Ç—å ${friendName} –Ω–∞ –¥—É—ç–ª—å –∏–∑-–∑–∞ –µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏`,'var(--err)');
        // Send duel challenge
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const myItem = (d.cloudInv||[]).find(x=>String(x.inst)==String(myInst));
        if(!myItem) return showToast('–ü–æ–¥–∞—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!','var(--err)');
        const duelKey = `${user.id}_${Date.now()}`;
        await set(ref(db,`duelChallenges/${friendId}/${duelKey}`),{
            fromId:user.id, fromName:user.name,
            itemInst:myInst, itemName:myItem.n, itemEmoji:myItem.i||'üéÅ',
            ts:Date.now(), expiresAt: Date.now() + 15*60*1000
        });
        // –ê–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç
        setTimeout(async () => {
            try {
                const snap = await get(ref(db,`duelChallenges/${friendId}/${duelKey}`));
                if(snap.exists()) await remove(ref(db,`duelChallenges/${friendId}/${duelKey}`));
            } catch(e){}
        }, 15*60*1000);
        getTgId(friendId).then(cid=>sendTg(cid,`‚öîÔ∏è <b>–í—ã–∑–æ–≤ –Ω–∞ –¥—É—ç–ª—å!</b>\n\n<b>${user.name}</b> –±—Ä–æ—Å–∞–µ—Ç —Ç–µ–±–µ –≤—ã–∑–æ–≤!\n\nüéØ –ï–≥–æ —Å—Ç–∞–≤–∫–∞: <b>${myItem.n} ${myItem.i||''}</b>\nüèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –∑–∞–±–µ—Ä—ë—Ç –æ–±–∞ –ø–æ–¥–∞—Ä–∫–∞!\n\nüì± –û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –î—Ä—É–∑—å—è ‚Üí –î—É—ç–ª–∏`));
        logActivity('duel_challenge', {user: user.name, userId: user.id, toName: friendName, toId: friendId, item: myItem.n, emoji: myItem.i||'üéÅ'});
        closeModal();
        showToast(`‚öîÔ∏è –í—ã–∑–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ${friendName}!`,'#ff6b6b','‚öîÔ∏è');
    };

    window.acceptDuelChallenge = async (duelKey, challenge) => {
        // Show your gifts to pick your stake
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const myInv = d.cloudInv||[];
        if(!myInv.length) return showToast('–£ —Ç–µ–±—è –Ω–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤ –¥–ª—è –¥—É—ç–ª–∏!','var(--err)');
        const makeCard = (x) => {
            const cat = catalog.find(c=>c.id==x.id);
            const img = (x.imgKey==='pan'?PAN_IMG:null)||x.img||(cat&&cat.img);
            const emoji = x.i||(cat&&cat.i)||'üéÅ';
            return `<div onclick="selectDuelGift('${x.inst}',this)" style="cursor:pointer;text-align:center;background:#0a1520;border-radius:14px;padding:10px 8px;border:2px solid rgba(255,255,255,0.06);transition:all 0.2s;" class="duel-my-card">
                ${img?`<img src="${img}" style="width:40px;height:40px;object-fit:contain;display:block;margin:0 auto 5px;" onerror="this.style.display='none'">`:`<div style="font-size:32px;line-height:1;margin-bottom:5px;">${emoji}</div>`}
                <div style="font-size:10px;font-weight:bold;color:white;">${x.n}</div>
            </div>`;
        };
        document.getElementById('modal-content').innerHTML=`
            <div style="padding:5px 0;">
                <div style="text-align:center;margin-bottom:14px;">
                    <div style="font-size:32px;">‚öîÔ∏è</div>
                    <h3 style="margin:6px 0 4px;background:linear-gradient(90deg,#ff6b6b,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">–î—É—ç–ª—å!</h3>
                    <div style="background:#0a1520;border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0;border:1px solid rgba(255,107,107,0.3);">
                        <div style="font-size:24px;">${challenge.itemEmoji}</div>
                        <div><div style="font-size:11px;color:var(--secondary);">–°–¢–ê–í–ö–ê ${challenge.fromName.toUpperCase()}</div><div style="font-weight:bold;color:#ff6b6b;">${challenge.itemName}</div></div>
                    </div>
                    <div style="font-size:12px;color:var(--secondary);">–í—ã–±–µ—Ä–∏ —Å–≤–æ—é —Å—Ç–∞–≤–∫—É:</div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-height:220px;overflow-y:auto;margin-bottom:14px;">
                    ${myInv.map(makeCard).join('')}
                </div>
                <div id="duel-selected-info" style="display:none;background:rgba(255,107,107,0.08);border:1px solid rgba(255,107,107,0.3);border-radius:14px;padding:8px;text-align:center;margin-bottom:12px;">
                    <div style="font-size:11px;color:var(--secondary);">–¢–í–û–Ø –°–¢–ê–í–ö–ê</div>
                    <div id="duel-selected-name" style="font-weight:bold;color:#ff6b6b;"></div>
                </div>
                <button id="duel-fight-btn" class="btn" style="background:linear-gradient(90deg,#e74c3c,#c0392b);display:none;" onclick="fightDuel('${duelKey}','${challenge.fromId}','${challenge.itemInst}','${challenge.fromName}','${challenge.itemEmoji}','${challenge.itemName}')">‚öîÔ∏è –í –ë–û–ô!</button>
                <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);margin-top:8px;" onclick="declineDuel('${duelKey}')">üè≥Ô∏è –û—Ç–∫–∞–∑–∞—Ç—å—Å—è</button>
            </div>`;
        openModal();
    };

    let selectedDuelInst = null, selectedDuelEmoji = 'üéÅ', selectedDuelName = '';
    window.selectDuelGift = (inst, el) => {
        selectedDuelInst = inst;
        document.querySelectorAll('.duel-my-card').forEach(c=>{c.style.border='2px solid rgba(255,255,255,0.06)';c.style.background='#0a1520';});
        el.style.border='2px solid #ff6b6b';el.style.background='rgba(255,107,107,0.1)';
        const imgEl = el.querySelector('img');
        selectedDuelEmoji = el.querySelector('div[style*="font-size:32px"]')?.innerText || 'üéÅ';
        selectedDuelName = el.querySelector('div[style*="font-weight:bold"]')?.innerText||'?';
        document.getElementById('duel-selected-info').style.display='block';
        document.getElementById('duel-selected-name').innerText=selectedDuelName;
        document.getElementById('duel-fight-btn').style.display='block';
    };

    window.fightDuel = async (duelKey, challengerId, theirInst, challengerName, theirEmoji, theirItemName) => {
        if(!selectedDuelInst) return showToast('–í—ã–±–µ—Ä–∏ —Å—Ç–∞–≤–∫—É!','var(--err)');

        // Fetch both inventories
        const [mySnap, theirSnap] = await Promise.all([get(ref(db,'users/'+user.id)), get(ref(db,'users/'+challengerId))]);
        const myD = mySnap.val(), theirD = theirSnap.val();
        let myInv = myD.cloudInv||[], theirInv = theirD.cloudInv||[];
        const myItem = myInv.find(x=>String(x.inst)==String(selectedDuelInst));
        const theirItem = theirInv.find(x=>String(x.inst)==String(theirInst));
        if(!myItem||!theirItem) { closeModal(); return showToast('–û–¥–∏–Ω –∏–∑ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ —É–∂–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!','var(--err)'); }

        // Determine winner 50/50
        const iWin = Math.random() < 0.5;
        const winnerId = iWin ? user.id : challengerId;
        const winnerName = iWin ? user.name : challengerName;
        const myEmoji2 = myItem.i||(catalog.find(c=>c.id==myItem.id)?.i)||'üéÅ';

        // Update inventories
        if(iWin) {
            myInv = myInv.filter(x=>String(x.inst)!=String(selectedDuelInst));
            theirInv = theirInv.filter(x=>String(x.inst)!=String(theirInst));
            myInv.push({...myItem, from:`‚öîÔ∏è –î—É—ç–ª—å`, inst:Date.now()});
            myInv.push({...theirItem, from:`‚öîÔ∏è ${challengerName}`, seen:false, inst:Date.now()+1});
        } else {
            myInv = myInv.filter(x=>String(x.inst)!=String(selectedDuelInst));
            theirInv = theirInv.filter(x=>String(x.inst)!=String(theirInst));
            theirInv.push({...myItem, from:`‚öîÔ∏è ${user.name}`, seen:false, inst:Date.now()});
            theirInv.push({...theirItem, from:`‚öîÔ∏è –î—É—ç–ª—å`, inst:Date.now()+1});
        }

        await Promise.all([
            update(ref(db,'users/'+user.id),{cloudInv:myInv}),
            update(ref(db,'users/'+challengerId),{cloudInv:theirInv}),
            remove(ref(db,`duelChallenges/${user.id}/${duelKey}`))
        ]);
        logActivity('duel_result', {winner: winnerName, winnerId, loser: iWin ? challengerName : user.name, loserId: iWin ? challengerId : user.id, item1: myItem.n, item2: theirItem.n});
        // –¢—Ä–µ–∫–∞–µ–º –ø–æ–±–µ–¥—ã –∏ –≤—ã–¥–∞—ë–º –±–µ–π–¥–∂
        if(iWin) {
            const newWins = (myD.duelWins||0) + 1;
            const winsUpdate = {duelWins: newWins};
            const ownedSet = new Set(myD.cosmetics||[]);
            if(newWins >= 10 && !ownedSet.has('bdg_duelist')) {
                winsUpdate.cosmetics = [...(myD.cosmetics||[]), 'bdg_duelist'];
            }
            await update(ref(db,'users/'+user.id), winsUpdate);
        }

        // DUEL ANIMATION
        const overlay = document.getElementById('modal-overlay');
        document.getElementById('modal-content').innerHTML = `
            <div style="text-align:center;padding:20px 0;" id="duel-anim-wrap">
                <div style="font-size:13px;color:var(--secondary);margin-bottom:20px;letter-spacing:1px;text-transform:uppercase;">‚öîÔ∏è –î—É—ç–ª—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!</div>
                <div style="display:flex;align-items:center;justify-content:center;gap:20px;">
                    <div id="duel-left" style="text-align:center;transition:all 1s ease;">
                        <div style="font-size:52px;margin-bottom:8px;">${myEmoji2}</div>
                        <div style="font-size:12px;font-weight:bold;color:#4db4ff;">${user.name}</div>
                    </div>
                    <div id="duel-vs" style="font-size:32px;font-weight:900;color:#ff6b6b;">VS</div>
                    <div id="duel-right" style="text-align:center;transition:all 1s ease;">
                        <div style="font-size:52px;margin-bottom:8px;">${theirEmoji}</div>
                        <div style="font-size:12px;font-weight:bold;color:#ff6b6b;">${challengerName}</div>
                    </div>
                </div>
                <div id="duel-result" style="margin-top:24px;opacity:0;transition:opacity 0.5s;"></div>
            </div>`;

        // Phase 1: shake
        setTimeout(()=>{
            document.getElementById('duel-left').style.animation='duelShakeL 0.4s ease-in-out 4';
            document.getElementById('duel-right').style.animation='duelShakeR 0.4s ease-in-out 4';
            overlay.style.animation='duelFlash 0.4s ease 4';
        },300);

        // Phase 2: clash emoji
        setTimeout(()=>{
            const el=document.createElement('div');el.className='duel-clash-emoji';el.innerText='üí•';
            document.body.appendChild(el);setTimeout(()=>el.remove(),900);
        },900);

        // Phase 3: result
        setTimeout(()=>{
            overlay.style.animation='';
            if(iWin){
                document.getElementById('duel-left').style.animation='duelWinner 0.6s ease forwards';
                document.getElementById('duel-right').style.animation='duelLoser 0.6s ease forwards';
            } else {
                document.getElementById('duel-right').style.animation='duelWinner 0.6s ease forwards';
                document.getElementById('duel-left').style.animation='duelLoser 0.6s ease forwards';
            }
        },1800);

        // Phase 4: show result text
        setTimeout(()=>{
            const res=document.getElementById('duel-result');
            if(!res) return;
            res.style.opacity='1';
            if(iWin){
                spawnConfetti(window.innerWidth/2,window.innerHeight/2,60);
                const newWins2 = (myD.duelWins||0) + 1;
                const badgeJustUnlocked = newWins2 >= 10 && !new Set(myD.cosmetics||[]).has('bdg_duelist');
                res.innerHTML=`<div style="font-size:36px;margin-bottom:10px;">üèÜ</div><div style="font-size:20px;font-weight:900;color:gold;">–¢–´ –ü–û–ë–ï–î–ò–õ!</div><div style="font-size:13px;color:var(--secondary);margin-top:6px;">–¢—ã –ø–æ–ª—É—á–∏–ª –æ–±–∞ –ø–æ–¥–∞—Ä–∫–∞</div><div style="font-size:12px;color:#4db4ff;margin-top:8px;">‚öîÔ∏è –ü–æ–±–µ–¥: ${newWins2}/10</div>${badgeJustUnlocked?'<div style="margin-top:10px;background:linear-gradient(135deg,rgba(255,107,107,0.15),rgba(255,215,0,0.1));border:1px solid rgba(255,215,0,0.4);border-radius:14px;padding:10px;"><div style="font-size:22px;">‚öîÔ∏è</div><div style="font-weight:bold;color:gold;font-size:13px;">–ë–µ–π–¥–∂ ¬´–î—É—ç–ª—è–Ω—Ç¬ª —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!</div></div>':''}`;
                if(badgeJustUnlocked) setTimeout(()=>showToast('‚öîÔ∏è –ë–µ–π–¥–∂ ¬´–î—É—ç–ª—è–Ω—Ç¬ª —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!','gold'), 500);
            } else {
                res.innerHTML=`<div style="font-size:36px;margin-bottom:10px;">üíÄ</div><div style="font-size:20px;font-weight:900;color:#ff6b6b;">–¢–´ –ü–†–û–ò–ì–†–ê–õ</div><div style="font-size:13px;color:var(--secondary);margin-top:6px;">${challengerName} –∑–∞–±—Ä–∞–ª –æ–±–∞ –ø–æ–¥–∞—Ä–∫–∞</div>`;
            }
            setTimeout(()=>{
                if(!document.getElementById('duel-close-btn')){
                    const btn=document.createElement('button');btn.className='btn';btn.id='duel-close-btn';btn.style.marginTop='16px';btn.innerText='–ó–∞–∫—Ä—ã—Ç—å';btn.onclick=closeModal;
                    document.getElementById('duel-result').appendChild(btn);
                }
            },200);
        },2600);

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏
        if(iWin) {
            // challenger –ø—Ä–æ–∏–≥—Ä–∞–ª —Å–≤–æ—é —Å—Ç–∞–≤–∫—É (theirItem)
            getTgId(challengerId).then(cid=>sendTg(cid,`‚öîÔ∏è <b>–î—É—ç–ª—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</b>\n\nüèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: <b>${winnerName}</b>\n\nüòî –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ç—ã –ø—Ä–æ–∏–≥—Ä–∞–ª.\n‚ùå –£—Ç–µ—Ä—è–Ω–æ: <b>${theirItemName}</b> ${theirEmoji}`));
        } else {
            // challenger –≤—ã–∏–≥—Ä–∞–ª –æ–±–∞ –ø—Ä–µ–¥–º–µ—Ç–∞
            getTgId(challengerId).then(cid=>sendTg(cid,`‚öîÔ∏è <b>–î—É—ç–ª—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</b>\n\nüèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: <b>${winnerName}</b>\n\nüéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, —Ç—ã –ø–æ–±–µ–¥–∏–ª!\n‚úÖ –ü–æ–ª—É—á–µ–Ω–æ: <b>${theirItemName}</b> ${theirEmoji}\n‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: <b>${myItem.n}</b> ${myEmoji2}`));
        }
    };

    window.declineDuel = async (duelKey) => {
        await remove(ref(db,`duelChallenges/${user.id}/${duelKey}`));
        closeModal();
        showToast('–í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω—ë–Ω','var(--secondary)');
    };

    // Listen for duel challenges
    function listenDuelChallenges() {
        onValue(ref(db,`duelChallenges/${user.id}`), snap => {
            const challenges = snap.val()||{};
            renderDuelChallenges(challenges);
        });
        // –û–±–Ω–æ–≤–ª—è—Ç—å —Ç–∞–π–º–µ—Ä—ã –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫ + —É–¥–∞–ª—è—Ç—å –∏—Å—Ç—ë–∫—à–∏–µ
        setInterval(async () => {
            const snap = await get(ref(db,`duelChallenges/${user.id}`));
            const challenges = snap.val()||{};
            const now = Date.now();
            for(const [key, ch] of Object.entries(challenges)) {
                const expiry = ch.expiresAt || (ch.ts + 15*60*1000);
                if(now >= expiry) remove(ref(db,`duelChallenges/${user.id}/${key}`)).catch(()=>{});
            }
            renderDuelChallenges(challenges);
        }, 30000);
    }

    function renderDuelChallenges(challenges) {
        const container = document.getElementById('duel-challenges-section');
        if(!container) return;
        const now = Date.now();
        // –§–∏–ª—å—Ç—Ä—É–µ–º –∏—Å—Ç—ë–∫—à–∏–µ (–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ UI)
        const entries = Object.entries(challenges).filter(([k,ch]) => {
            const expiry = ch.expiresAt || (ch.ts + 15*60*1000);
            return now < expiry;
        });
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ ‚öîÔ∏è
        const badge = document.getElementById('badge-duel');
        if(badge) { badge.style.display = entries.length > 0 ? 'flex' : 'none'; badge.textContent = entries.length; }
        if(!entries.length){container.innerHTML='';return;}
        container.innerHTML=`
            <div style="background:linear-gradient(135deg,rgba(255,107,107,0.08),rgba(255,107,107,0.03));border:1px solid rgba(255,107,107,0.3);border-radius:18px;padding:14px;margin-bottom:12px;">
                <div style="font-size:11px;font-weight:bold;color:#ff6b6b;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:10px;">‚öîÔ∏è –í—ã–∑–æ–≤—ã –Ω–∞ –¥—É—ç–ª—å (${entries.length})</div>
                ${entries.map(([key,ch])=>{
                    const expiry = ch.expiresAt||(ch.ts+15*60*1000);
                    const mLeft = Math.max(0,Math.floor((expiry-now)/60000));
                    const sLeft = Math.max(0,Math.floor(((expiry-now)%60000)/1000));
                    return `<div style="display:flex;align-items:center;justify-content:space-between;gap:10px;background:#0a1520;border-radius:12px;padding:10px 12px;margin-bottom:8px;border:1px solid rgba(255,107,107,0.2);">
                        <div style="display:flex;align-items:center;gap:10px;flex:1;">
                            <div style="font-size:28px;">${ch.itemEmoji}</div>
                            <div>
                                <div style="font-weight:bold;font-size:13px;">${ch.itemName}</div>
                                <div style="font-size:11px;color:var(--secondary);">–æ—Ç ${ch.fromName}</div>
                                <div style="font-size:10px;color:var(--orange);">‚è≥ ${mLeft}:${String(sLeft).padStart(2,'0')}</div>
                            </div>
                        </div>
                        <button class="btn" style="padding:8px 14px;font-size:12px;width:auto;background:linear-gradient(90deg,#e74c3c,#c0392b);" onclick='acceptDuelChallenge("${key}",${JSON.stringify(ch)})'>‚öîÔ∏è –ü—Ä–∏–Ω—è—Ç—å</button>
                    </div>`;
                }).join('')}
            </div>`;
    }

    window.giftOpen = async (inst) => {
        const s=await get(ref(db,'users/'+user.id)),frs=s.val().friends||{};
        if(!Object.keys(frs).length) return showToast("–ù–µ—Ç –¥—Ä—É–∑–µ–π!",'var(--err)');
        document.getElementById('modal-content').innerHTML=`
            <h3>–ü–æ–¥–∞—Ä–∏—Ç—å</h3>
            <div style="max-height:200px;overflow-y:auto;">
                ${Object.entries(frs).map(([id,d])=>`<button class="btn" style="margin-bottom:10px;" onclick="sendG('${inst}','${id}')">üéÅ ${d.name}</button>`).join('')}
            </div>
            <button class="btn" style="background:none;margin-top:5px;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>`;
        openModal();
    };
    window.sendG = async (inst,fid) => {
        const r=ref(db,'users/'+user.id),s=await get(r),d=s.val();
        const inv=d.cloudInv||[],itm=inv.find(x=>x.inst==inst);
        if(!itm) return showToast("–ù–µ –Ω–∞–π–¥–µ–Ω!",'var(--err)');
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        const frSnap2=await get(ref(db,'users/'+fid));
        const frPrivacy=(frSnap2.val()&&frSnap2.val().privacy)||{};
        if(frPrivacy.allowGifts===false) return showToast("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫ —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–∑-–∑–∞ –µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏",'var(--err)');
        const newGiven=(d.giftsGiven||0)+1;
        await update(r,{cloudInv:inv.filter(x=>x.inst!=inst),pinnedInsts:(d.pinnedInsts||[]).filter(id=>String(id)!=String(inst)),giftsGiven:newGiven});
        const frS=await get(ref(db,'users/'+fid)),frInv=frS.val().cloudInv||[];
        frInv.push({...itm,from:user.name,seen:false,inst:Date.now()});
        await update(ref(db,'users/'+fid),{cloudInv:frInv,giftsReceived:(frS.val().giftsReceived||0)+1});
        getTgId(fid).then(cid=>sendTg(cid,`üéÅ <b>–ù–æ–≤—ã–π –ø–æ–¥–∞—Ä–æ–∫!</b>\n\n<b>${user.name}</b> –ø–æ–¥–∞—Ä–∏–ª —Ç–µ–±–µ:\n${itm.i||'üéÅ'} <b>${itm.n}</b>\n\nüè∑ –†–µ–¥–∫–æ—Å—Ç—å: <b>${RARITY_LEVELS[itm.r]&&RARITY_LEVELS[itm.r].label||'–û–±—ã—á–Ω—ã–π'}</b>\n\n–û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å!`));
        closeModal();spawnConfetti(window.innerWidth/2,window.innerHeight/2,40);
        flyEmoji('üéÅ',window.innerWidth/2,window.innerHeight/2);
        showToast("–ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! üéÅ",'var(--green)');
        logActivity('gift_sent', {user: user.name, userId: user.id, toId: fid, item: itm.n, emoji: itm.i||'üéÅ'});
        renderInv();
    };
    function renderMyProfile(d) {
        const inv = d.cloudInv || [];
        const friends = d.friends || {};
        const friendCount = Object.keys(friends).length;

        const pinnedInsts = new Set((d.pinnedInsts||[]).map(String));
        const sortedInv = [
            ...inv.filter(x => pinnedInsts.has(String(x.inst))),
            ...inv.filter(x => !pinnedInsts.has(String(x.inst)))
        ];

        const makeGiftCell = (x) => {
            const cat = catalog.find(c => c.id == x.id);
            const img = (x.imgKey==='pan'?PAN_IMG:null) || x.img || (cat && cat.img);
            const emoji = x.i || (cat && cat.i) || 'üéÅ';
            const isPin = pinnedInsts.has(String(x.inst));
            const isNFT = !!x.nft;
            const isLizard = isNFT && x.id === 997;
            const nftClass = isNFT ? (isLizard ? ' tg-gift-nft-lizard' : ' tg-gift-nft') : '';
            const nftPrice = isNFT ? (x.id===997?7000:x.id===998?10000:x.id===999?5000:(x.price||0)) : 0;
            // NFT upgrade
            const upgClasses = isNFT ? getNftUpgradeClasses(x) : '';
            const upgBadge = isNFT ? getNftUpgradeBadge(x) : '';
            const particleHtml = isNFT ? getNftParticleHtml(x) : '';
            return `<div class="tg-gift-cell${nftClass}${isPin?' tg-gift-pinned':''}${upgClasses?' '+upgClasses:''}" onclick="openGiftDetail('${x.inst}')" style="position:relative;">
                ${isNFT ? `<div class="tg-gift-nft-badge">NFT</div>` : ''}
                ${upgBadge}
                ${particleHtml}
                ${isPin ? `<div style="position:absolute;top:5px;left:5px;font-size:12px;z-index:3;filter:drop-shadow(0 1px 3px rgba(0,0,0,0.8));">üìå</div>` : ''}
                <div class="tg-gift-inner">
                    ${img ? `<img src="${img}" alt="${x.n}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><span style="display:none;font-size:34px;">${emoji}</span>` : `<span style="font-size:34px;">${emoji}</span>`}
                    ${x.from ? `<div class="tg-gift-from">${x.from}</div>` : ''}
                </div>
                ${isNFT && x.nftSerial ? `<div class="tg-gift-nft-serial">#${x.nftSerial}</div>` : ''}
                <div class="tg-gift-name">${x.n}</div>
                ${isNFT ? `<div class="tg-gift-nft-price">${nftPrice.toLocaleString()}üí∞</div>` : ''}
            </div>`;
        };

        const giftsGrid = sortedInv.length ? sortedInv.map(makeGiftCell).join('') 
        : `<div style="grid-column:1/-1;text-align:center;padding:40px 20px;color:var(--secondary);">
            <div style="font-size:48px;margin-bottom:12px;">üéÅ</div>
            <div style="font-size:14px;">–ü–æ–¥–∞—Ä–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
            <div style="font-size:12px;margin-top:6px;opacity:0.6;">–ö—É–ø–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ –∏–ª–∏ –ø–æ–ø—Ä–æ—Å–∏ –¥—Ä—É–≥–∞</div>
        </div>`;

        document.getElementById('profile').innerHTML = `
        <div class="tg-profile">
            <div class="tg-profile-hero">
                <div class="avatar-ring-wrap">
                    ${(() => {
                        const pinnedArr = [...pinnedInsts]
                            .map(inst => inv.find(x => String(x.inst) === String(inst)))
                            .filter(item => item && item.nft)
                            .slice(0, 6);
                        if(!pinnedArr.length) return '';
                        const angle = 360 / pinnedArr.length;
                        const radius = 72; // centre=100, avatar radius=50 + gap 8 + item half 14 = 72
                        return `<div class="avatar-ring-orbit" style="position:absolute;top:0;left:0;width:200px;height:200px;pointer-events:none;">${pinnedArr.map((item, i) => {
                            const cat2 = catalog.find(c => c.id == item.id);
                            const img2 = item.img || (cat2 && cat2.img);
                            const em2 = item.i || (cat2 && cat2.i) || 'üéÅ';
                            const rad = (angle * i - 90) * Math.PI / 180;
                            const x2 = Math.round(100 + radius * Math.cos(rad) - 14);
                            const y2 = Math.round(100 + radius * Math.sin(rad) - 14);
                            const upgCls2 = item.upgrade && item.upgrade.level ? getNftUpgradeClasses(item) : '';
                            const upgStyle2 = (()=>{
                                if(!item.upgrade||!item.upgrade.level) return '';
                                const lvlD=NFT_UPGRADE_LEVELS[item.upgrade.level];
                                const thD=lvlD&&lvlD.themes&&lvlD.themes.find(t=>t.id===item.upgrade.theme);
                                if(!thD) return '';
                                if(item.upgrade.level===1){
                                    const c={fire:'255,80,0',ocean:'0,150,255',forest:'0,200,80',galaxy:'150,50,255',sunset:'255,100,150'}[item.upgrade.theme];
                                    return c?`border-color:rgba(${c},0.9);box-shadow:0 0 10px rgba(${c},0.6),0 2px 10px rgba(0,0,0,0.6);`:'';
                                }
                                if(item.upgrade.level>=3){
                                    const c={fire:'255,80,0',ocean:'0,150,255',forest:'0,200,80',galaxy:'150,50,255',sunset:'255,100,150'}[item.upgrade.theme];
                                    return c?`border-color:rgba(${c},0.9);box-shadow:0 0 14px rgba(${c},0.8),0 2px 10px rgba(0,0,0,0.6);`:'';
                                }
                                return '';
                            })();
                            return `<div class="avatar-ring-item ring-nft ${upgCls2}" style="left:${x2}px;top:${y2}px;${upgStyle2}" data-inst="${item.inst}">${img2?'<img src="'+img2+'" onerror="this.style.display=\'none\'">':'<span>'+em2+'</span>'}</div>`;
                        }).join('')}</div>`;
                    })()}
                    <div class="tg-avatar-wrap" style="position:relative;z-index:2;margin:0;flex-shrink:0;">
                        <img src="${d.pic || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
                             class="tg-avatar" onclick="openEdit()"
                             onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                        <div class="tg-avatar-edit" onclick="openEdit()">‚úèÔ∏è</div>
                    </div>
                </div>
                <h2 class="tg-username">${buildUsername(d)}</h2>
                <p class="tg-bio">${d.bio || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                <div class="tg-stats">
                    <div class="tg-stat"><div class="tg-stat-val">${inv.length}</div><div class="tg-stat-lbl">–ü–æ–¥–∞—Ä–∫–æ–≤</div></div>
                    <div class="tg-stat-div"></div>
                    <div class="tg-stat"><div class="tg-stat-val">${friendCount}</div><div class="tg-stat-lbl">–î—Ä—É–∑–µ–π</div></div>
                    <div class="tg-stat-div"></div>
                    <div class="tg-stat"><div class="tg-stat-val">${(d.balance||0).toLocaleString()}</div><div class="tg-stat-lbl">üí∞ –ú–æ–Ω–µ—Ç</div></div>
                </div>
                <div class="tg-actions">
                    <button class="tg-action-btn" onclick="openEdit()"><span class="tg-action-icon">‚öôÔ∏è</span><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
                    <button class="tg-action-btn" onclick="openPromoModal()"><span class="tg-action-icon">üéüÔ∏è</span><span>–ü—Ä–æ–º–æ–∫–æ–¥</span></button>
                    ${inv.some(x=>x.nft) ? `<button class="tg-action-btn" style="background:rgba(124,58,237,0.15);border:1px solid rgba(124,58,237,0.3);" onclick="openNftUpgradeSelect()"><span class="tg-action-icon">‚ö°</span><span>–ü—Ä–æ–∫–∞—á–∫–∞</span></button>` : ''}
                    <button class="tg-action-btn tg-action-tg" onclick="window.open('https://t.me/Gifts_World_Pro','_blank')"><span class="tg-action-icon">üì¢</span><span>–ö–∞–Ω–∞–ª</span></button>
                    <button class="tg-action-btn tg-action-red" onclick="logout()"><span class="tg-action-icon">üö™</span><span>–í—ã—Ö–æ–¥</span></button>
                </div>
            </div>
            <div class="tg-gifts-section">
                <div class="tg-gifts-header">
                    <span>üéÅ –ü–æ–¥–∞—Ä–∫–∏</span>
                    <span class="tg-gifts-count">${inv.length}</span>
                </div>
                <div class="tg-gifts-grid">${giftsGrid}</div>
            </div>
            <div style="padding:0 15px 15px;">
                <a href="https://dalink.to/gifworld" target="_blank" class="btn" style="background:#1a2636;border:1px solid rgba(255,255,255,0.08);color:var(--secondary);font-size:13px;">üíé –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</a>
            </div>
            <div style="padding:4px 0 20px;text-align:center;">
                <span style="font-size:9px;color:#131f2c;letter-spacing:0.3px;cursor:default;">—Å–ø–∞—Å–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –æ–Ω–∏ —Å–∫–∞–∑–∞–ª–∏ –µ—Å–ª–∏ —è –Ω–µ –±—É–¥—É –ø–∏—Å–∞—Ç—å –∫–æ–¥ —Ç–æ –æ–Ω–∏ –Ω–µ –±—É–¥—É—Ç –º–µ–Ω—è –∫–æ—Ä–º–∏—Ç—å</span>
            </div>
        </div>`;
    }

    window.openGiftDetail = async (inst) => {
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const inv = d.cloudInv || [];
        const x = inv.find(i => String(i.inst) == String(inst));
        if (!x) return;
        const cat = catalog.find(c => c.id == x.id);
        const img = (x.imgKey==='pan'?PAN_IMG:null) || x.img || (cat && cat.img);
        const emoji = x.i || (cat && cat.i) || 'üéÅ';
        const frs = d.friends || {};
        const isPinned = (d.pinnedInsts||[]).some(id => String(id) == String(inst));

        const rarObj2 = getRarityObj(x);
        const rarLevel2 = getRarityLevel(x);

        const price = x.nft ? 5000 : getPrice(x.id||0);
        const rarMultiplier = x.nft ? 1 : [1, 2, 5, 15][rarLevel2] || 1;
        const marketPrice = x.nft ? (x.id===997?7000:x.id===998?10000:x.id===999?5000:5000) : Math.round(price * rarMultiplier);
        const origin = x.from ? (x.from === 'PROMO' ? 'üéüÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥' : x.from === 'ADMIN' ? 'üõ†Ô∏è –í—ã–¥–∞–Ω –∞–¥–º–∏–Ω–æ–º' : x.from === 'RESET' ? 'üîÑ –°–±—Ä–æ—Å' : x.from === '‚öóÔ∏è –°–ª–∏—è–Ω–∏–µ' ? '‚öóÔ∏è –ü–æ–ª—É—á–µ–Ω —Å–ª–∏—è–Ω–∏–µ–º' : 'üéÅ –ü–æ–¥–∞—Ä–µ–Ω–æ: ' + x.from) : 'üõí –ö—É–ø–ª–µ–Ω–æ –≤ –º–∞–≥–∞–∑–∏–Ω–µ';

        const rarLabel = x.nft
            ? `<span class="rarity-nft">‚ú¶ NFT ‚Äî –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π</span>`
            : `<span style="display:inline-block;background:rgba(255,255,255,0.06);border-radius:20px;padding:3px 12px;font-size:12px;font-weight:bold;" class="${rarObj2.cls}">${rarObj2.icon} ${rarObj2.label}</span>`;

        document.getElementById('modal-content').innerHTML = `
            <div style="padding:5px 0;">
                <!-- Gift image -->
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="width:110px;height:110px;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;background:${x.nft?'rgba(255,215,0,0.06)':'rgba(255,255,255,0.04)'};border-radius:28px;border:1px solid ${x.nft?'rgba(255,215,0,0.3)':'rgba(255,255,255,0.08)'};">
                        ${img ? `<img src="${img}" style="width:90px;height:90px;object-fit:contain;filter:drop-shadow(0 6px 24px rgba(0,0,0,0.6));">` : `<span style="font-size:72px;">${emoji}</span>`}
                    </div>
                    <h3 style="margin:0 0 6px;font-size:20px;">${x.n}</h3>
                    ${rarLabel}
                </div>

                <!-- Info grid -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">
                    <div style="background:#0a1520;border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.06);">
                        <div style="font-size:10px;color:var(--secondary);margin-bottom:4px;">–ü–†–û–ò–°–•–û–ñ–î–ï–ù–ò–ï</div>
                        <div style="font-size:12px;font-weight:bold;">${origin}</div>
                    </div>
                    <div style="background:#0a1520;border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.06);">
                        <div style="font-size:10px;color:var(--secondary);margin-bottom:4px;">–¶–ï–ù–ê –ü–û–ö–£–ü–ö–ò</div>
                        <div style="font-size:12px;font-weight:bold;color:gold;">${x.from && x.from !== 'RESET' ? '‚Äî (–ø–æ–¥–∞—Ä–µ–Ω–æ)' : price.toLocaleString() + ' üí∞'}</div>
                    </div>
                    <div style="background:#0a1520;border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.06);">
                        <div style="font-size:10px;color:var(--secondary);margin-bottom:4px;">–†–´–ù–û–ß–ù–ê–Ø –¶–ï–ù–ê</div>
                        <div style="font-size:12px;font-weight:bold;color:var(--accent);">${marketPrice.toLocaleString()} üí∞</div>
                    </div>
                    <div style="background:#0a1520;border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.06);">
                        <div style="font-size:10px;color:var(--secondary);margin-bottom:4px;">–†–ï–î–ö–û–°–¢–¨</div>
                        <div style="font-size:12px;font-weight:bold;"><span class="${rarObj2.cls}">${rarObj2.icon} ${rarObj2.label}</span></div>
                    </div>
                    <div style="background:#0a1520;border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.06);grid-column:1/-1;">
                        <div style="font-size:10px;color:var(--secondary);margin-bottom:4px;">–°–ï–†–ò–ô–ù–´–ô –ù–û–ú–ï–†</div>
                        <div style="font-size:13px;font-weight:bold;font-family:monospace;color:${x.nft?'gold':'var(--accent)'};">${x.nftSerial ? '#' + x.nftSerial : '‚Äî'}</div>
                    </div>
                </div>

                <!-- Actions -->
                <div style="display:flex;flex-direction:column;gap:8px;">
                    ${x.nft ? `<button class="btn" style="background:linear-gradient(90deg,#7c3aed,#a855f7);font-weight:bold;" onclick="openNftUpgradeFromDetail('${inst}')">‚ö° –ü—Ä–æ–∫–∞—á–∞—Ç—å NFT ${(x.upgrade&&x.upgrade.level)?`(–£—Ä–æ–≤–µ–Ω—å ${x.upgrade.level}/5)`:''}</button>` : ''}
                    <button class="btn" style="background:${isPinned?'var(--secondary)':'var(--orange)'};" onclick="togglePin('${inst}');closeModal()">
                        ${isPinned ? 'üìå –°–Ω—è—Ç—å' : 'üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å'}
                    </button>
                    <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);border:1px solid rgba(255,255,255,0.08);" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>`;
        openModal();
    };

    window.openNftUpgradeSelect = async () => {
        const s = await get(ref(db, 'users/' + user.id)), d = s.val();
        const inv = (d.cloudInv || []).filter(x => x.nft);
        if (!inv.length) return showToast('–ù–µ—Ç NFT –¥–ª—è –ø—Ä–æ–∫–∞—á–∫–∏!', 'var(--err)');
        if (inv.length === 1) return openNftUpgrade(inv[0].inst);
        const cat2 = (x) => { const c = catalog.find(cc => cc.id == x.id); return x.img || (c && c.img); };
        const em2 = (x) => { const c = catalog.find(cc => cc.id == x.id); return x.i || (c && c.i) || 'üéÅ'; };
        document.getElementById('modal-content').innerHTML = `
            <h3 style="margin-bottom:12px;">‚ö° –í—ã–±–µ—Ä–∏ NFT –¥–ª—è –ø—Ä–æ–∫–∞—á–∫–∏</h3>
            <div style="display:flex;flex-direction:column;gap:8px;max-height:400px;overflow-y:auto;">
                ${inv.map(x => {
                    const img = cat2(x), em = em2(x);
                    const lvl = (x.upgrade && x.upgrade.level) || 0;
                    return `<div onclick="closeModal();setTimeout(()=>openNftUpgrade('${x.inst}'),350)" style="display:flex;align-items:center;gap:12px;background:#0a1520;border-radius:14px;padding:12px;cursor:pointer;border:1.5px solid rgba(255,215,0,0.2);transition:0.2s;" onmouseover="this.style.borderColor='rgba(255,215,0,0.5)'" onmouseout="this.style.borderColor='rgba(255,215,0,0.2)'">
                        <div style="width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:rgba(255,215,0,0.06);border-radius:12px;flex-shrink:0;">
                            ${img ? `<img src="${img}" style="width:40px;height:40px;object-fit:contain;">` : `<span style="font-size:32px;">${em}</span>`}
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:bold;font-size:13px;">${x.n}</div>
                            <div style="font-size:11px;color:gold;">‚ú¶ NFT ${lvl > 0 ? `¬∑ –£—Ä–æ–≤–µ–Ω—å ${lvl}/5` : '¬∑ –ù–µ –ø—Ä–æ–∫–∞—á–∞–Ω'}</div>
                        </div>
                        <div style="color:var(--accent);font-size:18px;">‚ö°</div>
                    </div>`;
                }).join('')}
            </div>
            <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);margin-top:8px;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>`;
        openModal();
    };

    window.renderMyProfileFresh = async () => {
        const s = await get(ref(db,'users/'+user.id));
        if(s.exists()) renderMyProfile(s.val());
    };

    window.openPromoModal = () => {
        document.getElementById('modal-content').innerHTML=`
            <h3>üéüÔ∏è –í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥</h3>
            <input type="text" id="promo-input" placeholder="–í–í–ï–î–ò –ö–û–î" style="text-transform:uppercase;font-size:18px;text-align:center;letter-spacing:3px;">
            <button class="btn" style="margin-top:5px;" onclick="usePromo()">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn" style="background:none;margin-top:5px;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>`;
        openModal();
    };
    window.openEdit = async () => {
        const s=await get(ref(db,'users/'+user.id));
        const d=s.val();
        const owned=new Set(d.cosmetics||[]);
        const active=d.activeCosmetic||{};
        const isAdm=user.isAdm;
        const unlocked=checkUnlocks(d);
        if(unlocked.length){
            const newOwned=[...owned,...unlocked];
            await update(ref(db,'users/'+user.id),{cosmetics:newOwned});
            unlocked.forEach(id=>{owned.add(id);showToast('üéâ –û—Ç–∫—Ä—ã—Ç–∞ –∫–æ—Å–º–µ—Ç–∏–∫–∞: '+COSMETICS.find(c=>c.id===id).name,'var(--accent)');});
        }

        const renderCosm = (type, label) => {
            const items = COSMETICS.filter(c=>c.type===type);
            return `<div class="cosm-section-title">${label}</div>
            <div class="cosm-grid">${items.map(c=>{
                const isOwned = isAdm || owned.has(c.id);
                const isActive = active[type]===c.id;
                const canBuy = !isOwned && !c.unlock;
                const preview = type==='color'
                    ? `<span style="color:${c.val};font-weight:bold;font-size:15px;">@–Ω–∏–∫</span>`
                    : `<span class="cosm-preview">${c.val}</span>`;
                const priceHtml = isOwned
                    ? `<span style="color:var(--green);font-size:11px;">‚úì –ï—Å—Ç—å</span>`
                    : c.unlock
                        ? `<span class="cosm-unlock">üîí ${c.unlockDesc}</span>`
                        : `<span class="cosm-price">${c.price}üí∞</span>`;
                return `<div class="cosm-item${isActive?' active-cosm':''}${!isOwned?' locked':''}" onclick="cosmClick('${c.id}','${type}',${isOwned},${canBuy},${c.price})">
                    ${preview}
                    <span class="cosm-name">${c.name}</span>
                    ${priceHtml}
                    ${isActive?'<span style="font-size:10px;color:var(--accent);">‚ñ∂ –ê–∫—Ç–∏–≤–Ω–æ</span>':''}
                </div>`;
            }).join('')}</div>`;
        };

        document.getElementById('modal-content').innerHTML=`
            <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <textarea id="ebio" placeholder="–û —Å–µ–±–µ">${d.bio||''}</textarea>
            <p style="font-size:12px;color:var(--secondary)">–ê–≤–∞—Ç–∞—Ä (—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞):</p>
            <input type="file" id="efile" accept="image/*" style="padding:5px;font-size:12px;">
            <button class="btn" onclick="saveP()" style="margin-bottom:4px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
            <hr style="border-color:rgba(255,255,255,0.07);margin:12px 0;">


            <!-- Privacy collapsible -->
            <div style="background:rgba(255,107,107,0.05);border:1px solid rgba(255,107,107,0.2);border-radius:14px;padding:10px 14px;margin-bottom:10px;">
                <div class="collapsible-header" onclick="toggleCollapsible('privacy-section',this)">
                    <span style="font-weight:bold;font-size:14px;">üîí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</span>
                    <span class="collapsible-arrow">‚ñº</span>
                </div>
                <div class="collapsible-body" id="privacy-section">
                    <div style="padding:8px 0 4px;display:flex;flex-direction:column;gap:10px;">
                        <p style="font-size:11px;color:var(--secondary);margin:0 0 6px;">–ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞ ‚Äî –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —Å–º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ.</p>
                        ${['showGifts:üëÅÔ∏è –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ–∏ –ø–æ–¥–∞—Ä–∫–∏:–î—Ä—É–≥–∏–µ –≤–∏–¥—è—Ç —Ç–≤–æ–∏ –ø–æ–¥–∞—Ä–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ',
                           'allowGifts:üéÅ –ü—Ä–∏–Ω–∏–º–∞—Ç—å –ø–æ–¥–∞—Ä–∫–∏:–î—Ä—É–≥–∏–µ –º–æ–≥—É—Ç –¥–∞—Ä–∏—Ç—å —Ç–µ–±–µ –ø–æ–¥–∞—Ä–∫–∏',
                           'allowTrade:üîÑ –ü—Ä–∏–Ω–∏–º–∞—Ç—å –æ–±–º–µ–Ω—ã:–î—Ä—É–≥–∏–µ –º–æ–≥—É—Ç –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –æ–±–º–µ–Ω—ã',
                           'allowDuel:‚öîÔ∏è –ü—Ä–∏–Ω–∏–º–∞—Ç—å –¥—É—ç–ª–∏:–î—Ä—É–≥–∏–µ –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å —Ç–µ–±—è –Ω–∞ –¥—É—ç–ª—å',
                           'allowFriends:üë• –ü—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è:–î—Ä—É–≥–∏–µ –º–æ–≥—É—Ç –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–±—è –≤ –¥—Ä—É–∑—å—è'
                          ].map(item => {
                            const [key, label, desc] = item.split(':');
                            const isOn = (d.privacy||{})[key] !== false;
                            return `<div style="display:flex;align-items:center;justify-content:space-between;gap:12px;background:#0a1520;border-radius:12px;padding:10px 12px;border:1px solid rgba(255,255,255,0.06);">
                                <div>
                                    <div style="font-size:13px;font-weight:bold;">${label}</div>
                                    <div style="font-size:11px;color:var(--secondary);margin-top:2px;">${desc}</div>
                                </div>
                                <div onclick="togglePrivacy('${key}')" style="cursor:pointer;width:44px;height:24px;border-radius:12px;background:${isOn?'var(--green)':'rgba(255,255,255,0.1)'};position:relative;transition:background 0.25s;flex-shrink:0;border:1.5px solid ${isOn?'rgba(46,204,113,0.5)':'rgba(255,255,255,0.08)'};">
                                    <div style="position:absolute;top:2px;${isOn?'right:2px':'left:2px'};width:18px;height:18px;border-radius:50%;background:white;transition:all 0.25s;box-shadow:0 1px 4px rgba(0,0,0,0.4);"></div>
                                </div>
                            </div>`;
                          }).join('')}
                    </div>
                </div>
            </div>

            <!-- Telegram collapsible -->
            <div style="background:rgba(0,136,204,0.08);border:1px solid rgba(0,136,204,0.2);border-radius:14px;padding:10px 14px;margin-bottom:10px;">
                <div class="collapsible-header" onclick="toggleCollapsible('tg-section',this)">
                    <span style="font-weight:bold;font-size:14px;">üì± –ü—Ä–∏–≤—è–∑–∫–∞ Telegram</span>
                    <span class="collapsible-arrow">‚ñº</span>
                </div>
                <div class="collapsible-body" id="tg-section">
                    <div style="padding-bottom:10px;">
                        ${d.tgChatId
                            ? `<div style="background:rgba(0,136,204,0.12);border-radius:10px;padding:10px;margin-bottom:8px;font-size:13px;">‚úÖ Telegram –ø—Ä–∏–≤—è–∑–∞–Ω (ID: <code>${d.tgChatId}</code>)</div>
                               <button class="btn" style="background:rgba(231,76,60,0.15);border:1px solid rgba(231,76,60,0.3);color:var(--err);font-size:13px;" onclick="unlinkTg()">üîì –û—Ç–≤—è–∑–∞—Ç—å Telegram</button>`
                            : `<p style="font-size:13px;color:var(--secondary);margin:0 0 10px;">–ü—Ä–∏–≤—è–∂–∏ Telegram —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–¥–∞—Ä–∫–∞—Ö, –ø—Ä–æ–¥–∞–∂–∞—Ö –∏ –¥—Ä—É–∑—å—è—Ö.</p>
                               <a href="https://t.me/Gift_world_to_market_bot?start=link_${user.id}" target="_blank" class="btn" style="background:linear-gradient(90deg,#0088cc,#006bad);display:block;text-align:center;">‚úàÔ∏è –ü—Ä–∏–≤—è–∑–∞—Ç—å —á–µ—Ä–µ–∑ –±–æ—Ç–∞</a>
                               <p style="font-size:11px;color:var(--secondary);margin:8px 0 0;text-align:center;">–ò–ª–∏ –Ω–∞–ø–∏—à–∏ –±–æ—Ç—É: /link ${user.id} [–ø–∞—Ä–æ–ª—å]</p>`
                        }
                    </div>
                </div>
            </div>

            <!-- Cosmetics collapsible -->
            <div style="background:rgba(162,155,254,0.05);border:1px solid rgba(162,155,254,0.15);border-radius:14px;padding:10px 14px;">
                <div class="collapsible-header" onclick="toggleCollapsible('cosm-section',this)">
                    <span style="font-weight:bold;font-size:14px;">üé® –ö–æ—Å–º–µ—Ç–∏–∫–∞</span>
                    <span class="collapsible-arrow">‚ñº</span>
                </div>
                <div class="collapsible-body" id="cosm-section">
                    <div style="padding-bottom:10px;">
                        <p style="font-size:11px;color:var(--secondary);margin:0 0 8px;">–ù–∞–∂–º–∏ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—É—é —á—Ç–æ–±—ã —Å–Ω—è—Ç—å</p>
                        ${renderCosm('prefix','‚ú® –ü—Ä–µ—Ñ–∏–∫—Å')}
                        ${renderCosm('color','üé® –¶–≤–µ—Ç –Ω–∏–∫–∞')}
                        ${renderCosm('badge','üèÜ –ó–Ω–∞—á–æ–∫')}
                    </div>
                </div>
            </div>
        `;
        openModal();
    };


    window.togglePrivacy = async (key) => {
        const s = await get(ref(db,'users/'+user.id)), d = s.val();
        const privacy = d.privacy || {};
        const current = privacy[key] !== false;
        privacy[key] = !current;
        await update(ref(db,'users/'+user.id), {privacy});
        showToast(privacy[key] ? '‚úÖ –í–∫–ª—é—á–µ–Ω–æ' : 'üîí –í—ã–∫–ª—é—á–µ–Ω–æ', privacy[key] ? 'var(--green)' : 'var(--secondary)');
        openEdit();
    };
    window.cosmClick = async (id, type, isOwned, canBuy, price) => {
        const r=ref(db,'users/'+user.id);
        const s=await get(r); const d=s.val();
        const owned=d.cosmetics||[];
        const active=d.activeCosmetic||{};
        if(!isOwned && !user.isAdm){
            if(!canBuy) return showToast('–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π —ç—Ç–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!','var(--err)');
            if((d.balance||0)<price) return showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!','var(--err)');
            const newOwned=[...owned,id];
            const newSpent=(d.totalSpent||0)+price;
            await update(r,{balance:user.isAdm ? (d.balance||0) : d.balance-price,cosmetics:newOwned,totalSpent:newSpent});
            showToast('üéâ –ö—É–ø–ª–µ–Ω–æ!','var(--green)');
            isOwned=true;
        }
        if(isOwned || user.isAdm){
            const newActive={...active};
            if(newActive[type]===id) delete newActive[type];
            else newActive[type]=id;
            await update(r,{activeCosmetic:newActive});
            showToast(newActive[type]?'‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ!':'‚Ü©Ô∏è –°–Ω—è—Ç–æ','var(--accent)');
        }
        openEdit();
    };
    window.saveP = async () => {
        const file=document.getElementById('efile').files[0];
        if(file){
            const reader=new FileReader();
            reader.onload=async(e)=>{await update(ref(db,'users/'+user.id),{bio:document.getElementById('ebio').value,pic:e.target.result});closeModal();showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");};
            reader.readAsDataURL(file);
        } else {
            await update(ref(db,'users/'+user.id),{bio:document.getElementById('ebio').value});
            closeModal();showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
        }
    };
    window.openUserProfile = async (uid) => {
        const s = await get(ref(db,'users/'+uid));
        if (!s.exists()) return showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω','var(--err)');
        const d = s.val();
        const inv = d.cloudInv || [];
        const pinned = (d.pinnedInsts||[]);
        const friends = d.friends || {};

        const rarityMap = [
            {label:'–û–±—ã—á–Ω—ã–π',   color:'#7f91a4', icon:'‚ö™'},
            {label:'–†–µ–¥–∫–∏–π',    color:'#4db4ff', icon:'üîµ'},
            {label:'–≠–ø–∏—á–µ—Å–∫–∏–π', color:'#a29bfe', icon:'üü£'},
            {label:'–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π',color:'#ffd700',icon:'üü°'},
            {label:'NFT',       color:'#ffd700', icon:'‚ú¶'},
        ];

        const giftCard = (x, isPinCard=false) => {
            const cat = catalog.find(c => c.id == x.id);
            const img = (x.imgKey==='pan'?PAN_IMG:null) || x.img || (cat && cat.img);
            const emoji = x.i || (cat && cat.i) || 'üéÅ';
            const isNFT = !!x.nft;
            const isLizard = isNFT && x.id === 997;
            const nftPrice = isNFT ? (x.id===997?7000:x.id===998?10000:x.id===999?5000:(x.price||0)) : 0;
            const bg = isLizard ? 'linear-gradient(145deg,#001a08,#0a1f12,#001208)'
                      : isNFT   ? 'linear-gradient(145deg,#1c1200,#0f1a1f,#1a1100)'
                      : '#0a1520';
            const border = isLizard ? 'rgba(77,255,145,0.5)' : isNFT ? 'rgba(255,215,0,0.5)' : 'rgba(255,255,255,0.06)';
            const shadow = isLizard ? '0 0 0 1.5px rgba(77,255,145,0.4),0 4px 16px rgba(77,255,145,0.2)'
                          : isNFT   ? '0 0 0 1.5px rgba(255,215,0,0.4),0 4px 16px rgba(255,215,0,0.2)'
                          : 'none';
            const imgFilter = isLizard ? 'drop-shadow(0 4px 14px rgba(77,255,145,0.55))'
                             : isNFT   ? 'drop-shadow(0 4px 14px rgba(255,215,0,0.55))'
                             : 'drop-shadow(0 3px 10px rgba(0,0,0,0.5))';
            const nameColor = isLizard
                ? 'background:linear-gradient(90deg,#00ff88,#4dff91,#00cc66);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:bold;'
                : isNFT
                ? 'background:linear-gradient(90deg,#ffd700,#ffb347,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:bold;'
                : '';
            return `<div style="text-align:center;background:${bg};border-radius:16px;padding:10px 6px 8px;border:1.5px solid ${border};box-shadow:${shadow};position:relative;overflow:hidden;transition:transform 0.2s;">
                ${isNFT ? `<div style="position:absolute;top:4px;right:4px;background:${isLizard?'linear-gradient(90deg,#007744,#4dff91)':'linear-gradient(90deg,#b8860b,#ffd700)'};color:#000;font-size:7px;font-weight:900;border-radius:5px;padding:2px 5px;letter-spacing:0.5px;z-index:2;">NFT</div>` : ''}
                ${isPinCard ? `<div style="position:absolute;top:4px;left:4px;font-size:11px;z-index:2;">üìå</div>` : ''}
                ${isNFT ? `<div style="position:absolute;inset:0;border-radius:16px;background:linear-gradient(105deg,transparent 25%,${isLizard?'rgba(77,255,145,0.08)':'rgba(255,215,0,0.08)'} 50%,transparent 75%);background-size:200% 100%;animation:nftGoldShimmer 2.5s linear infinite;pointer-events:none;"></div>` : ''}
                <div style="width:56px;height:56px;margin:0 auto 6px;display:flex;align-items:center;justify-content:center;position:relative;z-index:1;">
                    ${img ? `<img src="${img}" style="width:52px;height:52px;object-fit:contain;filter:${imgFilter};${isNFT?'animation:nftImgFloat 3s ease-in-out infinite;':''}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><span style="display:none;font-size:36px;">${emoji}</span>` : `<span style="font-size:36px;">${emoji}</span>`}
                </div>
                <div style="font-size:11px;font-weight:bold;margin-bottom:2px;${nameColor}">${x.n}</div>
                ${isNFT ? `<div style="font-size:8px;font-weight:bold;color:${isLizard?'rgba(77,255,145,0.75)':'rgba(255,215,0,0.75)'};">${nftPrice.toLocaleString()}üí∞</div>` : ''}
                ${isNFT && x.nftSerial ? `<div style="font-size:7px;color:${isLizard?'rgba(77,255,145,0.4)':'rgba(255,215,0,0.4)'};font-family:monospace;">#${x.nftSerial}</div>` : ''}
                ${x.from && !isNFT ? `<div style="font-size:9px;color:var(--orange);margin-top:2px;">–æ—Ç ${x.from}</div>` : ''}
            </div>`;
        };

        const pinnedSet = new Set(pinned.map(String));
        const sortedInv = [
            ...inv.filter(x => pinnedSet.has(String(x.inst))),
            ...inv.filter(x => !pinnedSet.has(String(x.inst)))
        ];

        const allGiftsHtml = sortedInv.length
            ? `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px;">${sortedInv.map(x=>giftCard(x, pinnedSet.has(String(x.inst)))).join('')}</div>`
            : `<div style="text-align:center;color:var(--secondary);font-size:13px;padding:24px;">–ü–æ–¥–∞—Ä–∫–æ–≤ –Ω–µ—Ç</div>`;

        document.getElementById('modal-content').innerHTML = `
            <div style="padding:5px 0;">
                <!-- Header -->
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="position:relative;display:inline-block;margin-bottom:10px;">
                        ${(() => {
                            const pArr = pinned
                                .map(inst2 => inv.find(x=>String(x.inst)===String(inst2)))
                                .filter(it2 => it2 && it2.nft)
                                .slice(0,6);
                            if(!pArr.length) return '';
                            const ang = 360/pArr.length;
                            const rad2 = 52; // avatar radius=40, items sit just outside border
                            return '<div style="position:absolute;top:50%;left:50%;width:0;height:0;pointer-events:none;">' +
                            pArr.map((it2,i2) => {
                                const ct2 = catalog.find(c=>c.id==it2.id);
                                const mg2 = it2.img||(ct2&&ct2.img);
                                const em3 = it2.i||(ct2&&ct2.i)||'üéÅ';
                                const r3 = (ang*i2-90)*Math.PI/180;
                                const x3 = Math.round(rad2*Math.cos(r3)-12);
                                const y3 = Math.round(rad2*Math.sin(r3)-12);
                                return `<div class="avatar-ring-item ring-nft" style="left:${x3}px;top:${y3}px;width:24px;height:24px;">${mg2?'<img src="'+mg2+'" style="width:16px;height:16px;" onerror="this.style.display=\'none\'">':'<span style="font-size:12px;">'+em3+'</span>'}</div>`;
                            }).join('') + '</div>';
                        })()}
                        <img src="${d.pic || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
                             style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--accent);background:#0e1824;position:relative;z-index:2;"
                             onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                    </div>
                    <h3 style="margin:0 0 4px;">${buildUsername(d)}</h3>
                    ${d.bio ? `<p style="color:var(--secondary);font-size:13px;margin:0 0 10px;">${d.bio}</p>` : ''}
                    <div style="display:flex;justify-content:center;gap:20px;">
                        <div style="text-align:center;"><div style="font-weight:bold;color:var(--accent);font-size:18px;">${inv.length}</div><div style="font-size:11px;color:var(--secondary);">–ü–æ–¥–∞—Ä–∫–æ–≤</div></div>
                        <div style="text-align:center;"><div style="font-weight:bold;color:var(--accent);font-size:18px;">${Object.keys(friends).length}</div><div style="font-size:11px;color:var(--secondary);">–î—Ä—É–∑–µ–π</div></div>
                    </div>
                </div>

                <!-- All gifts (pinned first) -->
                ${((d.privacy||{}).showGifts !== false) ? `
                <div style="margin-bottom:14px;">
                    <div style="font-size:13px;font-weight:bold;color:var(--secondary);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;">
                        <span>üéÅ –ü–æ–¥–∞—Ä–∫–∏</span>
                        <span style="background:rgba(255,255,255,0.07);border-radius:20px;padding:2px 10px;font-size:11px;">${inv.length}</span>
                    </div>
                    ${allGiftsHtml}
                </div>` : `<div style="text-align:center;padding:20px;color:var(--secondary);font-size:13px;">üîí –ü–æ–¥–∞—Ä–∫–∏ —Å–∫—Ä—ã—Ç—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</div>`}

                <button class="btn" style="background:rgba(255,255,255,0.05);color:var(--secondary);border:1px solid rgba(255,255,255,0.08);" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>`;
        openModal();
    };

    window.toggleCollapsible = (id, header) => {
        const body = document.getElementById(id);
        const arrow = header.querySelector('.collapsible-arrow');
        const isOpen = body.classList.toggle('open');
        if(arrow) arrow.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
    };
    window.unlinkTg = async () => {
        const ok = await showConfirm('–û—Ç–≤—è–∑–∞—Ç—å Telegram','–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–µ—Ä–µ—Å—Ç–∞–Ω—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤ Telegram.','üì±','var(--err)','–û—Ç–≤—è–∑–∞—Ç—å');
        if(!ok) return;
        await update(ref(db,'users/'+user.id),{tgChatId:null});
        showToast('Telegram –æ—Ç–≤—è–∑–∞–Ω','var(--secondary)');
        openEdit();
    };
    window.logout=()=>{localStorage.removeItem('gifts_user');location.reload();};
    window.admTab = (id, btn) => {
        document.querySelectorAll('.adm-section').forEach(s=>s.classList.remove('active'));
        document.querySelectorAll('.adm-tab').forEach(b=>b.classList.remove('active'));
        document.getElementById('adm-'+id).classList.add('active');
        btn.classList.add('active');
        // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–æ–¥–∞–∂ –µ—Å–ª–∏ —É—Ö–æ–¥–∏–º —Å –≤–∫–ª–∞–¥–∫–∏
        if(id!=='sales' && salesUnsubscribe) { salesUnsubscribe(); salesUnsubscribe=null; }
        if(id==='sales') loadSalesLog();
        if(id==='market') loadAdminMarket();
    };

    window.admRefresh = () => { showToast('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã üîÑ','var(--accent)'); };

    let salesUnsubscribe = null;
    function loadSalesLog(){
        const el=document.getElementById('adm-sales-list');
        const totalEl=document.getElementById('adm-sales-total');
        // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è –µ—Å–ª–∏ –±—ã–ª
        if(salesUnsubscribe) { salesUnsubscribe(); salesUnsubscribe=null; }
        el.innerHTML='<div style="color:var(--secondary);text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        salesUnsubscribe = onValue(ref(db,'users/ckovoroda/shopLog'), snap=>{
            const shopLog = snap.exists() ? snap.val() : null;
            const logArr = shopLog ? (Array.isArray(shopLog) ? shopLog : Object.values(shopLog)) : [];
            if(!logArr.length){
                totalEl.innerHTML='';
                el.innerHTML='<div style="color:var(--secondary);text-align:center;padding:30px;">–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫</div>';
                return;
            }
            const sorted=[...logArr].reverse();
            const totalEarned=logArr.reduce((a,r)=>a+(r.price||0),0);
            totalEl.innerHTML=`<div style="background:rgba(36,129,204,0.08);border:1px solid rgba(36,129,204,0.15);border-radius:16px;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;">
                <div style="font-size:12px;color:var(--secondary);">–í—Å–µ–≥–æ –ø–æ–∫—É–ø–æ–∫: <b style="color:white;">${logArr.length}</b></div>
                <div style="font-size:14px;font-weight:900;color:gold;">+${totalEarned.toLocaleString()}üí∞</div>
            </div>`;
            el.innerHTML=sorted.map(r=>{
                const d=new Date(r.time);
                const dateStr=d.toLocaleDateString('ru-RU')+' '+d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
                return `<div style="background:#0d1720;border-radius:16px;padding:12px 14px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center;gap:10px;">
                    <div>
                        <div style="font-weight:bold;font-size:13px;">${r.emoji||'üéÅ'} ${r.item}</div>
                        <div style="font-size:11px;color:var(--secondary);margin-top:3px;">üë§ ${r.buyer} <span style="color:#4a6080;font-family:monospace;">(${r.buyerId})</span></div>
                        <div style="font-size:10px;color:#4a6080;margin-top:2px;">üïê ${dateStr}</div>
                    </div>
                    <div style="color:gold;font-weight:bold;font-size:14px;white-space:nowrap;background:rgba(255,215,0,0.08);padding:6px 12px;border-radius:12px;">+${r.price.toLocaleString()}üí∞</div>
                </div>`;
            }).join('');
        });
    }

    let adminMarketData = {};
    window.loadAdminMarket = async () => {
        const snap = await get(ref(db,'market/'));
        adminMarketData = snap.val() || {};
        renderAdminMarket(adminMarketData);
    };
    window.admFilterMarket = (q) => {
        const filtered = Object.fromEntries(Object.entries(adminMarketData).filter(([,x])=>x.n.toLowerCase().includes(q.toLowerCase())||x.sN.toLowerCase().includes(q.toLowerCase())));
        renderAdminMarket(filtered);
    };
    function renderAdminMarket(data) {
        const entries = Object.entries(data);
        const totalVal = entries.reduce((a,[,x])=>a+(x.mP||0),0);
        document.getElementById('adm-market-stats').innerHTML=`
            <div style="background:#0a1520;border-radius:14px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06);">
                <div style="font-size:18px;font-weight:900;color:var(--accent);">${entries.length}</div>
                <div style="font-size:10px;color:var(--secondary);margin-top:2px;">–õ–æ—Ç–æ–≤</div>
            </div>
            <div style="background:#0a1520;border-radius:14px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06);">
                <div style="font-size:18px;font-weight:900;color:gold;">${totalVal.toLocaleString()}</div>
                <div style="font-size:10px;color:var(--secondary);margin-top:2px;">üí∞ –°—É–º–º–∞</div>
            </div>
            <div style="background:#0a1520;border-radius:14px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06);">
                <div style="font-size:18px;font-weight:900;color:var(--green);">${entries.length?Math.round(totalVal/entries.length).toLocaleString():0}</div>
                <div style="font-size:10px;color:var(--secondary);margin-top:2px;">üí∞ –°—Ä–µ–¥–Ω–µ–µ</div>
            </div>`;
        const list = document.getElementById('adm-market-list');
        if(!entries.length){list.innerHTML='<div style="text-align:center;color:var(--secondary);padding:30px;">–†—ã–Ω–æ–∫ –ø—É—Å—Ç</div>';return;}
        list.innerHTML=entries.map(([k,x])=>`
            <div style="background:#0d1720;border-radius:16px;padding:12px 14px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.05);display:flex;align-items:center;gap:12px;">
                <div style="font-size:28px;flex-shrink:0;">${x.i||'üéÅ'}</div>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:bold;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${x.n}</div>
                    <div style="font-size:11px;color:var(--secondary);margin-top:2px;">üë§ ${x.sN} <span style="color:#4a6080;">(${x.sI})</span></div>
                </div>
                <div style="text-align:right;flex-shrink:0;">
                    <div style="font-size:14px;font-weight:900;color:gold;">${(x.mP||0).toLocaleString()}üí∞</div>
                    <button onclick="admRemoveMarketItem('${k}')" style="background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.25);color:var(--err);border-radius:8px;padding:3px 8px;font-size:10px;cursor:pointer;margin-top:4px;">üóë –°–Ω—è—Ç—å</button>
                </div>
            </div>`).join('');
    }
    window.admRemoveMarketItem = async (k) => {
        const ok = await showConfirm('–°–Ω—è—Ç—å –ª–æ—Ç','–≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä –±—É–¥–µ—Ç —Å–Ω—è—Ç —Å —Ä—ã–Ω–∫–∞ –±–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø—Ä–æ–¥–∞–≤—Ü—É.','üóëÔ∏è','var(--err)','–°–Ω—è—Ç—å');
        if(!ok) return;
        await remove(ref(db,'market/'+k));
        showToast('–õ–æ—Ç —Å–Ω—è—Ç —Å —Ä—ã–Ω–∫–∞','var(--err)');
        loadAdminMarket();
    };

    window.admFilterUsers = (q) => {
        const query=q.toLowerCase().trim();
        let visible=0;
        document.querySelectorAll('.adm-user-row').forEach(row=>{
            const match = !query || row.dataset.name.includes(query);
            row.parentElement.style.display=match?'':'none';
            if(match) visible++;
        });
        const countEl=document.getElementById('adm-user-count');
        if(countEl) countEl.textContent = query ? `${visible} –Ω–∞–π–¥–µ–Ω–æ` : `${document.querySelectorAll('.adm-user-row').length} –∏–≥—Ä–æ–∫–æ–≤`;
    };

    function initAdmin() {
        onValue(ref(db,'users'),s=>{
            const us=s.val(); if(!us) return;
            allUsersCache=us;
            const userList=Object.entries(us);
            const nonAdminList=userList.filter(([id])=>!ADMIN_IDS.has(id));
            const totalBal=nonAdminList.reduce((a,[,u])=>a+(u.balance||0),0);
            const totalItems=nonAdminList.reduce((a,[,u])=>a+(u.cloudInv||[]).length,0);
            const sorted=[...nonAdminList].sort((a,b)=>(b[1].balance||0)-(a[1].balance||0));

            // Stats
            const avgBal = nonAdminList.length ? Math.round(totalBal/nonAdminList.length) : 0;
            const tgLinked = nonAdminList.filter(([,u])=>u.tgChatId).length;
            document.getElementById('adm-stats-grid').innerHTML=`
                <div class="adm-stat blue"><div class="ico">üë•</div><div class="val">${nonAdminList.length}</div><div class="lbl">–ò–≥—Ä–æ–∫–æ–≤</div></div>
                <div class="adm-stat green"><div class="ico">üì¶</div><div class="val">${totalItems}</div><div class="lbl">–ü—Ä–µ–¥–º–µ—Ç–æ–≤</div></div>
                <div class="adm-stat orange"><div class="ico">üí∞</div><div class="val">${totalBal.toLocaleString()}</div><div class="lbl">–ú–æ–Ω–µ—Ç –≤ –∏–≥—Ä–µ</div></div>
                <div class="adm-stat purple"><div class="ico">‚úàÔ∏è</div><div class="val">${tgLinked}</div><div class="lbl">TG –ø—Ä–∏–≤—è–∑–∞–Ω–æ</div></div>`;
            document.getElementById('adm-online-hint').textContent = `${nonAdminList.length} –∏–≥—Ä–æ–∫–æ–≤ ¬∑ ${totalItems} –ø—Ä–µ–¥–º–µ—Ç–æ–≤ ¬∑ ${totalBal.toLocaleString()}üí∞ –≤ –æ–±–æ—Ä–æ—Ç–µ`;

            // Top users
            document.getElementById('adm-top-users').innerHTML=sorted.slice(0,5).map(([id,u],i)=>{
                const medals=['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£'];
                return `<div style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;" onclick="openUserProfile('${id}')">
                    <span style="font-size:18px;width:24px;text-align:center;">${medals[i]}</span>
                    <span style="flex:1;font-size:13px;font-weight:bold;">${u.username}</span>
                    <span style="color:gold;font-weight:bold;font-size:13px;">${(u.balance||0).toLocaleString()}üí∞</span>
                    <span style="color:var(--accent);font-size:16px;">‚Ä∫</span>
                </div>`;
            }).join('');

            // Users list
            const userCount = document.getElementById('adm-user-count');
            if(userCount) userCount.textContent = userList.length + ' –∏–≥—Ä–æ–∫–æ–≤';
            document.getElementById('adm-users-list').innerHTML=userList.map(([id,u])=>{
                const invCount = (u.cloudInv||[]).length;
                const hasTg = !!u.tgChatId;
                const isAdm = ADMIN_IDS.has(id);
                return `<div>
                    <div class="adm-user-row" data-name="${(u.username||'').toLowerCase()} ${(u.ip||'').toLowerCase()}">
                        <div class="uavatar">${(u.username||'?')[0].toUpperCase()}</div>
                        <div style="flex:1;min-width:0;" onclick="admToggleUser('${id}')">
                            <div class="uname">${u.username}${isAdm?` <span style="background:rgba(243,156,18,0.2);color:var(--orange);font-size:9px;padding:1px 6px;border-radius:8px;font-weight:bold;">ADMIN</span>`:''}</div>
                            <div class="uinfo">${hasTg?'‚úàÔ∏è':'üìµ'} ¬∑ üì¶ ${invCount} ¬∑ üåê ${u.ip||'‚Äî'}</div>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <button onclick="openUserProfile('${id}')" style="background:rgba(36,129,204,0.1);border:1px solid rgba(36,129,204,0.2);color:var(--accent);border-radius:10px;padding:5px 10px;font-size:11px;cursor:pointer;">üëÅ</button>
                            <div class="ubadge" onclick="admToggleUser('${id}')">${(u.balance||0).toLocaleString()}üí∞</div>
                        </div>
                    </div>
                    <div id="admu-${id}" class="adm-user-detail">
                        <!-- Info grid -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">
                            <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:10px;">
                                <div style="font-size:10px;color:#4a6080;margin-bottom:3px;">üîë –ü–∞—Ä–æ–ª—å</div>
                                <div style="font-size:12px;font-family:monospace;color:#7f91a4;word-break:break-all;">${u.password||'‚Äî'}</div>
                            </div>
                            <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:10px;">
                                <div style="font-size:10px;color:#4a6080;margin-bottom:3px;">üåê IP</div>
                                <div style="font-size:12px;font-family:monospace;color:#7f91a4;">${u.ip||'‚Äî'}</div>
                            </div>
                            <div style="background:rgba(36,129,204,0.08);border:1px solid rgba(36,129,204,0.15);border-radius:12px;padding:10px;">
                                <div style="font-size:10px;color:#4a6080;margin-bottom:3px;">üí∞ –ë–∞–ª–∞–Ω—Å</div>
                                <div style="font-size:16px;font-weight:900;color:var(--accent);">${(u.balance||0).toLocaleString()}</div>
                            </div>
                            <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:10px;">
                                <div style="font-size:10px;color:#4a6080;margin-bottom:3px;">üì¶ –ü—Ä–µ–¥–º–µ—Ç–æ–≤</div>
                                <div style="font-size:16px;font-weight:900;color:#7f91a4;">${invCount}</div>
                            </div>
                        </div>

                        <!-- Inventory -->
                        <div style="font-size:10px;color:#4a6080;margin-bottom:6px;font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;">üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
                        <div class="adm-inv-scroll" style="margin-bottom:14px;">
                            ${invCount ? (u.cloudInv||[]).map(x=>{
                                const rar=RARITY_LEVELS[x.rarity||0]||RARITY_LEVELS[0];
                                const borderC=x.nft?'rgba(255,215,0,0.5)':rar.id===3?'rgba(255,215,0,0.4)':rar.id===2?'rgba(162,155,254,0.4)':rar.id===1?'rgba(77,180,255,0.35)':'rgba(255,255,255,0.07)';
                                return `<div class="adm-inv-item" title="${x.n} ${rar.icon}" style="border:1px solid ${borderC};">${x.img?`<img src="${x.img}" style="width:28px;height:28px;object-fit:contain;">`:x.i}<div style="font-size:7px;color:#4a6080;font-family:monospace;text-align:center;">#${String(x.inst||'').slice(-4)}</div></div>`;
                            }).join('') : '<span style="color:var(--secondary);font-size:12px;padding:8px;">–ü—É—Å—Ç–æ</span>'}
                        </div>

                        <!-- Actions -->
                        <div style="display:flex;flex-direction:column;gap:8px;">
                            <div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:10px 12px;">
                                <div style="font-size:10px;color:#4a6080;margin-bottom:6px;font-weight:bold;text-transform:uppercase;letter-spacing:0.5px;">üí∞ –ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</div>
                                <div style="display:flex;gap:6px;">
                                    <input type="number" id="ab-${id}" placeholder="–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å" style="flex:1;margin:0;padding:8px 12px;height:40px;border-radius:10px;font-size:13px;">
                                    <button class="btn" style="width:50px;padding:0;height:40px;border-radius:10px;font-size:18px;background:var(--green);" onclick="setB('${id}')">‚úì</button>
                                </div>
                            </div>
                            <div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:10px 12px;">
                                <div style="font-size:10px;color:#4a6080;margin-bottom:6px;font-weight:bold;text-transform:uppercase;letter-spacing:0.5px;">üéÅ –í—ã–¥–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç</div>
                                <div style="display:flex;gap:6px;margin-bottom:6px;">
                                    <select id="ag-${id}" style="flex:1;margin:0;padding:6px 10px;height:40px;border-radius:10px;font-size:12px;">
                                        <option value="nft_liz">ü¶é –Ø—â–µ—Ä–∏—Ü–∞ (NFT)</option>
                                        <option value="nft_pan">üç≥ –°–∫–æ–≤–æ—Ä–æ–¥–∞ (NFT)</option>
                                        <option value="nft_beer">üç∫ –ö—Ä—É–∂–∫–∞ –ü–∏–≤–∞ (NFT)</option>
                                        <option value="nft_sock">üß¶ –ù–æ—Å–æ–∫ (NFT)</option>
                                        <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                                        ${catalog.map(x=>`<option value="${x.id}">${x.i} ${x.n}</option>`).join('')}
                                    </select>
                                </div>
                                <div style="display:flex;gap:6px;">
                                    <select id="agr-${id}" style="flex:1;margin:0;padding:6px 10px;height:40px;border-radius:10px;font-size:12px;">
                                        <option value="0">‚¨ú –û–±—ã—á–Ω—ã–π</option>
                                        <option value="1">üîµ –†–µ–¥–∫–∏–π</option>
                                        <option value="2">üü£ –≠–ø–∏—á–µ—Å–∫–∏–π</option>
                                        <option value="3">üü° –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π</option>
                                    </select>
                                    <button class="btn" style="width:50px;padding:0;height:40px;border-radius:10px;background:var(--orange);font-size:18px;" onclick="giveI('${id}')">üéÅ</button>
                                </div>
                            </div>
                            <button class="btn" style="background:rgba(231,76,60,0.08);border:1px solid rgba(231,76,60,0.25);color:var(--err);padding:11px;font-size:13px;border-radius:12px;" onclick="delUser('${id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        });

        // Load promos
        onValue(ref(db,'promos'),s=>{
            const promos=s.val();
            const countLbl = document.getElementById('promo-count-lbl');
            if(countLbl) countLbl.textContent = promos ? `–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤: ${Object.keys(promos).length}` : '–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ—Ç';
            document.getElementById('promo-list').innerHTML = promos
                ? Object.entries(promos).map(([code,p])=>{
                    const isUsed=(p.useCount||0)>=(p.maxUses||999);
                    return `<div class="promo-card">
                        <div class="promo-card-info">
                            <div class="promo-badge ${isUsed?'used':''}">${isUsed?'–ò—Å—á–µ—Ä–ø–∞–Ω':'‚óè –ê–∫—Ç–∏–≤–µ–Ω'}</div>
                            <div class="promo-code-text">${code}</div>
                            <div style="font-size:11px;color:var(--secondary);margin-top:5px;">
                                üí∞ +${p.reward||0} ${p.giftObj?`¬∑ üéÅ ${p.giftObj.i||''} ${p.giftObj.n||''}`:(p.gift?`¬∑ üéÅ ${p.gift}`:'')} ¬∑ ${p.useCount||0}/${p.maxUses||'‚àû'} –∏—Å–ø–æ–ª—å–∑.
                            </div>
                        </div>
                        <button class="btn" style="padding:8px 12px;font-size:12px;background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.25);color:var(--err);flex-shrink:0;" onclick="deletePromo('${code}')">üóë</button>
                    </div>`;
                }).join('')
                : `<p style="color:var(--secondary);text-align:center;padding:20px;">–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ—Ç</p>`;
        });

        // Live activity feed
        onValue(ref(db,'activity_log'), snap => {
            const feedEl = document.getElementById('adm-activity-feed');
            if(!feedEl) return;
            const raw = snap.exists() ? snap.val() : null;
            const log = raw ? (Array.isArray(raw) ? raw : Object.values(raw)) : [];
            if(!log.length) { feedEl.innerHTML='<div style="color:var(--secondary);text-align:center;padding:16px;font-size:13px;">–î–µ–π—Å—Ç–≤–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>'; return; }
            const sorted = [...log].reverse().slice(0, 100);
            feedEl.innerHTML = sorted.map(e => {
                const d = new Date(e.time);
                const timeStr = d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}) + ' ' + d.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'});
                let icon, text, color;
                if(e.type === 'shop_buy') {
                    icon='üõçÔ∏è'; color='rgba(36,129,204,0.12)';
                    text=`<b>@${e.userId}</b> –∫—É–ø–∏–ª –≤ –º–∞–≥–∞–∑–∏–Ω–µ: ${e.emoji||''} <b>${e.item}</b> –∑–∞ ${(e.price||0).toLocaleString()}üí∞`;
                } else if(e.type === 'market_buy') {
                    icon='‚öñÔ∏è'; color='rgba(243,156,18,0.12)';
                    text=`<b>@${e.userId}</b> –∫—É–ø–∏–ª –Ω–∞ —Ä—ã–Ω–∫–µ: ${e.emoji||''} <b>${e.item}</b> —É <b>@${e.seller}</b> –∑–∞ ${(e.price||0).toLocaleString()}üí∞`;
                } else if(e.type === 'market_list') {
                    icon='üì§'; color='rgba(162,155,254,0.1)';
                    text=`<b>@${e.userId}</b> –≤—ã—Å—Ç–∞–≤–∏–ª –Ω–∞ —Ä—ã–Ω–æ–∫: ${e.emoji||''} <b>${e.item}</b> –∑–∞ ${(e.price||0).toLocaleString()}üí∞`;
                } else if(e.type === 'friend_add') {
                    icon='üë•'; color='rgba(46,204,113,0.1)';
                    text=`<b>@${e.userId}</b> –¥–æ–±–∞–≤–∏–ª –≤ –¥—Ä—É–∑—å—è <b>@${e.friendId}</b>`;
                } else if(e.type === 'friend_request') {
                    icon='üëã'; color='rgba(46,204,113,0.07)';
                    text=`<b>@${e.userId}</b> –æ—Ç–ø—Ä–∞–≤–∏–ª –∑–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è ‚Üí <b>@${e.toId}</b>`;
                } else if(e.type === 'gift_sent') {
                    icon='üéÅ'; color='rgba(255,215,0,0.08)';
                    text=`<b>@${e.userId}</b> –ø–æ–¥–∞—Ä–∏–ª ${e.emoji||'üéÅ'} <b>${e.item}</b> ‚Üí <b>@${e.toId}</b>`;
                } else if(e.type === 'trade_offer') {
                    icon='üîÑ'; color='rgba(36,129,204,0.08)';
                    text=`<b>@${e.userId}</b> –ø—Ä–µ–¥–ª–æ–∂–∏–ª –æ–±–º–µ–Ω: ${e.emoji||'üéÅ'} <b>${e.item}</b> ‚Üí <b>@${e.toId}</b>`;
                } else if(e.type === 'duel_challenge') {
                    icon='‚öîÔ∏è'; color='rgba(255,107,107,0.08)';
                    text=`<b>@${e.userId}</b> –≤—ã–∑–≤–∞–ª –Ω–∞ –¥—É—ç–ª—å <b>@${e.toId}</b> (—Å—Ç–∞–≤–∫–∞: ${e.emoji||'üéÅ'} ${e.item})`;
                } else if(e.type === 'duel_result') {
                    icon='üèÜ'; color='rgba(255,215,0,0.1)';
                    text=`–î—É—ç–ª—å: <b>@${e.winnerId}</b> –ø–æ–±–µ–¥–∏–ª <b>@${e.loserId}</b> ¬∑ ${e.item1} vs ${e.item2}`;
                } else if(e.type === 'sell_item') {
                    icon='üóëÔ∏è'; color='rgba(255,255,255,0.04)';
                    text=`<b>@${e.userId}</b> –ø—Ä–æ–¥–∞–ª: ${e.emoji||'üéÅ'} <b>${e.item}</b> –∑–∞ ${(e.reward||0).toLocaleString()}üí∞`;
                } else if(e.type === 'promo') {
                    icon='üéüÔ∏è'; color='rgba(243,156,18,0.1)';
                    text=`<b>@${e.userId}</b> –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ø—Ä–æ–º–æ–∫–æ–¥ <b>${e.code}</b> ¬∑ +${e.reward||0}üí∞${e.gift?` + üéÅ ${e.gift}`:''}`;
                } else {
                    icon='üìå'; color='rgba(255,255,255,0.04)';
                    text=`<b>@${e.userId||'?'}</b> ¬∑ ${e.type}`;
                }
                return `<div style="display:flex;align-items:flex-start;gap:10px;padding:9px 12px;border-radius:12px;margin-bottom:5px;background:${color};border:1px solid rgba(255,255,255,0.04);">
                    <span style="font-size:17px;flex-shrink:0;margin-top:1px;">${icon}</span>
                    <div style="flex:1;min-width:0;">
                        <div style="font-size:12px;line-height:1.5;">${text}</div>
                        <div style="font-size:10px;color:var(--secondary);margin-top:2px;font-family:monospace;">üïê ${timeStr}</div>
                    </div>
                </div>`;
            }).join('');
        });
    }

    // ‚îÄ‚îÄ‚îÄ MOD PANEL (–æ–±—Ä–µ–∑–∞–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è batlukov / nowkie) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function initAdminMod() {
        const modLabel = MOD_PREFIXES[user.id] || '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä';
        onValue(ref(db,'users'),s=>{
            const us=s.val(); if(!us) return;
            const userList=Object.entries(us);
            const nonAdminList=userList.filter(([id])=>!ADMIN_IDS.has(id));
            const totalBal=nonAdminList.reduce((a,[,u])=>a+(u.balance||0),0);
            const totalItems=nonAdminList.reduce((a,[,u])=>a+(u.cloudInv||[]).length,0);
            const tgLinked=nonAdminList.filter(([,u])=>u.tgChatId).length;
            const adminEl=document.getElementById('admin');
            adminEl.innerHTML=`
            <div class="adm-header">
                <div>
                    <div class="adm-header-title">üõ°Ô∏è –ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞</div>
                    <div class="adm-header-sub" style="color:#a29bfe;">${modLabel} ¬∑ ${nonAdminList.length} –∏–≥—Ä–æ–∫–æ–≤</div>
                </div>
            </div>
            <div class="adm-tabs">
                <button class="adm-tab active" onclick="modTab('mod-overview',this)">üìä –û–±–∑–æ—Ä</button>
                <button class="adm-tab" onclick="modTab('mod-users',this)">üë• –ò–≥—Ä–æ–∫–∏</button>
                <button class="adm-tab" onclick="modTab('mod-market',this)">‚öñÔ∏è –†—ã–Ω–æ–∫</button>
            </div>

            <!-- Overview -->
            <div id="mod-overview" class="adm-section active">
                <div class="adm-stat-grid">
                    <div class="adm-stat blue"><div class="ico">üë•</div><div class="val">${nonAdminList.length}</div><div class="lbl">–ò–≥—Ä–æ–∫–æ–≤</div></div>
                    <div class="adm-stat green"><div class="ico">üì¶</div><div class="val">${totalItems}</div><div class="lbl">–ü—Ä–µ–¥–º–µ—Ç–æ–≤</div></div>
                    <div class="adm-stat orange"><div class="ico">üí∞</div><div class="val">${totalBal.toLocaleString()}</div><div class="lbl">–ú–æ–Ω–µ—Ç</div></div>
                    <div class="adm-stat purple"><div class="ico">‚úàÔ∏è</div><div class="val">${tgLinked}</div><div class="lbl">TG –ø—Ä–∏–≤—è–∑–∞–Ω–æ</div></div>
                </div>
                <div style="background:#0d1720;border-radius:20px;padding:16px;border:1px solid rgba(255,255,255,0.06);margin-top:12px;">
                    <div style="font-size:11px;color:var(--secondary);font-weight:bold;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:12px;">üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</div>
                    <div>${[...nonAdminList].sort((a,b)=>(b[1].balance||0)-(a[1].balance||0)).slice(0,5).map(([id,u],i)=>{
                        const medals=['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£'];
                        return `<div style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;" onclick="openUserProfile('${id}')">
                            <span style="font-size:18px;width:24px;text-align:center;">${medals[i]}</span>
                            <span style="flex:1;font-size:13px;font-weight:bold;">${u.username}</span>
                            <span style="color:gold;font-weight:bold;font-size:13px;">${(u.balance||0).toLocaleString()}üí∞</span>
                        </div>`;
                    }).join('')}</div>
                </div>
            </div>

            <!-- Users (—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä + –∫–Ω–æ–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è) -->
            <div id="mod-users" class="adm-section">
                <div class="search-box" style="margin-bottom:10px;">
                    <span style="color:var(--secondary);">üîç</span>
                    <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É..." oninput="modFilterUsers(this.value)" style="flex:1;">
                </div>
                <div id="mod-users-list">${userList.map(([id,u])=>{
                    const invCount=(u.cloudInv||[]).length;
                    const hasTg=!!u.tgChatId;
                    return `<div class="adm-user-row" data-name="${(u.username||'').toLowerCase()}">
                        <div class="uavatar">${(u.username||'?')[0].toUpperCase()}</div>
                        <div style="flex:1;min-width:0;">
                            <div class="uname">${u.username}</div>
                            <div class="uinfo">${hasTg?'‚úàÔ∏è':'üìµ'} ¬∑ üì¶ ${invCount} –ø—Ä–µ–¥–º.</div>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <button onclick="openUserProfile('${id}')" style="background:rgba(36,129,204,0.1);border:1px solid rgba(36,129,204,0.2);color:var(--accent);border-radius:10px;padding:5px 10px;font-size:11px;cursor:pointer;">üëÅ –ü—Ä–æ—Ñ–∏–ª—å</button>
                            <div class="ubadge">${(u.balance||0).toLocaleString()}üí∞</div>
                        </div>
                    </div>`;
                }).join('')}</div>
            </div>

            <!-- Market (—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä) -->
            <div id="mod-market" class="adm-section">
                <div style="background:#0a1520;border-radius:14px;padding:10px;margin-bottom:10px;">
                    <div id="mod-market-stats" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;"></div>
                </div>
                <div class="search-box" style="margin-bottom:10px;">
                    <span style="color:var(--secondary);">üîç</span>
                    <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º..." oninput="modFilterMarket(this.value)" style="flex:1;">
                </div>
                <div id="mod-market-list"><div style="color:var(--secondary);text-align:center;padding:30px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
            </div>`;

            let modMarketData = {};
            window.loadModMarket = async () => {
                const snap = await get(ref(db,'market/'));
                modMarketData = snap.val() || {};
                renderModMarket(modMarketData);
            };
            window.modFilterMarket = (q) => {
                const filtered = Object.fromEntries(Object.entries(modMarketData).filter(([,x])=>(x.n||'').toLowerCase().includes(q.toLowerCase())||(x.sN||'').toLowerCase().includes(q.toLowerCase())));
                renderModMarket(filtered);
            };
            function renderModMarket(data) {
                const entries = Object.entries(data);
                const totalVal = entries.reduce((a,[,x])=>a+(x.mP||0),0);
                const statsEl = document.getElementById('mod-market-stats');
                if(statsEl) statsEl.innerHTML=`
                    <div style="background:#0d1720;border-radius:12px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06);">
                        <div style="font-size:18px;font-weight:900;color:var(--accent);">${entries.length}</div>
                        <div style="font-size:10px;color:var(--secondary);margin-top:2px;">–õ–æ—Ç–æ–≤</div>
                    </div>
                    <div style="background:#0d1720;border-radius:12px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06);">
                        <div style="font-size:18px;font-weight:900;color:gold;">${totalVal.toLocaleString()}</div>
                        <div style="font-size:10px;color:var(--secondary);margin-top:2px;">üí∞ –°—É–º–º–∞</div>
                    </div>
                    <div style="background:#0d1720;border-radius:12px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06);">
                        <div style="font-size:18px;font-weight:900;color:var(--green);">${entries.length?Math.round(totalVal/entries.length).toLocaleString():0}</div>
                        <div style="font-size:10px;color:var(--secondary);margin-top:2px;">üí∞ –°—Ä–µ–¥–Ω–µ–µ</div>
                    </div>`;
                const list = document.getElementById('mod-market-list');
                if(!list) return;
                if(!entries.length){list.innerHTML='<div style="text-align:center;color:var(--secondary);padding:30px;">–†—ã–Ω–æ–∫ –ø—É—Å—Ç</div>';return;}
                list.innerHTML=entries.map(([k,x])=>`
                    <div style="background:#0d1720;border-radius:16px;padding:12px 14px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.05);display:flex;align-items:center;gap:12px;">
                        <div style="font-size:28px;flex-shrink:0;">${x.i||'üéÅ'}</div>
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:bold;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${x.n}</div>
                            <div style="font-size:11px;color:var(--secondary);margin-top:2px;">üë§ ${x.sN} <span style="color:#4a6080;">(${x.sI})</span></div>
                        </div>
                        <div style="font-size:14px;font-weight:900;color:gold;">${(x.mP||0).toLocaleString()}üí∞</div>
                    </div>`).join('');
            }

            window.modTab = (id,b) => {
                document.querySelectorAll('#admin .adm-section').forEach(s=>s.classList.remove('active'));
                document.querySelectorAll('#admin .adm-tab').forEach(t=>t.classList.remove('active'));
                document.getElementById(id)?.classList.add('active');
                b.classList.add('active');
                if(id==='mod-market') loadModMarket();
            };
            window.modFilterUsers = (q) => {
                const rows = document.querySelectorAll('#mod-users-list .adm-user-row');
                rows.forEach(r=>{ r.style.display=(!q||r.dataset.name.includes(q.toLowerCase()))?'':'none'; });
            };
        });
    }

    window.admToggleUser = (id) => {
        const el=document.getElementById('admu-'+id);
        el.classList.toggle('open');
    };

    window.delUser=async(id)=>{const ok=await showConfirm('–£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞','–ê–∫–∫–∞—É–Ω—Ç @'+id+' –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.','üóëÔ∏è','var(--err)','–£–¥–∞–ª–∏—Ç—å');if(ok) await remove(ref(db,'users/'+id));};
    window.setB=async(id)=>{const v=document.getElementById('ab-'+id).value;if(v){await update(ref(db,'users/'+id),{balance:parseInt(v)});showToast(`üí∞ –ë–∞–ª–∞–Ω—Å @${id} –æ–±–Ω–æ–≤–ª—ë–Ω`);}};
    window.giveI=async(id)=>{
        const sel=document.getElementById('ag-'+id).value;
        const rar=parseInt(document.getElementById('agr-'+id)?.value||'0');
        let itm;
        if(sel==='nft_liz')  itm={...NFT_LIZARD};
        else if(sel==='nft_pan') itm={...NFT_PAN};
        else if(sel==='nft_beer') itm={...NFT_BEER};
        else if(sel==='nft_sock') itm={...NFT_SOCK};
        else itm=catalog.find(x=>x.id==sel);
        if(!itm) return showToast('–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!','var(--err)');
        try {
            const s=await get(ref(db,'users/'+id));
            if(!s.exists()) return showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!','var(--err)');
            const inv=s.val().cloudInv||[];
            const serial=await getNextNftSerial();
            const itmClean={...itm};
            // Strip large base64 images before writing to Firebase
            if(itmClean.img&&itmClean.img.startsWith('data:')) delete itmClean.img;
            const entry={...itmClean, inst:Date.now(), from:"ADMIN", seen:false, nftSerial:serial};
            // NFT items must not have rarity field, regular items get rarity
            if(itm.nft) { delete entry.rarity; } else { entry.rarity=rar; }
            inv.push(entry);
            await update(ref(db,'users/'+id),{cloudInv:inv});
            const rarLabel=itm.nft?'‚ú¶ NFT':(RARITY_LEVELS[rar]?.icon||'');
            getTgId(id).then(cid=>sendTg(cid,`üéÅ <b>–ü–æ–¥–∞—Ä–æ–∫ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!</b>\n\n–¢–µ–±–µ –±—ã–ª –≤—ã–¥–∞–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫:\n${itm.i} <b>${itm.n}</b>\nüè∑ –†–µ–¥–∫–æ—Å—Ç—å: <b>${rarLabel}</b>\n\nüéâ –û–Ω —É–∂–µ –≤ —Ç–≤–æ—ë–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ!`));
            showToast(`${itm.i} ${itm.n} #${serial} ‚Üí @${id}`,'var(--green)');
        } catch(e) {
            console.error('giveI error:', e);
            showToast('–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏: '+e.message,'var(--err)');
        }
    };

    window.createPromo = async () => {
        const code=document.getElementById('promo-code-in').value.trim().toUpperCase();
        const reward=parseInt(document.getElementById('promo-reward-in').value)||0;
        const maxUses=parseInt(document.getElementById('promo-uses-in').value)||0;
        const giftSel=document.getElementById('promo-gift-in').value.trim();
        const giftRarity=parseInt(document.getElementById('promo-gift-rarity')?.value||'0');
        if(!code) return showToast("–í–≤–µ–¥–∏ –∫–æ–¥!",'var(--err)');
        const ex=await get(ref(db,'promos/'+code));
        if(ex.exists()) return showToast("–ö–æ–¥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!",'var(--err)');
        // Build gift object
        let giftObj = null;
        if(giftSel) {
            if(giftSel==='nft_liz') giftObj = {...NFT_LIZARD};
            else if(giftSel==='nft_pan') giftObj = {...NFT_PAN};
            else if(giftSel==='nft_beer') giftObj = {...NFT_BEER};
            else if(giftSel==='nft_sock') giftObj = {...NFT_SOCK};
            else {
                const catItem = catalog.find(x=>x.id==giftSel);
                if(catItem) giftObj = {...catItem, rarity: giftRarity};
            }
        }
        await set(ref(db,'promos/'+code),{reward,maxUses:maxUses||null,giftObj:giftObj||null,useCount:0,usedBy:{}});
        document.getElementById('promo-code-in').value='';
        document.getElementById('promo-reward-in').value='';
        document.getElementById('promo-uses-in').value='';
        document.getElementById('promo-gift-in').value='';
        showToast("–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω! üéüÔ∏è",'var(--green)');
    };
    window.deletePromo=async(code)=>{const ok=await showConfirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥','–ü—Ä–æ–º–æ–∫–æ–¥ '+code+' –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω.','üéüÔ∏è','var(--err)','–£–¥–∞–ª–∏—Ç—å');if(ok) await remove(ref(db,'promos/'+code));};

    window.broadcastCoins = async () => {
        const amount=parseInt(document.getElementById('bcast-coins').value);
        if(!amount||amount<=0) return showToast("–í–≤–µ–¥–∏ —Å—É–º–º—É!",'var(--err)');
        const ok=await showConfirm('–†–∞—Å—Å—ã–ª–∫–∞ –º–æ–Ω–µ—Ç','–†–∞–∑–æ—Å–ª–∞—Ç—å '+amount+'üí∞ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º?','üì¢','var(--green)','–†–∞–∑–æ—Å–ª–∞—Ç—å');
        if(!ok) return;
        const s=await get(ref(db,'users')),us=s.val();
        const up={};for(let id in us) up[`users/${id}/balance`]=(us[id].balance||0)+amount;
        await update(ref(db),up);
        // Notify all TG users
        for(let id in us){if(us[id].tgChatId)sendTg(us[id].tgChatId,`üí∞ <b>–ú–æ–Ω–µ—Ç—ã –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!</b>\n\n–í—Å–µ–º –∏–≥—Ä–æ–∫–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ:\n<b>${Number(amount).toLocaleString()} –º–æ–Ω–µ—Ç</b>\n\nüéâ –û–Ω–∏ —É–∂–µ –Ω–∞ —Ç–≤–æ—ë–º –±–∞–ª–∞–Ω—Å–µ!`);}
        showToast(`‚úÖ –†–∞–∑–æ—Å–ª–∞–Ω–æ ${amount}üí∞ –≤—Å–µ–º!`,'var(--green)');
        document.getElementById('bcast-coins').value='';
    };

    window.broadcastGift = async () => {
        const itm=catalog.find(x=>x.id==document.getElementById('bcast-gift').value);
        const ok2=await showConfirm('–í—ã–¥–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫ –≤—Å–µ–º',itm.i+' '+itm.n+' –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º?','üéÅ','var(--orange)','–í—ã–¥–∞—Ç—å');
        if(!ok2) return;
        const s=await get(ref(db,'users')),us=s.val();
        const up={};
        for(let id in us){const inv=(us[id].cloudInv||[]);inv.push({...itm,inst:Date.now(),from:"ADMIN",seen:false});up[`users/${id}/cloudInv`]=inv;}
        await update(ref(db),up);
        for(let id in us){if(us[id].tgChatId)sendTg(us[id].tgChatId,`üéÅ <b>–ü–æ–¥–∞—Ä–æ–∫ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º!</b>\n\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤—ã–¥–∞–ª –≤—Å–µ–º:\n${itm.i} <b>${itm.n}</b>\n\n‚úÖ –ü–æ–¥–∞—Ä–æ–∫ —É–∂–µ –≤ —Ç–≤–æ—ë–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ!`);}
        showToast(`‚úÖ ${itm.i} –≤—ã–¥–∞–Ω –≤—Å–µ–º!`,'var(--green)');
    };

    window.resetAndReissue = async () => {
        const ok = await showConfirm(
            '–°–±—Ä–æ—Å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π',
            '–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã —É –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏ –≤–µ—Å—å —Ä—ã–Ω–æ–∫ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –ó–∞—Ç–µ–º –∫–∞–∂–¥–æ–º—É –∏–≥—Ä–æ–∫—É –±—É–¥–µ—Ç –≤—ã–¥–∞–Ω –Ω–æ–≤—ã–π –Ω–∞–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ (5 —Å–ª—É—á–∞–π–Ω—ã—Ö). –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!',
            '‚ö†Ô∏è', 'var(--err)', '–°–±—Ä–æ—Å–∏—Ç—å –∏ –ø–µ—Ä–µ–≤—ã–¥–∞—Ç—å'
        );
        if (!ok) return;

        // Step 1: clear market
        await remove(ref(db, 'market'));

        // Step 2: clear all inventories/pinned, give 5 random new items
        const s = await get(ref(db, 'users')), us = s.val();
        if (!us) return showToast('–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤', 'var(--err)');

        const up = {};
        for (let id in us) {
            // Pick 5 random unique items from catalog
            const shuffled = [...catalog].sort(() => Math.random() - 0.5).slice(0, 5);
            const newInv = shuffled.map(itm => ({
                ...itm,
                inst: Date.now() + Math.floor(Math.random() * 100000),
                from: 'RESET',
                seen: false
            }));
            up[`users/${id}/cloudInv`] = newInv;
            up[`users/${id}/pinnedInsts`] = [];
        }
        await update(ref(db), up);
        showToast(`‚úÖ –ì–æ—Ç–æ–≤–æ! –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏ —Å–±—Ä–æ—à–µ–Ω—ã –∏ –ø–µ—Ä–µ–≤—ã–¥–∞–Ω—ã –≤—Å–µ–º ${Object.keys(us).length} –∏–≥—Ä–æ–∫–∞–º`, 'var(--green)');
    };

    window.clearAllShowcases = async () => {
        const ok=await showConfirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–∏—Ç—Ä–∏–Ω—ã','–í—Å–µ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –±—É–¥—É—Ç —Å–Ω—è—Ç—ã —Å –≤–∏—Ç—Ä–∏–Ω –∏–≥—Ä–æ–∫–æ–≤.','üßπ','var(--err)','–û—á–∏—Å—Ç–∏—Ç—å');
        if(!ok) return;
        const s=await get(ref(db,'users')),us=s.val();
        const up={};for(let id in us) up[`users/${id}/pinnedInsts`]=[];
        await update(ref(db),up);showToast("–í–∏—Ç—Ä–∏–Ω—ã –æ—á–∏—â–µ–Ω—ã!",'var(--err)');
    };

    window.clearMarket = async () => {
        const ok=await showConfirm('–û—á–∏—Å—Ç–∏—Ç—å —Ä—ã–Ω–æ–∫','–í—Å–µ –ª–æ—Ç—ã –Ω–∞ —Ä—ã–Ω–∫–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.','üóëÔ∏è','var(--err)','–û—á–∏—Å—Ç–∏—Ç—å');
        if(!ok) return;
        await remove(ref(db,'market'));showToast("–†—ã–Ω–æ–∫ –æ—á–∏—â–µ–Ω!",'var(--err)');
    };
    // ===== INSTANT NFT AVATAR THEME UPDATE =====
    window.applyPinnedNftThemeToAvatar = (d) => {
        const inv = d.cloudInv || [];
        const pinnedInsts = new Set((d.pinnedInsts||[]).map(String));
        // –ò—â–µ–º –≤—Å–µ ring-item —ç–ª–µ–º–µ–Ω—Ç—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏—Ö —Å—Ç–∏–ª—å
        document.querySelectorAll('.avatar-ring-item.ring-nft[data-inst]').forEach(el => {
            const inst = el.getAttribute('data-inst');
            const item = inv.find(x=>String(x.inst)===String(inst));
            if(!item||!item.upgrade||!item.upgrade.level) return;
            const lvlD = NFT_UPGRADE_LEVELS[item.upgrade.level];
            if(!lvlD) return;
            // Remove old upgrade classes
            el.classList.forEach(cls=>{if(cls.startsWith('nft-lvl'))el.classList.remove(cls);});
            // Add new classes
            const newCls = getNftUpgradeClasses(item);
            if(newCls) newCls.split(' ').forEach(c=>c&&el.classList.add(c));
            // Update border glow
            const thD = lvlD.themes && lvlD.themes.find(t=>t.id===item.upgrade.theme);
            if(thD){
                const colorMap = {fire:'255,80,0',ocean:'0,150,255',forest:'0,200,80',galaxy:'150,50,255',sunset:'255,100,150'};
                const c = colorMap[item.upgrade.theme];
                if(c && item.upgrade.level >= 1){
                    el.style.borderColor = `rgba(${c},0.9)`;
                    el.style.boxShadow = `0 0 ${item.upgrade.level>=3?'14':'10'}px rgba(${c},${item.upgrade.level>=3?'0.8':'0.6'}),0 2px 10px rgba(0,0,0,0.6)`;
                }
            }
        });
    };

    window.tab=(id,b)=>{
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(n=>n.classList.remove('active'));
        document.getElementById(id).classList.add('active');b.classList.add('active');
        if(id==='inv') renderInv();
        if(id==='shop') renderShop();
        if(id==='market') listenMarket();
        if(id==='profile') { get(ref(db,'users/'+user.id)).then(s=>{ if(s.val()) renderMyProfile(s.val()); }); }
    };
    // ===== TELEGRAM INTEGRATION =====
    const TG_BOT_TOKEN = '8080771405:AAGsN_dudAoaiNmqLdgWsol8iL7ZDwqu-Ho';
    async function getTgId(uid) {
        try { const s=await get(ref(db,'users/'+uid)); return s.exists()&&s.val().tgChatId?s.val().tgChatId:null; } catch(e){return null;}
    }
    async function sendTg(chatId, text) {
        if(!chatId) return;
        try {
            await fetch(`https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage`,{
                method:'POST',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({chat_id:chatId,text,parse_mode:'HTML'})
            });
        } catch(e){}
    }
    window.broadcastMsg = async () => {
        const msg=document.getElementById('bcast-msg')?.value?.trim();
        if(!msg) return showToast('–í–≤–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ!','var(--err)');
        const ok=await showConfirm('–†–∞—Å—Å—ã–ª–∫–∞ –≤ Telegram','–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º —É –∫–æ–≥–æ –ø—Ä–∏–≤—è–∑–∞–Ω Telegram?','üì¢','var(--accent)','–†–∞–∑–æ—Å–ª–∞—Ç—å');
        if(!ok) return;
        const s=await get(ref(db,'users')),us=s.val();
        let sent=0;
        for(let id in us){
            if(us[id].tgChatId){
                await sendTg(us[id].tgChatId,`üì¢ <b>–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ Gift World</b>\n\n${msg}\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nüéÅ Gift World`);
                sent++;
            }
        }
        showToast(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${sent} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º`,'var(--green)');
        if(document.getElementById('bcast-msg')) document.getElementById('bcast-msg').value='';
    };

    // Auto-login from localStorage
    (()=>{
        const s=localStorage.getItem('gifts_user');
        if(s){
            try{
                const d=JSON.parse(s);
                if(d&&d.name&&d.id) startApp(d.name,d.id);
            }catch(e){}
        }
    })();
</script>
</body>
</html>
