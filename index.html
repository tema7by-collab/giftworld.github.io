<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gifts World Ultimate Edition 2026</title>
    <style>
        :root {
            --bg-color: #0b141a;
            --card-bg: #111b21;
            --accent-color: #00a884;
            --text-main: #e9edef;
            --text-secondary: #8696a0;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --glass: rgba(17, 27, 33, 0.9);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* --- UI COMPONENTS --- */
        .btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn:active { transform: scale(0.97); filter: brightness(0.9); }
        .btn-danger { background: var(--danger); }
        .btn-warn { background: var(--warning); color: #000; }
        .btn-ghost { background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary); }

        input, textarea, select {
            width: 100%;
            background: #202c33;
            border: 1px solid #2a3942;
            padding: 12px 16px;
            border-radius: 10px;
            color: var(--text-main);
            font-size: 16px;
            margin: 8px 0;
        }

        /* --- LAYOUT --- */
        #app { display: none; padding-bottom: 100px; }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; }

        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* --- NAVIGATION --- */
        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--glass);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 11px;
            cursor: pointer;
            position: relative;
            flex: 1;
        }

        .nav-item.active { color: var(--accent-color); }
        .nav-item i { font-size: 22px; margin-bottom: 4px; font-style: normal; }

        /* –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –°–ß–ï–¢–ß–ò–ö (BADGE) */
        .nav-badge {
            position: absolute;
            top: -5px;
            right: 25%;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: bold;
            height: 18px;
            min-width: 18px;
            border-radius: 9px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            border: 2px solid var(--bg-color);
        }

        /* --- GAME UI --- */
        .coin-box {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            margin: 20px 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .flipping { animation: flip 0.6s infinite; }
        @keyframes flip {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        /* --- GIFT NOTE FRAME --- */
        .note-container {
            margin-top: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #1d2b33 0%, #111b21 100%);
            border: 2px solid var(--accent-color);
            border-radius: 15px;
            position: relative;
            box-shadow: inset 0 0 15px rgba(0,168,132,0.2);
        }

        .note-container::before {
            content: "‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ:";
            display: block;
            font-size: 12px;
            color: var(--accent-color);
            margin-bottom: 8px;
            font-weight: bold;
        }

        .note-text {
            font-style: italic;
            color: #d1d7db;
            word-wrap: break-word;
        }

        /* --- ADMIN PANEL --- */
        .admin-user-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #202c33;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .status-banned { color: var(--danger); font-weight: bold; }

        /* --- TOAST --- */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--accent-color);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            z-index: 9999;
            transition: 0.5s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            font-weight: bold;
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
    </style>
</head>
<body>

<div id="toast">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>

<div id="auth-page" style="display: flex; align-items: center; height: 100vh; justify-content: center;">
    <div class="card" style="width: 100%; max-width: 350px;">
        <h2 style="text-align: center; color: var(--accent-color);">Gifts World</h2>
        <input type="text" id="auth-login" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" onclick="app.handleAuth('login')">–í–æ–π—Ç–∏</button>
        <button class="btn btn-ghost" style="margin-top: 10px;" onclick="app.handleAuth('reg')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
</div>

<div id="app">
    <header style="padding: 15px; background: var(--card-bg); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 900; border-bottom: 1px solid #2a3942;">
        <div id="user-display" style="font-weight: bold; display: flex; align-items: center; gap: 8px;">---</div>
        <div style="color: var(--accent-color); font-weight: bold;"><span id="balance-display">0</span> üí∞</div>
    </header>

    <div class="container">
        <div id="page-shop" class="page active">
            <h3 style="margin-top: 0;">–í–∏—Ç—Ä–∏–Ω–∞ –ø–æ–¥–∞—Ä–∫–æ–≤</h3>
            <div id="shop-items" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;"></div>
        </div>

        <div id="page-inventory" class="page">
            <h3 style="margin-top: 0;">–ú–æ–π —Å–∫–ª–∞–¥</h3>
            <div id="inventory-items" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;"></div>
        </div>

        <div id="page-market" class="page">
            <h3 style="margin-top: 0;">–ú–∏—Ä–æ–≤–æ–π —Ä—ã–Ω–æ–∫</h3>
            <div id="market-items" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>

        <div id="page-game" class="page">
            <div class="card" style="text-align: center;">
                <h3>–ú–æ–Ω–µ—Ç–∫–∞ (–°—Ç–∞–≤–∫–∞ 100)</h3>
                <div id="game-lobby">
                    <p style="color: var(--text-secondary);">–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞ –¥–ª—è –≤—ã–∑–æ–≤–∞:</p>
                    <div id="game-friends" style="display: flex; flex-direction: column; gap: 8px;"></div>
                </div>
                <div id="game-active" style="display: none;">
                    <div class="coin-box" id="coin-visual">ü™ô</div>
                    <p id="game-info">–í–∞—à —Ö–æ–¥!</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn" onclick="app.gameAction('eagle')">–û—Ä—ë–ª</button>
                        <button class="btn" onclick="app.gameAction('tails')">–†–µ—à–∫–∞</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-friends" class="page">
            <div class="card">
                <input type="text" id="friend-id-input" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <button class="btn btn-ghost" onclick="app.addFriend()">–ù–∞–π—Ç–∏ –¥—Ä—É–≥–∞</button>
            </div>
            <div id="friends-list"></div>
        </div>

        <div id="page-profile" class="page">
            <div class="card" style="text-align: center;">
                <div id="profile-pic" style="width: 80px; height: 80px; background: #2a3942; border-radius: 50%; margin: 0 auto 15px; font-size: 40px; display: flex; align-items: center; justify-content: center;">üë§</div>
                <h2 id="profile-name">–ò–º—è –§–∞–º–∏–ª–∏—è</h2>
                <p id="profile-bio" style="color: var(--text-secondary);">–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–ª—å–∑—É—é—Å—å Gifts World.</p>
                <button class="btn btn-ghost" onclick="app.openEditProfile()">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <button class="btn btn-danger" style="margin-top: 15px;" onclick="app.logout()">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <div id="page-admin" class="page">
            <h2 style="color: var(--warning);">üõ† –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
            <div class="card">
                <h4>–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                <p>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <span id="adm-total-users">0</span></p>
                <p>–ú–æ–Ω–µ—Ç –≤ –æ–±–æ—Ä–æ—Ç–µ: <span id="adm-total-coins">0</span></p>
            </div>
            <div id="adm-user-list"></div>
        </div>
    </div>

    <nav class="navbar">
        <div class="nav-item active" onclick="app.nav('shop', this)"><i>üõçÔ∏è</i><span>–ú–∞–≥–∞–∑–∏–Ω</span></div>
        <div class="nav-item" onclick="app.nav('market', this)"><i>‚öñÔ∏è</i><span>–†—ã–Ω–æ–∫</span></div>
        <div class="nav-item" onclick="app.nav('inventory', this)">
            <div class="nav-badge" id="inv-badge">0</div>
            <i>üì¶</i><span>–°–∫–ª–∞–¥</span>
        </div>
        <div class="nav-item" onclick="app.nav('game', this)"><i>üé∞</i><span>–ò–≥—Ä–∞</span></div>
        <div class="nav-item" onclick="app.nav('friends', this)"><i>üë•</i><span>–î—Ä—É–∑—å—è</span></div>
        <div class="nav-item" onclick="app.nav('profile', this)"><i>üë§</i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></div>
        <div class="nav-item" id="nav-admin" style="display: none; color: var(--warning);" onclick="app.nav('admin', this)"><i>‚öôÔ∏è</i><span>–ê–¥–º–∏–Ω</span></div>
    </nav>
</div>

<div class="modal-overlay" id="modal">
    <div class="card" id="modal-body" style="width: 100%; max-width: 400px; position: relative;">
        </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDK9IMy-DDNXvPcHv7uAjgZ8ZLdXUh8OCw",
        authDomain: "gift-1292c.firebaseapp.com",
        projectId: "gift-1292c",
        databaseURL: "https://gift-1292c-default-rtdb.firebaseio.com",
        storageBucket: "gift-1292c.appspot.com",
        appId: "1:527659513899:web:4023b323982425ad18526e"
    };

    const fb = initializeApp(firebaseConfig);
    const db = getDatabase(fb);

    const CATALOG = [
        {id: 1, name: "–ó–æ–ª–æ—Ç–∞—è –†–æ–∑–∞", icon: "üåπ", price: 500},
        {id: 2, name: "–ê–ª–º–∞–∑", icon: "üíé", price: 2500},
        {id: 3, name: "–ö–æ—Ñ–µ", icon: "‚òï", price: 100},
        {id: 4, name: "–ü–∏—Ü—Ü–∞", icon: "üçï", price: 350},
        {id: 5, name: "–¢–æ—Ä—Ç", icon: "üéÇ", price: 800},
        {id: 6, name: "–†–∞–∫–µ—Ç–∞", icon: "üöÄ", price: 10000}
    ];

    window.app = {
        user: null,
        activeGame: null,

        showToast(msg, isErr = false) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.background = isErr ? 'var(--danger)' : 'var(--accent-color)';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        },

        handleAuth: async (type) => {
            const login = document.getElementById('auth-login').value.trim().toLowerCase();
            const pass = document.getElementById('auth-pass').value.trim();

            if (login.length < 3 || pass.length < 3) return app.showToast("–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞", true);

            const userRef = ref(db, 'users/' + login);
            const snap = await get(userRef);

            if (type === 'reg') {
                if (snap.exists()) return app.showToast("–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç", true);
                await set(userRef, {
                    username: login,
                    password: pass,
                    balance: 1000,
                    bio: "–ü—Ä–∏–≤–µ—Ç! –Ø –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.",
                    inventory: [],
                    friends: {},
                    role: (login === 'ckovoroda' || login === 'kukumbr') ? 'admin' : 'user',
                    status: 'active'
                });
                app.login(login);
            } else {
                if (!snap.exists() || snap.val().password !== pass) return app.showToast("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞", true);
                if (snap.val().status === 'banned') return app.showToast("–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!", true);
                app.login(login);
            }
        },

        login(id) {
            localStorage.setItem('gifts_uid', id);
            location.reload();
        },

        logout() {
            localStorage.removeItem('gifts_uid');
            location.reload();
        },

        init: () => {
            const uid = localStorage.getItem('gifts_uid');
            if (!uid) return;

            document.getElementById('auth-page').style.display = 'none';
            document.getElementById('app').style.display = 'block';

            onValue(ref(db, 'users/' + uid), (snap) => {
                const data = snap.val();
                if (!data) return app.logout();
                if (data.status === 'banned') app.logout();
                
                app.user = data;
                app.updateUI();
            });

            // –°–ª—É—à–∞–µ–º —Ä—ã–Ω–æ–∫
            onValue(ref(db, 'market'), (snap) => {
                app.renderMarket(snap.val());
            });

            // –°–ª—É—à–∞–µ–º –∏–≥—Ä—ã
            onValue(ref(db, 'games'), (snap) => {
                app.checkGames(snap.val());
            });

            app.renderShop();
        },

        updateUI() {
            document.getElementById('user-display').innerText = '@' + app.user.username;
            document.getElementById('balance-display').innerText = app.user.balance;
            
            // –ü–†–û–§–ò–õ–¨
            document.getElementById('profile-name').innerText = app.user.username;
            document.getElementById('profile-bio').innerText = app.user.bio;

            // –°–ß–ï–¢–ß–ò–ö –°–ö–õ–ê–î–ê (–§–ò–ö–°)
            const invCount = app.user.inventory ? Object.keys(app.user.inventory).length : 0;
            const badge = document.getElementById('inv-badge');
            badge.innerText = invCount;
            badge.style.display = invCount > 0 ? 'flex' : 'none';

            app.renderInventory();
            app.renderFriends();
            
            if (app.user.role === 'admin') {
                document.getElementById('nav-admin').style.display = 'flex';
                app.loadAdminData();
            }
        },

        nav(pageId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            el.classList.add('active');
        },

        renderShop() {
            const container = document.getElementById('shop-items');
            container.innerHTML = CATALOG.map(item => `
                <div class="card" style="text-align: center;">
                    <div style="font-size: 40px;">${item.icon}</div>
                    <div style="font-weight: bold;">${item.name}</div>
                    <div style="color: var(--accent-color); margin: 5px 0;">${item.price} üí∞</div>
                    <button class="btn btn-sm" onclick="app.buyItem(${item.id})">–ö—É–ø–∏—Ç—å</button>
                </div>
            `).join('');
        },

        buyItem: async (id) => {
            const item = CATALOG.find(i => i.id === id);
            if (app.user.balance < item.price) return app.showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤", true);

            const newBalance = app.user.balance - item.price;
            const newItem = { ...item, instanceId: Date.now() + Math.random().toString(36).substr(2, 9) };

            await update(ref(db, 'users/' + app.user.username), { balance: newBalance });
            await push(ref(db, 'users/' + app.user.username + '/inventory'), newItem);
            
            app.showToast("–£—Å–ø–µ—à–Ω–∞—è –ø–æ–∫—É–ø–∫–∞!");
        },

        renderInventory() {
            const container = document.getElementById('inventory-items');
            if (!app.user.inventory) return container.innerHTML = '<p>–¢—É—Ç –ø–æ–∫–∞ –ø—É—Å—Ç–æ...</p>';

            container.innerHTML = Object.entries(app.user.inventory).map(([key, item]) => `
                <div class="card" style="text-align: center;">
                    <div style="font-size: 40px;">${item.icon}</div>
                    <div style="font-weight: bold;">${item.name}</div>
                    <div style="display: flex; flex-direction: column; gap: 5px; margin-top: 10px;">
                        <button class="btn btn-ghost" onclick="app.openGiftModal('${key}')">–ü–æ–¥–∞—Ä–∏—Ç—å</button>
                        <button class="btn btn-ghost" style="color: var(--warning);" onclick="app.sellMarket('${key}')">–ù–∞ —Ä—ã–Ω–æ–∫</button>
                        <button class="btn btn-ghost" style="color: var(--accent-color);" onclick="app.viewItemInfo('${key}')">–ò–Ω—Ñ–æ</button>
                    </div>
                </div>
            `).join('');
        },

        viewItemInfo(key) {
            const item = app.user.inventory[key];
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            body.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 60px;">${item.icon}</div>
                    <h2>${item.name}</h2>
                    <p style="color: var(--text-secondary);">ID –≠–∫–∑–µ–º–ø–ª—è—Ä–∞: ${item.instanceId}</p>
                    ${item.note ? `
                        <div class="note-container">
                            <div class="note-text">${item.note}</div>
                        </div>
                    ` : '<p>–ó–∞–ø–∏—Å–∫–∏ –Ω–µ—Ç</p>'}
                    <button class="btn" style="margin-top: 20px;" onclick="app.closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            modal.style.display = 'flex';
        },

        openGiftModal(key) {
            const item = app.user.inventory[key];
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            const friends = app.user.friends ? Object.keys(app.user.friends) : [];
            if (friends.length === 0) return app.showToast("–£ –≤–∞—Å –Ω–µ—Ç –¥—Ä—É–∑–µ–π", true);

            body.innerHTML = `
                <h3>–ü–æ–¥–∞—Ä–∏—Ç—å ${item.icon}</h3>
                <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
                <select id="gift-target">
                    ${friends.map(f => `<option value="${f}">${f}</option>`).join('')}
                </select>
                <label>–¢–µ–∫—Å—Ç –∑–∞–ø–∏—Å–∫–∏:</label>
                <textarea id="gift-note" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –ø—Ä–∏—è—Ç–Ω–æ–µ..."></textarea>
                <button class="btn" onclick="app.sendGift('${key}')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <button class="btn btn-ghost" style="margin-top:10px" onclick="app.closeModal()">–û—Ç–º–µ–Ω–∞</button>
            `;
            modal.style.display = 'flex';
        },

        sendGift: async (key) => {
            const target = document.getElementById('gift-target').value;
            const note = document.getElementById('gift-note').value;
            const item = app.user.inventory[key];

            // –£–¥–∞–ª—è–µ–º —É —Å–µ–±—è
            await remove(ref(db, `users/${app.user.username}/inventory/${key}`));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥—Ä—É–≥–æ–º—É
            const gift = { ...item, note: note || null, from: app.user.username };
            await push(ref(db, `users/${target}/inventory`), gift);

            app.closeModal();
            app.showToast("–ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
        },

        sellMarket: async (key) => {
            const price = prompt("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏:");
            if (!price || isNaN(price)) return;

            const item = app.user.inventory[key];
            await remove(ref(db, `users/${app.user.username}/inventory/${key}`));
            
            await push(ref(db, 'market'), {
                ...item,
                marketPrice: parseInt(price),
                seller: app.user.username
            });
            app.showToast("–õ–æ—Ç –≤—ã—Å—Ç–∞–≤–ª–µ–Ω");
        },

        renderMarket(data) {
            const container = document.getElementById('market-items');
            if (!data) return container.innerHTML = '<p>–†—ã–Ω–æ–∫ –ø—É—Å—Ç</p>';

            container.innerHTML = Object.entries(data).map(([key, item]) => `
                <div class="admin-user-row">
                    <div style="display:flex; align-items:center; gap:10px">
                        <span style="font-size: 24px;">${item.icon}</span>
                        <div>
                            <b>${item.name}</b><br>
                            <small>–ü—Ä–æ–¥–∞–≤–µ—Ü: @${item.seller}</small>
                        </div>
                    </div>
                    <div style="text-align: right">
                        <div style="color: var(--accent-color); font-weight: bold;">${item.marketPrice} üí∞</div>
                        <button class="btn btn-sm" style="padding: 5px 10px; height:auto; width:auto;" onclick="app.buyFromMarket('${key}')">–ö—É–ø–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');
        },

        buyFromMarket: async (key) => {
            const snap = await get(ref(db, 'market/' + key));
            const item = snap.val();
            if (item.seller === app.user.username) return app.showToast("–≠—Ç–æ –≤–∞—à –ª–æ—Ç", true);
            if (app.user.balance < item.marketPrice) return app.showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥", true);

            // –°–¥–µ–ª–∫–∞
            const sellerRef = ref(db, 'users/' + item.seller);
            const sellerSnap = await get(sellerRef);
            
            await update(sellerRef, { balance: sellerSnap.val().balance + item.marketPrice });
            await update(ref(db, 'users/' + app.user.username), { balance: app.user.balance - item.marketPrice });
            await push(ref(db, 'users/' + app.user.username + '/inventory'), item);
            await remove(ref(db, 'market/' + key));

            app.showToast("–ö—É–ø–ª–µ–Ω–æ –Ω–∞ —Ä—ã–Ω–∫–µ!");
        },

        // --- GAME LOGIC ---
        checkGames(games) {
            if (!games) return;
            Object.entries(games).forEach(([gid, g]) => {
                if (g.target === app.user.username && g.status === 'pending') {
                    if (confirm(`–í—ã–∑–æ–≤ –æ—Ç ${g.host}! –ü—Ä–∏–Ω—è—Ç—å –∑–∞ 100 –º–æ–Ω–µ—Ç?`)) {
                        app.acceptGame(gid);
                    } else {
                        remove(ref(db, 'games/' + gid));
                    }
                }
            });
        },

        acceptGame: async (gid) => {
            if (app.user.balance < 100) return app.showToast("–ú–∞–ª–æ –º–æ–Ω–µ—Ç", true);
            app.activeGame = gid;
            await update(ref(db, 'games/' + gid), { status: 'playing' });
            app.nav('game', document.querySelectorAll('.nav-item')[3]);
            document.getElementById('game-lobby').style.display = 'none';
            document.getElementById('game-active').style.display = 'block';
        },

        inviteGame: async (target) => {
            if (app.user.balance < 100) return app.showToast("–ù—É–∂–Ω–æ 100 –º–æ–Ω–µ—Ç", true);
            const gid = 'game_' + Date.now();
            await set(ref(db, 'games/' + gid), {
                host: app.user.username,
                target: target,
                status: 'pending',
                bet: 100
            });
            app.showToast("–í—ã–∑–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");
        },

        gameAction: async (choice) => {
            const visual = document.getElementById('coin-visual');
            visual.classList.add('flipping');
            document.getElementById('game-info').innerText = "–ú–æ–Ω–µ—Ç–∫–∞ –∫—Ä—É—Ç–∏—Ç—Å—è...";

            setTimeout(async () => {
                visual.classList.remove('flipping');
                const result = Math.random() > 0.5 ? 'eagle' : 'tails';
                visual.innerText = result === 'eagle' ? 'ü¶Ö' : 'ü™ô';

                const win = choice === result;
                const change = win ? 100 : -100;

                await update(ref(db, 'users/' + app.user.username), { balance: app.user.balance + change });
                document.getElementById('game-info').innerHTML = win ? 
                    `<span style="color:var(--success)">–í–´–ò–ì–†–´–®! +100</span>` : 
                    `<span style="color:var(--danger)">–ü–†–û–ò–ì–†–´–®! -100</span>`;

                setTimeout(() => {
                    document.getElementById('game-lobby').style.display = 'block';
                    document.getElementById('game-active').style.display = 'none';
                    remove(ref(db, 'games/' + app.activeGame));
                    app.activeGame = null;
                }, 3000);
            }, 2000);
        },

        // --- ADMIN SYSTEM ---
        loadAdminData: async () => {
            onValue(ref(db, 'users'), (snap) => {
                const users = snap.val();
                if (!users) return;
                
                let totalCoins = 0;
                const list = Object.entries(users).map(([id, u]) => {
                    totalCoins += u.balance;
                    return `
                        <div class="admin-user-row">
                            <div>
                                <b class="${u.status === 'banned' ? 'status-banned' : ''}">${u.username}</b><br>
                                <small>${u.balance} üí∞ | ${u.role}</small>
                            </div>
                            <div style="display:flex; gap:5px">
                                <button class="btn btn-sm btn-ghost" onclick="app.viewUserProfile('${id}')">üîé</button>
                                <button class="btn btn-sm btn-warn" onclick="app.admToggleBan('${id}', '${u.status}')">üö´</button>
                                <button class="btn btn-sm btn-danger" onclick="app.admDeleteUser('${id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('adm-total-users').innerText = Object.keys(users).length;
                document.getElementById('adm-total-coins').innerText = totalCoins;
                document.getElementById('adm-user-list').innerHTML = list;
            });
        },

        viewUserProfile: async (id) => {
            const snap = await get(ref(db, 'users/' + id));
            const u = snap.val();
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            body.innerHTML = `
                <h3>–ü—Ä–æ—Ñ–∏–ª—å @${u.username}</h3>
                <p>–†–æ–ª—å: ${u.role}</p>
                <p>–ë–∞–ª–∞–Ω—Å: ${u.balance} üí∞</p>
                <p>–û —Å–µ–±–µ: ${u.bio}</p>
                <hr>
                <button class="btn" onclick="app.admAddCoins('${id}')">–ù–∞—á–∏—Å–ª–∏—Ç—å 1000 üí∞</button>
                <button class="btn btn-ghost" style="margin-top:10px" onclick="app.closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            `;
            modal.style.display = 'flex';
        },

        admAddCoins: async (id) => {
            const snap = await get(ref(db, 'users/' + id));
            await update(ref(db, 'users/' + id), { balance: snap.val().balance + 1000 });
            app.showToast("–ú–æ–Ω–µ—Ç—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã");
            app.closeModal();
        },

        admToggleBan: async (id, currentStatus) => {
            if (id === 'ckovoroda' || id === 'kukumbr') return app.showToast("–ù–µ–ª—å–∑—è –∑–∞–±–∞–Ω–∏—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª—è", true);
            const next = currentStatus === 'banned' ? 'active' : 'banned';
            await update(ref(db, 'users/' + id), { status: next });
            app.showToast("–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω");
        },

        admDeleteUser: async (id) => {
            if (id === 'ckovoroda' || id === 'kukumbr') return app.showToast("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª—è", true);
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç ${id} –Ω–∞–≤—Å–µ–≥–¥–∞?`)) {
                await remove(ref(db, 'users/' + id));
                app.showToast("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω");
            }
        },

        // --- HELPERS ---
        renderFriends() {
            const container = document.getElementById('friends-list');
            if (!app.user.friends) return container.innerHTML = '<p>–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –ø—É—Å—Ç</p>';
            
            container.innerHTML = Object.keys(app.user.friends).map(f => `
                <div class="admin-user-row">
                    <b>${f}</b>
                    <button class="btn btn-sm" style="width:auto;" onclick="app.inviteGame('${f}')">–í—ã–∑–≤–∞—Ç—å ‚öîÔ∏è</button>
                </div>
            `).join('');

            // –î—Ä—É–∑—å—è –¥–ª—è –∏–≥—Ä—ã
            document.getElementById('game-friends').innerHTML = Object.keys(app.user.friends).map(f => `
                <button class="btn btn-ghost" onclick="app.inviteGame('${f}')">‚öîÔ∏è ${f}</button>
            `).join('');
        },

        addFriend: async () => {
            const fid = document.getElementById('friend-id-input').value.trim().toLowerCase();
            if (!fid || fid === app.user.username) return;

            const snap = await get(ref(db, 'users/' + fid));
            if (!snap.exists()) return app.showToast("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω", true);

            await update(ref(db, `users/${app.user.username}/friends/${fid}`), { status: 'friend' });
            await update(ref(db, `users/${fid}/friends/${app.user.username}`), { status: 'friend' });
            
            document.getElementById('friend-id-input').value = "";
            app.showToast("–î—Ä—É–≥ –¥–æ–±–∞–≤–ª–µ–Ω!");
        },

        closeModal() { document.getElementById('modal').style.display = 'none'; },
        
        openEditProfile() {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            body.innerHTML = `
                <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <label>–û —Å–µ–±–µ:</label>
                <textarea id="edit-bio">${app.user.bio}</textarea>
                <button class="btn" onclick="app.saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            `;
            modal.style.display = 'flex';
        },

        saveProfile: async () => {
            const bio = document.getElementById('edit-bio').value;
            await update(ref(db, 'users/' + app.user.username), { bio });
            app.closeModal();
            app.showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
        }
    };

    app.init();
</script>
</body>
</html>




















